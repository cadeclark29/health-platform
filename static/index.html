<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Platform - Supplement Dispenser</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            margin-bottom: 16px;
            font-size: 1.2em;
            color: #00d9ff;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        input, select {
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            flex: 1;
            min-width: 150px;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            color: #1a1a2e;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 217, 255, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .hidden {
            display: none !important;
        }

        #status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 350px;
            transition: opacity 0.3s;
        }

        #status.success {
            background: rgba(0, 255, 136, 0.9);
            color: #000;
        }

        #status.error {
            background: rgba(255, 68, 68, 0.9);
            color: #fff;
        }

        /* Onboarding */
        .onboarding-step {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .onboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .onboard-grid input, .onboard-grid select {
            min-width: 0;
        }

        /* Date Navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }

        .date-nav button {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-nav button:hover {
            background: rgba(0, 217, 255, 0.3);
        }

        .date-display {
            text-align: center;
            min-width: 200px;
        }

        .date-display .day {
            font-size: 1.4em;
            font-weight: 700;
        }

        .date-display .full-date {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
        }

        .date-display .today-badge {
            display: inline-block;
            background: #00ff88;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Time Selector */
        .time-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .time-btn {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 20px;
            color: #fff;
            font-size: 0.9em;
        }

        .time-btn.active {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.2);
        }

        /* Main Dispenser Layout */
        .dispenser-layout {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        /* AI Recommendation - Center */
        .ai-recommendation {
            grid-column: 2;
            grid-row: 1;
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.3) 0%, rgba(0, 217, 255, 0.3) 100%);
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .ai-recommendation:hover {
            transform: scale(1.02);
            border-color: #8a2be2;
            box-shadow: 0 8px 30px rgba(138, 43, 226, 0.4);
        }

        .ai-recommendation .ai-icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        .ai-recommendation .ai-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 6px;
            background: linear-gradient(90deg, #8a2be2, #00d9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-recommendation .ai-subtitle {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.3;
        }

        .ai-recommendation.loading .ai-icon {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Daily Foundation - Below AI */
        .daily-foundation {
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2) 0%, rgba(0, 217, 255, 0.2) 100%);
            border: 2px solid rgba(0, 255, 136, 0.4);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .daily-foundation:hover {
            transform: scale(1.02);
            border-color: #00ff88;
            box-shadow: 0 8px 30px rgba(0, 255, 136, 0.3);
        }

        .daily-foundation.taken {
            opacity: 0.4;
            cursor: default;
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .daily-foundation.taken:hover {
            transform: none;
            box-shadow: none;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .daily-foundation.taken .df-name {
            color: rgba(255, 255, 255, 0.5);
        }

        .daily-foundation .taken-badge {
            display: none;
            background: rgba(0, 255, 136, 0.3);
            color: #00ff88;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
            margin-top: 6px;
        }

        .daily-foundation.taken .taken-badge {
            display: inline-block;
        }

        .daily-foundation .df-icon {
            font-size: 1.8em;
            margin-bottom: 6px;
        }

        .daily-foundation .df-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #00ff88;
        }

        .daily-foundation .df-desc {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Mix Cards */
        .mix-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mix-card:hover {
            transform: translateY(-4px);
            border-color: var(--mix-color, #00d9ff);
            box-shadow: 0 8px 25px rgba(var(--mix-color-rgb, 0, 217, 255), 0.3);
        }

        .mix-card .mix-icon {
            font-size: 1.8em;
            margin-bottom: 6px;
        }

        .mix-card .mix-name {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .mix-card .mix-desc {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.2;
        }

        .mix-card.custom-blend-mix {
            position: relative;
        }

        .mix-card .custom-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(138, 43, 226, 0.9);
            color: #fff;
            font-size: 0.55em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Dispense Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-icon {
            font-size: 3em;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .modal-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }

        .supplement-list {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .supplement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .supplement-item:last-child {
            border-bottom: none;
        }

        .supplement-name {
            font-weight: 500;
            font-size: 0.95em;
        }

        .supplement-dose {
            color: #00ff88;
            font-weight: 600;
        }

        .modal-warning {
            background: rgba(255, 170, 0, 0.2);
            border: 1px solid rgba(255, 170, 0, 0.4);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 16px;
            font-size: 0.85em;
            color: #ffaa00;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-actions button {
            flex: 1;
            padding: 14px;
            font-size: 1em;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-dispense {
            background: linear-gradient(90deg, #00ff88, #00d9ff);
        }

        .btn-dispense.dispensing {
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
        }

        /* Dispense Animation */
        .dispense-animation {
            text-align: center;
            padding: 20px 0;
        }

        .glass-container {
            position: relative;
            width: 120px;
            height: 160px;
            margin: 0 auto 20px;
        }

        .glass {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 140px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 0 0 20px 20px;
            border-top: none;
            overflow: hidden;
        }

        .glass-water {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(0, 217, 255, 0.6) 0%, rgba(0, 255, 136, 0.8) 100%);
            height: 0;
            transition: height 2s ease-out;
            border-radius: 0 0 16px 16px;
        }

        .glass-water.filling {
            height: 85%;
        }

        .dropping-supplements {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .dropping-pill {
            font-size: 1.2em;
            animation: dropPill 1s ease-in forwards;
            opacity: 0;
        }

        @keyframes dropPill {
            0% { transform: translateY(-20px); opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }

        .dispense-message {
            font-size: 1.3em;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 8px;
        }

        .dispense-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }

        .dispensed-list {
            margin-top: 16px;
            padding: 12px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 8px;
            text-align: left;
        }

        .dispensed-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85em;
        }

        /* Tracking Section */
        .tracking-section {
            margin-top: 20px;
        }

        .tracking-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tracking-tab {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 0.9em;
        }

        .tracking-tab.active {
            background: rgba(0, 217, 255, 0.3);
            color: #00d9ff;
        }

        .tracking-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 16px;
        }

        .tracking-item {
            margin-bottom: 16px;
        }

        .tracking-item:last-child {
            margin-bottom: 0;
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .tracking-name {
            font-weight: 500;
            font-size: 0.95em;
        }

        .tracking-values {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
        }

        .tracking-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .tracking-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d9ff);
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        .tracking-fill.warning {
            background: linear-gradient(90deg, #ffaa00, #ff6600);
        }

        .tracking-fill.danger {
            background: linear-gradient(90deg, #ff4444, #ff0000);
        }

        /* Saturation Gauge */
        .saturation-gauge {
            margin-top: 20px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .saturation-title {
            font-size: 0.9em;
            color: #00d9ff;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .saturation-item {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .saturation-ring {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .saturation-ring svg {
            transform: rotate(-90deg);
        }

        .saturation-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .saturation-ring .bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .saturation-ring .progress {
            stroke: #00ff88;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-out;
        }

        .saturation-ring .progress.building {
            stroke: #ffaa00;
        }

        .saturation-ring .progress.decaying {
            stroke: #ff6666;
        }

        .saturation-pct {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.1em;
            font-weight: 700;
        }

        .saturation-info {
            flex: 1;
        }

        .saturation-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .saturation-status {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
        }

        .saturation-status.saturated {
            color: #00ff88;
        }

        .saturation-status.building {
            color: #ffaa00;
        }

        .saturation-status.decaying {
            color: #ff6666;
        }

        /* User header */
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #1a1a2e;
        }

        .user-name {
            font-weight: 600;
        }

        .btn-logout {
            padding: 8px 16px;
            font-size: 0.85em;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 700px) {
            .dispenser-layout {
                grid-template-columns: repeat(2, 1fr);
            }

            .ai-recommendation {
                grid-column: 1 / span 2;
                grid-row: auto;
            }

            .daily-foundation {
                grid-column: 1 / span 2;
                grid-row: auto;
            }
        }

        @media (max-width: 400px) {
            .dispenser-layout {
                grid-template-columns: 1fr;
            }

            .ai-recommendation, .daily-foundation {
                grid-column: 1;
            }
        }

        /* Settings panel */
        .settings-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(26, 26, 46, 0.95);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 280px;
            backdrop-filter: blur(10px);
        }

        .settings-panel h3 {
            margin-bottom: 16px;
            font-size: 1em;
            color: #00d9ff;
        }

        .setting-row {
            margin-bottom: 12px;
        }

        .setting-row label {
            display: block;
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }

        .setting-row select {
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state .emoji {
            font-size: 2.5em;
            margin-bottom: 12px;
        }

        /* Custom Blends Section */
        .custom-blends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .custom-blends-header h2 {
            margin: 0;
        }

        .btn-create-blend {
            padding: 8px 16px;
            font-size: 0.85em;
            border-radius: 20px;
            background: linear-gradient(90deg, #8a2be2, #00d9ff);
        }

        .custom-blend-card {
            background: rgba(138, 43, 226, 0.15);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-blend-card:hover {
            border-color: #8a2be2;
            background: rgba(138, 43, 226, 0.25);
        }

        .custom-blend-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .custom-blend-icon {
            font-size: 1.5em;
        }

        .custom-blend-name {
            font-weight: 600;
        }

        .custom-blend-count {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
        }

        .custom-blend-actions {
            display: flex;
            gap: 8px;
        }

        .btn-delete-blend {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-delete-blend:hover {
            background: rgba(255, 68, 68, 0.4);
        }

        /* Blend Builder Modal */
        .blend-builder {
            max-height: 80vh;
            overflow-y: auto;
        }

        .blend-builder-header {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .blend-builder-header input {
            flex: 1;
        }

        .icon-picker {
            width: 50px;
            text-align: center;
            font-size: 1.5em;
            cursor: pointer;
        }

        .supplement-categories {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .category-btn {
            padding: 6px 12px;
            font-size: 0.8em;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid transparent;
            border-radius: 16px;
            color: #fff;
            cursor: pointer;
        }

        .category-btn.active {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.2);
        }

        .supplement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
            margin-bottom: 16px;
        }

        .supplement-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .supplement-card:hover {
            border-color: rgba(0, 217, 255, 0.5);
        }

        .supplement-card.selected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .supplement-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .supplement-card-name {
            font-weight: 600;
            font-size: 0.95em;
        }

        .supplement-card-dose {
            font-size: 0.8em;
            color: #00d9ff;
        }

        .supplement-card-desc {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.3;
            margin-bottom: 8px;
        }

        .supplement-card-benefits {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .benefit-tag {
            padding: 2px 6px;
            font-size: 0.65em;
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            border-radius: 4px;
        }

        .supplement-card-links {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pubmed-link {
            display: block;
            font-size: 0.7em;
            color: #8a2be2;
            text-decoration: none;
            padding: 2px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pubmed-link:hover {
            color: #00d9ff;
            text-decoration: underline;
        }

        .selected-supplements {
            background: rgba(0, 255, 136, 0.1);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .selected-supplements-title {
            font-size: 0.85em;
            color: #00ff88;
            margin-bottom: 8px;
        }

        .selected-supp-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .selected-supp-item:last-child {
            border-bottom: none;
        }

        .selected-supp-name {
            font-size: 0.9em;
        }

        .selected-supp-dose {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dose-input {
            width: 70px;
            padding: 4px 8px;
            font-size: 0.85em;
            text-align: center;
        }

        .dose-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dose-unit {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.6);
            min-width: 30px;
        }

        .dose-range {
            font-size: 0.65em;
            color: rgba(255, 255, 255, 0.4);
        }

        /* AI Blend Assistant */
        .ai-blend-section {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(0, 217, 255, 0.1));
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .ai-blend-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .ai-blend-header .ai-icon {
            font-size: 1.5em;
        }

        .ai-blend-header h3 {
            margin: 0;
            font-size: 1em;
            color: #fff;
        }

        .ai-blend-header span {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
        }

        .ai-input-row {
            display: flex;
            gap: 10px;
        }

        .ai-input-row textarea {
            flex: 1;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
        }

        .ai-input-row button {
            align-self: flex-end;
            white-space: nowrap;
        }

        .ai-suggestions {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            display: none;
        }

        .ai-suggestions.visible {
            display: block;
        }

        .ai-suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ai-suggestions-title {
            font-size: 0.9em;
            color: #00d9ff;
        }

        .ai-suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .ai-suggestion-item:last-child {
            margin-bottom: 0;
        }

        .ai-suggestion-name {
            font-size: 0.9em;
        }

        .ai-suggestion-dose {
            font-size: 0.8em;
            color: #00ff88;
        }

        .ai-suggestion-reason {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
        }

        .ai-loading {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .ai-loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .btn-add-all {
            padding: 6px 12px;
            font-size: 0.8em;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .btn-add-all:hover {
            background: rgba(0, 255, 136, 0.3);
        }

        .btn-remove-supp {
            width: 24px;
            height: 24px;
            padding: 0;
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border-radius: 50%;
            font-size: 0.8em;
        }

        /* Supplement Info Modal */
        .supp-info-modal {
            max-width: 450px;
        }

        .supp-info-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .supp-info-name {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .supp-info-dose {
            color: #00d9ff;
            font-size: 0.9em;
        }

        .supp-info-desc {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .supp-info-benefits {
            margin-bottom: 16px;
        }

        .supp-info-benefits-title {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .supp-info-benefits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .supp-info-benefit {
            padding: 4px 10px;
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .supp-info-studies {
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 12px;
            padding: 14px;
        }

        .supp-info-studies-title {
            font-size: 0.85em;
            color: #8a2be2;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .study-link {
            display: block;
            padding: 8px;
            margin-bottom: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            text-decoration: none;
            transition: background 0.2s;
        }

        .study-link:last-child {
            margin-bottom: 0;
        }

        .study-link:hover {
            background: rgba(138, 43, 226, 0.2);
        }

        .study-title {
            color: #fff;
            font-size: 0.85em;
            display: block;
            margin-bottom: 2px;
        }

        .study-pmid {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75em;
        }
    </style>
</head>
<body>
    <div id="status" class="hidden"></div>

    <div class="container">
        <h1>Supplement Dispenser</h1>

        <!-- Not logged in -->
        <div id="no-user">
            <div class="card onboarding-step" id="onboarding-step-1">
                <h2>Create Your Profile</h2>
                <p style="margin-bottom: 16px; color: rgba(255,255,255,0.7); font-size: 0.9em;">
                    We need a few details to personalize your supplement doses.
                </p>

                <div class="form-row">
                    <input type="text" id="user-name" placeholder="Your name" required>
                    <input type="email" id="user-email" placeholder="Email address" required>
                </div>

                <div class="onboard-grid">
                    <input type="number" id="onboard-age" placeholder="Age" min="18" max="100" required>
                    <select id="onboard-sex" required>
                        <option value="">Sex</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="onboard-height-feet" placeholder="Height (ft)" min="3" max="8" style="flex: 1;" required>
                        <input type="number" id="onboard-height-inches" placeholder="in" min="0" max="11" style="flex: 1;" required>
                    </div>
                    <input type="number" id="onboard-weight" placeholder="Weight (lbs)" step="0.1" required>
                </div>

                <button onclick="createAccount()" style="width: 100%; margin-top: 16px;">
                    Create Account
                </button>

                <div style="text-align: center; margin-top: 16px;">
                    <span style="color: rgba(255,255,255,0.5);">Already have an account?</span>
                    <a href="#" onclick="toggleSignIn(event)" style="color: #00d9ff; margin-left: 8px;">Sign in</a>
                </div>

                <div id="signin-form" class="hidden" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="form-row">
                        <input type="email" id="signin-email" placeholder="Email address">
                        <button onclick="signIn()">Sign In</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logged in -->
        <div id="has-user" class="hidden">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <span class="user-name" id="display-name">User</span>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>

            <!-- Date Navigation -->
            <div class="date-nav">
                <button onclick="changeDate(-1)" title="Previous day">&#8592;</button>
                <div class="date-display">
                    <div class="day" id="date-day">Today</div>
                    <div class="full-date" id="date-full">January 15, 2026</div>
                </div>
                <button onclick="changeDate(1)" title="Next day">&#8594;</button>
            </div>

            <!-- Time Selector -->
            <div class="time-selector">
                <button class="time-btn" onclick="setTime(7)" id="time-btn-morning">Morning</button>
                <button class="time-btn active" onclick="setTime(14)" id="time-btn-afternoon">Afternoon</button>
                <button class="time-btn" onclick="setTime(21)" id="time-btn-evening">Evening</button>
            </div>

            <!-- Dispenser Card -->
            <div class="card">
                <h2>What do you need today?</h2>

                <div class="dispenser-layout" id="dispenser-layout">
                    <!-- AI Recommendation -->
                    <div class="ai-recommendation" onclick="getAIRecommendation()" id="ai-recommendation">
                        <div class="ai-icon">ü§ñ</div>
                        <div class="ai-title">AI Recommendation</div>
                        <div class="ai-subtitle">Personalized based on your health data</div>
                    </div>

                    <!-- Daily Foundation - Always visible below AI -->
                    <div class="daily-foundation" onclick="selectDailyFoundation()" id="daily-foundation">
                        <div class="df-icon">üíé</div>
                        <div class="df-name">Daily Foundation</div>
                        <div class="df-desc">Essential daily nutrients</div>
                        <div class="taken-badge">‚úì Taken Today</div>
                    </div>

                    <!-- Mix cards populated by JS -->
                </div>
            </div>

            <!-- Tracking Card -->
            <div class="card" id="tracking-card">
                <h2>Your Supplement Intake</h2>

                <div class="tracking-tabs">
                    <button class="tracking-tab active" onclick="switchTrackingTab('daily')" id="tab-daily">Today</button>
                    <button class="tracking-tab" onclick="switchTrackingTab('weekly')" id="tab-weekly">This Week</button>
                </div>

                <div class="tracking-content" id="tracking-content">
                    <div class="empty-state">
                        <div class="emoji">üíä</div>
                        <div>No supplements taken yet</div>
                    </div>
                </div>

                <!-- Saturation Gauge -->
                <div class="saturation-gauge" id="saturation-gauge">
                    <div class="saturation-title">
                        <span>‚ö°</span> Saturation Tracking
                    </div>
                    <div id="saturation-content">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Custom Blends Card -->
            <div class="card" id="custom-blends-card">
                <div class="custom-blends-header">
                    <h2>Your Custom Blends</h2>
                    <button class="btn-create-blend" onclick="openBlendBuilder()">+ Create Blend</button>
                </div>
                <div id="custom-blends-list">
                    <div class="empty-state">
                        <div class="emoji">üß™</div>
                        <div>No custom blends yet</div>
                        <div style="font-size: 0.8em; color: rgba(255,255,255,0.4); margin-top: 4px;">
                            Create your own supplement combinations
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blend Builder Modal -->
    <div class="modal-overlay hidden" id="blend-builder-modal">
        <div class="modal-content blend-builder" id="blend-builder-content">
            <div class="modal-header" style="text-align: left; margin-bottom: 16px;">
                <div class="modal-title">Create Custom Blend</div>
                <div class="modal-subtitle">Select supplements and customize doses</div>
            </div>

            <div class="blend-builder-header">
                <input type="text" id="blend-name" placeholder="Blend name (e.g. My Morning Stack)">
                <input type="text" id="blend-icon" class="icon-picker" value="üß™" maxlength="2" onclick="this.select()">
            </div>

            <!-- AI Assistant Section -->
            <div class="ai-blend-section">
                <div class="ai-blend-header">
                    <span class="ai-icon">ü§ñ</span>
                    <div>
                        <h3>AI Blend Assistant</h3>
                        <span>Describe what you want and I'll suggest supplements</span>
                    </div>
                </div>
                <div class="ai-input-row">
                    <textarea id="ai-blend-input" placeholder="Example: I want better sleep and less stress, but I also need energy in the morning without feeling jittery..."></textarea>
                    <button onclick="getAIBlendSuggestion()">Suggest</button>
                </div>
                <div class="ai-suggestions" id="ai-suggestions">
                    <div class="ai-suggestions-header">
                        <span class="ai-suggestions-title">Suggested Supplements</span>
                        <button class="btn-add-all" onclick="addAllSuggestions()">+ Add All</button>
                    </div>
                    <div id="ai-suggestions-list"></div>
                </div>
            </div>

            <div class="supplement-categories" id="supplement-categories">
                <!-- Populated by JS -->
            </div>

            <div class="supplement-grid" id="supplement-grid">
                <!-- Populated by JS -->
            </div>

            <div class="selected-supplements" id="selected-supplements" style="display: none;">
                <div class="selected-supplements-title">Selected Supplements</div>
                <div id="selected-supplements-list"></div>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeBlendBuilder()">Cancel</button>
                <button class="btn-dispense" onclick="saveCustomBlend()" id="save-blend-btn">
                    Save Blend
                </button>
            </div>
        </div>
    </div>

    <!-- Supplement Info Modal -->
    <div class="modal-overlay hidden" id="supp-info-modal">
        <div class="modal-content supp-info-modal" id="supp-info-content">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Dispense Modal -->
    <div class="modal-overlay hidden" id="dispense-modal">
        <div class="modal-content" id="modal-content">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Settings Toggle -->
    <button class="settings-toggle" onclick="toggleSettings()" title="Settings">
        <span>‚öôÔ∏è</span>
    </button>

    <!-- Settings Panel -->
    <div class="settings-panel hidden" id="settings-panel">
        <h3>Settings</h3>
        <div class="setting-row">
            <label>Simulate Health Data</label>
            <select id="scenario" onchange="loadScenario()">
                <option value="none">-- Select scenario --</option>
                <option value="average">Average Day</option>
                <option value="poor_sleep">Poor Sleep</option>
                <option value="high_strain">High Strain</option>
                <option value="stressed">Stressed</option>
                <option value="recovering">Recovering Well</option>
            </select>
        </div>
        <div class="setting-row">
            <label>Connect Wearable</label>
            <button onclick="connectOura()" class="btn-secondary" style="width: 100%; margin-top: 4px;">
                Connect Oura Ring
            </button>
        </div>
    </div>

    <script>
        // State
        let currentUserId = localStorage.getItem('userId');
        let currentDate = new Date();
        let currentTime = 14;
        let availableMixes = [];
        let customBlends = [];
        let currentMixData = null;
        let isDispensing = false;
        let trackingTab = 'daily';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (currentUserId) {
                loadUserAndShow();
            }
            updateDateDisplay();
            updateTimeButtons();
        });

        // Status messages
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 4000);
        }

        // Toggle sign in form
        function toggleSignIn(e) {
            e.preventDefault();
            document.getElementById('signin-form').classList.toggle('hidden');
        }

        // Create account
        async function createAccount() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const age = parseInt(document.getElementById('onboard-age').value);
            const sex = document.getElementById('onboard-sex').value;
            const height_feet = parseInt(document.getElementById('onboard-height-feet').value);
            const height_inches = parseInt(document.getElementById('onboard-height-inches').value);
            const weight_lbs = parseFloat(document.getElementById('onboard-weight').value);

            if (!name || !email || !age || !sex || isNaN(height_feet) || isNaN(height_inches) || !weight_lbs) {
                showStatus('Please fill in all fields', 'error');
                return;
            }

            try {
                const res = await fetch('/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, age, sex, height_feet, height_inches, weight_lbs })
                });

                if (res.ok) {
                    const user = await res.json();
                    currentUserId = user.id;
                    localStorage.setItem('userId', user.id);
                    showLoggedIn(user);
                    loadAllData();
                    showStatus('Account created!', 'success');
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error creating account', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Sign in
        async function signIn() {
            const email = document.getElementById('signin-email').value.trim();
            if (!email) {
                showStatus('Please enter your email', 'error');
                return;
            }

            try {
                const res = await fetch('/users/signin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (res.ok) {
                    const user = await res.json();
                    currentUserId = user.id;
                    localStorage.setItem('userId', user.id);
                    showLoggedIn(user);
                    loadAllData();
                    showStatus('Welcome back!', 'success');
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error signing in', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Load user and show UI
        async function loadUserAndShow() {
            try {
                const res = await fetch(`/users/${currentUserId}`);
                if (res.ok) {
                    const user = await res.json();
                    showLoggedIn(user);
                    loadAllData();
                } else {
                    localStorage.removeItem('userId');
                    currentUserId = null;
                }
            } catch (e) {
                console.error('Error loading user:', e);
            }
        }

        // Load all data
        function loadAllData() {
            loadMixes();
            loadTracking();
            loadSaturation();
            checkDailyFoundationTaken();
        }

        // Check if Daily Foundation was already taken today
        async function checkDailyFoundationTaken() {
            if (!currentUserId) return;

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/tracking/daily?date_str=${dateStr}`);

                if (res.ok) {
                    const data = await res.json();
                    // Check if any Daily Foundation supplements were taken
                    // Daily Foundation contains: vitamin_d3, vitamin_k2, omega_3, magnesium_glycinate
                    const dfSupplements = ['vitamin_d3', 'vitamin_k2', 'omega_3'];
                    const takenSupps = data.supplements.map(s => s.supplement_id);

                    // Consider it taken if at least 2 of the foundation supplements were taken
                    const foundationTaken = dfSupplements.filter(s => takenSupps.includes(s)).length >= 2;

                    const dfElement = document.getElementById('daily-foundation');
                    if (foundationTaken) {
                        dfElement.classList.add('taken');
                    } else {
                        dfElement.classList.remove('taken');
                    }
                }
            } catch (e) {
                console.error('Error checking daily foundation:', e);
            }
        }

        // Select Daily Foundation (with taken check)
        function selectDailyFoundation() {
            const dfElement = document.getElementById('daily-foundation');
            if (dfElement.classList.contains('taken')) {
                showStatus('Daily Foundation already taken today', 'success');
                return;
            }
            selectMix('daily_foundation');
        }

        // Show logged in state
        function showLoggedIn(user) {
            document.getElementById('no-user').classList.add('hidden');
            document.getElementById('has-user').classList.remove('hidden');
            document.getElementById('display-name').textContent = user.name;
            document.getElementById('user-avatar').textContent = user.name.charAt(0).toUpperCase();
        }

        // Logout
        function logout() {
            localStorage.removeItem('userId');
            currentUserId = null;
            document.getElementById('no-user').classList.remove('hidden');
            document.getElementById('has-user').classList.add('hidden');
            document.getElementById('user-name').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('onboard-age').value = '';
            document.getElementById('onboard-sex').value = '';
            document.getElementById('onboard-height-feet').value = '';
            document.getElementById('onboard-height-inches').value = '';
            document.getElementById('onboard-weight').value = '';
        }

        // Date navigation
        function changeDate(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            updateDateDisplay();
            loadAllData();
        }

        function updateDateDisplay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const current = new Date(currentDate);
            current.setHours(0, 0, 0, 0);

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            const diff = Math.round((current - today) / (1000 * 60 * 60 * 24));

            let dayText = dayNames[currentDate.getDay()];
            let badge = '';

            if (diff === 0) {
                dayText = 'Today';
                badge = '<span class="today-badge">TODAY</span>';
            } else if (diff === -1) {
                dayText = 'Yesterday';
            } else if (diff === 1) {
                dayText = 'Tomorrow';
            }

            document.getElementById('date-day').innerHTML = dayText + badge;
            document.getElementById('date-full').textContent =
                `${monthNames[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
        }

        function getDateString() {
            return currentDate.toISOString().split('T')[0];
        }

        // Time selection
        function setTime(hour) {
            currentTime = hour;
            updateTimeButtons();
            loadMixes();
        }

        function updateTimeButtons() {
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));

            if (currentTime >= 5 && currentTime < 12) {
                document.getElementById('time-btn-morning').classList.add('active');
            } else if (currentTime >= 12 && currentTime < 18) {
                document.getElementById('time-btn-afternoon').classList.add('active');
            } else {
                document.getElementById('time-btn-evening').classList.add('active');
            }
        }

        // Load available mixes
        async function loadMixes() {
            if (!currentUserId) return;

            try {
                // Load both preset mixes and custom blends
                const [mixesRes, blendsRes] = await Promise.all([
                    fetch(`/mixes/available?time_override=${currentTime}`),
                    fetch(`/mixes/blends/${currentUserId}`)
                ]);

                if (mixesRes.ok) {
                    availableMixes = await mixesRes.json();
                }
                if (blendsRes.ok) {
                    customBlends = await blendsRes.json();
                }

                renderMixCards();
            } catch (e) {
                console.error('Error loading mixes:', e);
            }
        }

        // Render mix cards
        function renderMixCards() {
            const layout = document.getElementById('dispenser-layout');

            // Remove existing mix cards (but keep AI and Daily Foundation)
            layout.querySelectorAll('.mix-card').forEach(card => card.remove());

            // Filter out daily_foundation from available mixes (it's always shown separately)
            const otherMixes = availableMixes.filter(m => m.id !== 'daily_foundation');

            // Add preset mix cards
            for (const mix of otherMixes) {
                const card = document.createElement('div');
                card.className = 'mix-card';
                card.style.cssText = `--mix-color: ${mix.color}; --mix-color-rgb: ${hexToRgb(mix.color)}`;
                card.onclick = () => selectMix(mix.id);
                card.innerHTML = `
                    <div class="mix-icon">${mix.icon}</div>
                    <div class="mix-name">${mix.name}</div>
                    <div class="mix-desc">${mix.description}</div>
                `;
                layout.appendChild(card);
            }

            // Add custom blend cards
            for (const blend of customBlends) {
                const card = document.createElement('div');
                card.className = 'mix-card custom-blend-mix';
                card.style.cssText = `--mix-color: #8a2be2; --mix-color-rgb: 138, 43, 226`;
                card.onclick = () => selectCustomBlend(blend.id);
                card.innerHTML = `
                    <div class="mix-icon">${blend.icon}</div>
                    <div class="mix-name">${blend.name}</div>
                    <div class="mix-desc">${blend.components.length} supplements</div>
                    <div class="custom-badge">Custom</div>
                `;
                layout.appendChild(card);
            }
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result
                ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}`
                : '0, 217, 255';
        }

        // Select a mix
        async function selectMix(mixId) {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/${mixId}?time_override=${currentTime}&date_override=${dateStr}`);
                if (res.ok) {
                    currentMixData = await res.json();
                    showDispenseModal(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error loading mix', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Get AI recommendation
        async function getAIRecommendation() {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            const aiCard = document.getElementById('ai-recommendation');
            aiCard.classList.add('loading');

            try {
                const dateStr = getDateString();
                const smartRes = await fetch(`/mixes/${currentUserId}/smart?time_override=${currentTime}`);

                if (smartRes.ok) {
                    const smart = await smartRes.json();

                    if (smart.recommended_mix_id) {
                        const mixRes = await fetch(`/mixes/${currentUserId}/${smart.recommended_mix_id}?time_override=${currentTime}&date_override=${dateStr}`);

                        if (mixRes.ok) {
                            currentMixData = await mixRes.json();
                            currentMixData.ai_reason = smart.reason;
                            showDispenseModal(currentMixData, true);
                        }
                    } else {
                        showStatus('No recommendation available. Load health data first.', 'error');
                    }
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            } finally {
                aiCard.classList.remove('loading');
            }
        }

        // Show dispense modal
        function showDispenseModal(mixData, isAI = false) {
            const modal = document.getElementById('dispense-modal');
            const content = document.getElementById('modal-content');

            let supplementsHtml = '';
            for (const supp of mixData.supplements) {
                const adjusted = supp.adjusted_from ? ' <span style="color: rgba(255,255,255,0.5); font-size: 0.75em;">(adjusted)</span>' : '';
                supplementsHtml += `
                    <div class="supplement-item">
                        <span class="supplement-name">${supp.name}${adjusted}</span>
                        <span class="supplement-dose">${supp.dose} ${supp.unit}</span>
                    </div>
                `;
            }

            let warningsHtml = '';
            if (mixData.skipped && mixData.skipped.length > 0) {
                const skippedNames = mixData.skipped.map(s => s.name || s.supplement_id).join(', ');
                warningsHtml += `<div class="modal-warning">Skipped (daily limit): ${skippedNames}</div>`;
            }

            if (mixData.interaction_warnings && mixData.interaction_warnings.length > 0) {
                for (const w of mixData.interaction_warnings) {
                    warningsHtml += `<div class="modal-warning">${w.description}</div>`;
                }
            }

            const aiReasonHtml = isAI && mixData.ai_reason
                ? `<div style="background: rgba(138, 43, 226, 0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.85em;">
                     <strong style="color: #8a2be2;">Why:</strong> ${mixData.ai_reason}
                   </div>`
                : '';

            content.innerHTML = `
                <div class="modal-header">
                    <div class="modal-icon">${mixData.mix_icon}</div>
                    <div class="modal-title">${mixData.mix_name}</div>
                    <div class="modal-subtitle">${mixData.mix_description}</div>
                </div>

                ${aiReasonHtml}

                <div class="supplement-list">
                    ${supplementsHtml}
                </div>

                ${warningsHtml}

                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button class="btn-dispense" onclick="dispense()" id="dispense-btn">
                        Dispense Now
                    </button>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('dispense-modal').classList.add('hidden');
            currentMixData = null;
            isDispensing = false;
        }

        // Handle backdrop click
        document.getElementById('dispense-modal').addEventListener('click', (e) => {
            if (e.target.id === 'dispense-modal' && !isDispensing) {
                closeModal();
            }
        });

        // Dispense
        async function dispense() {
            if (!currentMixData || !currentUserId || isDispensing) return;

            isDispensing = true;
            const btn = document.getElementById('dispense-btn');
            btn.classList.add('dispensing');
            btn.textContent = 'Dispensing...';

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/${currentMixData.mix_id}/dispense?time_override=${currentTime}&date_override=${dateStr}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    const result = await res.json();
                    showDispenseAnimation(result);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error dispensing', 'error');
                    btn.classList.remove('dispensing');
                    btn.textContent = 'Dispense Now';
                    isDispensing = false;
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
                btn.classList.remove('dispensing');
                btn.textContent = 'Dispense Now';
                isDispensing = false;
            }
        }

        // Show dispense animation
        function showDispenseAnimation(result) {
            const content = document.getElementById('modal-content');

            // Build list of dispensed supplements
            let dispensedHtml = '';
            for (const supp of result.supplements_dispensed) {
                dispensedHtml += `
                    <div class="dispensed-item">
                        <span>${supp.name}</span>
                        <span style="color: #00ff88;">${supp.dose} ${supp.unit}</span>
                    </div>
                `;
            }

            // Build dropping pills HTML
            const pills = result.supplements_dispensed.slice(0, 5).map((_, i) =>
                `<div class="dropping-pill" style="animation-delay: ${i * 0.2}s">üíä</div>`
            ).join('');

            content.innerHTML = `
                <div class="dispense-animation">
                    <div class="glass-container">
                        <div class="dropping-supplements">${pills}</div>
                        <div class="glass">
                            <div class="glass-water" id="glass-water"></div>
                        </div>
                    </div>
                    <div class="dispense-message">${result.mix_name} Dispensed!</div>
                    <div class="dispense-details">${result.total_dispensed} supplements added</div>
                    <div class="dispensed-list">
                        ${dispensedHtml}
                    </div>
                </div>
            `;

            // Trigger water fill animation
            setTimeout(() => {
                document.getElementById('glass-water').classList.add('filling');
            }, 100);

            // Close and refresh after animation
            setTimeout(() => {
                closeModal();
                loadAllData();
            }, 3500);
        }

        // Load tracking data
        async function loadTracking() {
            if (!currentUserId) return;

            if (trackingTab === 'daily') {
                await loadDailyTracking();
            } else {
                await loadWeeklyTracking();
            }
        }

        async function loadDailyTracking() {
            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/tracking/daily?date_str=${dateStr}`);

                if (res.ok) {
                    const data = await res.json();
                    renderDailyTracking(data.supplements);
                }
            } catch (e) {
                console.error('Error loading daily tracking:', e);
            }
        }

        async function loadWeeklyTracking() {
            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/tracking/weekly?end_date_str=${dateStr}`);

                if (res.ok) {
                    const data = await res.json();
                    renderWeeklyTracking(data.supplements);
                }
            } catch (e) {
                console.error('Error loading weekly tracking:', e);
            }
        }

        function renderDailyTracking(supplements) {
            const container = document.getElementById('tracking-content');

            if (!supplements || supplements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üíä</div>
                        <div>No supplements taken on this day</div>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const supp of supplements) {
                let fillClass = '';
                if (supp.percentage >= 100) fillClass = 'danger';
                else if (supp.percentage >= 80) fillClass = 'warning';

                html += `
                    <div class="tracking-item">
                        <div class="tracking-header">
                            <span class="tracking-name">${supp.name}</span>
                            <span class="tracking-values">${supp.taken} / ${supp.max_daily} ${supp.unit}</span>
                        </div>
                        <div class="tracking-bar">
                            <div class="tracking-fill ${fillClass}" style="width: ${supp.percentage}%"></div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderWeeklyTracking(supplements) {
            const container = document.getElementById('tracking-content');

            if (!supplements || supplements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üìä</div>
                        <div>No supplements taken this week</div>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const supp of supplements) {
                const pct = Math.min(100, Math.round((supp.weekly_total / supp.weekly_max) * 100));
                let fillClass = '';
                if (pct >= 100) fillClass = 'danger';
                else if (pct >= 80) fillClass = 'warning';

                html += `
                    <div class="tracking-item">
                        <div class="tracking-header">
                            <span class="tracking-name">${supp.name}</span>
                            <span class="tracking-values">${supp.weekly_total} ${supp.unit} (${supp.days_taken} days)</span>
                        </div>
                        <div class="tracking-bar">
                            <div class="tracking-fill ${fillClass}" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function switchTrackingTab(tab) {
            trackingTab = tab;
            document.querySelectorAll('.tracking-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            loadTracking();
        }

        // Load saturation data
        async function loadSaturation() {
            if (!currentUserId) return;

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/tracking/saturation?as_of_date=${dateStr}`);

                if (res.ok) {
                    const data = await res.json();
                    renderSaturation(data.supplements);
                }
            } catch (e) {
                console.error('Error loading saturation:', e);
            }
        }

        function renderSaturation(supplements) {
            const container = document.getElementById('saturation-content');

            if (!supplements || supplements.length === 0) {
                document.getElementById('saturation-gauge').classList.add('hidden');
                return;
            }

            document.getElementById('saturation-gauge').classList.remove('hidden');

            let html = '';
            for (const supp of supplements) {
                const circumference = 2 * Math.PI * 32;
                const offset = circumference - (supp.saturation_percentage / 100) * circumference;

                let progressClass = '';
                let statusText = '';

                switch (supp.status) {
                    case 'saturated':
                        statusText = 'Fully saturated';
                        break;
                    case 'building':
                        progressClass = 'building';
                        statusText = `Building (${supp.consecutive_days}/${supp.days_to_saturate} days)`;
                        break;
                    case 'starting':
                        progressClass = 'building';
                        statusText = `Just starting (${supp.consecutive_days} days)`;
                        break;
                    case 'decaying':
                        progressClass = 'decaying';
                        statusText = `Decaying (${supp.days_since_last_intake} days since last)`;
                        break;
                    default:
                        statusText = 'Not started';
                }

                html += `
                    <div class="saturation-item">
                        <div class="saturation-ring">
                            <svg width="80" height="80">
                                <circle class="bg" cx="40" cy="40" r="32"></circle>
                                <circle class="progress ${progressClass}" cx="40" cy="40" r="32"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${offset}"></circle>
                            </svg>
                            <div class="saturation-pct">${supp.saturation_percentage}%</div>
                        </div>
                        <div class="saturation-info">
                            <div class="saturation-name">${supp.name}</div>
                            <div class="saturation-status ${supp.status}">${statusText}</div>
                            <div style="font-size: 0.8em; color: rgba(255,255,255,0.5); margin-top: 4px;">
                                Maintenance: ${supp.maintenance_dose}${supp.unit}/day
                            </div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Settings
        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('hidden');
        }

        async function loadScenario() {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            const scenario = document.getElementById('scenario').value;
            if (scenario === 'none') return;

            try {
                const res = await fetch(`/integrations/${currentUserId}/mock?scenario=${scenario}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    showStatus(`Loaded ${scenario.replace('_', ' ')} scenario`, 'success');
                    document.getElementById('scenario').value = 'none';
                }
            } catch (e) {
                showStatus('Error loading scenario', 'error');
            }
        }

        function connectOura() {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }
            window.location.href = `/integrations/${currentUserId}/oura/authorize`;
        }

        // Close settings when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('settings-panel');
            const toggle = document.querySelector('.settings-toggle');

            if (!panel.contains(e.target) && !toggle.contains(e.target)) {
                panel.classList.add('hidden');
            }
        });

        // ===== CUSTOM BLENDS =====
        let supplementCatalog = [];
        let selectedSupplements = {};
        let activeCategory = 'all';

        // Load supplement catalog
        async function loadSupplementCatalog() {
            try {
                const res = await fetch('/mixes/catalog');
                if (res.ok) {
                    const data = await res.json();
                    supplementCatalog = data.supplements;
                }
            } catch (e) {
                console.error('Error loading supplement catalog:', e);
            }
        }

        // Load custom blends
        async function loadCustomBlends() {
            if (!currentUserId) return;

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}`);
                if (res.ok) {
                    customBlends = await res.json();
                    renderCustomBlends();
                }
            } catch (e) {
                console.error('Error loading custom blends:', e);
            }
        }

        // Render custom blends list
        function renderCustomBlends() {
            const container = document.getElementById('custom-blends-list');

            if (!customBlends || customBlends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üß™</div>
                        <div>No custom blends yet</div>
                        <div style="font-size: 0.8em; color: rgba(255,255,255,0.4); margin-top: 4px;">
                            Create your own supplement combinations
                        </div>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const blend of customBlends) {
                html += `
                    <div class="custom-blend-card" onclick="selectCustomBlend('${blend.id}')">
                        <div class="custom-blend-info">
                            <div class="custom-blend-icon">${blend.icon}</div>
                            <div>
                                <div class="custom-blend-name">${blend.name}</div>
                                <div class="custom-blend-count">${blend.components.length} supplements</div>
                            </div>
                        </div>
                        <div class="custom-blend-actions">
                            <button class="btn-delete-blend" onclick="event.stopPropagation(); deleteCustomBlend('${blend.id}')" title="Delete blend">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // Open blend builder
        async function openBlendBuilder() {
            if (supplementCatalog.length === 0) {
                await loadSupplementCatalog();
            }

            selectedSupplements = {};
            document.getElementById('blend-name').value = '';
            document.getElementById('blend-icon').value = 'üß™';

            renderSupplementCategories();
            renderSupplementGrid();
            updateSelectedSupplementsUI();

            document.getElementById('blend-builder-modal').classList.remove('hidden');
        }

        // Close blend builder
        function closeBlendBuilder() {
            document.getElementById('blend-builder-modal').classList.add('hidden');
        }

        // Render supplement categories
        function renderSupplementCategories() {
            const categories = ['all', ...new Set(supplementCatalog.map(s => s.category))];
            const categoryLabels = {
                'all': 'All',
                'vitamins': 'Vitamins',
                'minerals': 'Minerals',
                'amino_acids': 'Amino Acids',
                'performance': 'Performance',
                'adaptogens': 'Adaptogens',
                'nootropics': 'Nootropics',
                'antioxidants': 'Antioxidants',
                'sleep': 'Sleep',
                'fatty_acids': 'Fatty Acids',
                'herbals': 'Herbals'
            };

            const container = document.getElementById('supplement-categories');
            let html = '';
            for (const cat of categories) {
                const label = categoryLabels[cat] || cat;
                const active = cat === activeCategory ? 'active' : '';
                html += `<button class="category-btn ${active}" onclick="filterByCategory('${cat}')">${label}</button>`;
            }
            container.innerHTML = html;
        }

        // Filter by category
        function filterByCategory(category) {
            activeCategory = category;
            renderSupplementCategories();
            renderSupplementGrid();
        }

        // Render supplement grid
        function renderSupplementGrid() {
            const container = document.getElementById('supplement-grid');
            let filtered = supplementCatalog;

            if (activeCategory !== 'all') {
                filtered = supplementCatalog.filter(s => s.category === activeCategory);
            }

            let html = '';
            for (const supp of filtered) {
                const selected = selectedSupplements[supp.id] ? 'selected' : '';
                const benefitsHtml = supp.benefits.slice(0, 3).map(b => `<span class="benefit-tag">${b}</span>`).join('');

                const pubmedHtml = supp.pubmed_studies.length > 0
                    ? `<div class="supplement-card-links">
                         ${supp.pubmed_studies.slice(0, 2).map(s => `<a href="${s.url}" target="_blank" class="pubmed-link" onclick="event.stopPropagation()">üìÑ ${s.title}</a>`).join('')}
                       </div>`
                    : '';

                html += `
                    <div class="supplement-card ${selected}" onclick="toggleSupplement('${supp.id}')">
                        <div class="supplement-card-header">
                            <div>
                                <div class="supplement-card-name">${supp.name}</div>
                                <div class="supplement-card-dose">${supp.standard_dose} ${supp.unit}</div>
                            </div>
                            <button style="padding: 4px 8px; font-size: 0.7em;" onclick="event.stopPropagation(); showSupplementInfo('${supp.id}')">‚ÑπÔ∏è</button>
                        </div>
                        <div class="supplement-card-desc">${supp.description}</div>
                        <div class="supplement-card-benefits">${benefitsHtml}</div>
                        ${pubmedHtml}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // Toggle supplement selection
        function toggleSupplement(suppId) {
            if (selectedSupplements[suppId]) {
                delete selectedSupplements[suppId];
            } else {
                const supp = supplementCatalog.find(s => s.id === suppId);
                if (supp) {
                    selectedSupplements[suppId] = {
                        supplement_id: suppId,
                        dose_multiplier: 1.0,
                        dose: supp.standard_dose,
                        name: supp.name,
                        standard_dose: supp.standard_dose,
                        max_daily_dose: supp.max_daily_dose,
                        unit: supp.unit
                    };
                }
            }
            renderSupplementGrid();
            updateSelectedSupplementsUI();
        }

        // Update selected supplements UI
        function updateSelectedSupplementsUI() {
            const container = document.getElementById('selected-supplements');
            const list = document.getElementById('selected-supplements-list');
            const keys = Object.keys(selectedSupplements);

            if (keys.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            let html = '';
            for (const suppId of keys) {
                const s = selectedSupplements[suppId];
                const currentDose = s.dose || s.standard_dose;
                const maxDose = s.max_daily_dose;
                html += `
                    <div class="selected-supp-item">
                        <div>
                            <span class="selected-supp-name">${s.name}</span>
                            <div class="dose-range">Range: 0 - ${maxDose} ${s.unit}</div>
                        </div>
                        <div class="dose-controls">
                            <input type="number" class="dose-input" value="${currentDose}"
                                step="${s.unit === 'g' ? '0.5' : (s.unit === 'IU' ? '500' : '25')}"
                                min="0" max="${maxDose}"
                                onchange="updateDose('${suppId}', this.value)">
                            <span class="dose-unit">${s.unit}</span>
                            <button class="btn-remove-supp" onclick="toggleSupplement('${suppId}')">√ó</button>
                        </div>
                    </div>
                `;
            }
            list.innerHTML = html;
        }

        // Update dose (actual value)
        function updateDose(suppId, value) {
            if (selectedSupplements[suppId]) {
                const dose = parseFloat(value) || 0;
                const s = selectedSupplements[suppId];
                // Clamp to max
                selectedSupplements[suppId].dose = Math.min(dose, s.max_daily_dose);
                // Calculate multiplier for backend
                selectedSupplements[suppId].dose_multiplier = selectedSupplements[suppId].dose / s.standard_dose;
            }
        }

        // Save custom blend
        async function saveCustomBlend() {
            const name = document.getElementById('blend-name').value.trim();
            const icon = document.getElementById('blend-icon').value.trim() || 'üß™';

            if (!name) {
                showStatus('Please enter a blend name', 'error');
                return;
            }

            const components = Object.values(selectedSupplements).map(s => ({
                supplement_id: s.supplement_id,
                dose_multiplier: s.dose_multiplier
            }));

            if (components.length === 0) {
                showStatus('Please select at least one supplement', 'error');
                return;
            }

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, icon, components })
                });

                if (res.ok) {
                    showStatus('Custom blend created!', 'success');
                    closeBlendBuilder();
                    loadCustomBlends();
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error creating blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Delete custom blend
        async function deleteCustomBlend(blendId) {
            if (!confirm('Delete this custom blend?')) return;

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}/${blendId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    showStatus('Blend deleted', 'success');
                    loadCustomBlends();
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Select custom blend (show dispense modal)
        async function selectCustomBlend(blendId) {
            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/blends/${currentUserId}/${blendId}/preview?date_override=${dateStr}`);

                if (res.ok) {
                    const data = await res.json();
                    currentMixData = {
                        mix_id: `custom/${blendId}`,
                        mix_name: data.blend_name,
                        mix_icon: data.blend_icon,
                        mix_description: 'Your custom blend',
                        supplements: data.supplements,
                        skipped: data.skipped,
                        warnings: data.warnings,
                        interaction_warnings: data.interaction_warnings,
                        is_custom: true,
                        custom_blend_id: blendId
                    };
                    showDispenseModal(currentMixData);
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Show supplement info modal
        function showSupplementInfo(suppId) {
            const supp = supplementCatalog.find(s => s.id === suppId);
            if (!supp) return;

            const benefitsHtml = supp.benefits.map(b => `<span class="supp-info-benefit">${b}</span>`).join('');

            const studiesHtml = supp.pubmed_studies.length > 0
                ? supp.pubmed_studies.map(s => `
                    <a href="${s.url}" target="_blank" class="study-link">
                        <span class="study-title">${s.title}</span>
                        <span class="study-pmid">PMID: ${s.pmid}</span>
                    </a>
                  `).join('')
                : '<div style="color: rgba(255,255,255,0.5); font-size: 0.85em;">No studies linked yet</div>';

            const content = document.getElementById('supp-info-content');
            content.innerHTML = `
                <div class="supp-info-header">
                    <div class="supp-info-name">${supp.name}</div>
                    <div class="supp-info-dose">Standard dose: ${supp.standard_dose} ${supp.unit} (max: ${supp.max_daily_dose} ${supp.unit}/day)</div>
                </div>

                <div class="supp-info-desc">${supp.description}</div>

                <div class="supp-info-benefits">
                    <div class="supp-info-benefits-title">Key Benefits</div>
                    <div class="supp-info-benefits-list">${benefitsHtml}</div>
                </div>

                <div class="supp-info-studies">
                    <div class="supp-info-studies-title">
                        <span>üìö</span> PubMed Studies
                    </div>
                    ${studiesHtml}
                </div>

                <div class="modal-actions" style="margin-top: 16px;">
                    <button class="btn-cancel" onclick="closeSuppInfo()">Close</button>
                    <button class="btn-dispense" onclick="closeSuppInfo(); toggleSupplement('${suppId}')">
                        ${selectedSupplements[suppId] ? 'Remove from Blend' : 'Add to Blend'}
                    </button>
                </div>
            `;

            document.getElementById('supp-info-modal').classList.remove('hidden');
        }

        // Close supplement info modal
        function closeSuppInfo() {
            document.getElementById('supp-info-modal').classList.add('hidden');
        }

        // Handle modal backdrop clicks
        document.getElementById('blend-builder-modal').addEventListener('click', (e) => {
            if (e.target.id === 'blend-builder-modal') closeBlendBuilder();
        });

        document.getElementById('supp-info-modal').addEventListener('click', (e) => {
            if (e.target.id === 'supp-info-modal') closeSuppInfo();
        });

        // Override dispense for custom blends
        const originalDispense = dispense;
        dispense = async function() {
            if (currentMixData && currentMixData.is_custom) {
                await dispenseCustomBlend();
            } else {
                await originalDispense();
            }
        };

        async function dispenseCustomBlend() {
            if (!currentMixData || !currentUserId || isDispensing) return;

            isDispensing = true;
            const btn = document.getElementById('dispense-btn');
            btn.classList.add('dispensing');
            btn.textContent = 'Dispensing...';

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/blends/${currentUserId}/${currentMixData.custom_blend_id}/dispense?time_override=${currentTime}&date_override=${dateStr}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    const result = await res.json();
                    result.mix_name = currentMixData.mix_name;
                    showDispenseAnimation(result);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error dispensing', 'error');
                    btn.classList.remove('dispensing');
                    btn.textContent = 'Dispense Now';
                    isDispensing = false;
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
                btn.classList.remove('dispensing');
                btn.textContent = 'Dispense Now';
                isDispensing = false;
            }
        }

        // Update loadAllData to include custom blends
        const originalLoadAllData = loadAllData;
        loadAllData = function() {
            originalLoadAllData();
            loadCustomBlends();
        };

        // ===== AI BLEND ASSISTANT =====
        let aiSuggestions = [];

        async function getAIBlendSuggestion() {
            const input = document.getElementById('ai-blend-input').value.trim();
            if (!input) {
                showStatus('Please describe what you want from your blend', 'error');
                return;
            }

            const suggestionsDiv = document.getElementById('ai-suggestions');
            const listDiv = document.getElementById('ai-suggestions-list');

            // Show loading state
            suggestionsDiv.classList.add('visible');
            listDiv.innerHTML = '<div class="ai-loading">Analyzing your request</div>';

            try {
                const res = await fetch('/mixes/suggest-blend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_request: input,
                        user_id: currentUserId
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    aiSuggestions = data.supplements || [];
                    window.lastAIResponse = data;

                    // Auto-fill blend name and icon if empty
                    const nameInput = document.getElementById('blend-name');
                    const iconInput = document.getElementById('blend-icon');
                    if (!nameInput.value && data.blend_name) {
                        nameInput.value = data.blend_name;
                    }
                    if (data.blend_icon) {
                        iconInput.value = data.blend_icon;
                    }

                    // Render suggestions
                    renderAISuggestions(data);
                } else {
                    const err = await res.json();
                    listDiv.innerHTML = `<div style="color: #ff6b6b; padding: 10px;">${err.detail || 'Error getting suggestions'}</div>`;
                }
            } catch (e) {
                listDiv.innerHTML = `<div style="color: #ff6b6b; padding: 10px;">Error: ${e.message}</div>`;
            }
        }

        function renderAISuggestions(data) {
            const listDiv = document.getElementById('ai-suggestions-list');

            if (!data.supplements || data.supplements.length === 0) {
                listDiv.innerHTML = '<div style="color: rgba(255,255,255,0.5); padding: 10px;">No supplements suggested. Try a different description.</div>';
                return;
            }

            let html = '';

            // Show summary if available
            if (data.summary) {
                html += `<div style="margin-bottom: 12px; padding: 10px; background: rgba(138, 43, 226, 0.15); border-radius: 8px; font-size: 0.85em;">
                    <strong style="color: #8a2be2;">AI Says:</strong> ${data.summary}
                    ${data.timing ? `<br><span style="color: rgba(255,255,255,0.6);">Best taken: ${data.timing}</span>` : ''}
                </div>`;
            }

            for (const supp of data.supplements) {
                const catalogSupp = supplementCatalog.find(s => s.id === supp.supplement_id);
                if (!catalogSupp) continue;

                const isSelected = selectedSupplements[supp.supplement_id];
                html += `
                    <div class="ai-suggestion-item">
                        <div>
                            <div class="ai-suggestion-name">${catalogSupp.name}</div>
                            <div class="ai-suggestion-reason">${supp.reason || ''}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="ai-suggestion-dose">${supp.dose} ${catalogSupp.unit}</span>
                            <button style="padding: 4px 10px; font-size: 0.8em; ${isSelected ? 'background: rgba(0,255,136,0.3);' : ''}"
                                onclick="addAISuggestion('${supp.supplement_id}', ${supp.dose})">
                                ${isSelected ? '‚úì' : '+ Add'}
                            </button>
                        </div>
                    </div>
                `;
            }

            listDiv.innerHTML = html;
        }

        function addAISuggestion(suppId, dose) {
            const supp = supplementCatalog.find(s => s.id === suppId);
            if (!supp) return;

            if (selectedSupplements[suppId]) {
                // Already selected, just update the dose
                selectedSupplements[suppId].dose = dose;
                selectedSupplements[suppId].dose_multiplier = dose / supp.standard_dose;
            } else {
                // Add new
                selectedSupplements[suppId] = {
                    supplement_id: suppId,
                    dose_multiplier: dose / supp.standard_dose,
                    dose: dose,
                    name: supp.name,
                    standard_dose: supp.standard_dose,
                    max_daily_dose: supp.max_daily_dose,
                    unit: supp.unit
                };
            }

            renderSupplementGrid();
            updateSelectedSupplementsUI();
            // Re-render AI suggestions to update button states
            if (window.lastAIResponse) {
                renderAISuggestions(window.lastAIResponse);
            }
        }

        function addAllSuggestions() {
            for (const supp of aiSuggestions) {
                addAISuggestion(supp.supplement_id, supp.dose);
            }
            showStatus('All suggestions added!', 'success');
        }

        // Load supplement catalog on page load
        loadSupplementCatalog();
    </script>
</body>
</html>
