<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dose - Smart Supplement Dispensing</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0A0A0A;
            min-height: 100vh;
            color: #E8E8E8;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 24px;
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 50%, #C4B5FD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .card h2 {
            margin-bottom: 16px;
            font-size: 1.1em;
            font-weight: 600;
            color: #A0A0A0;
            letter-spacing: -0.01em;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        input, select, textarea {
            padding: 14px 18px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.04);
            color: #E8E8E8;
            font-size: 0.95em;
            font-family: inherit;
            flex: 1;
            min-width: 150px;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.08);
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.35);
        }

        select {
            cursor: pointer;
        }

        select option {
            background: #1a1a1a;
            color: #E8E8E8;
        }

        button {
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: #fff;
            font-size: 0.95em;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.35);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.06);
            color: #A0A0A0;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #E8E8E8;
            box-shadow: none;
        }

        .hidden {
            display: none !important;
        }

        #status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 1000;
            max-width: 350px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        #status.success {
            background: rgba(34, 197, 94, 0.9);
            color: #fff;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.3);
        }

        #status.error {
            background: rgba(239, 68, 68, 0.9);
            color: #fff;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }

        /* Onboarding */
        .onboarding-step {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .onboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .onboard-grid input, .onboard-grid select {
            min-width: 0;
        }

        /* Date Navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .date-nav button {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.04);
            color: #A0A0A0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-nav button:hover {
            background: rgba(139, 92, 246, 0.15);
            color: #8B5CF6;
            box-shadow: none;
        }

        .date-display {
            text-align: center;
            min-width: 200px;
        }

        .date-display .day {
            font-size: 1.4em;
            font-weight: 700;
            color: #E8E8E8;
        }

        .date-display .full-date {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .date-display .today-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Time Selector */
        .time-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .time-btn {
            padding: 10px 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 24px;
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }

        .time-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .time-btn.active {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }

        /* Main Dispenser Layout */
        .dispenser-layout {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        /* AI Recommendation - Center */
        .ai-recommendation {
            grid-column: 2;
            grid-row: 1;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12) 0%, rgba(167, 139, 250, 0.08) 100%);
            border: 1px solid rgba(139, 92, 246, 0.25);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .ai-recommendation:hover {
            transform: scale(1.02);
            border-color: #8B5CF6;
            box-shadow: 0 8px 40px rgba(139, 92, 246, 0.25);
        }

        .ai-recommendation .ai-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .ai-recommendation .ai-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #A78BFA, #C4B5FD);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-recommendation .ai-subtitle {
            font-size: 0.8em;
            color: #666;
            line-height: 1.4;
        }

        .ai-recommendation.loading .ai-icon {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Daily Foundation - Below AI */
        .daily-foundation {
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(196, 181, 253, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .daily-foundation:hover {
            transform: scale(1.02);
            border-color: #A78BFA;
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.2);
        }

        .daily-foundation.taken {
            opacity: 0.4;
            cursor: default;
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .daily-foundation.taken:hover {
            transform: none;
            box-shadow: none;
            border-color: rgba(255, 255, 255, 0.05);
        }

        .daily-foundation.taken .df-name {
            color: #555;
        }

        .daily-foundation .taken-badge {
            display: none;
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.7em;
            font-weight: 600;
            margin-top: 8px;
        }

        .daily-foundation.taken .taken-badge {
            display: inline-block;
        }

        .daily-foundation .df-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .daily-foundation .df-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #A78BFA;
        }

        .daily-foundation .df-desc {
            font-size: 0.75em;
            color: #555;
            margin-top: 4px;
        }

        /* Mix Cards */
        .mix-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mix-card:hover {
            transform: translateY(-4px);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
            background: rgba(139, 92, 246, 0.05);
        }

        .mix-card .mix-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .mix-card .mix-name {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 4px;
            color: #E8E8E8;
        }

        .mix-card .mix-desc {
            font-size: 0.7em;
            color: #555;
            line-height: 1.3;
        }

        .mix-card.custom-blend-mix {
            position: relative;
        }

        .mix-card .custom-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            font-size: 0.55em;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Dispense Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(20px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: #121212;
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.08);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-icon {
            font-size: 3em;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 6px;
            color: #E8E8E8;
        }

        .modal-subtitle {
            color: #666;
            font-size: 0.9em;
        }

        .supplement-list {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 18px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .supplement-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            gap: 12px;
        }

        .supplement-item:last-child {
            border-bottom: none;
        }

        .supplement-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .supplement-name {
            font-weight: 500;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .supplement-description {
            font-size: 0.75em;
            color: #888;
            margin-top: 4px;
            line-height: 1.4;
        }

        .supplement-dose {
            color: #A78BFA;
            font-weight: 600;
            white-space: nowrap;
            padding-top: 2px;
        }

        .modal-warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.25);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 18px;
            font-size: 0.85em;
            color: #FBBF24;
        }

        .modal-skipped {
            background: rgba(100, 100, 100, 0.1);
            border: 1px solid rgba(100, 100, 100, 0.25);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 18px;
            font-size: 0.8em;
        }

        .skipped-header {
            color: #888;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .skipped-item {
            display: inline-block;
            background: rgba(255, 255, 255, 0.05);
            color: #666;
            padding: 4px 10px;
            border-radius: 20px;
            margin: 2px 4px 2px 0;
            font-size: 0.9em;
            text-decoration: line-through;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-actions button {
            flex: 1;
            padding: 16px;
            font-size: 1em;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            color: #666;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #A0A0A0;
            box-shadow: none;
        }

        .btn-dispense {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .btn-dispense.dispensing {
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
        }

        /* Dispense Animation */
        .dispense-animation {
            text-align: center;
            padding: 20px 0;
        }

        .glass-container {
            position: relative;
            width: 120px;
            height: 160px;
            margin: 0 auto 24px;
        }

        .glass {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 140px;
            border: 4px solid rgba(139, 92, 246, 0.3);
            border-radius: 0 0 24px 24px;
            border-top: none;
            overflow: hidden;
        }

        .glass-water {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.5) 0%, rgba(167, 139, 250, 0.7) 100%);
            height: 0;
            transition: height 2s ease-out;
            border-radius: 0 0 20px 20px;
        }

        .glass-water.filling {
            height: 85%;
        }

        .dropping-supplements {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .dropping-pill {
            font-size: 1.2em;
            animation: dropPill 1s ease-in forwards;
            opacity: 0;
        }

        @keyframes dropPill {
            0% { transform: translateY(-20px); opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }

        .dispense-message {
            font-size: 1.3em;
            font-weight: 700;
            background: linear-gradient(135deg, #A78BFA, #C4B5FD);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .dispense-details {
            color: #666;
            font-size: 0.9em;
        }

        .dispensed-list {
            margin-top: 18px;
            padding: 14px;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 12px;
            text-align: left;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .dispensed-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.85em;
        }

        .dispensed-item span:first-child {
            color: #A0A0A0;
        }

        .dispensed-item span:last-child {
            color: #A78BFA;
            font-weight: 500;
        }

        /* Tracking Section */
        .tracking-section {
            margin-top: 20px;
        }

        .tracking-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }

        .tracking-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            color: #555;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
        }

        .tracking-tab:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .tracking-tab.active {
            background: rgba(139, 92, 246, 0.12);
            border-color: rgba(139, 92, 246, 0.3);
            color: #A78BFA;
        }

        .tracking-content {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .tracking-item {
            margin-bottom: 18px;
        }

        .tracking-item:last-child {
            margin-bottom: 0;
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .tracking-name {
            font-weight: 500;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .tracking-values {
            font-size: 0.85em;
            color: #666;
        }

        .tracking-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .tracking-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #A78BFA);
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        .tracking-fill.warning {
            background: linear-gradient(90deg, #F59E0B, #FBBF24);
        }

        .tracking-fill.danger {
            background: linear-gradient(90deg, #EF4444, #F87171);
        }

        /* Saturation Gauge */
        .saturation-gauge {
            margin-top: 24px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .saturation-title {
            font-size: 0.9em;
            color: #A78BFA;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .saturation-item {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .saturation-ring {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .saturation-ring svg {
            transform: rotate(-90deg);
        }

        .saturation-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .saturation-ring .bg {
            stroke: rgba(255, 255, 255, 0.06);
        }

        .saturation-ring .progress {
            stroke: #8B5CF6;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-out;
        }

        .saturation-ring .progress.building {
            stroke: #F59E0B;
        }

        .saturation-ring .progress.decaying {
            stroke: #EF4444;
        }

        .saturation-pct {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.1em;
            font-weight: 700;
            color: #E8E8E8;
        }

        .saturation-info {
            flex: 1;
        }

        .saturation-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #E8E8E8;
        }

        .saturation-status {
            font-size: 0.85em;
            color: #555;
        }

        .saturation-status.saturated {
            color: #22C55E;
        }

        .saturation-status.building {
            color: #F59E0B;
        }

        .saturation-status.decaying {
            color: #EF4444;
        }

        /* User header */
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #fff;
            font-size: 1.1em;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.05em;
            color: #E8E8E8;
        }

        .btn-logout {
            padding: 10px 18px;
            font-size: 0.85em;
            background: rgba(255, 255, 255, 0.04);
            color: #666;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #A0A0A0;
            box-shadow: none;
        }

        /* Responsive */
        @media (max-width: 700px) {
            .dispenser-layout {
                grid-template-columns: repeat(2, 1fr);
            }

            .ai-recommendation {
                grid-column: 1 / span 2;
                grid-row: auto;
            }

            .daily-foundation {
                grid-column: 1 / span 2;
                grid-row: auto;
            }
        }

        @media (max-width: 400px) {
            .dispenser-layout {
                grid-template-columns: 1fr;
            }

            .ai-recommendation, .daily-foundation {
                grid-column: 1;
            }
        }

        /* Settings panel */
        .settings-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #666;
            font-size: 1.4em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .settings-toggle:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .settings-panel {
            position: fixed;
            bottom: 88px;
            right: 24px;
            background: #121212;
            border-radius: 18px;
            padding: 22px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            min-width: 280px;
            backdrop-filter: blur(20px);
        }

        .settings-panel h3 {
            margin-bottom: 18px;
            font-size: 1em;
            color: #A78BFA;
            font-weight: 600;
        }

        .setting-row {
            margin-bottom: 14px;
        }

        .setting-row label {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 6px;
        }

        .setting-row select {
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 36px;
            color: #444;
        }

        .empty-state .emoji {
            font-size: 2.5em;
            margin-bottom: 14px;
            opacity: 0.5;
        }

        /* Custom Blends Section */
        .custom-blends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .custom-blends-header h2 {
            margin: 0;
        }

        .btn-create-blend {
            padding: 10px 18px;
            font-size: 0.85em;
            border-radius: 24px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .custom-blend-card {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-blend-card:hover {
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.12);
        }

        .custom-blend-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .custom-blend-icon {
            font-size: 1.5em;
        }

        .custom-blend-name {
            font-weight: 600;
            color: #E8E8E8;
        }

        .custom-blend-count {
            font-size: 0.8em;
            color: #555;
            margin-top: 2px;
        }

        .custom-blend-actions {
            display: flex;
            gap: 8px;
        }

        .btn-delete-blend {
            width: 34px;
            height: 34px;
            padding: 0;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-delete-blend:hover {
            background: rgba(239, 68, 68, 0.2);
            box-shadow: none;
        }

        /* Blend Builder Modal */
        .blend-builder {
            max-height: 80vh;
            overflow-y: auto;
        }

        .blend-builder-header {
            display: flex;
            gap: 12px;
            margin-bottom: 22px;
        }

        .blend-builder-header input {
            flex: 1;
        }

        .icon-picker {
            width: 54px;
            text-align: center;
            font-size: 1.5em;
            cursor: pointer;
        }

        .supplement-categories {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .category-btn {
            padding: 8px 14px;
            font-size: 0.8em;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .category-btn.active {
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.12);
            color: #A78BFA;
        }

        .supplement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
            margin-bottom: 18px;
        }

        .supplement-card {
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .supplement-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .supplement-card.selected {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.1);
        }

        .supplement-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .supplement-card-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .supplement-card-dose {
            font-size: 0.8em;
            color: #A78BFA;
        }

        .supplement-card-desc {
            font-size: 0.75em;
            color: #555;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .supplement-card-benefits {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .benefit-tag {
            padding: 3px 8px;
            font-size: 0.65em;
            background: rgba(139, 92, 246, 0.12);
            color: #A78BFA;
            border-radius: 6px;
        }

        .supplement-card-links {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .pubmed-link {
            display: block;
            font-size: 0.7em;
            color: #8B5CF6;
            text-decoration: none;
            padding: 3px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pubmed-link:hover {
            color: #A78BFA;
            text-decoration: underline;
        }

        .selected-supplements {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 18px;
        }

        .selected-supplements-title {
            font-size: 0.85em;
            color: #A78BFA;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .selected-supp-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .selected-supp-item:last-child {
            border-bottom: none;
        }

        .selected-supp-name {
            font-size: 0.9em;
            color: #E8E8E8;
        }

        .selected-supp-dose {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dose-input {
            width: 75px;
            padding: 6px 10px;
            font-size: 0.85em;
            text-align: center;
        }

        .dose-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dose-unit {
            font-size: 0.75em;
            color: #555;
            min-width: 30px;
        }

        .dose-range {
            font-size: 0.65em;
            color: #444;
        }

        /* AI Blend Assistant */
        .ai-blend-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(167, 139, 250, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 22px;
        }

        .ai-blend-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .ai-blend-header .ai-icon {
            font-size: 1.5em;
        }

        .ai-blend-header h3 {
            margin: 0;
            font-size: 1em;
            color: #E8E8E8;
            font-weight: 600;
        }

        .ai-blend-header span {
            font-size: 0.8em;
            color: #555;
        }

        .ai-input-row {
            display: flex;
            gap: 10px;
        }

        .ai-input-row textarea {
            flex: 1;
            min-height: 60px;
            resize: vertical;
        }

        .ai-input-row button {
            align-self: flex-end;
            white-space: nowrap;
        }

        .ai-suggestions {
            margin-top: 14px;
            padding: 14px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: none;
        }

        .ai-suggestions.visible {
            display: block;
        }

        .ai-suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ai-suggestions-title {
            font-size: 0.9em;
            color: #A78BFA;
            font-weight: 500;
        }

        .ai-suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .ai-suggestion-item:last-child {
            margin-bottom: 0;
        }

        .ai-suggestion-name {
            font-size: 0.9em;
            color: #E8E8E8;
        }

        .ai-suggestion-dose {
            font-size: 0.8em;
            color: #A78BFA;
            font-weight: 500;
        }

        .ai-suggestion-reason {
            font-size: 0.75em;
            color: #555;
            margin-top: 3px;
        }

        .ai-loading {
            text-align: center;
            padding: 24px;
            color: #555;
        }

        .ai-loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .btn-add-all {
            padding: 8px 14px;
            font-size: 0.8em;
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
            border: 1px solid rgba(34, 197, 94, 0.25);
        }

        .btn-add-all:hover {
            background: rgba(34, 197, 94, 0.25);
            box-shadow: none;
        }

        .btn-remove-supp {
            width: 26px;
            height: 26px;
            padding: 0;
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
            border-radius: 50%;
            font-size: 0.8em;
        }

        .btn-remove-supp:hover {
            background: rgba(239, 68, 68, 0.25);
            box-shadow: none;
        }

        /* Supplement Info Modal */
        .supp-info-modal {
            max-width: 450px;
        }

        .supp-info-header {
            text-align: center;
            margin-bottom: 22px;
        }

        .supp-info-name {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 6px;
            color: #E8E8E8;
        }

        .supp-info-dose {
            color: #A78BFA;
            font-size: 0.9em;
        }

        .supp-info-desc {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 18px;
            font-size: 0.9em;
            line-height: 1.6;
            color: #A0A0A0;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .supp-info-benefits {
            margin-bottom: 18px;
        }

        .supp-info-benefits-title {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .supp-info-benefits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .supp-info-benefit {
            padding: 5px 12px;
            background: rgba(139, 92, 246, 0.12);
            color: #A78BFA;
            border-radius: 14px;
            font-size: 0.8em;
        }

        .supp-info-studies {
            background: rgba(139, 92, 246, 0.06);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 14px;
            padding: 16px;
        }

        .supp-info-studies-title {
            font-size: 0.85em;
            color: #A78BFA;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .study-link {
            display: block;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .study-link:last-child {
            margin-bottom: 0;
        }

        .study-link:hover {
            background: rgba(139, 92, 246, 0.15);
        }

        .study-title {
            color: #E8E8E8;
            font-size: 0.85em;
            display: block;
            margin-bottom: 3px;
        }

        .study-pmid {
            color: #555;
            font-size: 0.75em;
        }

        /* Intelligence notes styling */
        .intelligence-note {
            background: rgba(139, 92, 246, 0.08);
            border-left: 3px solid #8B5CF6;
            padding: 10px 14px;
            margin-top: 10px;
            border-radius: 0 10px 10px 0;
            font-size: 0.8em;
            color: #A78BFA;
        }

        /* Sign in link */
        a {
            color: #8B5CF6;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        a:hover {
            color: #A78BFA;
        }

        /* Footer */
        .footer {
            margin-top: 60px;
            padding: 30px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 12px;
        }

        .footer-links a {
            color: #666;
            text-decoration: none;
            font-size: 0.85em;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #A78BFA;
        }

        .footer-copyright {
            color: #444;
            font-size: 0.75em;
        }
    </style>
</head>
<body>
    <div id="status" class="hidden"></div>

    <div class="container">
        <h1>Dose</h1>

        <!-- Not logged in -->
        <div id="no-user">
            <div class="card onboarding-step" id="onboarding-step-1">
                <h2>Create Your Profile</h2>
                <p style="margin-bottom: 18px; color: #555; font-size: 0.9em;">
                    We need a few details to personalize your supplement doses.
                </p>

                <div class="form-row">
                    <input type="text" id="user-name" placeholder="Your name" required>
                    <input type="email" id="user-email" placeholder="Email address" required>
                </div>

                <div class="onboard-grid">
                    <input type="number" id="onboard-age" placeholder="Age" min="18" max="100" required>
                    <select id="onboard-sex" required>
                        <option value="">Sex</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="onboard-height-feet" placeholder="Height (ft)" min="3" max="8" style="flex: 1;" required>
                        <input type="number" id="onboard-height-inches" placeholder="in" min="0" max="11" style="flex: 1;" required>
                    </div>
                    <input type="number" id="onboard-weight" placeholder="Weight (lbs)" step="0.1" required>
                </div>

                <h3 style="margin-top: 28px; margin-bottom: 14px; font-size: 1em; color: #E8E8E8; font-weight: 600;">
                    Lifestyle Quiz <span style="font-weight: normal; color: #555;">(helps personalize your supplements)</span>
                </h3>

                <div class="onboard-grid">
                    <select id="onboard-region">
                        <option value="">Where do you live?</option>
                        <option value="northern">Northern US/Canada (Seattle, Boston, Chicago)</option>
                        <option value="central">Central US (NYC, Denver, SF)</option>
                        <option value="southern">Southern US (LA, Phoenix, Atlanta)</option>
                        <option value="gulf">Gulf/Florida (Miami, Houston)</option>
                    </select>
                    <select id="onboard-activity">
                        <option value="">Activity Level</option>
                        <option value="sedentary">Sedentary (desk job, minimal exercise)</option>
                        <option value="light">Lightly Active (light exercise 1-2x/week)</option>
                        <option value="moderate">Moderately Active (exercise 3-4x/week)</option>
                        <option value="active">Very Active (exercise 5-6x/week)</option>
                        <option value="athlete">Athlete (intense training daily)</option>
                    </select>
                    <select id="onboard-work">
                        <option value="">Work Environment</option>
                        <option value="office">Office/Indoor</option>
                        <option value="remote">Remote/Work from Home</option>
                        <option value="outdoor">Outdoor Work</option>
                        <option value="shift">Shift Work (irregular hours)</option>
                    </select>
                    <select id="onboard-diet">
                        <option value="">Diet Type</option>
                        <option value="omnivore">Omnivore (eat everything)</option>
                        <option value="vegetarian">Vegetarian (no meat)</option>
                        <option value="vegan">Vegan (no animal products)</option>
                    </select>
                </div>

                <div class="onboard-grid" style="margin-top: 12px;">
                    <select id="onboard-chronotype">
                        <option value="">Sleep Pattern</option>
                        <option value="early_bird">Early Bird (prefer early mornings)</option>
                        <option value="night_owl">Night Owl (prefer late nights)</option>
                        <option value="neutral">Neutral (flexible)</option>
                    </select>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="time" id="onboard-bedtime" style="flex: 1;" title="Typical bedtime">
                        <span style="color: #444;">to</span>
                        <input type="time" id="onboard-waketime" style="flex: 1;" title="Typical wake time">
                    </div>
                </div>

                <button onclick="createAccount()" style="width: 100%; margin-top: 20px;">
                    Create Account
                </button>

                <div style="text-align: center; margin-top: 18px;">
                    <span style="color: #444;">Already have an account?</span>
                    <a href="#" onclick="toggleSignIn(event)" style="margin-left: 8px;">Sign in</a>
                </div>

                <div id="signin-form" class="hidden" style="margin-top: 18px; padding-top: 18px; border-top: 1px solid rgba(255,255,255,0.06);">
                    <div class="form-row">
                        <input type="email" id="signin-email" placeholder="Email address">
                        <button onclick="signIn()">Sign In</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logged in -->
        <div id="has-user" class="hidden">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <span class="user-name" id="display-name">User</span>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>

            <!-- Date Navigation -->
            <div class="date-nav">
                <button onclick="changeDate(-1)" title="Previous day">&#8592;</button>
                <div class="date-display">
                    <div class="day" id="date-day">Today</div>
                    <div class="full-date" id="date-full">January 15, 2026</div>
                </div>
                <button onclick="changeDate(1)" title="Next day">&#8594;</button>
            </div>

            <!-- Time Selector -->
            <div class="time-selector">
                <button class="time-btn" onclick="setTime(7)" id="time-btn-morning">Morning</button>
                <button class="time-btn active" onclick="setTime(14)" id="time-btn-afternoon">Afternoon</button>
                <button class="time-btn" onclick="setTime(21)" id="time-btn-evening">Evening</button>
            </div>

            <!-- Dispenser Card -->
            <div class="card">
                <h2>What do you need today?</h2>

                <div class="dispenser-layout" id="dispenser-layout">
                    <!-- AI Recommendation -->
                    <div class="ai-recommendation" onclick="getAIRecommendation()" id="ai-recommendation">
                        <div class="ai-icon">&#x2728;</div>
                        <div class="ai-title">Smart Recommendation</div>
                        <div class="ai-subtitle">Personalized based on your health data</div>
                    </div>

                    <!-- Daily Foundation - Always visible below AI -->
                    <div class="daily-foundation" onclick="selectDailyFoundation()" id="daily-foundation">
                        <div class="df-icon">&#x1F48E;</div>
                        <div class="df-name">Daily Foundation</div>
                        <div class="df-desc">Essential daily nutrients</div>
                        <div class="taken-badge">&#x2713; Taken Today</div>
                    </div>

                    <!-- Mix cards populated by JS -->
                </div>
            </div>

            <!-- Tracking Card -->
            <div class="card" id="tracking-card">
                <h2>Your Supplement Intake</h2>

                <div class="tracking-tabs">
                    <button class="tracking-tab active" onclick="switchTrackingTab('daily')" id="tab-daily">Today</button>
                    <button class="tracking-tab" onclick="switchTrackingTab('weekly')" id="tab-weekly">This Week</button>
                </div>

                <div class="tracking-content" id="tracking-content">
                    <div class="empty-state">
                        <div class="emoji">&#x1F48A;</div>
                        <div>No supplements taken yet</div>
                    </div>
                </div>

                <!-- Saturation Gauge -->
                <div class="saturation-gauge" id="saturation-gauge">
                    <div class="saturation-title">
                        <span>&#x26A1;</span> Saturation Tracking
                    </div>
                    <div id="saturation-content">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Custom Blends Card -->
            <div class="card" id="custom-blends-card">
                <div class="custom-blends-header">
                    <h2>Your Custom Blends</h2>
                    <button class="btn-create-blend" onclick="openBlendBuilder()">+ Create Blend</button>
                </div>
                <div id="custom-blends-list">
                    <div class="empty-state">
                        <div class="emoji">&#x1F9EA;</div>
                        <div>No custom blends yet</div>
                        <div style="font-size: 0.8em; color: #333; margin-top: 6px;">
                            Create your own supplement combinations
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blend Builder Modal -->
    <div class="modal-overlay hidden" id="blend-builder-modal">
        <div class="modal-content blend-builder" id="blend-builder-content">
            <div class="modal-header" style="text-align: left; margin-bottom: 18px;">
                <div class="modal-title">Create Custom Blend</div>
                <div class="modal-subtitle">Select supplements and customize doses</div>
            </div>

            <div class="blend-builder-header">
                <input type="text" id="blend-name" placeholder="Blend name (e.g. My Morning Stack)">
                <input type="text" id="blend-icon" class="icon-picker" value="&#x1F9EA;" maxlength="2" onclick="this.select()">
            </div>

            <!-- AI Assistant Section -->
            <div class="ai-blend-section">
                <div class="ai-blend-header">
                    <span class="ai-icon">&#x2728;</span>
                    <div>
                        <h3>AI Blend Assistant</h3>
                        <span>Describe what you want and I'll suggest supplements</span>
                    </div>
                </div>
                <div class="ai-input-row">
                    <textarea id="ai-blend-input" placeholder="Example: I want better sleep and less stress, but I also need energy in the morning without feeling jittery..."></textarea>
                    <button onclick="getAIBlendSuggestion()">Suggest</button>
                </div>
                <div class="ai-suggestions" id="ai-suggestions">
                    <div class="ai-suggestions-header">
                        <span class="ai-suggestions-title">Suggested Supplements</span>
                        <button class="btn-add-all" onclick="addAllSuggestions()">+ Add All</button>
                    </div>
                    <div id="ai-suggestions-list"></div>
                </div>
            </div>

            <div class="supplement-categories" id="supplement-categories">
                <!-- Populated by JS -->
            </div>

            <div class="supplement-grid" id="supplement-grid">
                <!-- Populated by JS -->
            </div>

            <div class="selected-supplements" id="selected-supplements" style="display: none;">
                <div class="selected-supplements-title">Selected Supplements</div>
                <div id="selected-supplements-list"></div>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeBlendBuilder()">Cancel</button>
                <button class="btn-dispense" onclick="saveCustomBlend()" id="save-blend-btn">
                    Save Blend
                </button>
            </div>
        </div>
    </div>

    <!-- Supplement Info Modal -->
    <div class="modal-overlay hidden" id="supp-info-modal">
        <div class="modal-content supp-info-modal" id="supp-info-content">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Dispense Modal -->
    <div class="modal-overlay hidden" id="dispense-modal">
        <div class="modal-content" id="modal-content">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Settings Toggle -->
    <button class="settings-toggle" onclick="toggleSettings()" title="Settings">
        <span>&#x2699;</span>
    </button>

    <!-- Settings Panel -->
    <div class="settings-panel hidden" id="settings-panel">
        <h3>Settings</h3>
        <div class="setting-row">
            <label>Simulate Health Data</label>
            <select id="scenario" onchange="loadScenario()">
                <option value="none">-- Select scenario --</option>
                <option value="average">Average Day</option>
                <option value="poor_sleep">Poor Sleep</option>
                <option value="high_strain">High Strain</option>
                <option value="stressed">Stressed</option>
                <option value="recovering">Recovering Well</option>
            </select>
        </div>
        <div class="setting-row">
            <label>Connect Wearable</label>
            <button onclick="connectOura()" class="btn-secondary" style="width: 100%; margin-top: 6px;">
                Connect Oura Ring
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-links">
            <a href="/privacy">Privacy Policy</a>
            <a href="/terms">Terms of Service</a>
        </div>
        <div class="footer-copyright">
            &copy; 2026 Dose. All rights reserved.
        </div>
    </footer>

    <script>
        // State
        let currentUserId = localStorage.getItem('userId');
        let currentDate = new Date();
        let currentTime = 14;
        let availableMixes = [];
        let customBlends = [];
        let currentMixData = null;
        let isDispensing = false;
        let trackingTab = 'daily';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (currentUserId) {
                loadUserAndShow();
            }
            updateDateDisplay();
            updateTimeButtons();
        });

        // Status messages
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 4000);
        }

        // Toggle sign in form
        function toggleSignIn(e) {
            e.preventDefault();
            document.getElementById('signin-form').classList.toggle('hidden');
        }

        // Create account
        async function createAccount() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const age = parseInt(document.getElementById('onboard-age').value);
            const sex = document.getElementById('onboard-sex').value;
            const height_feet = parseInt(document.getElementById('onboard-height-feet').value);
            const height_inches = parseInt(document.getElementById('onboard-height-inches').value);
            const weight_lbs = parseFloat(document.getElementById('onboard-weight').value);

            // Lifestyle quiz fields (optional)
            const region = document.getElementById('onboard-region').value || null;
            const activity_level = document.getElementById('onboard-activity').value || null;
            const work_environment = document.getElementById('onboard-work').value || null;
            const diet_type = document.getElementById('onboard-diet').value || null;
            const chronotype = document.getElementById('onboard-chronotype').value || null;
            const bedtime = document.getElementById('onboard-bedtime').value || null;
            const wake_time = document.getElementById('onboard-waketime').value || null;

            if (!name || !email || !age || !sex || isNaN(height_feet) || isNaN(height_inches) || !weight_lbs) {
                showStatus('Please fill in all required fields', 'error');
                return;
            }

            try {
                const res = await fetch('/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name, email, age, sex, height_feet, height_inches, weight_lbs,
                        region, activity_level, work_environment, diet_type,
                        chronotype, bedtime, wake_time
                    })
                });

                if (res.ok) {
                    const user = await res.json();
                    currentUserId = user.id;
                    localStorage.setItem('userId', user.id);
                    showLoggedIn(user);
                    loadAllData();
                    showStatus('Account created!', 'success');
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error creating account', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Sign in
        async function signIn() {
            const email = document.getElementById('signin-email').value.trim();
            if (!email) {
                showStatus('Please enter your email', 'error');
                return;
            }

            try {
                const res = await fetch('/users/signin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (res.ok) {
                    const user = await res.json();
                    currentUserId = user.id;
                    localStorage.setItem('userId', user.id);
                    showLoggedIn(user);
                    loadAllData();
                    showStatus('Welcome back!', 'success');
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error signing in', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Load user and show UI
        async function loadUserAndShow() {
            try {
                const res = await fetch(`/users/${currentUserId}`);
                if (res.ok) {
                    const user = await res.json();
                    showLoggedIn(user);
                    loadAllData();
                } else {
                    localStorage.removeItem('userId');
                    currentUserId = null;
                }
            } catch (e) {
                console.error('Error loading user:', e);
            }
        }

        // Load all data
        function loadAllData() {
            loadMixes();
            loadTracking();
            loadSaturation();
            checkDailyFoundationTaken();
        }

        // Check if Daily Foundation was already taken today
        async function checkDailyFoundationTaken() {
            if (!currentUserId) return;

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/tracking/daily?date_str=${dateStr}`);

                if (res.ok) {
                    const data = await res.json();
                    // Check if any Daily Foundation supplements were taken
                    // Daily Foundation contains: vitamin_d3, vitamin_k2, omega_3, magnesium_glycinate
                    const dfSupplements = ['vitamin_d3', 'vitamin_k2', 'omega_3'];
                    const takenSupps = data.supplements.map(s => s.supplement_id);

                    // Consider it taken if at least 2 of the foundation supplements were taken
                    const foundationTaken = dfSupplements.filter(s => takenSupps.includes(s)).length >= 2;

                    const dfElement = document.getElementById('daily-foundation');
                    if (foundationTaken) {
                        dfElement.classList.add('taken');
                    } else {
                        dfElement.classList.remove('taken');
                    }
                }
            } catch (e) {
                console.error('Error checking daily foundation:', e);
            }
        }

        // Select Daily Foundation (with taken check)
        function selectDailyFoundation() {
            const dfElement = document.getElementById('daily-foundation');
            if (dfElement.classList.contains('taken')) {
                showStatus('Daily Foundation already taken today', 'success');
                return;
            }
            selectMix('daily_foundation');
        }

        // Show logged in state
        function showLoggedIn(user) {
            document.getElementById('no-user').classList.add('hidden');
            document.getElementById('has-user').classList.remove('hidden');
            document.getElementById('display-name').textContent = user.name;
            document.getElementById('user-avatar').textContent = user.name.charAt(0).toUpperCase();
        }

        // Logout
        function logout() {
            localStorage.removeItem('userId');
            currentUserId = null;
            document.getElementById('has-user').classList.add('hidden');
            document.getElementById('no-user').classList.remove('hidden');
        }

        // Date functions
        function getDateString() {
            return currentDate.toISOString().split('T')[0];
        }

        function updateDateDisplay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const current = new Date(currentDate);
            current.setHours(0, 0, 0, 0);

            const isToday = today.getTime() === current.getTime();
            const dayEl = document.getElementById('date-day');
            const fullEl = document.getElementById('date-full');

            const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
            fullEl.textContent = currentDate.toLocaleDateString('en-US', options);

            if (isToday) {
                dayEl.innerHTML = 'Today<span class="today-badge">Now</span>';
            } else {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                dayEl.textContent = days[currentDate.getDay()];
            }
        }

        function changeDate(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            updateDateDisplay();
            loadAllData();
        }

        // Time functions
        function setTime(hour) {
            currentTime = hour;
            updateTimeButtons();
            loadMixes();
        }

        function updateTimeButtons() {
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            if (currentTime < 12) {
                document.getElementById('time-btn-morning').classList.add('active');
            } else if (currentTime < 18) {
                document.getElementById('time-btn-afternoon').classList.add('active');
            } else {
                document.getElementById('time-btn-evening').classList.add('active');
            }
        }

        // Load mixes
        async function loadMixes() {
            try {
                const res = await fetch('/mixes/all');
                if (res.ok) {
                    availableMixes = await res.json();
                    renderMixCards();
                }
            } catch (e) {
                console.error('Error loading mixes:', e);
            }
        }

        // Render mix cards
        function renderMixCards() {
            const layout = document.getElementById('dispenser-layout');
            // Keep AI recommendation and Daily Foundation
            const aiRec = document.getElementById('ai-recommendation');
            const dailyFoundation = document.getElementById('daily-foundation');

            // Remove existing mix cards
            layout.querySelectorAll('.mix-card').forEach(card => card.remove());

            // Filter mixes by time of day and exclude daily_foundation
            const currentPeriod = currentTime < 12 ? 'morning' : currentTime < 18 ? 'afternoon' : 'evening';
            const filteredMixes = availableMixes.filter(mix => {
                if (mix.id === 'daily_foundation') return false;
                if (!mix.time_windows || mix.time_windows.length === 0) return true;
                return mix.time_windows.includes(currentPeriod);
            });

            // Add mix cards
            filteredMixes.forEach(mix => {
                const card = document.createElement('div');
                card.className = 'mix-card';
                card.onclick = () => selectMix(mix.id);
                card.innerHTML = `
                    <div class="mix-icon">${mix.icon || '&#x1F48A;'}</div>
                    <div class="mix-name">${mix.name}</div>
                    <div class="mix-desc">${mix.description}</div>
                `;
                layout.appendChild(card);
            });

            // Load custom blends
            loadCustomBlends();
        }

        // Load custom blends
        async function loadCustomBlends() {
            if (!currentUserId) return;

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}`);
                if (res.ok) {
                    customBlends = await res.json();
                    renderCustomBlends();
                    renderCustomBlendCards();
                }
            } catch (e) {
                console.error('Error loading custom blends:', e);
            }
        }

        // Render custom blend cards in dispenser grid
        function renderCustomBlendCards() {
            const layout = document.getElementById('dispenser-layout');

            // Remove existing custom blend cards first to prevent duplicates
            layout.querySelectorAll('.custom-blend-mix').forEach(card => card.remove());

            customBlends.forEach(blend => {
                const card = document.createElement('div');
                card.className = 'mix-card custom-blend-mix';
                card.onclick = () => selectCustomBlend(blend.id);
                card.innerHTML = `
                    <div class="custom-badge">Custom</div>
                    <div class="mix-icon">${blend.icon || '&#x1F9EA;'}</div>
                    <div class="mix-name">${blend.name}</div>
                    <div class="mix-desc">${(blend.components || []).length} supplements</div>
                `;
                layout.appendChild(card);
            });
        }

        // Render custom blends list
        function renderCustomBlends() {
            const list = document.getElementById('custom-blends-list');

            if (customBlends.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">&#x1F9EA;</div>
                        <div>No custom blends yet</div>
                        <div style="font-size: 0.8em; color: #333; margin-top: 6px;">
                            Create your own supplement combinations
                        </div>
                    </div>
                `;
                return;
            }

            list.innerHTML = customBlends.map(blend => `
                <div class="custom-blend-card" onclick="selectCustomBlend('${blend.id}')">
                    <div class="custom-blend-info">
                        <span class="custom-blend-icon">${blend.icon || '&#x1F9EA;'}</span>
                        <div>
                            <div class="custom-blend-name">${blend.name}</div>
                            <div class="custom-blend-count">${(blend.components || []).length} supplements</div>
                        </div>
                    </div>
                    <div class="custom-blend-actions">
                        <button class="btn-delete-blend" onclick="event.stopPropagation(); deleteCustomBlend('${blend.id}')" title="Delete">&#x2715;</button>
                    </div>
                </div>
            `).join('');
        }

        // Select a mix
        async function selectMix(mixId) {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/${mixId}?hour=${currentTime}&date_str=${dateStr}`);

                if (res.ok) {
                    currentMixData = await res.json();
                    showDispenseModal(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error calculating mix', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Select custom blend
        async function selectCustomBlend(blendId) {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/blends/${currentUserId}/${blendId}/preview?hour=${currentTime}&date_str=${dateStr}`);

                if (res.ok) {
                    currentMixData = await res.json();
                    showDispenseModal(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error calculating blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // AI Recommendation
        async function getAIRecommendation() {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            const aiRec = document.getElementById('ai-recommendation');
            aiRec.classList.add('loading');
            aiRec.querySelector('.ai-subtitle').textContent = 'Analyzing your health data...';

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/smart?hour=${currentTime}&date_str=${dateStr}`);

                if (res.ok) {
                    currentMixData = await res.json();
                    showDispenseModal(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error getting recommendation', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            } finally {
                aiRec.classList.remove('loading');
                aiRec.querySelector('.ai-subtitle').textContent = 'Personalized based on your health data';
            }
        }

        // Show dispense modal
        function showDispenseModal(data) {
            const modal = document.getElementById('dispense-modal');
            const content = document.getElementById('modal-content');

            const supplements = data.supplements || [];
            const warnings = data.warnings || [];
            const skipped = data.skipped || [];

            content.innerHTML = `
                <div class="modal-header">
                    <div class="modal-icon">${data.mix_icon || '&#x1F48A;'}</div>
                    <div class="modal-title">${data.mix_name}</div>
                    <div class="modal-subtitle">${data.mix_description || 'Your personalized supplement mix'}</div>
                </div>

                ${supplements.length > 0 ? `
                    <div class="supplement-list">
                        ${supplements.map(s => `
                            <div class="supplement-item">
                                <div class="supplement-info">
                                    <span class="supplement-name">${s.name}</span>
                                    <span class="supplement-description">${s.description || ''}</span>
                                </div>
                                <span class="supplement-dose">${s.dose}${s.unit}</span>
                            </div>
                            ${s.intelligence_notes && s.intelligence_notes.length > 0 ? `
                                <div class="intelligence-note">
                                    ${s.intelligence_notes.join('; ')}
                                </div>
                            ` : ''}
                        `).join('')}
                    </div>
                ` : `
                    <div class="empty-state" style="padding: 20px 0;">
                        <div style="color: #666;">All supplements in this mix have reached their daily limits</div>
                    </div>
                `}

                ${skipped.length > 0 ? `
                    <div class="modal-skipped">
                        <div class="skipped-header">Skipped (daily limit reached):</div>
                        ${skipped.map(s => `<span class="skipped-item">${s.name || s.supplement_id}</span>`).join('')}
                    </div>
                ` : ''}

                ${warnings.length > 0 ? `
                    <div class="modal-warning">
                        ${warnings.map(w => w.message || w).join('<br>')}
                    </div>
                ` : ''}

                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeDispenseModal()">Cancel</button>
                    <button class="btn-dispense" onclick="confirmDispense()" id="dispense-btn" ${supplements.length === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        ${supplements.length === 0 ? 'Nothing to Dispense' : 'Get Dose'}
                    </button>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close dispense modal
        function closeDispenseModal() {
            document.getElementById('dispense-modal').classList.add('hidden');
            currentMixData = null;
            isDispensing = false;
        }

        // Confirm dispense
        async function confirmDispense() {
            if (!currentMixData || isDispensing) return;
            isDispensing = true;

            const btn = document.getElementById('dispense-btn');
            btn.classList.add('dispensing');
            btn.textContent = 'Dispensing...';

            try {
                const dateStr = getDateString();

                // Determine if this is a custom blend or regular mix
                let url;
                if (currentMixData.blend_id) {
                    // Custom blend
                    url = `/mixes/blends/${currentUserId}/${currentMixData.blend_id}/dispense?time_override=${currentTime}&date_override=${dateStr}`;
                } else {
                    // Regular mix
                    url = `/mixes/${currentUserId}/${currentMixData.mix_id}/dispense?time_override=${currentTime}&date_override=${dateStr}`;
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (res.ok) {
                    showDispenseAnimation(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error dispensing', 'error');
                    closeDispenseModal();
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
                closeDispenseModal();
            }
        }

        // Show dispense animation
        function showDispenseAnimation(data) {
            const content = document.getElementById('modal-content');
            const supplements = data.supplements || [];

            content.innerHTML = `
                <div class="dispense-animation">
                    <div class="glass-container">
                        <div class="glass">
                            <div class="glass-water" id="water"></div>
                        </div>
                        <div class="dropping-supplements" id="dropping">
                            ${supplements.map((s, i) => `
                                <span class="dropping-pill" style="animation-delay: ${0.2 * i}s">&#x1F48A;</span>
                            `).join('')}
                        </div>
                    </div>
                    <div class="dispense-message">Dispensing your dose...</div>
                    <div class="dispense-details">${supplements.length} supplements</div>
                </div>
            `;

            // Start animation
            setTimeout(() => {
                document.getElementById('water').classList.add('filling');
            }, 100);

            // Show success after animation
            setTimeout(() => {
                showDispenseSuccess(data);
            }, 2500);
        }

        // Show dispense success
        function showDispenseSuccess(data) {
            const content = document.getElementById('modal-content');
            const supplements = data.supplements || [];

            content.innerHTML = `
                <div class="dispense-animation">
                    <div style="font-size: 4em; margin-bottom: 16px;">&#x2705;</div>
                    <div class="dispense-message">Dose Ready!</div>
                    <div class="dispense-details">Your supplements have been dispensed</div>

                    <div class="dispensed-list">
                        ${supplements.map(s => `
                            <div class="dispensed-item">
                                <span>${s.name}</span>
                                <span>${s.dose}${s.unit}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 20px;">
                    <button class="btn-dispense" onclick="closeDispenseModal(); loadAllData();" style="width: 100%;">
                        Done
                    </button>
                </div>
            `;
        }

        // Load tracking
        async function loadTracking() {
            if (!currentUserId) return;

            try {
                const dateStr = getDateString();
                let url = `/mixes/${currentUserId}/tracking/daily?date_str=${dateStr}`;
                if (trackingTab === 'weekly') {
                    url = `/mixes/${currentUserId}/tracking/weekly?date_str=${dateStr}`;
                }

                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    renderTracking(data);
                }
            } catch (e) {
                console.error('Error loading tracking:', e);
            }
        }

        // Render tracking
        function renderTracking(data) {
            const content = document.getElementById('tracking-content');
            const supplements = data.supplements || [];
            const isWeekly = trackingTab === 'weekly';

            if (supplements.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">&#x1F48A;</div>
                        <div>No supplements taken ${isWeekly ? 'this week' : 'yet'}</div>
                    </div>
                `;
                return;
            }

            content.innerHTML = supplements.map(s => {
                // Handle both daily (taken/max_daily) and weekly (weekly_total/weekly_max) formats
                const taken = isWeekly ? s.weekly_total : s.taken;
                const max = isWeekly ? s.weekly_max : s.max_daily;
                const pct = s.percentage || Math.min((taken / max) * 100, 100);
                let barClass = '';
                if (pct >= 90) barClass = 'danger';
                else if (pct >= 70) barClass = 'warning';

                // Format display value (round if needed)
                const takenDisplay = taken % 1 === 0 ? taken : taken.toFixed(1);
                const maxDisplay = max % 1 === 0 ? max : max.toFixed(0);

                return `
                    <div class="tracking-item">
                        <div class="tracking-header">
                            <span class="tracking-name">${s.name}${isWeekly ? ` (${s.days_taken || 0} days)` : ''}</span>
                            <span class="tracking-values">${takenDisplay}${s.unit} / ${maxDisplay}${s.unit}</span>
                        </div>
                        <div class="tracking-bar">
                            <div class="tracking-fill ${barClass}" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Switch tracking tab
        function switchTrackingTab(tab) {
            trackingTab = tab;
            document.querySelectorAll('.tracking-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            loadTracking();
        }

        // Load saturation
        async function loadSaturation() {
            if (!currentUserId) return;

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/tracking/saturation?as_of_date=${dateStr}`);
                if (res.ok) {
                    const data = await res.json();
                    renderSaturation(data);
                }
            } catch (e) {
                console.error('Error loading saturation:', e);
            }
        }

        // Render saturation
        function renderSaturation(data) {
            const content = document.getElementById('saturation-content');
            const items = data.supplements || [];

            if (items.length === 0) {
                content.innerHTML = '<p style="color: #444; font-size: 0.85em;">No saturation data yet. Take supplements with saturation effects to see progress here.</p>';
                return;
            }

            content.innerHTML = items.map(s => {
                const pct = s.saturation_percentage || 0;
                const circumference = 2 * Math.PI * 32;
                const offset = circumference - (pct / 100) * circumference;
                let progressClass = '';
                let statusClass = '';
                let statusText = '';

                if (pct >= 100) {
                    statusClass = 'saturated';
                    statusText = 'Fully saturated';
                } else if (s.status === 'building' || s.consecutive_days > 0) {
                    progressClass = 'building';
                    statusClass = 'building';
                    statusText = `Building (${s.consecutive_days} days) - ${s.days_to_saturate - s.consecutive_days} days to full`;
                } else if (s.status === 'not_started') {
                    statusClass = '';
                    statusText = `Not started - ${s.days_to_saturate} days to saturate`;
                } else {
                    progressClass = 'decaying';
                    statusClass = 'decaying';
                    statusText = 'Decaying - take daily to maintain';
                }

                return `
                    <div class="saturation-item">
                        <div class="saturation-ring">
                            <svg width="80" height="80">
                                <circle class="bg" cx="40" cy="40" r="32"></circle>
                                <circle class="progress ${progressClass}" cx="40" cy="40" r="32"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${offset}"></circle>
                            </svg>
                            <div class="saturation-pct">${Math.round(pct)}%</div>
                        </div>
                        <div class="saturation-info">
                            <div class="saturation-name">${s.name}</div>
                            <div class="saturation-status ${statusClass}">${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle settings
        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('hidden');
        }

        // Load scenario
        async function loadScenario() {
            const scenario = document.getElementById('scenario').value;
            if (!currentUserId || scenario === 'none') return;

            try {
                const res = await fetch(`/integrations/${currentUserId}/mock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scenario: scenario })
                });

                if (res.ok) {
                    showStatus(`Loaded ${scenario} scenario`, 'success');
                    loadAllData();
                } else {
                    showStatus('Error loading scenario', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Connect Oura
        function connectOura() {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }
            // Would redirect to OAuth flow
            showStatus('Oura connection coming soon!', 'success');
        }

        // ========== Custom Blend Builder ==========

        let selectedSupplements = {};
        let allSupplements = [];
        let aiSuggestions = [];
        let aiBlendName = 'Custom Blend';
        let aiBlendIcon = '';

        // Open blend builder
        async function openBlendBuilder() {
            document.getElementById('blend-builder-modal').classList.remove('hidden');
            document.getElementById('blend-name').value = '';
            document.getElementById('blend-icon').value = '&#x1F9EA;';
            selectedSupplements = {};
            aiSuggestions = [];

            await loadSupplements();
            renderSupplementGrid();
            updateSelectedSupplements();
        }

        // Close blend builder
        function closeBlendBuilder() {
            document.getElementById('blend-builder-modal').classList.add('hidden');
        }

        // Load all supplements
        async function loadSupplements() {
            try {
                const res = await fetch('/mixes/catalog');
                if (res.ok) {
                    const data = await res.json();
                    allSupplements = data.supplements || [];
                    renderCategories();
                }
            } catch (e) {
                console.error('Error loading supplements:', e);
            }
        }

        // Render categories
        function renderCategories() {
            const categories = [...new Set(allSupplements.map(s => s.category).filter(Boolean))];
            const container = document.getElementById('supplement-categories');

            container.innerHTML = `
                <button class="category-btn active" onclick="filterCategory('all')">All</button>
                ${categories.map(cat => `
                    <button class="category-btn" onclick="filterCategory('${cat}')">${cat.replace('_', ' ')}</button>
                `).join('')}
            `;
        }

        // Filter by category
        function filterCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            renderSupplementGrid(category);
        }

        // Render supplement grid
        function renderSupplementGrid(category = 'all') {
            const grid = document.getElementById('supplement-grid');
            let supplements = allSupplements;

            if (category !== 'all') {
                supplements = allSupplements.filter(s => s.category === category);
            }

            grid.innerHTML = supplements.map(s => `
                <div class="supplement-card ${selectedSupplements[s.id] ? 'selected' : ''}"
                     onclick="toggleSupplement('${s.id}')">
                    <div class="supplement-card-header">
                        <span class="supplement-card-name">${s.name}</span>
                        <span class="supplement-card-dose">${s.standard_dose}${s.unit}</span>
                    </div>
                    <div class="supplement-card-desc">${s.description}</div>
                    <div class="supplement-card-benefits">
                        ${(s.benefits || []).slice(0, 3).map(b => `<span class="benefit-tag">${b}</span>`).join('')}
                    </div>
                    ${s.pubmed_studies && s.pubmed_studies.length > 0 ? `
                        <div class="supplement-card-links">
                            ${s.pubmed_studies.slice(0, 2).map(link => `
                                <a href="${link.url}" target="_blank" class="pubmed-link" onclick="event.stopPropagation()">
                                    ${link.title.substring(0, 50)}...
                                </a>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Toggle supplement selection
        function toggleSupplement(id) {
            const supp = allSupplements.find(s => s.id === id);
            if (!supp) return;

            if (selectedSupplements[id]) {
                delete selectedSupplements[id];
            } else {
                selectedSupplements[id] = {
                    supplement_id: id,
                    name: supp.name,
                    dose: supp.standard_dose,
                    unit: supp.unit,
                    min_dose: supp.standard_dose * 0.5,
                    max_dose: supp.max_daily_dose
                };
            }

            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
        }

        // Update selected supplements display
        function updateSelectedSupplements() {
            const container = document.getElementById('selected-supplements');
            const list = document.getElementById('selected-supplements-list');
            const selected = Object.values(selectedSupplements);

            if (selected.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            list.innerHTML = selected.map(s => `
                <div class="selected-supp-item">
                    <span class="selected-supp-name">${s.name}</span>
                    <div class="selected-supp-dose">
                        <div class="dose-controls">
                            <input type="number" class="dose-input" value="${s.dose}"
                                min="${s.min_dose}" max="${s.max_dose}"
                                onchange="updateDose('${s.supplement_id}', this.value)">
                            <span class="dose-unit">${s.unit}</span>
                        </div>
                        <span class="dose-range">(${s.min_dose}-${s.max_dose})</span>
                        <button class="btn-remove-supp" onclick="removeSupplement('${s.supplement_id}')">&#x2715;</button>
                    </div>
                </div>
            `).join('');
        }

        // Update dose
        function updateDose(id, value) {
            if (selectedSupplements[id]) {
                selectedSupplements[id].dose = parseFloat(value);
            }
        }

        // Remove supplement
        function removeSupplement(id) {
            delete selectedSupplements[id];
            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
        }

        // AI Blend suggestion
        async function getAIBlendSuggestion() {
            const input = document.getElementById('ai-blend-input').value.trim();
            if (!input) {
                showStatus('Please describe what you want', 'error');
                return;
            }

            const suggestionsDiv = document.getElementById('ai-suggestions');
            const listDiv = document.getElementById('ai-suggestions-list');

            suggestionsDiv.classList.add('visible');
            listDiv.innerHTML = '<div class="ai-loading">Thinking</div>';

            try {
                const res = await fetch('/mixes/suggest-blend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_request: input, user_id: currentUserId })
                });

                if (res.ok) {
                    const data = await res.json();
                    aiSuggestions = data.supplements || [];
                    aiBlendName = data.blend_name || 'Custom Blend';
                    aiBlendIcon = data.blend_icon || '';
                    renderAISuggestions(data.summary);
                } else {
                    listDiv.innerHTML = '<p style="color: #EF4444;">Error getting suggestions</p>';
                }
            } catch (e) {
                listDiv.innerHTML = '<p style="color: #EF4444;">Error: ' + e.message + '</p>';
            }
        }

        // Render AI suggestions
        function renderAISuggestions(summary) {
            const listDiv = document.getElementById('ai-suggestions-list');

            if (aiSuggestions.length === 0) {
                listDiv.innerHTML = '<p style="color: #888;">No suggestions found. Try a different description.</p>';
                return;
            }

            // Show summary and suggested blend name
            let html = '';
            if (summary) {
                html += `<div style="color: #A78BFA; margin-bottom: 12px; font-size: 0.9em;">${summary}</div>`;
            }

            html += aiSuggestions.map(s => {
                // Look up supplement details from catalog
                const supp = allSupplements.find(sup => sup.id === s.supplement_id);
                const name = supp ? supp.name : s.supplement_id;
                const unit = supp ? supp.unit : 'mg';

                return `
                    <div class="ai-suggestion-item" onclick="addSuggestion('${s.supplement_id}', ${s.dose})">
                        <div>
                            <div class="ai-suggestion-name">${name}</div>
                            <div class="ai-suggestion-reason">${s.reason}</div>
                        </div>
                        <span class="ai-suggestion-dose">${s.dose}${unit}</span>
                    </div>
                `;
            }).join('');

            // Add "Add All" button
            html += `<button class="btn-dispense" onclick="addAllSuggestions()" style="margin-top: 12px; width: 100%;">Add All to Blend</button>`;

            listDiv.innerHTML = html;

            // Auto-fill blend name if empty
            const blendNameInput = document.getElementById('blend-name');
            if (!blendNameInput.value) {
                blendNameInput.value = aiBlendName;
            }
            const blendIconInput = document.getElementById('blend-icon');
            if (blendIconInput.value === '&#x1F9EA;' || !blendIconInput.value) {
                blendIconInput.value = aiBlendIcon;
            }
        }

        // Add single suggestion
        function addSuggestion(id, dose) {
            const suggestion = aiSuggestions.find(s => s.supplement_id === id);
            if (!suggestion) return;

            const supp = allSupplements.find(s => s.id === id);
            if (!supp) return;

            selectedSupplements[id] = {
                supplement_id: id,
                name: supp.name,
                dose: dose || suggestion.dose,
                unit: supp.unit,
                min_dose: supp.standard_dose * 0.5,
                max_dose: supp.max_daily_dose
            };

            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
            showStatus(`Added ${supp.name}`, 'success');
        }

        // Add all suggestions
        function addAllSuggestions() {
            aiSuggestions.forEach(s => {
                const supp = allSupplements.find(sup => sup.id === s.supplement_id);
                if (supp) {
                    selectedSupplements[s.supplement_id] = {
                        supplement_id: s.supplement_id,
                        name: supp.name,
                        dose: s.dose,
                        unit: supp.unit,
                        min_dose: supp.standard_dose * 0.5,
                        max_dose: supp.max_daily_dose
                    };
                }
            });

            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
            showStatus(`Added ${aiSuggestions.length} supplements`, 'success');
        }

        // Save custom blend
        async function saveCustomBlend() {
            const name = document.getElementById('blend-name').value.trim();
            const icon = document.getElementById('blend-icon').value || '&#x1F9EA;';
            const supplements = Object.values(selectedSupplements);

            if (!name) {
                showStatus('Please enter a blend name', 'error');
                return;
            }

            if (supplements.length === 0) {
                showStatus('Please select at least one supplement', 'error');
                return;
            }

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        icon,
                        components: supplements.map(s => ({
                            supplement_id: s.supplement_id,
                            dose: s.dose
                        }))
                    })
                });

                if (res.ok) {
                    showStatus('Blend created!', 'success');
                    closeBlendBuilder();
                    loadCustomBlends();
                    loadMixes();
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error creating blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Delete custom blend
        async function deleteCustomBlend(blendId) {
            if (!confirm('Delete this blend?')) return;

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}/${blendId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    showStatus('Blend deleted', 'success');
                    loadCustomBlends();
                    loadMixes();
                } else {
                    showStatus('Error deleting blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>
