<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dose - Smart Supplement Dispensing</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0A0A0A;
            min-height: 100vh;
            color: #E8E8E8;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 24px;
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 50%, #C4B5FD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow:
                0 4px 6px rgba(0, 0, 0, 0.1),
                0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow:
                0 8px 25px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(139, 92, 246, 0.05);
        }

        .card h2 {
            margin-bottom: 16px;
            font-size: 1.1em;
            font-weight: 600;
            color: #A0A0A0;
            letter-spacing: -0.01em;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        input, select, textarea {
            padding: 14px 18px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.04);
            color: #E8E8E8;
            font-size: 0.95em;
            font-family: inherit;
            flex: 1;
            min-width: 150px;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.08);
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.35);
        }

        select {
            cursor: pointer;
        }

        select option {
            background: #1a1a1a;
            color: #E8E8E8;
        }

        button {
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: #fff;
            font-size: 0.95em;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.35);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.06);
            color: #A0A0A0;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #E8E8E8;
            box-shadow: none;
        }

        .hidden {
            display: none !important;
        }

        #status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 1000;
            max-width: 350px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        #status.success {
            background: rgba(34, 197, 94, 0.9);
            color: #fff;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.3);
        }

        #status.error {
            background: rgba(239, 68, 68, 0.9);
            color: #fff;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }

        /* Signup Card */
        .signup-card {
            max-width: 400px;
            margin: 40px auto;
            padding: 32px;
            text-align: center;
        }

        .signup-header {
            margin-bottom: 28px;
        }

        .signup-logo {
            font-size: 3em;
            margin-bottom: 16px;
        }

        .signup-card h2 {
            font-size: 1.6em;
            margin-bottom: 8px;
            color: #E8E8E8;
        }

        .signup-subtitle {
            color: #888;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .signup-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .signup-input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #E8E8E8;
            font-size: 1em;
            box-sizing: border-box;
        }

        .signup-input:focus {
            outline: none;
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.08);
        }

        .signup-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .signup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.35);
        }

        .signup-btn.secondary {
            background: rgba(255, 255, 255, 0.06);
            color: #A0A0A0;
        }

        .signup-features {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .signup-feature {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #888;
            font-size: 0.85em;
        }

        .feature-icon {
            font-size: 1.1em;
        }

        .signin-section {
            color: #666;
            font-size: 0.9em;
        }

        .signin-link {
            color: #A78BFA;
            margin-left: 8px;
        }

        .signin-form-container {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Onboarding */
        .onboarding-step {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .onboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .onboard-grid input, .onboard-grid select {
            min-width: 0;
        }

        /* Date Navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .date-nav button {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.04);
            color: #A0A0A0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-nav button:hover {
            background: rgba(139, 92, 246, 0.15);
            color: #8B5CF6;
            box-shadow: none;
        }

        .date-display {
            text-align: center;
            min-width: 200px;
        }

        .date-display .day {
            font-size: 1.4em;
            font-weight: 700;
            color: #E8E8E8;
        }

        .date-display .full-date {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .date-display .today-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Time Selector */
        .time-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .time-btn {
            padding: 10px 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 24px;
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }

        .time-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .time-btn.active {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }

        /* Main Dispenser Layout */
        .dispenser-layout {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        /* AI Recommendation - Center */
        .ai-recommendation {
            grid-column: 1 / -1;  /* Full width - hero card */
            grid-row: 1;
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.2) 0%,
                rgba(124, 58, 237, 0.15) 50%,
                rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 20px;
            padding: 28px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.15);
            position: relative;
            overflow: hidden;
        }

        .ai-recommendation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
            animation: pulse-glow 4s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .ai-recommendation:hover {
            transform: scale(1.02);
            border-color: #8B5CF6;
            box-shadow: 0 8px 50px rgba(139, 92, 246, 0.35);
        }

        .ai-recommendation .ai-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .ai-recommendation .ai-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #A78BFA, #C4B5FD);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-recommendation .ai-subtitle {
            font-size: 0.8em;
            color: #666;
            line-height: 1.4;
        }

        .ai-recommendation.loading .ai-icon {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Daily Foundation - Below AI */
        .daily-foundation {
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(196, 181, 253, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .daily-foundation:hover {
            transform: scale(1.02);
            border-color: #A78BFA;
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.2);
        }

        .daily-foundation.taken {
            opacity: 0.4;
            cursor: default;
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .daily-foundation.taken:hover {
            transform: none;
            box-shadow: none;
            border-color: rgba(255, 255, 255, 0.05);
        }

        .daily-foundation.taken .df-name {
            color: #555;
        }

        .daily-foundation .df-contents {
            font-size: 0.7em;
            color: #888;
            margin-top: 4px;
            letter-spacing: 0.02em;
        }

        .daily-foundation .df-status {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.7em;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .daily-foundation.taken .df-status {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .daily-foundation.partial .df-status {
            background: rgba(251, 191, 36, 0.2);
            color: #FBBF24;
        }

        .daily-foundation .df-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .daily-foundation .df-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #A78BFA;
        }


        /* Mix Cards */
        .mix-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mix-card:hover {
            transform: translateY(-4px);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
            background: rgba(139, 92, 246, 0.05);
        }

        .mix-card .mix-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .mix-card .mix-name {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 4px;
            color: #E8E8E8;
        }

        .mix-card .mix-desc {
            font-size: 0.7em;
            color: #555;
            line-height: 1.3;
        }

        .mix-card.custom-blend-mix {
            position: relative;
        }

        .mix-card .custom-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            font-size: 0.55em;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Dispense Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(20px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: #121212;
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.08);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-icon {
            font-size: 3em;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 6px;
            color: #E8E8E8;
        }

        .modal-subtitle {
            color: #666;
            font-size: 0.9em;
        }

        .supplement-list {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 18px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .supplement-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            gap: 12px;
        }

        .supplement-item:last-child {
            border-bottom: none;
        }

        .supplement-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .supplement-name {
            font-weight: 500;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .supplement-description {
            font-size: 0.75em;
            color: #888;
            margin-top: 4px;
            line-height: 1.4;
        }

        .supplement-dose {
            color: #A78BFA;
            font-weight: 600;
            white-space: nowrap;
            padding-top: 2px;
        }

        .modal-warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.25);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 18px;
            font-size: 0.85em;
            color: #FBBF24;
        }

        .modal-skipped {
            background: rgba(100, 100, 100, 0.1);
            border: 1px solid rgba(100, 100, 100, 0.25);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 18px;
            font-size: 0.8em;
        }

        .skipped-header {
            color: #888;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .skipped-item {
            display: inline-block;
            background: rgba(255, 255, 255, 0.05);
            color: #666;
            padding: 4px 10px;
            border-radius: 20px;
            margin: 2px 4px 2px 0;
            font-size: 0.9em;
            text-decoration: line-through;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-actions button {
            flex: 1;
            padding: 16px;
            font-size: 1em;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            color: #666;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #A0A0A0;
            box-shadow: none;
        }

        .btn-dispense {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .btn-dispense.dispensing {
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
        }

        /* Onboarding Modal */
        .onboarding-modal-content {
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
        }

        .onboarding-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .progress-step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
            color: #666;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
        }

        .progress-step.completed {
            background: #22C55E;
            color: #fff;
        }

        .progress-line {
            width: 40px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
        }

        .progress-line.completed {
            background: #22C55E;
        }

        .onboarding-illustration {
            font-size: 4em;
            margin-bottom: 16px;
        }

        .onboarding-step-content h2 {
            font-size: 1.6em;
            margin-bottom: 8px;
            color: #E8E8E8;
        }

        .onboarding-subtitle {
            color: #888;
            margin-bottom: 24px;
        }

        /* Onboarding Form Components */
        .onboarding-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
            text-align: left;
        }

        .onboarding-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .onboarding-field label {
            font-size: 0.8em;
            color: #888;
            font-weight: 500;
        }

        .onboarding-field input {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #E8E8E8;
            font-size: 1em;
        }

        .onboarding-field input:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        .onboarding-pill-group {
            display: flex;
            gap: 8px;
        }

        .ob-pill {
            flex: 1;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #888;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ob-pill:hover {
            border-color: rgba(139, 92, 246, 0.3);
            color: #E8E8E8;
        }

        .ob-pill.selected {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8B5CF6;
            color: #E8E8E8;
        }

        .height-inputs, .weight-input {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .height-inputs input, .weight-input input {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #E8E8E8;
            font-size: 1em;
            min-width: 0;
        }

        .height-unit, .weight-unit {
            color: #666;
            font-size: 0.85em;
        }

        /* Lifestyle Cards */
        .lifestyle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .lifestyle-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lifestyle-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
        }

        .lifestyle-card.selected {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.1);
        }

        .lifestyle-icon {
            font-size: 1.5em;
            margin-bottom: 6px;
        }

        .lifestyle-label {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 4px;
        }

        .lifestyle-value {
            font-size: 0.95em;
            color: #E8E8E8;
            font-weight: 500;
        }

        .lifestyle-options {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .lifestyle-option {
            display: flex;
            flex-direction: column;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .lifestyle-option:last-child {
            border-bottom: none;
        }

        .lifestyle-option:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .lifestyle-option.selected {
            background: rgba(139, 92, 246, 0.15);
        }

        .lifestyle-option .option-label {
            color: #E8E8E8;
            font-weight: 500;
        }

        .lifestyle-option .option-desc {
            color: #666;
            font-size: 0.85em;
            margin-top: 2px;
        }

        /* Chronotype Cards */
        .chronotype-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .chronotype-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .chronotype-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .chronotype-card.selected {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.15);
        }

        .chronotype-icon {
            font-size: 2em;
        }

        .chronotype-label {
            color: #E8E8E8;
            font-weight: 600;
            font-size: 1em;
        }

        .chronotype-desc {
            color: #888;
            font-size: 0.85em;
            margin-top: 2px;
        }

        /* Progress line completed state */
        .progress-line.completed {
            background: linear-gradient(90deg, #8B5CF6, #7C3AED);
        }

        /* Onboarding navigation buttons */
        .onboarding-nav {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .onboarding-nav .onboarding-btn {
            flex: 1;
        }

        .onboarding-btn.back {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .onboarding-btn.back:hover {
            border-color: rgba(255, 255, 255, 0.2);
            color: #E8E8E8;
        }

        .onboarding-feature-card {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: left;
            margin-bottom: 24px;
        }

        .onboarding-feature-card .feature-icon {
            font-size: 2em;
            flex-shrink: 0;
        }

        .onboarding-feature-card .feature-text strong {
            display: block;
            color: #E8E8E8;
            margin-bottom: 4px;
        }

        .onboarding-feature-card .feature-text p {
            color: #888;
            font-size: 0.9em;
            margin: 0;
        }

        .onboarding-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .onboarding-btn.primary {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            border: none;
        }

        .onboarding-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.35);
        }

        .onboarding-btn.secondary {
            background: transparent;
            color: #888;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .onboarding-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #E8E8E8;
            box-shadow: none;
        }

        /* Quick Add Grid for Onboarding */
        .onboarding-quick-add {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 400px) {
            .onboarding-quick-add {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .onboarding-quick-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .onboarding-quick-item:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .onboarding-quick-item.selected {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22C55E;
        }

        .onboarding-quick-item .quick-icon {
            font-size: 1.8em;
            margin-bottom: 6px;
        }

        .onboarding-quick-item .quick-name {
            font-size: 0.85em;
            color: #E8E8E8;
        }

        .onboarding-quick-item .quick-check {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #22C55E;
            font-weight: bold;
            display: none;
        }

        .onboarding-quick-item.selected .quick-check {
            display: block;
        }

        /* Searchable Supplement Picker */
        .supp-search-container {
            margin-bottom: 16px;
        }

        .supp-search-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #E8E8E8;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
        }

        .supp-search-input:focus {
            border-color: rgba(139, 92, 246, 0.5);
        }

        .supp-search-input::placeholder {
            color: #666;
        }

        .supp-list-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
        }

        .supp-list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .supp-list-item:last-child {
            border-bottom: none;
        }

        .supp-list-item:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .supp-list-item.selected {
            background: rgba(34, 197, 94, 0.1);
        }

        .supp-list-icon {
            font-size: 1.3em;
            margin-right: 12px;
            width: 28px;
            text-align: center;
        }

        .supp-list-info {
            flex: 1;
        }

        .supp-list-name {
            color: #E8E8E8;
            font-weight: 500;
        }

        .supp-list-dose {
            color: #888;
            font-size: 0.8em;
        }

        .supp-list-check {
            color: #22C55E;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .supp-list-item.selected .supp-list-check {
            opacity: 1;
        }

        .supp-no-results {
            padding: 24px;
            text-align: center;
            color: #666;
        }

        /* Selected Supplements Section */
        .selected-supps-section {
            margin-bottom: 16px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .selected-supps-label {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 8px;
            position: sticky;
            top: 0;
            background: #121212;
            padding: 4px 0;
            z-index: 1;
        }

        .selected-supp-card {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .selected-supp-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .selected-supp-name {
            flex: 1;
            color: #E8E8E8;
            font-weight: 500;
        }

        .selected-supp-remove {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.9em;
        }

        .selected-supp-remove:hover {
            color: #EF4444;
        }

        .selected-supp-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .selected-supp-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .selected-supp-field label {
            font-size: 0.75em;
            color: #888;
        }

        .selected-supp-field input,
        .selected-supp-field select {
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #E8E8E8;
            font-size: 0.9em;
        }

        .selected-supp-field input:focus,
        .selected-supp-field select:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
        }

        /* Goal Options */
        .goal-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .goal-option {
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            position: relative;
        }

        .goal-option:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .goal-option.selected {
            background: rgba(139, 92, 246, 0.15);
            border-color: #8B5CF6;
        }

        .goal-option .goal-icon {
            font-size: 2em;
            display: block;
            margin-bottom: 8px;
        }

        .goal-option .goal-name {
            color: #E8E8E8;
            font-weight: 500;
        }

        .goal-option .goal-check {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #8B5CF6;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Completion */
        .completion-checkmark {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #22C55E, #16A34A);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            color: #fff;
            margin: 0 auto 24px;
            animation: scaleIn 0.5s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .completion-summary {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: #888;
            font-size: 0.9em;
        }

        .summary-item:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .summary-item .summary-icon {
            font-size: 1.2em;
        }

        .summary-item.completed {
            color: #22C55E;
        }

        /* Onboarding Duration/Adherence */
        .onboarding-details {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }

        .onboarding-details label {
            display: block;
            color: #888;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .onboarding-details select {
            width: 100%;
            margin-bottom: 16px;
        }

        .adherence-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .adherence-row input[type="range"] {
            flex: 1;
        }

        .adherence-row .adherence-value {
            min-width: 45px;
            text-align: right;
            color: #E8E8E8;
        }

        /* Getting Started Card */
        .getting-started-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .getting-started-card h3 {
            font-size: 1.1em;
            color: #E8E8E8;
            margin-bottom: 4px;
        }

        .getting-started-card .gs-subtitle {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 16px;
        }

        .gs-checklist {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .gs-checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .gs-checklist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .gs-check-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .gs-checklist-item.completed .gs-check-circle {
            background: #22C55E;
            border-color: #22C55E;
            color: #fff;
        }

        .gs-item-content {
            flex: 1;
        }

        .gs-item-title {
            color: #E8E8E8;
            font-weight: 500;
            font-size: 0.95em;
        }

        .gs-checklist-item.completed .gs-item-title {
            color: #888;
            text-decoration: line-through;
        }

        .gs-item-desc {
            color: #666;
            font-size: 0.8em;
            margin-top: 2px;
        }

        .gs-item-action {
            padding: 6px 14px;
            border-radius: 8px;
            border: none;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            background: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            transition: all 0.2s;
        }

        .gs-item-action:hover {
            background: rgba(139, 92, 246, 0.3);
        }

        .gs-checklist-item.completed .gs-item-action {
            display: none;
        }

        .gs-dismiss {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 10px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 0.85em;
            cursor: pointer;
        }

        .gs-dismiss:hover {
            color: #888;
        }

        .gs-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .gs-progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .gs-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #22C55E);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .gs-progress-text {
            color: #888;
            font-size: 0.8em;
            white-space: nowrap;
        }

        /* Chart Overlay */
        .chart-container {
            position: relative;
        }

        .chart-overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 10, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            text-align: center;
            padding: 24px;
            z-index: 5;
        }

        .chart-overlay.hidden {
            display: none;
        }

        .chart-overlay-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .chart-overlay h3 {
            color: #E8E8E8;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .chart-overlay p {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 16px;
            max-width: 260px;
        }

        .chart-overlay-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chart-overlay-btn:hover {
            transform: scale(1.05);
        }

        /* Saturation section hidden state */
        .saturation-gauge.hidden-section {
            display: none;
        }

        /* Improved empty state */
        .empty-state-modern {
            text-align: center;
            padding: 32px 20px;
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.05) 0%, transparent 100%);
            border-radius: 16px;
            border: 1px dashed rgba(139, 92, 246, 0.2);
        }

        .empty-state-modern .empty-illustration {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .empty-state-modern h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: #E8E8E8;
            margin-bottom: 8px;
        }

        .empty-state-modern p {
            color: #888;
            margin-bottom: 16px;
            font-size: 0.9em;
            max-width: 260px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state-cta {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .empty-state-cta:hover {
            transform: scale(1.03);
        }

        /* Dispense Animation */
        .dispense-animation {
            text-align: center;
            padding: 20px 0;
        }

        .glass-container {
            position: relative;
            width: 120px;
            height: 160px;
            margin: 0 auto 24px;
        }

        .glass {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 140px;
            border: 4px solid rgba(139, 92, 246, 0.3);
            border-radius: 0 0 24px 24px;
            border-top: none;
            overflow: hidden;
        }

        .glass-water {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.5) 0%, rgba(167, 139, 250, 0.7) 100%);
            height: 0;
            transition: height 2s ease-out;
            border-radius: 0 0 20px 20px;
        }

        .glass-water.filling {
            height: 85%;
        }

        .dropping-supplements {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .dropping-pill {
            font-size: 1.2em;
            animation: dropPill 1s ease-in forwards;
            opacity: 0;
        }

        @keyframes dropPill {
            0% { transform: translateY(-20px); opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }

        .dispense-message {
            font-size: 1.3em;
            font-weight: 700;
            background: linear-gradient(135deg, #A78BFA, #C4B5FD);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .dispense-details {
            color: #666;
            font-size: 0.9em;
        }

        .dispensed-list {
            margin-top: 18px;
            padding: 14px;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 12px;
            text-align: left;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .dispensed-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.85em;
        }

        .dispensed-item span:first-child {
            color: #A0A0A0;
        }

        .dispensed-item span:last-child {
            color: #A78BFA;
            font-weight: 500;
        }

        /* Tracking Section */
        .tracking-section {
            margin-top: 20px;
        }

        .tracking-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }

        .tracking-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            color: #555;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
        }

        .tracking-tab:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .tracking-tab.active {
            background: rgba(139, 92, 246, 0.12);
            border-color: rgba(139, 92, 246, 0.3);
            color: #A78BFA;
        }

        .tracking-content {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .tracking-item {
            margin-bottom: 18px;
        }

        .tracking-item:last-child {
            margin-bottom: 0;
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .tracking-name {
            font-weight: 500;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .tracking-values {
            font-size: 0.85em;
            color: #666;
        }

        .tracking-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .tracking-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #A78BFA);
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        .tracking-fill.warning {
            background: linear-gradient(90deg, #F59E0B, #FBBF24);
        }

        .tracking-fill.danger {
            background: linear-gradient(90deg, #EF4444, #F87171);
        }

        /* Saturation Gauge */
        .saturation-gauge {
            margin-top: 24px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .saturation-title {
            font-size: 0.9em;
            color: #A78BFA;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .saturation-item {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .saturation-ring {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .saturation-ring svg {
            transform: rotate(-90deg);
        }

        .saturation-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .saturation-ring .bg {
            stroke: rgba(255, 255, 255, 0.06);
        }

        .saturation-ring .progress {
            stroke: #8B5CF6;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-out;
        }

        .saturation-ring .progress.building {
            stroke: #F59E0B;
        }

        .saturation-ring .progress.decaying {
            stroke: #EF4444;
        }

        .saturation-pct {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.1em;
            font-weight: 700;
            color: #E8E8E8;
        }

        .saturation-info {
            flex: 1;
        }

        .saturation-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #E8E8E8;
        }

        .saturation-status {
            font-size: 0.85em;
            color: #555;
        }

        .saturation-status.saturated {
            color: #22C55E;
        }

        .saturation-status.building {
            color: #F59E0B;
        }

        .saturation-status.decaying {
            color: #EF4444;
        }

        /* Oura Connection Card */
        .oura-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(59, 130, 246, 0.08) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
        }

        .oura-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .oura-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .oura-logo {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #8B5CF6, #3B82F6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
        }

        .oura-title {
            font-weight: 600;
            color: #E8E8E8;
            font-size: 0.95em;
        }

        .oura-subtitle {
            font-size: 0.8em;
            color: #666;
        }

        .oura-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .oura-status.connected {
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
        }

        .oura-status.disconnected {
            background: rgba(255, 255, 255, 0.06);
            color: #666;
        }

        .oura-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .oura-connect-btn {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .oura-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
        }

        .oura-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .oura-metric {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .oura-metric-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #E8E8E8;
            margin-bottom: 4px;
        }

        .oura-metric-value.good {
            color: #22C55E;
        }

        .oura-metric-value.fair {
            color: #F59E0B;
        }

        .oura-metric-value.poor {
            color: #EF4444;
        }

        .oura-metric-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .oura-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }

        .oura-sync-btn {
            flex: 1;
            padding: 10px 16px;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            color: #A78BFA;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .oura-sync-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: none;
            box-shadow: none;
        }

        .oura-disconnect-btn {
            padding: 10px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .oura-disconnect-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #EF4444;
            transform: none;
            box-shadow: none;
        }

        .oura-loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 500px) {
            .oura-metrics {
                grid-template-columns: repeat(3, 1fr);
            }

            .oura-metric {
                padding: 10px;
            }

            .oura-metric-value {
                font-size: 1.2em;
            }
        }

        /* User header */
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #fff;
            font-size: 1.1em;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.05em;
            color: #E8E8E8;
        }

        .btn-logout {
            padding: 10px 18px;
            font-size: 0.85em;
            background: rgba(255, 255, 255, 0.04);
            color: #666;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #A0A0A0;
            box-shadow: none;
        }

        /* Responsive */
        @media (max-width: 700px) {
            .dispenser-layout {
                grid-template-columns: repeat(2, 1fr);
            }

            .ai-recommendation {
                grid-column: 1 / -1;
                grid-row: auto;
            }

            .daily-foundation {
                grid-column: 1 / -1;
                grid-row: auto;
            }
        }

        @media (max-width: 400px) {
            .dispenser-layout {
                grid-template-columns: 1fr;
            }

            .ai-recommendation, .daily-foundation {
                grid-column: 1;
            }
        }

        /* Settings panel */
        .settings-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #666;
            font-size: 1.4em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .settings-toggle:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .settings-panel {
            position: fixed;
            bottom: 88px;
            right: 24px;
            background: #121212;
            border-radius: 18px;
            padding: 22px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            min-width: 280px;
            backdrop-filter: blur(20px);
        }

        .settings-panel h3 {
            margin-bottom: 18px;
            font-size: 1em;
            color: #A78BFA;
            font-weight: 600;
        }

        .setting-row {
            margin-bottom: 14px;
        }

        .setting-row label {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 6px;
        }

        .setting-row select {
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 36px;
            color: #444;
        }

        .empty-state .emoji {
            font-size: 2.5em;
            margin-bottom: 14px;
            opacity: 0.5;
        }

        /* Custom Blends Section */
        .custom-blends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .custom-blends-header h2 {
            margin: 0;
        }

        .btn-create-blend {
            padding: 10px 18px;
            font-size: 0.85em;
            border-radius: 24px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .custom-blend-card {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-blend-card:hover {
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.12);
        }

        .custom-blend-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .custom-blend-icon {
            font-size: 1.5em;
        }

        .custom-blend-name {
            font-weight: 600;
            color: #E8E8E8;
        }

        .custom-blend-count {
            font-size: 0.8em;
            color: #555;
            margin-top: 2px;
        }

        .custom-blend-actions {
            display: flex;
            gap: 8px;
        }

        .btn-delete-blend {
            width: 34px;
            height: 34px;
            padding: 0;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-delete-blend:hover {
            background: rgba(239, 68, 68, 0.2);
            box-shadow: none;
        }

        /* Blend Builder Modal */
        .blend-builder {
            max-height: 80vh;
            overflow-y: auto;
        }

        .blend-builder-header {
            display: flex;
            gap: 12px;
            margin-bottom: 22px;
        }

        .blend-builder-header input {
            flex: 1;
        }

        .icon-picker {
            width: 54px;
            text-align: center;
            font-size: 1.5em;
            cursor: pointer;
        }

        .supplement-categories {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .category-btn {
            padding: 8px 14px;
            font-size: 0.8em;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .category-btn.active {
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.12);
            color: #A78BFA;
        }

        .supplement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
            margin-bottom: 18px;
        }

        .supplement-card {
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .supplement-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .supplement-card.selected {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.1);
        }

        .supplement-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .supplement-card-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .supplement-card-dose {
            font-size: 0.8em;
            color: #A78BFA;
        }

        .supplement-card-desc {
            font-size: 0.75em;
            color: #555;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .supplement-card-benefits {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .benefit-tag {
            padding: 3px 8px;
            font-size: 0.65em;
            background: rgba(139, 92, 246, 0.12);
            color: #A78BFA;
            border-radius: 6px;
        }

        .supplement-card-links {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .pubmed-link {
            display: block;
            font-size: 0.7em;
            color: #8B5CF6;
            text-decoration: none;
            padding: 3px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pubmed-link:hover {
            color: #A78BFA;
            text-decoration: underline;
        }

        .selected-supplements {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 18px;
        }

        .selected-supplements-title {
            font-size: 0.85em;
            color: #A78BFA;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .selected-supp-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .selected-supp-item:last-child {
            border-bottom: none;
        }

        .selected-supp-name {
            font-size: 0.9em;
            color: #E8E8E8;
        }

        .selected-supp-dose {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dose-input {
            width: 75px;
            padding: 6px 10px;
            font-size: 0.85em;
            text-align: center;
        }

        .dose-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dose-unit {
            font-size: 0.75em;
            color: #555;
            min-width: 30px;
        }

        .dose-range {
            font-size: 0.65em;
            color: #444;
        }

        /* AI Blend Assistant */
        .ai-blend-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(167, 139, 250, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 22px;
        }

        .ai-blend-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .ai-blend-header .ai-icon {
            font-size: 1.5em;
        }

        .ai-blend-header h3 {
            margin: 0;
            font-size: 1em;
            color: #E8E8E8;
            font-weight: 600;
        }

        .ai-blend-header span {
            font-size: 0.8em;
            color: #555;
        }

        .ai-input-row {
            display: flex;
            gap: 10px;
        }

        .ai-input-row textarea {
            flex: 1;
            min-height: 60px;
            resize: vertical;
        }

        .ai-input-row button {
            align-self: flex-end;
            white-space: nowrap;
        }

        .ai-suggestions {
            margin-top: 14px;
            padding: 14px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: none;
        }

        .ai-suggestions.visible {
            display: block;
        }

        .ai-suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ai-suggestions-title {
            font-size: 0.9em;
            color: #A78BFA;
            font-weight: 500;
        }

        .ai-suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .ai-suggestion-item:last-child {
            margin-bottom: 0;
        }

        .ai-suggestion-name {
            font-size: 0.9em;
            color: #E8E8E8;
        }

        .ai-suggestion-dose {
            font-size: 0.8em;
            color: #A78BFA;
            font-weight: 500;
        }

        .ai-suggestion-reason {
            font-size: 0.75em;
            color: #555;
            margin-top: 3px;
        }

        .ai-loading {
            text-align: center;
            padding: 24px;
            color: #555;
        }

        .ai-loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .btn-add-all {
            padding: 8px 14px;
            font-size: 0.8em;
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
            border: 1px solid rgba(34, 197, 94, 0.25);
        }

        .btn-add-all:hover {
            background: rgba(34, 197, 94, 0.25);
            box-shadow: none;
        }

        .btn-remove-supp {
            width: 26px;
            height: 26px;
            padding: 0;
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
            border-radius: 50%;
            font-size: 0.8em;
        }

        .btn-remove-supp:hover {
            background: rgba(239, 68, 68, 0.25);
            box-shadow: none;
        }

        /* Supplement Info Modal */
        .supp-info-modal {
            max-width: 450px;
        }

        .supp-info-header {
            text-align: center;
            margin-bottom: 22px;
        }

        .supp-info-name {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 6px;
            color: #E8E8E8;
        }

        .supp-info-dose {
            color: #A78BFA;
            font-size: 0.9em;
        }

        .supp-info-desc {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 18px;
            font-size: 0.9em;
            line-height: 1.6;
            color: #A0A0A0;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .supp-info-benefits {
            margin-bottom: 18px;
        }

        .supp-info-benefits-title {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .supp-info-benefits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .supp-info-benefit {
            padding: 5px 12px;
            background: rgba(139, 92, 246, 0.12);
            color: #A78BFA;
            border-radius: 14px;
            font-size: 0.8em;
        }

        .supp-info-studies {
            background: rgba(139, 92, 246, 0.06);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 14px;
            padding: 16px;
        }

        .supp-info-studies-title {
            font-size: 0.85em;
            color: #A78BFA;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .study-link {
            display: block;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .study-link:last-child {
            margin-bottom: 0;
        }

        .study-link:hover {
            background: rgba(139, 92, 246, 0.15);
        }

        .study-title {
            color: #E8E8E8;
            font-size: 0.85em;
            display: block;
            margin-bottom: 3px;
        }

        .study-pmid {
            color: #555;
            font-size: 0.75em;
        }

        /* Intelligence notes styling */
        .intelligence-note {
            background: rgba(139, 92, 246, 0.08);
            border-left: 3px solid #8B5CF6;
            padding: 10px 14px;
            margin-top: 10px;
            border-radius: 0 10px 10px 0;
            font-size: 0.8em;
            color: #A78BFA;
        }

        /* Sign in link */
        a {
            color: #8B5CF6;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        a:hover {
            color: #A78BFA;
        }

        /* Footer */
        .footer {
            margin-top: 60px;
            padding: 30px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 12px;
        }

        .footer-links a {
            color: #666;
            text-decoration: none;
            font-size: 0.85em;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #A78BFA;
        }

        .footer-copyright {
            color: #444;
            font-size: 0.75em;
        }

        /* Main Navigation Tabs */
        .main-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            padding: 4px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .main-nav-btn {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: #666;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .main-nav-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .main-nav-btn.active {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }

        /* Analytics Section */
        .analytics-section {
            display: none;
        }

        .analytics-section.active {
            display: block;
        }

        .dashboard-section {
            display: block;
        }

        .dashboard-section.hidden-section {
            display: none;
        }

        /* Supplement Insights */
        .insights-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .insights-loading .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8B5CF6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .insights-section-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #A78BFA;
            margin: 20px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insights-section-title:first-child {
            margin-top: 0;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .insight-card.positive {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .insight-card.negative {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.05);
        }

        .insight-card.pending {
            border-color: rgba(251, 191, 36, 0.3);
            background: rgba(251, 191, 36, 0.05);
        }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .insight-supp-name {
            font-weight: 600;
            color: #E8E8E8;
            font-size: 1em;
        }

        .insight-start-date {
            font-size: 0.8em;
            color: #666;
        }

        .insight-badge {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .insight-badge.positive {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .insight-badge.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        .insight-badge.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #FBBF24;
        }

        .insight-badge.neutral {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .insight-metric {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .insight-metric-label {
            font-size: 0.85em;
            color: #888;
            min-width: 80px;
        }

        .insight-metric-values {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .insight-metric-before {
            color: #666;
        }

        .insight-metric-arrow {
            color: #666;
        }

        .insight-metric-after {
            font-weight: 600;
            color: #E8E8E8;
        }

        .insight-metric-change {
            font-size: 0.85em;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 8px;
        }

        .insight-metric-change.positive {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .insight-metric-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        .insight-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            font-size: 0.8em;
            color: #666;
        }

        .insight-confidence {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .insight-confidence-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .insight-confidence-dot.high { background: #22C55E; }
        .insight-confidence-dot.medium { background: #F59E0B; }
        .insight-confidence-dot.low { background: #666; }

        .insight-adherence {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-streak {
            color: #F59E0B;
        }

        /* Consistency Cards */
        .consistency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .consistency-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 14px;
        }

        .consistency-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .consistency-name {
            font-weight: 600;
            color: #E8E8E8;
            font-size: 0.9em;
        }

        .consistency-streak {
            font-size: 0.8em;
            color: #F59E0B;
        }

        .consistency-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .consistency-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #A78BFA);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .consistency-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: #666;
        }

        .consistency-info {
            font-size: 0.75em;
            color: #888;
            font-style: italic;
            margin-top: 12px;
            padding: 10px;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 8px;
        }

        .insights-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .insights-empty-icon {
            font-size: 2em;
            margin-bottom: 12px;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: #A0A0A0;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Daily Check-in */
        .checkin-card {
            margin-top: 20px;
        }

        .checkin-date {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .checkin-date-text {
            font-weight: 600;
            color: #E8E8E8;
        }

        .checkin-supplements {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkin-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all 0.2s ease;
        }

        .checkin-item:hover {
            background: rgba(139, 92, 246, 0.05);
            border-color: rgba(139, 92, 246, 0.15);
        }

        .checkin-item.taken {
            background: rgba(34, 197, 94, 0.08);
            border-color: rgba(34, 197, 94, 0.2);
        }

        .checkin-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .checkin-checkbox.checked {
            background: #22C55E;
            border-color: #22C55E;
        }

        .checkin-checkbox.checked::after {
            content: '';
            color: #fff;
            font-size: 14px;
            font-weight: bold;
        }

        .checkin-info {
            flex: 1;
        }

        .checkin-name {
            font-weight: 500;
            color: #E8E8E8;
            margin-bottom: 2px;
        }

        .checkin-dose {
            font-size: 0.8em;
            color: #666;
        }

        .checkin-time-btns {
            display: flex;
            gap: 6px;
        }

        .checkin-time-btn {
            padding: 6px 12px;
            font-size: 0.75em;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 6px;
            color: #666;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .checkin-time-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .checkin-time-btn.active {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.3);
            color: #A78BFA;
        }

        /* Today's Stack - Quick Log */
        .todays-stack-card {
            margin-bottom: 20px;
        }

        .todays-stack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .todays-stack-title {
            font-weight: 600;
            color: #E8E8E8;
            font-size: 1.1em;
        }

        .todays-stack-date {
            font-size: 0.85em;
            color: #666;
        }

        .stack-pills {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .stack-pill {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 90px;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .stack-pill:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.25);
            transform: translateY(-2px);
        }

        .stack-pill:active {
            transform: translateY(0);
        }

        .stack-pill.taken {
            background: rgba(34, 197, 94, 0.12);
            border-color: rgba(34, 197, 94, 0.4);
        }

        .stack-pill.taken:hover {
            background: rgba(34, 197, 94, 0.18);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .stack-pill-check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #22C55E;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #fff;
            font-weight: bold;
        }

        .stack-pill.taken .stack-pill-check {
            display: flex;
        }

        .stack-pill-name {
            font-weight: 600;
            color: #E8E8E8;
            text-align: center;
            font-size: 0.95em;
            margin-bottom: 4px;
        }

        .stack-pill-dose {
            font-size: 0.75em;
            color: #666;
            text-align: center;
        }

        .stack-pill-time {
            font-size: 0.7em;
            color: #22C55E;
            margin-top: 6px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .stack-pill.taken .stack-pill-time {
            opacity: 1;
        }

        .stack-add-pill {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 12px;
            background: transparent;
            border: 2px dashed rgba(139, 92, 246, 0.25);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 90px;
            color: #8B5CF6;
        }

        .stack-add-pill:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: none;
            transform: translateY(-2px);
        }

        .stack-add-pill:active {
            transform: translateY(0);
        }

        .stack-add-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        .stack-add-text {
            font-size: 0.85em;
            font-weight: 500;
        }

        .stack-empty {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.05) 0%, transparent 100%);
            border-radius: 16px;
            border: 1px dashed rgba(139, 92, 246, 0.2);
        }

        .stack-empty-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .stack-empty-text {
            font-size: 1.15em;
            font-weight: 600;
            color: #E8E8E8;
            margin-bottom: 8px;
        }

        .stack-empty-hint {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 20px;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }

        .quick-add-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 8px;
        }

        .quick-add-btn {
            padding: 8px 14px;
            font-size: 0.85em;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            color: #A78BFA;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-add-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-1px);
            box-shadow: none;
        }

        /* Future date state for Your Stack */
        .stack-future {
            text-align: center;
            padding: 30px 20px;
            color: #666;
        }

        .stack-future-icon {
            font-size: 2em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .stack-future-text {
            font-size: 1em;
            font-weight: 500;
            color: #888;
            margin-bottom: 6px;
        }

        .stack-future-hint {
            font-size: 0.85em;
            color: #555;
        }

        /* Supplement Start Markers */
        .supplement-markers {
            margin-top: 20px;
        }

        .marker-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .marker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 20px;
            font-size: 0.85em;
        }

        .marker-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8B5CF6;
        }

        .marker-name {
            color: #A78BFA;
            font-weight: 500;
        }

        .marker-date {
            color: #666;
        }

        .add-marker-btn {
            padding: 8px 14px;
            font-size: 0.85em;
            background: transparent;
            border: 1px dashed rgba(139, 92, 246, 0.3);
            color: #8B5CF6;
            border-radius: 20px;
        }

        .add-marker-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-style: solid;
            box-shadow: none;
            transform: none;
        }

        /* Outcome Analysis Cards */
        .outcome-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .outcome-card {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .outcome-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .outcome-supplement {
            font-weight: 600;
            font-size: 1.05em;
            color: #E8E8E8;
        }

        .outcome-duration {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }

        .outcome-adherence {
            text-align: right;
        }

        .adherence-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #22C55E;
        }

        .adherence-label {
            font-size: 0.7em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .outcome-metrics {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .outcome-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-name {
            color: #A0A0A0;
            font-size: 0.9em;
        }

        .metric-change {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-values {
            font-size: 0.85em;
            color: #666;
        }

        .metric-diff {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .metric-diff.positive {
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
        }

        .metric-diff.negative {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        .metric-diff.neutral {
            background: rgba(255, 255, 255, 0.05);
            color: #666;
        }

        /* Confidence Badges */
        .outcome-badges {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .confidence-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .confidence-high {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .confidence-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
        }

        .confidence-low {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .confidence-warning {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        .conf-dot {
            font-size: 0.8em;
            opacity: 0.6;
        }

        .metric-trend {
            font-size: 0.9em;
            margin-left: 4px;
        }

        .confounding-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8em;
            color: #F59E0B;
            margin-bottom: 12px;
        }

        .insufficient-data-notice {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8em;
            color: #A78BFA;
            margin-bottom: 12px;
        }

        .outcome-card.insufficient-data {
            opacity: 0.7;
        }

        /* Correlation Cards */
        .correlation-section {
            margin-top: 20px;
        }

        .correlation-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .correlation-card {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .correlation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .correlation-supplement {
            font-weight: 600;
            font-size: 1.05em;
            color: #E8E8E8;
        }

        .correlation-days {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }

        .correlation-best {
            text-align: right;
        }

        .best-metric-label {
            font-size: 0.7em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .best-metric-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #22C55E;
        }

        .correlation-metrics {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .correlation-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
        }

        .corr-metric-name {
            color: #A0A0A0;
            font-size: 0.85em;
        }

        .corr-metric-diff {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .corr-diff-value {
            font-weight: 600;
            font-size: 0.9em;
        }

        .corr-diff-value.positive {
            color: #22C55E;
        }

        .corr-diff-value.negative {
            color: #EF4444;
        }

        .corr-strength {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.08);
            color: #888;
        }

        .corr-strength.strong {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .corr-strength.moderate {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
        }

        /* Life Events */
        .life-events-section {
            margin-top: 20px;
        }

        .life-event-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }

        .life-event-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .life-event-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .life-event-icon.positive {
            background: rgba(34, 197, 94, 0.15);
        }

        .life-event-icon.negative {
            background: rgba(239, 68, 68, 0.15);
        }

        .life-event-icon.neutral {
            background: rgba(255, 255, 255, 0.05);
        }

        .life-event-info {
            flex: 1;
        }

        .life-event-type {
            font-weight: 500;
            color: #E8E8E8;
        }

        .life-event-date {
            font-size: 0.8em;
            color: #666;
        }

        .life-event-delete {
            padding: 6px 10px;
            font-size: 0.8em;
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #EF4444;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .life-event-item:hover .life-event-delete {
            opacity: 1;
        }

        .life-event-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            box-shadow: none;
            transform: none;
        }

        /* Show delete on mobile (no hover) */
        @media (hover: none) {
            .life-event-delete {
                opacity: 1;
            }
        }

        /* Add Life Event Form */
        .add-event-form {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .add-event-form.visible {
            display: block;
        }

        .add-event-form .form-row {
            margin-bottom: 12px;
        }

        .add-event-btn {
            margin-top: 16px;
            padding: 10px 18px;
            font-size: 0.9em;
            background: transparent;
            border: 1px dashed rgba(139, 92, 246, 0.3);
            color: #8B5CF6;
            width: 100%;
        }

        .add-event-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-style: solid;
            box-shadow: none;
            transform: none;
        }

        /* Add Supplement Start Modal */
        .modal-form-row {
            margin-bottom: 16px;
        }

        .modal-form-row label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: #A0A0A0;
        }

        /* Your Supplements Section */
        .supplements-section {
            margin-bottom: 20px;
        }

        .supplements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .supplements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .supplement-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all 0.2s ease;
        }

        .supplement-card:hover {
            background: rgba(139, 92, 246, 0.05);
            border-color: rgba(139, 92, 246, 0.15);
        }

        .supplement-card.manual {
            border-left: 3px solid #22C55E;
        }

        .supplement-card.recommended {
            border-left: 3px solid #8B5CF6;
        }

        .supplement-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .supplement-icon.manual {
            background: rgba(34, 197, 94, 0.15);
        }

        .supplement-icon.recommended {
            background: rgba(139, 92, 246, 0.15);
        }

        .supplement-details {
            flex: 1;
            min-width: 0;
        }

        .supplement-name {
            font-weight: 500;
            color: #E8E8E8;
            margin-bottom: 2px;
        }

        .supplement-meta {
            font-size: 0.8em;
            color: #666;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .supplement-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 0.85em;
        }

        .supplement-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .supplement-card:hover .supplement-actions {
            opacity: 1;
        }

        .supplement-action-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #666;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .supplement-action-btn:hover {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .supplement-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        .supplement-action-btn.edit:hover {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }

        .supplement-action-btn.stop:hover {
            background: rgba(251, 191, 36, 0.15);
            color: #FBBF24;
        }

        /* Show actions on mobile (no hover) */
        @media (hover: none) {
            .supplement-actions {
                opacity: 1;
            }
        }

        .add-supplement-btn {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            color: #8B5CF6;
            font-size: 0.95em;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-supplement-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: none;
            transform: none;
        }

        .supplements-empty {
            text-align: center;
            padding: 30px 20px;
            color: #666;
        }

        .supplements-empty-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Supplement type badges */
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .type-badge.manual {
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
        }

        .type-badge.recommended {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }

        /* Updated marker colors for chart legend */
        .legend-marker {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8em;
            color: #666;
        }

        .legend-marker-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-marker-dot.manual {
            background: #22C55E;
        }

        .legend-marker-dot.recommended {
            background: #8B5CF6;
        }
    </style>
</head>
<body>
    <div id="status" class="hidden"></div>

    <div class="container">
        <h1>Dose</h1>

        <!-- Not logged in -->
        <div id="no-user">
            <div class="card signup-card">
                <div class="signup-header">
                    <div class="signup-logo"></div>
                    <h2>Welcome to Dose</h2>
                    <p class="signup-subtitle">Personalized supplement recommendations powered by your data</p>
                </div>

                <div class="signup-form">
                    <input type="text" id="user-name" placeholder="Your name" class="signup-input" required>
                    <input type="email" id="user-email" placeholder="Email address" class="signup-input" required>
                    <button onclick="createAccount()" class="signup-btn">
                        Get Started 
                    </button>
                </div>

                <div class="signup-features">
                    <div class="signup-feature">
                        <span class="feature-icon"></span>
                        <span>Track supplement effects</span>
                    </div>
                    <div class="signup-feature">
                        <span class="feature-icon"></span>
                        <span>Sync with Oura Ring</span>
                    </div>
                    <div class="signup-feature">
                        <span class="feature-icon"></span>
                        <span>Personalized dosing</span>
                    </div>
                </div>

                <div class="signin-section">
                    <span style="color: #666;">Already have an account?</span>
                    <a href="#" onclick="toggleSignIn(event)" class="signin-link">Sign in</a>
                </div>

                <div id="signin-form" class="hidden signin-form-container">
                    <input type="email" id="signin-email" placeholder="Email address" class="signup-input">
                    <button onclick="signIn()" class="signup-btn secondary">Sign In</button>
                </div>
            </div>
        </div>

        <!-- Logged in -->
        <div id="has-user" class="hidden">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <span class="user-name" id="display-name">User</span>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>

            <!-- Main Navigation -->
            <div class="main-nav">
                <button class="main-nav-btn active" onclick="switchMainTab('dashboard')" id="nav-dashboard">Dashboard</button>
                <button class="main-nav-btn" onclick="switchMainTab('analytics')" id="nav-analytics">Analytics</button>
            </div>

            <!-- Dashboard Section -->
            <div class="dashboard-section" id="dashboard-section">

            <!-- Getting Started Card (for new users) -->
            <div class="getting-started-card hidden" id="getting-started-card">
                <h3> Getting Started</h3>
                <p class="gs-subtitle">Complete these steps to get personalized insights</p>

                <div class="gs-progress">
                    <div class="gs-progress-bar">
                        <div class="gs-progress-fill" id="gs-progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="gs-progress-text" id="gs-progress-text">0/3</span>
                </div>

                <div class="gs-checklist">
                    <div class="gs-checklist-item" id="gs-item-oura">
                        <div class="gs-check-circle" id="gs-check-oura"></div>
                        <div class="gs-item-content">
                            <div class="gs-item-title">Connect Oura Ring</div>
                            <div class="gs-item-desc">Sync your sleep and recovery data</div>
                        </div>
                        <button class="gs-item-action" onclick="connectOura()">Connect</button>
                    </div>

                    <div class="gs-checklist-item" id="gs-item-supplements">
                        <div class="gs-check-circle" id="gs-check-supplements"></div>
                        <div class="gs-item-content">
                            <div class="gs-item-title">Add your supplements</div>
                            <div class="gs-item-desc">Track what you take daily</div>
                        </div>
                        <button class="gs-item-action" onclick="openAddManualSupplement()">Add</button>
                    </div>

                    <div class="gs-checklist-item" id="gs-item-log">
                        <div class="gs-check-circle" id="gs-check-log"></div>
                        <div class="gs-item-content">
                            <div class="gs-item-title">Log your first check-in</div>
                            <div class="gs-item-desc">Start building your history</div>
                        </div>
                        <button class="gs-item-action" onclick="switchMainTab('dashboard')">Log</button>
                    </div>
                </div>

                <button class="gs-dismiss" onclick="dismissGettingStarted()">Dismiss for now</button>
            </div>

            <!-- Oura Connection Card -->
            <div class="oura-card" id="oura-card">
                <div class="oura-header">
                    <div class="oura-brand">
                        <div class="oura-logo">&#x1F48D;</div>
                        <div>
                            <div class="oura-title">Oura Ring</div>
                            <div class="oura-subtitle">Health data sync</div>
                        </div>
                    </div>
                    <div class="oura-status disconnected" id="oura-status">
                        <span class="oura-status-dot"></span>
                        <span id="oura-status-text">Not connected</span>
                    </div>
                </div>

                <!-- Not connected state -->
                <div id="oura-not-connected">
                    <button class="oura-connect-btn" onclick="connectOura()">
                        Connect Oura Ring
                    </button>
                </div>

                <!-- Connected state with metrics -->
                <div id="oura-connected" class="hidden">
                    <div class="oura-date-label" id="oura-date-label" style="text-align: center; font-size: 0.75em; color: #666; margin-bottom: 8px;">Today's scores</div>
                    <div class="oura-metrics" id="oura-metrics">
                        <div class="oura-metric">
                            <div class="oura-metric-value" id="oura-sleep">--</div>
                            <div class="oura-metric-label">Sleep</div>
                        </div>
                        <div class="oura-metric">
                            <div class="oura-metric-value" id="oura-hrv">--</div>
                            <div class="oura-metric-label">HRV</div>
                        </div>
                        <div class="oura-metric">
                            <div class="oura-metric-value" id="oura-recovery">--</div>
                            <div class="oura-metric-label">Recovery</div>
                        </div>
                    </div>
                    <div class="oura-actions">
                        <button class="oura-sync-btn" onclick="syncOuraData()">
                            Sync Latest
                        </button>
                        <button class="oura-sync-btn" onclick="syncOuraFullHistory()" style="background: rgba(139, 92, 246, 0.3);">
                            Sync Full History
                        </button>
                        <button class="oura-disconnect-btn" onclick="disconnectOura()">
                            Disconnect
                        </button>
                    </div>
                </div>

                <!-- Loading state -->
                <div id="oura-loading" class="oura-loading hidden">
                    Checking connection...
                </div>
            </div>

            <!-- Your Stack - Quick Log -->
            <div class="card todays-stack-card">
                <div class="todays-stack-header">
                    <span class="todays-stack-title">Your Stack</span>
                    <span class="todays-stack-date" id="todays-stack-date">Loading...</span>
                </div>
                <div class="stack-pills" id="stack-pills">
                    <div class="stack-empty">
                        <div class="stack-empty-icon"></div>
                        <div class="stack-empty-text">Loading your supplements...</div>
                    </div>
                </div>
            </div>

            <!-- Date Navigation -->
            <div class="date-nav">
                <button onclick="changeDate(-1)" title="Previous day">&#8592;</button>
                <div class="date-display">
                    <div class="day" id="date-day">Today</div>
                    <div class="full-date" id="date-full">January 15, 2026</div>
                </div>
                <button onclick="changeDate(1)" title="Next day">&#8594;</button>
            </div>

            <!-- Time Selector -->
            <div class="time-selector">
                <button class="time-btn" onclick="setTime(7)" id="time-btn-morning">Morning</button>
                <button class="time-btn active" onclick="setTime(14)" id="time-btn-afternoon">Afternoon</button>
                <button class="time-btn" onclick="setTime(21)" id="time-btn-evening">Evening</button>
            </div>

            <!-- Dispenser Card -->
            <div class="card">
                <h2>What do you need today?</h2>

                <div class="dispenser-layout" id="dispenser-layout">
                    <!-- AI Recommendation -->
                    <div class="ai-recommendation" onclick="getAIRecommendation()" id="ai-recommendation">
                        <div class="ai-icon">&#x2728;</div>
                        <div class="ai-title">Smart Recommendation</div>
                        <div class="ai-subtitle" id="ai-subtitle">Connect Oura for personalized insights</div>
                    </div>

                    <!-- Daily Foundation - Always visible below AI -->
                    <div class="daily-foundation" onclick="selectDailyFoundation()" id="daily-foundation">
                        <div class="df-icon">&#x1F48E;</div>
                        <div class="df-name">Daily Foundation</div>
                        <div class="df-contents">D3 + K2 + Omega-3</div>
                        <div class="df-status" id="df-status">Tap to dispense</div>
                    </div>

                    <!-- Mix cards populated by JS -->
                </div>
            </div>

            <!-- Tracking Card -->
            <div class="card" id="tracking-card">
                <h2>Your Supplement Intake</h2>

                <div class="tracking-tabs">
                    <button class="tracking-tab active" onclick="switchTrackingTab('daily')" id="tab-daily">Today</button>
                    <button class="tracking-tab" onclick="switchTrackingTab('weekly')" id="tab-weekly">This Week</button>
                </div>

                <div class="tracking-content" id="tracking-content">
                    <div class="empty-state">
                        <div class="emoji">&#x1F48A;</div>
                        <div>No supplements taken yet</div>
                    </div>
                </div>

                <!-- Saturation Gauge -->
                <div class="saturation-gauge" id="saturation-gauge">
                    <div class="saturation-title">
                        <span>&#x26A1;</span> Saturation Tracking
                    </div>
                    <div id="saturation-content">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Custom Blends Card -->
            <div class="card" id="custom-blends-card">
                <div class="custom-blends-header">
                    <h2>Your Custom Blends</h2>
                    <button class="btn-create-blend" onclick="openBlendBuilder()">+ Create Blend</button>
                </div>
                <div id="custom-blends-list">
                    <div class="empty-state">
                        <div class="emoji">&#x1F9EA;</div>
                        <div>No custom blends yet</div>
                        <div style="font-size: 0.8em; color: #333; margin-top: 6px;">
                            Create your own supplement combinations
                        </div>
                    </div>
                </div>
            </div>

            </div><!-- End Dashboard Section -->

            <!-- Analytics Section -->
            <div class="analytics-section" id="analytics-section">
                <!-- My Supplements Section -->
                <div class="card supplements-section">
                    <div class="supplements-header">
                        <h2>My Supplements</h2>
                        <button class="btn-secondary" onclick="openAddManualSupplement()" style="padding: 8px 16px; font-size: 0.85em;">+ Add Supplement</button>
                    </div>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 16px;">Supplements you're currently taking. Add start dates to track their effects on your health.</p>
                    <div class="supplements-grid" id="supplements-grid">
                        <div class="supplements-empty">
                            <div class="supplements-empty-icon"></div>
                            <div>No supplements tracked yet</div>
                            <div style="font-size: 0.85em; margin-top: 6px;">Add the supplements you're currently taking</div>
                        </div>
                    </div>
                </div>

                <!-- Supplement Insights -->
                <div class="card" id="insights-card">
                    <h2>Supplement Insights</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 16px;">See how your supplements are affecting your health metrics.</p>

                    <div id="insights-content">
                        <div class="insights-loading">
                            <div class="spinner"></div>
                            <div>Analyzing your data...</div>
                        </div>
                    </div>
                </div>

                <!-- Health Metrics Chart -->
                <div class="card">
                    <h2>Health Metrics Over Time</h2>
                    <div class="chart-container">
                        <canvas id="health-chart"></canvas>
                        <!-- Overlay for when Oura not connected -->
                        <div class="chart-overlay hidden" id="chart-overlay">
                            <div class="chart-overlay-icon"></div>
                            <h3>See Your Health Trends</h3>
                            <p>Connect your Oura Ring to visualize sleep, HRV, and recovery data over time</p>
                            <button class="chart-overlay-btn" onclick="connectOura()">Connect Oura</button>
                        </div>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #8B5CF6;"></div>
                            <span>Sleep Score</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #22C55E;"></div>
                            <span>HRV</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #F59E0B;"></div>
                            <span>Recovery</span>
                        </div>
                    </div>

                    <!-- Supplement Start Markers -->
                    <div class="supplement-markers">
                        <h3 style="font-size: 0.95em; color: #A0A0A0; margin-bottom: 8px;">Supplement Markers on Chart</h3>
                        <div class="marker-list" id="supplement-markers-list">
                            <button class="add-marker-btn" onclick="openAddSupplementStart()">+ Add Supplement Start</button>
                        </div>
                    </div>
                </div>

                <!-- Outcome Analysis -->
                <div class="card">
                    <h2>Outcome Analysis</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 16px;">Compare your health metrics before and after starting each supplement.  high confidence,  medium,  low</p>
                    <div class="outcome-cards" id="outcome-cards">
                        <div class="empty-state">
                            <div class="emoji">&#x1F4CA;</div>
                            <div>Add supplement start dates to see analysis</div>
                        </div>
                    </div>
                </div>

                <!-- Correlation Insights -->
                <div class="card correlation-section">
                    <h2>Correlation Insights</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 16px;">See how your metrics differ on days you take each supplement vs days you don't</p>
                    <div class="correlation-cards" id="correlation-cards">
                        <div class="empty-state">
                            <div class="emoji"></div>
                            <div>Log daily supplement intake to see correlations</div>
                        </div>
                    </div>
                </div>

                <!-- Life Events -->
                <div class="card life-events-section">
                    <h2>Life Events</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 12px;">Track events that might affect your health metrics</p>
                    <div class="life-event-list" id="life-events-list">
                        <!-- Populated by JS -->
                    </div>
                    <button class="add-event-btn" onclick="toggleAddEventForm()">+ Log Life Event</button>
                    <div class="add-event-form" id="add-event-form">
                        <div class="form-row">
                            <input type="date" id="event-date" style="flex: 1;">
                            <select id="event-type" style="flex: 1;">
                                <option value="">Select event type...</option>
                                <option value="new_job">New job/work stress</option>
                                <option value="changed_mattress">Changed mattress</option>
                                <option value="moved">Moved homes</option>
                                <option value="started_exercise">Started exercising</option>
                                <option value="stopped_exercise">Stopped exercising</option>
                                <option value="sick">Got sick</option>
                                <option value="travel">Travel/jet lag</option>
                                <option value="relationship">Relationship change</option>
                                <option value="diet_change">Major diet change</option>
                                <option value="medication">Started/stopped medication</option>
                                <option value="stress">Major stress event</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <input type="text" id="event-description" placeholder="Optional description..." style="flex: 2;">
                            <select id="event-impact" style="flex: 1;">
                                <option value="neutral">Neutral</option>
                                <option value="positive">Positive</option>
                                <option value="negative">Negative</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button class="btn-secondary" onclick="toggleAddEventForm()" style="flex: 1;">Cancel</button>
                            <button onclick="saveLifeEvent()" style="flex: 1;">Save Event</button>
                        </div>
                    </div>
                </div>
            </div><!-- End Analytics Section -->

        </div>
    </div>

    <!-- Add Supplement Modal (supports both manual and recommended) -->
    <div class="modal-overlay hidden" id="supplement-start-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="text-align: left; margin-bottom: 18px;">
                <div class="modal-title" id="supplement-modal-title">Add Supplement</div>
                <div class="modal-subtitle" id="supplement-modal-subtitle">Track a supplement you're taking</div>
            </div>
            <div class="modal-form-row">
                <label>Supplement</label>
                <select id="start-supplement-id" style="width: 100%;" onchange="onSupplementSelect()">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div class="modal-form-row" id="custom-name-row" style="display: none;">
                <label>Custom Name</label>
                <input type="text" id="start-supplement-name" placeholder="Enter supplement name" style="width: 100%;">
            </div>
            <div class="modal-form-row">
                <label>Dosage</label>
                <input type="text" id="start-dosage" placeholder="e.g., 500mg, 2000 IU" style="width: 100%;">
            </div>
            <div class="form-row">
                <div class="modal-form-row" style="flex: 1;">
                    <label>Frequency</label>
                    <select id="start-frequency" style="width: 100%;">
                        <option value="daily">Once daily</option>
                        <option value="twice_daily">Twice daily</option>
                        <option value="three_times">Three times daily</option>
                        <option value="as_needed">As needed</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>
                <div class="modal-form-row" style="flex: 1;">
                    <label>Start Date</label>
                    <input type="date" id="start-date" style="width: 100%;" onchange="checkBackdateAdherence()">
                </div>
            </div>
            <div class="modal-form-row">
                <label>Goal / Reason</label>
                <select id="start-reason" style="width: 100%;">
                    <option value="">Select reason (optional)</option>
                    <option value="sleep">Better Sleep</option>
                    <option value="energy">More Energy</option>
                    <option value="recovery">Exercise Recovery</option>
                    <option value="focus">Focus & Cognition</option>
                    <option value="stress">Stress & Mood</option>
                    <option value="immunity">Immune Support</option>
                    <option value="general_health">General Health</option>
                    <option value="deficiency">Address Deficiency</option>
                </select>
            </div>
            <div class="modal-form-row">
                <label>Notes (optional)</label>
                <input type="text" id="start-notes" placeholder="Any additional notes..." style="width: 100%;">
            </div>
            <div class="modal-form-row" id="adherence-row" style="display: none;">
                <label>Estimated Adherence</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="range" id="start-adherence" min="0" max="100" value="80" style="flex: 1;" oninput="updateAdherenceLabel()">
                    <span id="adherence-label" style="min-width: 45px; text-align: right;">80%</span>
                </div>
                <div style="font-size: 0.75em; color: #666; margin-top: 4px;">
                    We'll auto-fill past logs based on this percentage
                </div>
            </div>
            <input type="hidden" id="start-is-manual" value="true">
            <input type="hidden" id="edit-supplement-id" value="">
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn-cancel" onclick="closeSupplementStartModal()">Cancel</button>
                <button id="supplement-save-btn" onclick="saveSupplementStart()">Add Supplement</button>
            </div>
        </div>
    </div>

    <!-- Blend Builder Modal -->
    <div class="modal-overlay hidden" id="blend-builder-modal">
        <div class="modal-content blend-builder" id="blend-builder-content">
            <div class="modal-header" style="text-align: left; margin-bottom: 18px;">
                <div class="modal-title">Create Custom Blend</div>
                <div class="modal-subtitle">Select supplements and customize doses</div>
            </div>

            <div class="blend-builder-header">
                <input type="text" id="blend-name" placeholder="Blend name (e.g. My Morning Stack)">
                <input type="text" id="blend-icon" class="icon-picker" value="&#x1F9EA;" maxlength="2" onclick="this.select()">
            </div>

            <!-- AI Assistant Section -->
            <div class="ai-blend-section">
                <div class="ai-blend-header">
                    <span class="ai-icon">&#x2728;</span>
                    <div>
                        <h3>AI Blend Assistant</h3>
                        <span>Describe what you want and I'll suggest supplements</span>
                    </div>
                </div>
                <div class="ai-input-row">
                    <textarea id="ai-blend-input" placeholder="Example: I want better sleep and less stress, but I also need energy in the morning without feeling jittery..."></textarea>
                    <button onclick="getAIBlendSuggestion()">Suggest</button>
                </div>
                <div class="ai-suggestions" id="ai-suggestions">
                    <div class="ai-suggestions-header">
                        <span class="ai-suggestions-title">Suggested Supplements</span>
                        <button class="btn-add-all" onclick="addAllSuggestions()">+ Add All</button>
                    </div>
                    <div id="ai-suggestions-list"></div>
                </div>
            </div>

            <div class="supplement-categories" id="supplement-categories">
                <!-- Populated by JS -->
            </div>

            <div class="supplement-grid" id="supplement-grid">
                <!-- Populated by JS -->
            </div>

            <div class="selected-supplements" id="selected-supplements" style="display: none;">
                <div class="selected-supplements-title">Selected Supplements</div>
                <div id="selected-supplements-list"></div>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeBlendBuilder()">Cancel</button>
                <button class="btn-dispense" onclick="saveCustomBlend()" id="save-blend-btn">
                    Save Blend
                </button>
            </div>
        </div>
    </div>

    <!-- Supplement Info Modal -->
    <div class="modal-overlay hidden" id="supp-info-modal">
        <div class="modal-content supp-info-modal" id="supp-info-content">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Dispense Modal -->
    <div class="modal-overlay hidden" id="dispense-modal">
        <div class="modal-content" id="modal-content">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Settings Toggle -->
    <button class="settings-toggle" onclick="toggleSettings()" title="Settings">
        <span>&#x2699;</span>
    </button>

    <!-- Settings Panel -->
    <div class="settings-panel hidden" id="settings-panel">
        <h3>Settings</h3>
        <div class="setting-row">
            <label>Simulate Health Data</label>
            <select id="scenario" onchange="loadScenario()">
                <option value="none">-- Select scenario --</option>
                <option value="average">Average Day</option>
                <option value="poor_sleep">Poor Sleep</option>
                <option value="high_strain">High Strain</option>
                <option value="stressed">Stressed</option>
                <option value="recovering">Recovering Well</option>
            </select>
        </div>
        <div class="setting-row">
            <label>Connect Wearable</label>
            <button onclick="connectOura()" class="btn-secondary" style="width: 100%; margin-top: 6px;">
                Connect Oura Ring
            </button>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal-overlay hidden" id="onboarding-modal">
        <div class="modal-content onboarding-modal-content">
            <!-- Progress indicator (built dynamically by JS) -->
            <div class="onboarding-progress"></div>

            <!-- Step content container -->
            <div id="onboarding-content"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-links">
            <a href="/privacy">Privacy Policy</a>
            <a href="/terms">Terms of Service</a>
        </div>
        <div class="footer-copyright">
            &copy; 2026 Dose. All rights reserved.
        </div>
    </footer>

    <script>
        // State
        let currentUserId = localStorage.getItem('userId');
        let currentDate = new Date();
        let currentTime = 14;
        let availableMixes = [];
        let customBlends = [];
        let currentMixData = null;
        let isDispensing = false;
        let trackingTab = 'daily';
        let ouraConnected = false;
        let ouraData = null;

        // Analytics State
        let healthChart = null;
        let analyticsData = null;
        let supplementList = []; // List of all supplements for dropdown

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check for Oura OAuth callback
            checkOuraCallback();

            if (currentUserId) {
                loadUserAndShow();
            }
            updateDateDisplay();
            updateTimeButtons();
        });

        // Check Oura OAuth callback from URL params
        function checkOuraCallback() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('oura_connected') === 'true') {
                showStatus('Oura Ring connected successfully!', 'success');
                // Clean URL
                window.history.replaceState({}, document.title, '/');
            } else if (params.get('oura_error')) {
                showStatus('Failed to connect Oura: ' + params.get('oura_error'), 'error');
                window.history.replaceState({}, document.title, '/');
            }
        }

        // Status messages
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 4000);
        }

        // ========== OURA INTEGRATION ==========

        // Connect Oura - redirect to OAuth
        function connectOura() {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }
            // Redirect to Oura OAuth
            window.location.href = `/api/oura/auth?user_id=${currentUserId}`;
        }

        // Check Oura connection status
        async function checkOuraStatus() {
            if (!currentUserId) return;

            const card = document.getElementById('oura-card');
            const loading = document.getElementById('oura-loading');
            const notConnected = document.getElementById('oura-not-connected');
            const connected = document.getElementById('oura-connected');
            const status = document.getElementById('oura-status');
            const statusText = document.getElementById('oura-status-text');

            // Show loading
            loading.classList.remove('hidden');
            notConnected.classList.add('hidden');
            connected.classList.add('hidden');

            try {
                const res = await fetch(`/integrations/${currentUserId}/oura/status`);
                const data = await res.json();

                loading.classList.add('hidden');

                if (data.connected) {
                    ouraConnected = true;
                    status.className = 'oura-status connected';
                    statusText.textContent = 'Connected';
                    notConnected.classList.add('hidden');
                    connected.classList.remove('hidden');
                    updateAISubtitle();
                    updateProgressiveDisclosure();
                    // Fetch latest data
                    await fetchOuraHistory();
                } else {
                    ouraConnected = false;
                    status.className = 'oura-status disconnected';
                    statusText.textContent = 'Not connected';
                    notConnected.classList.remove('hidden');
                    connected.classList.add('hidden');
                    updateAISubtitle();
                    updateProgressiveDisclosure();
                }
            } catch (e) {
                loading.classList.add('hidden');
                notConnected.classList.remove('hidden');
                connected.classList.add('hidden');
                console.error('Error checking Oura status:', e);
            }
        }

        // Fetch Oura history data (just syncs data, doesn't update display)
        async function fetchOuraHistory() {
            if (!currentUserId) return;

            try {
                // Sync latest 7 days of data to the database
                const res = await fetch(`/integrations/${currentUserId}/oura/history?days=7`);
                if (res.ok) {
                    // Data is now synced to database
                    // The display will be updated by updateOuraMetricsForSelectedDate()
                    // which uses analyticsData.health_data for the selected date
                    console.log('Oura history synced');
                }
            } catch (e) {
                console.error('Error fetching Oura data:', e);
            }
        }

        // Update AI subtitle based on Oura status
        function updateAISubtitle() {
            const subtitle = document.getElementById('ai-subtitle');
            if (subtitle) {
                subtitle.textContent = ouraConnected ? 'Powered by your Oura Ring data' : 'Connect Oura for personalized insights';
            }
        }

        // Update Oura metrics display
        function updateOuraMetrics(data) {
            const sleepEl = document.getElementById('oura-sleep');
            const hrvEl = document.getElementById('oura-hrv');
            const recoveryEl = document.getElementById('oura-recovery');

            // Sleep score
            if (data.sleep_score != null) {
                sleepEl.textContent = Math.round(data.sleep_score);
                sleepEl.className = 'oura-metric-value ' + getScoreClass(data.sleep_score);
            } else {
                sleepEl.textContent = '--';
                sleepEl.className = 'oura-metric-value';
            }

            // HRV score
            if (data.hrv_score != null) {
                hrvEl.textContent = Math.round(data.hrv_score);
                hrvEl.className = 'oura-metric-value ' + getScoreClass(data.hrv_score);
            } else {
                hrvEl.textContent = '--';
                hrvEl.className = 'oura-metric-value';
            }

            // Recovery score
            if (data.recovery_score != null) {
                recoveryEl.textContent = Math.round(data.recovery_score);
                recoveryEl.className = 'oura-metric-value ' + getScoreClass(data.recovery_score);
            } else {
                recoveryEl.textContent = '--';
                recoveryEl.className = 'oura-metric-value';
            }
        }

        // Update Oura metrics for the currently selected date
        function updateOuraMetricsForSelectedDate() {
            if (!ouraConnected) return;

            const dateLabel = document.getElementById('oura-date-label');
            const selectedDateStr = currentDate.toISOString().split('T')[0];

            // Check if today or future
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selected = new Date(currentDate);
            selected.setHours(0, 0, 0, 0);
            const isToday = today.getTime() === selected.getTime();
            const isFuture = selected.getTime() > today.getTime();

            // Handle future dates
            if (isFuture) {
                updateOuraMetrics({ sleep_score: null, hrv_score: null, recovery_score: null });
                const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
                dateLabel.textContent = currentDate.toLocaleDateString('en-US', dateOptions) + ' (future)';
                return;
            }

            // Find health data for this date from analyticsData
            const healthData = analyticsData?.health_data || [];
            const dayData = healthData.find(h => h.date === selectedDateStr);

            if (dayData) {
                updateOuraMetrics(dayData);
                if (isToday) {
                    dateLabel.textContent = "Today's scores";
                } else {
                    const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
                    dateLabel.textContent = currentDate.toLocaleDateString('en-US', dateOptions);
                }
            } else {
                // No data for this date
                updateOuraMetrics({ sleep_score: null, hrv_score: null, recovery_score: null });
                if (isToday) {
                    dateLabel.textContent = "No data yet today";
                } else {
                    const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
                    dateLabel.textContent = currentDate.toLocaleDateString('en-US', dateOptions) + ' (no data)';
                }
            }
        }

        // Get CSS class based on score
        function getScoreClass(score) {
            if (score >= 70) return 'good';
            if (score >= 50) return 'fair';
            return 'poor';
        }

        // Sync Oura data (fetch last 7 days to ensure we get today's data)
        async function syncOuraData() {
            if (!currentUserId) return;

            const btn = document.querySelector('.oura-sync-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Syncing...';
            btn.disabled = true;

            try {
                // Use history endpoint with 7 days to properly store date-specific data
                const res = await fetch(`/integrations/${currentUserId}/oura/history?days=7`);

                if (res.ok) {
                    const result = await res.json();
                    // Refresh analytics data to get new health scores
                    const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                    if (analyticsRes.ok) {
                        analyticsData = await analyticsRes.json();
                        updateOuraMetricsForSelectedDate();
                    }
                    const added = result.records_added || 0;
                    showStatus(added > 0 ? `Synced ${added} day(s) of data!` : 'Data is up to date!', 'success');
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Sync failed', 'error');
                }
            } catch (e) {
                showStatus('Error syncing: ' + e.message, 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Sync full Oura history (up to 365 days)
        async function syncOuraFullHistory() {
            if (!currentUserId) return;

            if (!confirm('Sync your full Oura history? This may take a moment and will fetch up to 12 months of data.')) {
                return;
            }

            const btns = document.querySelectorAll('.oura-sync-btn');
            btns.forEach(btn => {
                btn.disabled = true;
            });
            showStatus('Syncing full history... This may take a moment.', 'success');

            try {
                // Fetch 365 days of history
                const res = await fetch(`/integrations/${currentUserId}/oura/history?days=365`);

                if (res.ok) {
                    const data = await res.json();
                    showStatus(`Full history synced! Added ${data.records_added || 0} days of data.`, 'success');

                    // Refresh analytics data and update Oura display
                    const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                    if (analyticsRes.ok) {
                        analyticsData = await analyticsRes.json();
                        updateOuraMetricsForSelectedDate();
                        // Also refresh chart if on analytics tab
                        if (document.getElementById('analytics-section').classList.contains('active')) {
                            renderHealthChart();
                        }
                    }
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Failed to sync full history', 'error');
                }
            } catch (e) {
                showStatus('Error syncing history: ' + e.message, 'error');
            } finally {
                btns.forEach(btn => {
                    btn.disabled = false;
                });
            }
        }

        // Disconnect Oura
        async function disconnectOura() {
            if (!currentUserId) return;

            if (!confirm('Disconnect your Oura Ring?')) return;

            try {
                const res = await fetch(`/integrations/${currentUserId}/oura`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    ouraConnected = false;
                    ouraData = null;

                    const status = document.getElementById('oura-status');
                    const statusText = document.getElementById('oura-status-text');
                    const notConnected = document.getElementById('oura-not-connected');
                    const connected = document.getElementById('oura-connected');

                    status.className = 'oura-status disconnected';
                    statusText.textContent = 'Not connected';
                    notConnected.classList.remove('hidden');
                    connected.classList.add('hidden');
                    updateAISubtitle();

                    showStatus('Oura Ring disconnected', 'success');
                }
            } catch (e) {
                showStatus('Error disconnecting: ' + e.message, 'error');
            }
        }

        // ========== END OURA INTEGRATION ==========

        // Toggle sign in form
        function toggleSignIn(e) {
            e.preventDefault();
            document.getElementById('signin-form').classList.toggle('hidden');
        }

        // Create account
        async function createAccount() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();

            if (!name || !email) {
                showStatus('Please enter your name and email', 'error');
                return;
            }

            try {
                const res = await fetch('/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });

                if (res.ok) {
                    const user = await res.json();
                    currentUserId = user.id;
                    localStorage.setItem('userId', user.id);
                    showLoggedIn(user);
                    // Show onboarding to collect profile data
                    showOnboarding();
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error creating account', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // ==================== ONBOARDING ====================

        let onboardingStep = 1;
        const ONBOARDING_TOTAL_STEPS = 6; // About You, Lifestyle, Sleep, Oura, Supplements, Goal
        let onboardingData = {
            // Profile - Step 1: About You
            age: null,
            sex: null,
            height_feet: null,
            height_inches: null,
            weight_lbs: null,
            // Profile - Step 2: Lifestyle
            region: null,
            activity_level: null,
            work_environment: null,
            diet_type: null,
            // Profile - Step 3: Sleep
            chronotype: null,
            // Step 4: Oura
            ouraConnected: false,
            // Step 5: Supplements
            selectedSupplements: [], // { id, name, dosage, duration }
            // Step 6: Goals (multi-select)
            goals: []
        };

        // Icons for common supplements (used in onboarding search)
        const SUPPLEMENT_ICONS = {
            'vitamin_d3': '',
            'fish_oil': '',
            'magnesium': '',
            'magnesium_glycinate': '',
            'vitamin_b12': '',
            'b_complex': '',
            'ashwagandha': '',
            'zinc': '',
            'creatine': '',
            'protein_powder': '',
            'melatonin': '',
            'vitamin_c': '',
            'iron': '',
            'calcium': '',
            'probiotics': '',
            'collagen': '',
            'turmeric': '',
            'default': ''
        };

        function getSupplementIcon(id) {
            return SUPPLEMENT_ICONS[id] || SUPPLEMENT_ICONS['default'];
        }

        // Helper to escape HTML attributes
        function escapeAttr(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function showOnboarding() {
            document.getElementById('onboarding-modal').classList.remove('hidden');
            onboardingStep = 1;
            onboardingData = {
                age: null,
                sex: null,
                height_feet: null,
                height_inches: null,
                weight_lbs: null,
                region: null,
                activity_level: null,
                work_environment: null,
                diet_type: null,
                chronotype: null,
                ouraConnected: false,
                selectedSupplements: [],
                goals: []
            };
            renderOnboardingStep(1);
        }

        function renderOnboardingStep(step) {
            onboardingStep = step;
            updateProgressIndicator(step);
            const content = document.getElementById('onboarding-content');

            switch(step) {
                case 1:
                    content.innerHTML = getStepAboutYouHTML();
                    break;
                case 2:
                    content.innerHTML = getStepLifestyleHTML();
                    break;
                case 3:
                    content.innerHTML = getStepSleepHTML();
                    break;
                case 4:
                    content.innerHTML = getStepOuraHTML();
                    break;
                case 5:
                    content.innerHTML = getStepSupplementsHTML();
                    setTimeout(() => filterOnboardingSupplements(''), 10);
                    break;
                case 6:
                    content.innerHTML = getStepGoalHTML();
                    break;
                case 7:
                    content.innerHTML = getCompletionHTML();
                    break;
            }
        }

        function updateProgressIndicator(currentStep) {
            const progressContainer = document.querySelector('.onboarding-progress');
            if (!progressContainer) return;

            // Build progress indicator HTML dynamically for 6 steps
            let progressHTML = '';
            for (let i = 1; i <= ONBOARDING_TOTAL_STEPS; i++) {
                const isActive = i === currentStep;
                const isCompleted = i < currentStep;
                progressHTML += `<div class="progress-step ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">${i}</div>`;
                if (i < ONBOARDING_TOTAL_STEPS) {
                    progressHTML += `<div class="progress-line ${isCompleted ? 'completed' : ''}"></div>`;
                }
            }
            progressContainer.innerHTML = progressHTML;
        }

        function nextOnboardingStep() {
            renderOnboardingStep(onboardingStep + 1);
        }

        function prevOnboardingStep() {
            if (onboardingStep > 1) {
                renderOnboardingStep(onboardingStep - 1);
            }
        }

        // Step 1: About You (age, sex, height, weight)
        function getStepAboutYouHTML() {
            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration"></div>
                    <h2>About You</h2>
                    <p class="onboarding-subtitle">Help us personalize your supplement doses</p>

                    <div class="onboarding-form-grid">
                        <div class="onboarding-field">
                            <label>Age</label>
                            <input type="number" id="ob-age" placeholder="30" min="18" max="100"
                                   value="${onboardingData.age || ''}"
                                   onchange="onboardingData.age = parseInt(this.value)">
                        </div>
                        <div class="onboarding-field">
                            <label>Sex</label>
                            <div class="onboarding-pill-group">
                                <button class="ob-pill ${onboardingData.sex === 'male' ? 'selected' : ''}" onclick="selectSex('male')">Male</button>
                                <button class="ob-pill ${onboardingData.sex === 'female' ? 'selected' : ''}" onclick="selectSex('female')">Female</button>
                                <button class="ob-pill ${onboardingData.sex === 'other' ? 'selected' : ''}" onclick="selectSex('other')">Other</button>
                            </div>
                        </div>
                    </div>

                    <div class="onboarding-form-grid">
                        <div class="onboarding-field">
                            <label>Height</label>
                            <div class="height-inputs">
                                <input type="number" id="ob-height-ft" placeholder="5" min="3" max="8"
                                       value="${onboardingData.height_feet || ''}"
                                       onchange="onboardingData.height_feet = parseInt(this.value)">
                                <span class="height-unit">ft</span>
                                <input type="number" id="ob-height-in" placeholder="10" min="0" max="11"
                                       value="${onboardingData.height_inches || ''}"
                                       onchange="onboardingData.height_inches = parseInt(this.value)">
                                <span class="height-unit">in</span>
                            </div>
                        </div>
                        <div class="onboarding-field">
                            <label>Weight</label>
                            <div class="weight-input">
                                <input type="number" id="ob-weight" placeholder="170" step="1"
                                       value="${onboardingData.weight_lbs || ''}"
                                       onchange="onboardingData.weight_lbs = parseFloat(this.value)">
                                <span class="weight-unit">lbs</span>
                            </div>
                        </div>
                    </div>

                    <button class="onboarding-btn primary" onclick="nextOnboardingStep()">
                        Continue
                    </button>
                    <button class="onboarding-btn secondary" onclick="nextOnboardingStep()">
                        Skip for now
                    </button>
                </div>
            `;
        }

        function selectSex(value) {
            onboardingData.sex = value;
            document.querySelectorAll('.onboarding-pill-group .ob-pill').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent.toLowerCase() === value);
            });
        }

        // Step 2: Lifestyle (region, activity, work, diet)
        function getStepLifestyleHTML() {
            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration"></div>
                    <h2>Your Lifestyle</h2>
                    <p class="onboarding-subtitle">This helps us optimize your recommendations</p>

                    <div class="lifestyle-grid">
                        <div class="lifestyle-card" onclick="showLifestyleOptions('region')">
                            <span class="lifestyle-icon"></span>
                            <span class="lifestyle-label">Location</span>
                            <span class="lifestyle-value" id="lifestyle-region">${getRegionLabel(onboardingData.region) || 'Select'}</span>
                        </div>
                        <div class="lifestyle-card" onclick="showLifestyleOptions('activity')">
                            <span class="lifestyle-icon"></span>
                            <span class="lifestyle-label">Activity</span>
                            <span class="lifestyle-value" id="lifestyle-activity">${getActivityLabel(onboardingData.activity_level) || 'Select'}</span>
                        </div>
                        <div class="lifestyle-card" onclick="showLifestyleOptions('work')">
                            <span class="lifestyle-icon"></span>
                            <span class="lifestyle-label">Work</span>
                            <span class="lifestyle-value" id="lifestyle-work">${getWorkLabel(onboardingData.work_environment) || 'Select'}</span>
                        </div>
                        <div class="lifestyle-card" onclick="showLifestyleOptions('diet')">
                            <span class="lifestyle-icon"></span>
                            <span class="lifestyle-label">Diet</span>
                            <span class="lifestyle-value" id="lifestyle-diet">${getDietLabel(onboardingData.diet_type) || 'Select'}</span>
                        </div>
                    </div>

                    <div class="lifestyle-options hidden" id="lifestyle-options">
                        <!-- Populated dynamically -->
                    </div>

                    <div class="onboarding-nav">
                        <button class="onboarding-btn back" onclick="prevOnboardingStep()"> Back</button>
                        <button class="onboarding-btn primary" onclick="nextOnboardingStep()">Continue</button>
                    </div>
                </div>
            `;
        }

        const LIFESTYLE_OPTIONS = {
            region: [
                { value: 'northern', label: 'Northern', desc: 'Seattle, Boston, Chicago' },
                { value: 'central', label: 'Central', desc: 'NYC, Denver, SF' },
                { value: 'southern', label: 'Southern', desc: 'LA, Phoenix, Atlanta' },
                { value: 'gulf', label: 'Gulf/Florida', desc: 'Miami, Houston' }
            ],
            activity: [
                { value: 'sedentary', label: 'Sedentary', desc: 'Desk job, minimal exercise' },
                { value: 'light', label: 'Light', desc: 'Exercise 1-2x/week' },
                { value: 'moderate', label: 'Moderate', desc: 'Exercise 3-4x/week' },
                { value: 'active', label: 'Active', desc: 'Exercise 5-6x/week' },
                { value: 'athlete', label: 'Athlete', desc: 'Intense training daily' }
            ],
            work: [
                { value: 'office', label: 'Office', desc: 'Indoor workplace' },
                { value: 'remote', label: 'Remote', desc: 'Work from home' },
                { value: 'outdoor', label: 'Outdoor', desc: 'Outside most of the day' },
                { value: 'shift', label: 'Shift Work', desc: 'Irregular hours' }
            ],
            diet: [
                { value: 'omnivore', label: 'Omnivore', desc: 'Eat everything' },
                { value: 'vegetarian', label: 'Vegetarian', desc: 'No meat' },
                { value: 'vegan', label: 'Vegan', desc: 'No animal products' }
            ]
        };

        function getRegionLabel(v) { return LIFESTYLE_OPTIONS.region.find(o => o.value === v)?.label; }
        function getActivityLabel(v) { return LIFESTYLE_OPTIONS.activity.find(o => o.value === v)?.label; }
        function getWorkLabel(v) { return LIFESTYLE_OPTIONS.work.find(o => o.value === v)?.label; }
        function getDietLabel(v) { return LIFESTYLE_OPTIONS.diet.find(o => o.value === v)?.label; }

        let currentLifestyleField = null;

        function showLifestyleOptions(field) {
            currentLifestyleField = field;
            const container = document.getElementById('lifestyle-options');
            const options = LIFESTYLE_OPTIONS[field];
            const dataKey = field === 'activity' ? 'activity_level' : field === 'work' ? 'work_environment' : field === 'diet' ? 'diet_type' : field;
            const currentValue = onboardingData[dataKey];

            container.innerHTML = options.map(opt => `
                <div class="lifestyle-option ${opt.value === currentValue ? 'selected' : ''}"
                     onclick="selectLifestyleOption('${field}', '${opt.value}', '${opt.label}')">
                    <span class="option-label">${opt.label}</span>
                    <span class="option-desc">${opt.desc}</span>
                </div>
            `).join('');

            container.classList.remove('hidden');
        }

        function selectLifestyleOption(field, value, label) {
            const dataKey = field === 'activity' ? 'activity_level' : field === 'work' ? 'work_environment' : field === 'diet' ? 'diet_type' : field;
            onboardingData[dataKey] = value;
            document.getElementById(`lifestyle-${field}`).textContent = label;
            document.getElementById('lifestyle-options').classList.add('hidden');

            // Update card to show selected
            document.querySelectorAll('.lifestyle-card').forEach(card => {
                if (card.querySelector(`#lifestyle-${field}`)) {
                    card.classList.add('selected');
                }
            });
        }

        // Step 3: Sleep (chronotype)
        function getStepSleepHTML() {
            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration"></div>
                    <h2>Your Sleep Style</h2>
                    <p class="onboarding-subtitle">When do you feel most energized?</p>

                    <div class="chronotype-options">
                        <div class="chronotype-card ${onboardingData.chronotype === 'early_bird' ? 'selected' : ''}"
                             onclick="selectChronotype('early_bird')">
                            <span class="chronotype-icon"></span>
                            <span class="chronotype-label">Early Bird</span>
                            <span class="chronotype-desc">I'm most productive in the morning</span>
                        </div>
                        <div class="chronotype-card ${onboardingData.chronotype === 'night_owl' ? 'selected' : ''}"
                             onclick="selectChronotype('night_owl')">
                            <span class="chronotype-icon"></span>
                            <span class="chronotype-label">Night Owl</span>
                            <span class="chronotype-desc">I come alive in the evening</span>
                        </div>
                        <div class="chronotype-card ${onboardingData.chronotype === 'neutral' ? 'selected' : ''}"
                             onclick="selectChronotype('neutral')">
                            <span class="chronotype-icon"></span>
                            <span class="chronotype-label">Flexible</span>
                            <span class="chronotype-desc">I adapt to any schedule</span>
                        </div>
                    </div>

                    <button class="onboarding-btn primary" onclick="nextOnboardingStep()">
                        Continue
                    </button>
                    <button class="onboarding-btn secondary" onclick="nextOnboardingStep()">
                        Skip for now
                    </button>
                    <button class="onboarding-btn back" onclick="prevOnboardingStep()">
                         Back
                    </button>
                </div>
            `;
        }

        function selectChronotype(value) {
            onboardingData.chronotype = value;
            document.querySelectorAll('.chronotype-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // Step 4: Connect Oura
        function getStepOuraHTML() {
            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration"></div>
                    <h2>Connect Oura Ring</h2>
                    <p class="onboarding-subtitle">Sync your sleep and recovery data for personalized insights</p>

                    <div class="onboarding-feature-card">
                        <div class="feature-icon"></div>
                        <div class="feature-text">
                            <strong>Connect Your Oura Ring</strong>
                            <p>We use your sleep and recovery data to personalize supplement recommendations</p>
                        </div>
                    </div>

                    <button class="onboarding-btn primary" onclick="startOuraConnectionOnboarding()">
                        Connect Oura Ring
                    </button>
                    <button class="onboarding-btn secondary" onclick="nextOnboardingStep()">
                        Skip for now
                    </button>
                    <button class="onboarding-btn back" onclick="prevOnboardingStep()">
                         Back
                    </button>
                </div>
            `;
        }

        function startOuraConnectionOnboarding() {
            // Start OAuth flow - this will redirect, so mark that we're in onboarding
            localStorage.setItem('onboardingInProgress', 'true');
            connectOura();
        }

        // Step 2: Add Supplements
        function getStepSupplementsHTML() {
            const hasSelected = onboardingData.selectedSupplements.length > 0;

            // Build selected supplements cards
            const selectedCardsHTML = onboardingData.selectedSupplements.map((supp, idx) => `
                <div class="selected-supp-card">
                    <div class="selected-supp-header">
                        <span class="selected-supp-name">${getSupplementIcon(supp.id)} ${escapeAttr(supp.name)}</span>
                        <button class="selected-supp-remove" onclick="removeOnboardingSupplement(${idx})"></button>
                    </div>
                    <div class="selected-supp-fields">
                        <div class="selected-supp-field">
                            <label>Dosage</label>
                            <input type="text" value="${escapeAttr(supp.dosage)}" placeholder="e.g. 2000 IU"
                                   onchange="updateOnboardingSupplementField(${idx}, 'dosage', this.value)">
                        </div>
                        <div class="selected-supp-field">
                            <label>Taking for</label>
                            <select onchange="updateOnboardingSupplementField(${idx}, 'duration', parseInt(this.value))">
                                <option value="0" ${supp.duration === 0 ? 'selected' : ''}>Just starting</option>
                                <option value="7" ${supp.duration === 7 ? 'selected' : ''}>~1 week</option>
                                <option value="30" ${supp.duration === 30 ? 'selected' : ''}>~1 month</option>
                                <option value="90" ${supp.duration === 90 ? 'selected' : ''}>3+ months</option>
                            </select>
                        </div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration"></div>
                    <h2>What do you take?</h2>
                    <p class="onboarding-subtitle">Search and add your supplements</p>

                    <div class="supp-search-container">
                        <input type="text" class="supp-search-input" id="onboarding-supp-search"
                               placeholder="Search supplements..."
                               oninput="filterOnboardingSupplements(this.value)">
                    </div>

                    <div class="supp-list-container" id="onboarding-supp-list">
                        <!-- Populated by JS -->
                    </div>

                    ${hasSelected ? `
                        <div class="selected-supps-section">
                            <div class="selected-supps-label">Your supplements (${onboardingData.selectedSupplements.length})</div>
                            ${selectedCardsHTML}
                        </div>
                    ` : ''}

                    <button class="onboarding-btn ${hasSelected ? 'primary' : 'secondary'}" onclick="nextOnboardingStep()">
                        ${hasSelected ? 'Continue' : 'Skip for now'}
                    </button>
                    <button class="onboarding-btn back" onclick="prevOnboardingStep()">
                         Back
                    </button>
                </div>
            `;
        }

        // Filter supplements in onboarding search
        function filterOnboardingSupplements(query) {
            const container = document.getElementById('onboarding-supp-list');
            if (!container) return;

            // Use supplement library if loaded, otherwise use a basic list
            let supplements = [];
            if (supplementLibrary && supplementLibrary.supplements) {
                supplements = supplementLibrary.supplements;
            } else {
                // Fallback list
                supplements = [
                    { id: 'vitamin_d3', name: 'Vitamin D3', typical_dose: '2000-5000 IU' },
                    { id: 'fish_oil', name: 'Fish Oil / Omega-3', typical_dose: '1000-2000mg' },
                    { id: 'magnesium_glycinate', name: 'Magnesium Glycinate', typical_dose: '200-400mg' },
                    { id: 'vitamin_b12', name: 'Vitamin B12', typical_dose: '500-1000mcg' },
                    { id: 'ashwagandha', name: 'Ashwagandha', typical_dose: '300-600mg' },
                    { id: 'zinc', name: 'Zinc', typical_dose: '15-30mg' },
                    { id: 'melatonin', name: 'Melatonin', typical_dose: '0.5-5mg' },
                    { id: 'creatine', name: 'Creatine', typical_dose: '3-5g' },
                    { id: 'vitamin_c', name: 'Vitamin C', typical_dose: '500-1000mg' },
                    { id: 'b_complex', name: 'B-Complex', typical_dose: '1 capsule' }
                ];
            }

            // Filter by query
            const lowerQuery = query.toLowerCase().trim();
            const filtered = lowerQuery
                ? supplements.filter(s => s.name.toLowerCase().includes(lowerQuery))
                : supplements.slice(0, 8); // Show first 8 by default

            // Check which are already selected
            const selectedIds = onboardingData.selectedSupplements.map(s => s.id);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="supp-no-results">No supplements found for "${query}"</div>`;
                return;
            }

            container.innerHTML = filtered.map(supp => {
                const isSelected = selectedIds.includes(supp.id);
                return `
                    <div class="supp-list-item ${isSelected ? 'selected' : ''}"
                         onclick="toggleOnboardingSupplementFromSearch('${supp.id}', '${supp.name.replace(/'/g, "\\'")}', '${(supp.typical_dose || '').replace(/'/g, "\\'")}')">
                        <span class="supp-list-icon">${getSupplementIcon(supp.id)}</span>
                        <div class="supp-list-info">
                            <div class="supp-list-name">${supp.name}</div>
                            <div class="supp-list-dose">${supp.typical_dose || ''}</div>
                        </div>
                        <span class="supp-list-check"></span>
                    </div>
                `;
            }).join('');
        }

        // Toggle supplement from search list
        function toggleOnboardingSupplementFromSearch(id, name, typicalDose) {
            const idx = onboardingData.selectedSupplements.findIndex(s => s.id === id);
            if (idx > -1) {
                // Remove it
                onboardingData.selectedSupplements.splice(idx, 1);
            } else {
                // Add it with default values
                const defaultDose = typicalDose ? typicalDose.split('-')[0] || typicalDose : '';
                onboardingData.selectedSupplements.push({
                    id: id,
                    name: name,
                    dosage: defaultDose,
                    duration: 30 // Default to 1 month
                });
            }
            // Re-render current step (supplements is step 5)
            renderOnboardingStep(5);
            // Restore search and re-filter
            setTimeout(() => {
                const searchInput = document.getElementById('onboarding-supp-search');
                if (searchInput) {
                    filterOnboardingSupplements(searchInput.value || '');
                }
            }, 10);
        }

        // Remove a selected supplement
        function removeOnboardingSupplement(idx) {
            onboardingData.selectedSupplements.splice(idx, 1);
            renderOnboardingStep(5);
            setTimeout(() => {
                const searchInput = document.getElementById('onboarding-supp-search');
                if (searchInput) {
                    filterOnboardingSupplements(searchInput.value || '');
                }
            }, 10);
        }

        // Update a field on a selected supplement
        function updateOnboardingSupplementField(idx, field, value) {
            if (onboardingData.selectedSupplements[idx]) {
                onboardingData.selectedSupplements[idx][field] = value;
            }
        }

        // Step 3: Set Goal (multi-select)
        function getStepGoalHTML() {
            const goals = [
                { id: 'sleep', icon: '', name: 'Better Sleep' },
                { id: 'recovery', icon: '', name: 'Recovery & Performance' },
                { id: 'energy', icon: '', name: 'Energy & Focus' },
                { id: 'wellness', icon: '', name: 'General Wellness' }
            ];

            // Ensure goals is an array
            if (!Array.isArray(onboardingData.goals)) {
                onboardingData.goals = [];
            }

            const goalsHTML = goals.map(goal => `
                <div class="goal-option ${onboardingData.goals.includes(goal.id) ? 'selected' : ''}"
                     onclick="toggleOnboardingGoal('${goal.id}')">
                    <span class="goal-icon">${goal.icon}</span>
                    <span class="goal-name">${goal.name}</span>
                    <span class="goal-check">${onboardingData.goals.includes(goal.id) ? '' : ''}</span>
                </div>
            `).join('');

            const hasGoals = onboardingData.goals.length > 0;

            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration"></div>
                    <h2>What's your focus?</h2>
                    <p class="onboarding-subtitle">Select all that apply</p>

                    <div class="goal-options">
                        ${goalsHTML}
                    </div>

                    <button class="onboarding-btn ${hasGoals ? 'primary' : 'secondary'}" onclick="nextOnboardingStep()">
                        ${hasGoals ? 'Continue' : 'Skip for now'}
                    </button>
                    <button class="onboarding-btn back" onclick="prevOnboardingStep()">
                         Back
                    </button>
                </div>
            `;
        }

        function toggleOnboardingGoal(goal) {
            // Ensure goals is an array
            if (!Array.isArray(onboardingData.goals)) {
                onboardingData.goals = [];
            }

            const idx = onboardingData.goals.indexOf(goal);
            if (idx > -1) {
                // Remove it
                onboardingData.goals.splice(idx, 1);
            } else {
                // Add it
                onboardingData.goals.push(goal);
            }

            // Re-render the step to update UI
            renderOnboardingStep(6);
        }

        // Completion Screen
        function getCompletionHTML() {
            const profileComplete = onboardingData.age && onboardingData.sex && onboardingData.height_feet && onboardingData.weight_lbs;
            const profileStatus = profileComplete
                ? '<span class="summary-icon"></span> Profile complete'
                : '<span class="summary-icon"></span> Profile (complete later)';

            const lifestyleComplete = onboardingData.region || onboardingData.activity_level || onboardingData.work_environment || onboardingData.diet_type;
            const lifestyleStatus = lifestyleComplete
                ? '<span class="summary-icon"></span> Lifestyle preferences set'
                : '<span class="summary-icon"></span> Lifestyle (set later)';

            const ouraStatus = onboardingData.ouraConnected || ouraConnected
                ? '<span class="summary-icon"></span> Oura Ring connected'
                : '<span class="summary-icon"></span> Oura Ring (connect later)';

            const suppCount = onboardingData.selectedSupplements.length;
            const suppStatus = suppCount > 0
                ? `<span class="summary-icon"></span> ${suppCount} supplement${suppCount > 1 ? 's' : ''} added`
                : '<span class="summary-icon"></span> No supplements added';

            const goalNames = {
                sleep: 'Better Sleep',
                recovery: 'Recovery & Performance',
                energy: 'Energy & Focus',
                wellness: 'General Wellness'
            };
            const goalsArray = onboardingData.goals || [];
            const hasGoals = goalsArray.length > 0;
            const goalsList = goalsArray.map(g => goalNames[g] || g).join(', ');
            const goalStatus = hasGoals
                ? `<span class="summary-icon"></span> Goals: ${goalsList}`
                : '<span class="summary-icon"></span> No goals set';

            return `
                <div class="onboarding-step-content">
                    <div class="completion-checkmark"></div>
                    <h2>You're all set!</h2>
                    <p class="onboarding-subtitle">Your personalized dashboard is ready</p>

                    <div class="completion-summary">
                        <div class="summary-item ${profileComplete ? 'completed' : ''}">${profileStatus}</div>
                        <div class="summary-item ${lifestyleComplete ? 'completed' : ''}">${lifestyleStatus}</div>
                        <div class="summary-item ${(onboardingData.ouraConnected || ouraConnected) ? 'completed' : ''}">${ouraStatus}</div>
                        <div class="summary-item ${suppCount > 0 ? 'completed' : ''}">${suppStatus}</div>
                        <div class="summary-item ${hasGoals ? 'completed' : ''}">${goalStatus}</div>
                    </div>

                    <button class="onboarding-btn primary" onclick="completeOnboarding()">
                        Go to Dashboard
                    </button>
                    <button class="onboarding-btn back" onclick="prevOnboardingStep()">
                         Back
                    </button>
                </div>
            `;
        }

        async function completeOnboarding() {
            // Save supplements if any were selected
            if (onboardingData.selectedSupplements.length > 0) {
                for (const supp of onboardingData.selectedSupplements) {
                    // Calculate start date based on duration
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - (supp.duration || 0));
                    const startDateStr = startDate.toISOString().split('T')[0];

                    try {
                        await fetch(`/analytics/${currentUserId}/supplement-starts`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                supplement_id: supp.id,
                                supplement_name: supp.name,
                                start_date: startDateStr,
                                is_manual: true,
                                dosage: supp.dosage || ''
                            })
                        });

                        // Create backdate logs if duration > 0 (assume 80% adherence)
                        if (supp.duration > 0) {
                            await createBackdateLogs(supp.id, startDateStr, 0.8);
                        }
                    } catch (e) {
                        console.error('Error adding supplement:', e);
                    }
                }
            }

            // Save all profile data to user
            try {
                const profileData = {
                    onboarding_complete: 'true'
                };

                // Add profile fields if provided
                if (onboardingData.age) profileData.age = onboardingData.age;
                if (onboardingData.sex) profileData.sex = onboardingData.sex;
                if (onboardingData.height_feet) profileData.height_feet = onboardingData.height_feet;
                if (onboardingData.height_inches !== null) profileData.height_inches = onboardingData.height_inches;
                if (onboardingData.weight_lbs) profileData.weight_lbs = onboardingData.weight_lbs;

                // Add lifestyle fields if provided
                if (onboardingData.region) profileData.region = onboardingData.region;
                if (onboardingData.activity_level) profileData.activity_level = onboardingData.activity_level;
                if (onboardingData.work_environment) profileData.work_environment = onboardingData.work_environment;
                if (onboardingData.diet_type) profileData.diet_type = onboardingData.diet_type;

                // Add sleep/chronotype if provided
                if (onboardingData.chronotype) profileData.chronotype = onboardingData.chronotype;

                // Add goals if provided (save first as primary health_goal, all in goals array)
                if (onboardingData.goals && onboardingData.goals.length > 0) {
                    profileData.health_goal = onboardingData.goals[0]; // Primary goal
                    profileData.goals = onboardingData.goals; // All goals
                }

                await fetch(`/users/${currentUserId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
            } catch (e) {
                console.error('Error saving profile:', e);
            }

            // Close modal and refresh data
            closeOnboarding();
            await loadAnalyticsData(); // Reload analytics to get new supplements
            loadAllData();
            showStatus('Welcome to Dose! Your dashboard is ready.', 'success');
        }

        function closeOnboarding() {
            document.getElementById('onboarding-modal').classList.add('hidden');
            localStorage.removeItem('onboardingInProgress');
        }

        // ==================== END ONBOARDING ====================


        // ==================== PROGRESSIVE DISCLOSURE ====================

        // Check user setup status
        function getUserSetupStatus() {
            return {
                hasOura: ouraConnected,
                hasSupplements: (analyticsData?.supplement_starts || []).filter(s => !s.end_date).length > 0,
                hasLogs: (analyticsData?.supplement_logs || []).length > 0
            };
        }

        // Check if user is new (needs getting started guidance)
        function isNewUser() {
            const status = getUserSetupStatus();
            // User is "new" if they haven't completed 2 of the 3 setup steps
            const completedSteps = (status.hasOura ? 1 : 0) + (status.hasSupplements ? 1 : 0) + (status.hasLogs ? 1 : 0);
            return completedSteps < 2;
        }

        // Update the Getting Started card
        function updateGettingStartedCard() {
            const card = document.getElementById('getting-started-card');
            if (!card) return;

            // Don't show if user dismissed it
            if (localStorage.getItem('gettingStartedDismissed') === 'true') {
                card.classList.add('hidden');
                return;
            }

            const status = getUserSetupStatus();

            // Update checklist items
            const ouraItem = document.getElementById('gs-item-oura');
            const supplementsItem = document.getElementById('gs-item-supplements');
            const logItem = document.getElementById('gs-item-log');

            if (status.hasOura) {
                ouraItem.classList.add('completed');
            } else {
                ouraItem.classList.remove('completed');
            }

            if (status.hasSupplements) {
                supplementsItem.classList.add('completed');
            } else {
                supplementsItem.classList.remove('completed');
            }

            if (status.hasLogs) {
                logItem.classList.add('completed');
            } else {
                logItem.classList.remove('completed');
            }

            // Update progress
            const completedCount = (status.hasOura ? 1 : 0) + (status.hasSupplements ? 1 : 0) + (status.hasLogs ? 1 : 0);
            const progressFill = document.getElementById('gs-progress-fill');
            const progressText = document.getElementById('gs-progress-text');

            if (progressFill) progressFill.style.width = `${(completedCount / 3) * 100}%`;
            if (progressText) progressText.textContent = `${completedCount}/3`;

            // Hide if all completed
            if (completedCount >= 3) {
                card.classList.add('hidden');
            } else if (isNewUser()) {
                card.classList.remove('hidden');
            } else {
                // User has some progress, show card to encourage completion
                card.classList.remove('hidden');
            }
        }

        // Dismiss Getting Started card
        function dismissGettingStarted() {
            localStorage.setItem('gettingStartedDismissed', 'true');
            const card = document.getElementById('getting-started-card');
            if (card) card.classList.add('hidden');
        }

        // Update Saturation section visibility
        function updateSaturationVisibility() {
            const saturationGauge = document.getElementById('saturation-gauge');
            if (!saturationGauge) return;

            const status = getUserSetupStatus();

            // Hide saturation if no supplements
            if (!status.hasSupplements) {
                saturationGauge.classList.add('hidden-section');
            } else {
                saturationGauge.classList.remove('hidden-section');
            }
        }

        // Update chart overlay visibility
        function updateChartOverlay() {
            const overlay = document.getElementById('chart-overlay');
            if (!overlay) return;

            // Show overlay if no Oura connected
            if (!ouraConnected) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        // Master function to update all progressive disclosure elements
        function updateProgressiveDisclosure() {
            updateGettingStartedCard();
            updateSaturationVisibility();
            updateChartOverlay();
        }

        // ==================== END PROGRESSIVE DISCLOSURE ====================


        // Sign in
        async function signIn() {
            const email = document.getElementById('signin-email').value.trim();
            if (!email) {
                showStatus('Please enter your email', 'error');
                return;
            }

            try {
                const res = await fetch('/users/signin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (res.ok) {
                    const user = await res.json();
                    currentUserId = user.id;
                    localStorage.setItem('userId', user.id);
                    showLoggedIn(user);
                    loadAllData();
                    showStatus('Welcome back!', 'success');
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error signing in', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Load user and show UI
        async function loadUserAndShow() {
            try {
                const res = await fetch(`/users/${currentUserId}`);
                if (res.ok) {
                    const user = await res.json();
                    showLoggedIn(user);
                    loadAllData();
                } else {
                    localStorage.removeItem('userId');
                    currentUserId = null;
                }
            } catch (e) {
                console.error('Error loading user:', e);
            }
        }

        // Load all data
        function loadAllData() {
            loadMixes();
            loadTracking();
            loadSaturation();
            checkDailyFoundationTaken();
            checkOuraStatus();
            loadTodaysStackData();
        }

        // Check Daily Foundation status and update display
        async function checkDailyFoundationTaken() {
            if (!currentUserId) return;

            const dfElement = document.getElementById('daily-foundation');
            const dfStatus = document.getElementById('df-status');

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/tracking/daily?date_override=${dateStr}`);

                if (res.ok) {
                    const data = await res.json();
                    // Daily Foundation contains: vitamin_d3, vitamin_k2, omega_3
                    const dfSupplements = ['vitamin_d3', 'vitamin_k2', 'omega_3'];
                    const takenSupps = data.supplements.map(s => s.supplement_id);
                    const takenCount = dfSupplements.filter(s => takenSupps.includes(s)).length;

                    // Update status based on how many were taken
                    dfElement.classList.remove('taken', 'partial');

                    if (takenCount === 3) {
                        dfElement.classList.add('taken');
                        dfStatus.textContent = ' All 3 taken';
                    } else if (takenCount > 0) {
                        dfElement.classList.add('partial');
                        dfStatus.textContent = `${takenCount}/3 taken`;
                    } else {
                        dfStatus.textContent = 'Tap to dispense';
                    }
                }
            } catch (e) {
                console.error('Error checking daily foundation:', e);
            }
        }

        // Select Daily Foundation (with taken check)
        function selectDailyFoundation() {
            const dfElement = document.getElementById('daily-foundation');
            if (dfElement.classList.contains('taken')) {
                showStatus('All 3 foundation supplements taken!', 'success');
                return;
            }
            selectMix('daily_foundation');
        }

        // Show logged in state
        function showLoggedIn(user) {
            document.getElementById('no-user').classList.add('hidden');
            document.getElementById('has-user').classList.remove('hidden');
            document.getElementById('display-name').textContent = user.name;
            document.getElementById('user-avatar').textContent = user.name.charAt(0).toUpperCase();
        }

        // Logout
        function logout() {
            localStorage.removeItem('userId');
            currentUserId = null;
            ouraConnected = false;
            ouraData = null;
            analyticsData = null;
            checkinState = {};
            document.getElementById('has-user').classList.add('hidden');
            document.getElementById('no-user').classList.remove('hidden');
            // Switch back to dashboard tab
            switchMainTab('dashboard');
        }

        // Date functions
        function getDateString() {
            return currentDate.toISOString().split('T')[0];
        }

        function updateDateDisplay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const current = new Date(currentDate);
            current.setHours(0, 0, 0, 0);

            const isToday = today.getTime() === current.getTime();
            const dayEl = document.getElementById('date-day');
            const fullEl = document.getElementById('date-full');

            const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
            fullEl.textContent = currentDate.toLocaleDateString('en-US', options);

            if (isToday) {
                dayEl.innerHTML = 'Today<span class="today-badge">Now</span>';
            } else {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                dayEl.textContent = days[currentDate.getDay()];
            }
        }

        function changeDate(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            updateDateDisplay();
            loadAllData();
        }

        // Time functions
        function setTime(hour) {
            currentTime = hour;
            updateTimeButtons();
            loadMixes();
        }

        function updateTimeButtons() {
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            if (currentTime < 12) {
                document.getElementById('time-btn-morning').classList.add('active');
            } else if (currentTime < 18) {
                document.getElementById('time-btn-afternoon').classList.add('active');
            } else {
                document.getElementById('time-btn-evening').classList.add('active');
            }
        }

        // Load mixes
        async function loadMixes() {
            try {
                const res = await fetch('/mixes/all');
                if (res.ok) {
                    availableMixes = await res.json();
                    renderMixCards();
                }
            } catch (e) {
                console.error('Error loading mixes:', e);
            }
        }

        // Render mix cards
        function renderMixCards() {
            const layout = document.getElementById('dispenser-layout');
            // Keep AI recommendation and Daily Foundation
            const aiRec = document.getElementById('ai-recommendation');
            const dailyFoundation = document.getElementById('daily-foundation');

            // Remove existing mix cards
            layout.querySelectorAll('.mix-card').forEach(card => card.remove());

            // Filter mixes by time of day and exclude daily_foundation
            const currentPeriod = currentTime < 12 ? 'morning' : currentTime < 18 ? 'afternoon' : 'evening';
            const filteredMixes = availableMixes.filter(mix => {
                if (mix.id === 'daily_foundation') return false;
                if (!mix.time_windows || mix.time_windows.length === 0) return true;
                return mix.time_windows.includes(currentPeriod);
            });

            // Add mix cards
            filteredMixes.forEach(mix => {
                const card = document.createElement('div');
                card.className = 'mix-card';
                card.onclick = () => selectMix(mix.id);
                card.innerHTML = `
                    <div class="mix-icon">${mix.icon || '&#x1F48A;'}</div>
                    <div class="mix-name">${mix.name}</div>
                    <div class="mix-desc">${mix.description}</div>
                `;
                layout.appendChild(card);
            });

            // Load custom blends
            loadCustomBlends();
        }

        // Load custom blends
        async function loadCustomBlends() {
            if (!currentUserId) return;

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}`);
                if (res.ok) {
                    customBlends = await res.json();
                    renderCustomBlends();
                    renderCustomBlendCards();
                }
            } catch (e) {
                console.error('Error loading custom blends:', e);
            }
        }

        // Render custom blend cards in dispenser grid
        function renderCustomBlendCards() {
            const layout = document.getElementById('dispenser-layout');

            // Remove existing custom blend cards first to prevent duplicates
            layout.querySelectorAll('.custom-blend-mix').forEach(card => card.remove());

            customBlends.forEach(blend => {
                const card = document.createElement('div');
                card.className = 'mix-card custom-blend-mix';
                card.onclick = () => selectCustomBlend(blend.id);
                card.innerHTML = `
                    <div class="custom-badge">Custom</div>
                    <div class="mix-icon">${blend.icon || '&#x1F9EA;'}</div>
                    <div class="mix-name">${blend.name}</div>
                    <div class="mix-desc">${(blend.components || []).length} supplements</div>
                `;
                layout.appendChild(card);
            });
        }

        // Render custom blends list
        function renderCustomBlends() {
            const list = document.getElementById('custom-blends-list');

            if (customBlends.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">&#x1F9EA;</div>
                        <div>No custom blends yet</div>
                        <div style="font-size: 0.8em; color: #333; margin-top: 6px;">
                            Create your own supplement combinations
                        </div>
                    </div>
                `;
                return;
            }

            list.innerHTML = customBlends.map(blend => `
                <div class="custom-blend-card" onclick="selectCustomBlend('${blend.id}')">
                    <div class="custom-blend-info">
                        <span class="custom-blend-icon">${blend.icon || '&#x1F9EA;'}</span>
                        <div>
                            <div class="custom-blend-name">${blend.name}</div>
                            <div class="custom-blend-count">${(blend.components || []).length} supplements</div>
                        </div>
                    </div>
                    <div class="custom-blend-actions">
                        <button class="btn-delete-blend" onclick="event.stopPropagation(); deleteCustomBlend('${blend.id}')" title="Delete">&#x2715;</button>
                    </div>
                </div>
            `).join('');
        }

        // Select a mix
        async function selectMix(mixId) {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/${mixId}?hour=${currentTime}&date_override=${dateStr}`);

                if (res.ok) {
                    currentMixData = await res.json();
                    showDispenseModal(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error calculating mix', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Select custom blend
        async function selectCustomBlend(blendId) {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/blends/${currentUserId}/${blendId}/preview?hour=${currentTime}&date_override=${dateStr}`);

                if (res.ok) {
                    currentMixData = await res.json();
                    showDispenseModal(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error calculating blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // AI Recommendation
        async function getAIRecommendation() {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            const aiRec = document.getElementById('ai-recommendation');
            aiRec.classList.add('loading');
            const loadingText = ouraConnected ? 'Analyzing your Oura data...' : 'Analyzing your health data...';
            aiRec.querySelector('.ai-subtitle').textContent = loadingText;

            try {
                const dateStr = getDateString();

                // Step 1: Get smart recommendation (which mix to use)
                const smartRes = await fetch(`/mixes/${currentUserId}/smart?time_override=${currentTime}`);
                if (!smartRes.ok) {
                    const err = await smartRes.json();
                    showStatus(err.detail || 'Error getting recommendation', 'error');
                    return;
                }

                const smartData = await smartRes.json();
                const recommendedMixId = smartData.recommended_mix_id;

                // Step 2: Get the full mix details
                const mixRes = await fetch(`/mixes/${currentUserId}/${recommendedMixId}?time_override=${currentTime}&date_override=${dateStr}`);
                if (!mixRes.ok) {
                    const err = await mixRes.json();
                    showStatus(err.detail || 'Error loading mix', 'error');
                    return;
                }

                currentMixData = await mixRes.json();

                // Add the AI reason to the mix data
                currentMixData.ai_reason = smartData.reason;
                currentMixData.health_summary = smartData.health_summary;

                showDispenseModal(currentMixData);
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            } finally {
                aiRec.classList.remove('loading');
                const subtitle = ouraConnected ? 'Powered by your Oura Ring data' : 'Connect Oura for personalized insights';
                aiRec.querySelector('.ai-subtitle').textContent = subtitle;
            }
        }

        // Show dispense modal
        function showDispenseModal(data) {
            const modal = document.getElementById('dispense-modal');
            const content = document.getElementById('modal-content');

            const supplements = data.supplements || [];
            const warnings = data.warnings || [];
            const skipped = data.skipped || [];

            content.innerHTML = `
                <div class="modal-header">
                    <div class="modal-icon">${data.mix_icon || '&#x1F48A;'}</div>
                    <div class="modal-title">${data.mix_name}</div>
                    <div class="modal-subtitle">${data.mix_description || 'Your personalized supplement mix'}</div>
                </div>

                ${data.ai_reason ? `
                    <div class="ai-reason" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <span style="font-size: 1.1em;">&#x2728;</span>
                            <span style="color: #A78BFA; font-weight: 600; font-size: 0.85em;">AI Recommendation</span>
                        </div>
                        <div style="color: #B0B0B0; font-size: 0.9em;">${data.ai_reason}</div>
                    </div>
                ` : ''}

                ${supplements.length > 0 ? `
                    <div class="supplement-list">
                        ${supplements.map(s => `
                            <div class="supplement-item">
                                <div class="supplement-info">
                                    <span class="supplement-name">${s.name}</span>
                                    <span class="supplement-description">${s.description || ''}</span>
                                </div>
                                <span class="supplement-dose">${s.dose}${s.unit}</span>
                            </div>
                            ${s.intelligence_notes && s.intelligence_notes.length > 0 ? `
                                <div class="intelligence-note">
                                    ${s.intelligence_notes.join('; ')}
                                </div>
                            ` : ''}
                        `).join('')}
                    </div>
                ` : `
                    <div class="empty-state" style="padding: 20px 0;">
                        <div style="color: #666;">All supplements in this mix have reached their daily limits</div>
                    </div>
                `}

                ${skipped.length > 0 ? `
                    <div class="modal-skipped">
                        <div class="skipped-header">Skipped (daily limit reached):</div>
                        ${skipped.map(s => `<span class="skipped-item">${s.name || s.supplement_id}</span>`).join('')}
                    </div>
                ` : ''}

                ${warnings.length > 0 ? `
                    <div class="modal-warning">
                        ${warnings.map(w => w.message || w).join('<br>')}
                    </div>
                ` : ''}

                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeDispenseModal()">Cancel</button>
                    <button class="btn-dispense" onclick="confirmDispense()" id="dispense-btn" ${supplements.length === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        ${supplements.length === 0 ? 'Nothing to Dispense' : 'Get Dose'}
                    </button>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close dispense modal
        function closeDispenseModal() {
            document.getElementById('dispense-modal').classList.add('hidden');
            currentMixData = null;
            isDispensing = false;
        }

        // Confirm dispense
        async function confirmDispense() {
            if (!currentMixData || isDispensing) return;
            isDispensing = true;

            const btn = document.getElementById('dispense-btn');
            btn.classList.add('dispensing');
            btn.textContent = 'Dispensing...';

            try {
                const dateStr = getDateString();

                // Determine if this is a custom blend or regular mix
                let url;
                if (currentMixData.blend_id) {
                    // Custom blend
                    url = `/mixes/blends/${currentUserId}/${currentMixData.blend_id}/dispense?time_override=${currentTime}&date_override=${dateStr}`;
                } else {
                    // Regular mix
                    url = `/mixes/${currentUserId}/${currentMixData.mix_id}/dispense?time_override=${currentTime}&date_override=${dateStr}`;
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (res.ok) {
                    // Also add dispensed supplements to daily stack
                    const supplements = currentMixData.supplements || [];
                    if (supplements.length > 0) {
                        const autoTime = currentTime < 12 ? 'morning' : 'evening';
                        try {
                            await fetch(`/analytics/${currentUserId}/daily-checkin`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    date: dateStr,
                                    supplements: supplements.map(s => ({
                                        supplement_id: s.supplement_id,
                                        taken: true,
                                        time_taken: autoTime
                                    }))
                                })
                            });
                            // Refresh analytics data in background
                            const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                            if (analyticsRes.ok) {
                                analyticsData = await analyticsRes.json();
                                loadTodaysStack();
                            }
                        } catch (e) {
                            console.error('Error logging dispensed supplements:', e);
                        }
                    }
                    showDispenseAnimation(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error dispensing', 'error');
                    closeDispenseModal();
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
                closeDispenseModal();
            }
        }

        // Show dispense animation
        function showDispenseAnimation(data) {
            const content = document.getElementById('modal-content');
            const supplements = data.supplements || [];

            content.innerHTML = `
                <div class="dispense-animation">
                    <div class="glass-container">
                        <div class="glass">
                            <div class="glass-water" id="water"></div>
                        </div>
                        <div class="dropping-supplements" id="dropping">
                            ${supplements.map((s, i) => `
                                <span class="dropping-pill" style="animation-delay: ${0.2 * i}s">&#x1F48A;</span>
                            `).join('')}
                        </div>
                    </div>
                    <div class="dispense-message">Dispensing your dose...</div>
                    <div class="dispense-details">${supplements.length} supplements</div>
                </div>
            `;

            // Start animation
            setTimeout(() => {
                document.getElementById('water').classList.add('filling');
            }, 100);

            // Show success after animation
            setTimeout(() => {
                showDispenseSuccess(data);
            }, 2500);
        }

        // Show dispense success
        function showDispenseSuccess(data) {
            const content = document.getElementById('modal-content');
            const supplements = data.supplements || [];

            content.innerHTML = `
                <div class="dispense-animation">
                    <div style="font-size: 4em; margin-bottom: 16px;">&#x2705;</div>
                    <div class="dispense-message">Dose Ready!</div>
                    <div class="dispense-details">Your supplements have been dispensed</div>

                    <div class="dispensed-list">
                        ${supplements.map(s => `
                            <div class="dispensed-item">
                                <span>${s.name}</span>
                                <span>${s.dose}${s.unit}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 20px;">
                    <button class="btn-dispense" onclick="closeDispenseModal(); loadAllData();" style="width: 100%;">
                        Done
                    </button>
                </div>
            `;
        }

        // Load tracking
        async function loadTracking() {
            if (!currentUserId) return;

            try {
                const dateStr = getDateString();
                let url = `/mixes/${currentUserId}/tracking/daily?date_override=${dateStr}`;
                if (trackingTab === 'weekly') {
                    url = `/mixes/${currentUserId}/tracking/weekly?date_override=${dateStr}`;
                }

                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    renderTracking(data);
                }
            } catch (e) {
                console.error('Error loading tracking:', e);
            }
        }

        // Render tracking
        function renderTracking(data) {
            const content = document.getElementById('tracking-content');
            const supplements = data.supplements || [];
            const isWeekly = trackingTab === 'weekly';

            if (supplements.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">&#x1F48A;</div>
                        <div>No supplements taken ${isWeekly ? 'this week' : 'yet'}</div>
                    </div>
                `;
                return;
            }

            content.innerHTML = supplements.map(s => {
                // Handle both daily (taken/max_daily) and weekly (weekly_total/weekly_max) formats
                const taken = isWeekly ? s.weekly_total : s.taken;
                const max = isWeekly ? s.weekly_max : s.max_daily;
                const pct = s.percentage || Math.min((taken / max) * 100, 100);
                let barClass = '';
                if (pct >= 90) barClass = 'danger';
                else if (pct >= 70) barClass = 'warning';

                // Format display value (round if needed)
                const takenDisplay = taken % 1 === 0 ? taken : taken.toFixed(1);
                const maxDisplay = max % 1 === 0 ? max : max.toFixed(0);

                return `
                    <div class="tracking-item">
                        <div class="tracking-header">
                            <span class="tracking-name">${s.name}${isWeekly ? ` (${s.days_taken || 0} days)` : ''}</span>
                            <span class="tracking-values">${takenDisplay}${s.unit} / ${maxDisplay}${s.unit}</span>
                        </div>
                        <div class="tracking-bar">
                            <div class="tracking-fill ${barClass}" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Switch tracking tab
        function switchTrackingTab(tab) {
            trackingTab = tab;
            document.querySelectorAll('.tracking-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            loadTracking();
        }

        // Load saturation
        async function loadSaturation() {
            if (!currentUserId) return;

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/tracking/saturation?as_of_date=${dateStr}`);
                if (res.ok) {
                    const data = await res.json();
                    renderSaturation(data);
                }
            } catch (e) {
                console.error('Error loading saturation:', e);
            }
        }

        // Render saturation
        function renderSaturation(data) {
            const content = document.getElementById('saturation-content');
            const items = data.supplements || [];

            if (items.length === 0) {
                content.innerHTML = '<p style="color: #444; font-size: 0.85em;">No saturation data yet. Take supplements with saturation effects to see progress here.</p>';
                return;
            }

            content.innerHTML = items.map(s => {
                const pct = s.saturation_percentage || 0;
                const circumference = 2 * Math.PI * 32;
                const offset = circumference - (pct / 100) * circumference;
                let progressClass = '';
                let statusClass = '';
                let statusText = '';

                if (pct >= 100) {
                    statusClass = 'saturated';
                    statusText = 'Fully saturated';
                } else if (s.status === 'building' || s.consecutive_days > 0) {
                    progressClass = 'building';
                    statusClass = 'building';
                    statusText = `Building (${s.consecutive_days} days) - ${s.days_to_saturate - s.consecutive_days} days to full`;
                } else if (s.status === 'not_started') {
                    statusClass = '';
                    statusText = `Not started - ${s.days_to_saturate} days to saturate`;
                } else {
                    progressClass = 'decaying';
                    statusClass = 'decaying';
                    statusText = 'Decaying - take daily to maintain';
                }

                return `
                    <div class="saturation-item">
                        <div class="saturation-ring">
                            <svg width="80" height="80">
                                <circle class="bg" cx="40" cy="40" r="32"></circle>
                                <circle class="progress ${progressClass}" cx="40" cy="40" r="32"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${offset}"></circle>
                            </svg>
                            <div class="saturation-pct">${Math.round(pct)}%</div>
                        </div>
                        <div class="saturation-info">
                            <div class="saturation-name">${s.name}</div>
                            <div class="saturation-status ${statusClass}">${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle settings
        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('hidden');
        }

        // Load scenario
        async function loadScenario() {
            const scenario = document.getElementById('scenario').value;
            if (!currentUserId || scenario === 'none') return;

            try {
                const res = await fetch(`/integrations/${currentUserId}/mock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scenario: scenario })
                });

                if (res.ok) {
                    showStatus(`Loaded ${scenario} scenario`, 'success');
                    loadAllData();
                } else {
                    showStatus('Error loading scenario', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // ========== Custom Blend Builder ==========

        let selectedSupplements = {};
        let allSupplements = [];
        let aiSuggestions = [];
        let aiBlendName = 'Custom Blend';
        let aiBlendIcon = '';

        // Open blend builder
        async function openBlendBuilder() {
            document.getElementById('blend-builder-modal').classList.remove('hidden');
            document.getElementById('blend-name').value = '';
            document.getElementById('blend-icon').value = '&#x1F9EA;';
            selectedSupplements = {};
            aiSuggestions = [];

            await loadSupplements();
            renderSupplementGrid();
            updateSelectedSupplements();
        }

        // Close blend builder
        function closeBlendBuilder() {
            document.getElementById('blend-builder-modal').classList.add('hidden');
        }

        // Load all supplements
        async function loadSupplements() {
            try {
                const res = await fetch('/mixes/catalog');
                if (res.ok) {
                    const data = await res.json();
                    allSupplements = data.supplements || [];
                    renderCategories();
                }
            } catch (e) {
                console.error('Error loading supplements:', e);
            }
        }

        // Render categories
        function renderCategories() {
            const categories = [...new Set(allSupplements.map(s => s.category).filter(Boolean))];
            const container = document.getElementById('supplement-categories');

            container.innerHTML = `
                <button class="category-btn active" onclick="filterCategory('all')">All</button>
                ${categories.map(cat => `
                    <button class="category-btn" onclick="filterCategory('${cat}')">${cat.replace('_', ' ')}</button>
                `).join('')}
            `;
        }

        // Filter by category
        function filterCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            renderSupplementGrid(category);
        }

        // Render supplement grid
        function renderSupplementGrid(category = 'all') {
            const grid = document.getElementById('supplement-grid');
            let supplements = allSupplements;

            if (category !== 'all') {
                supplements = allSupplements.filter(s => s.category === category);
            }

            grid.innerHTML = supplements.map(s => `
                <div class="supplement-card ${selectedSupplements[s.id] ? 'selected' : ''}"
                     onclick="toggleSupplement('${s.id}')">
                    <div class="supplement-card-header">
                        <span class="supplement-card-name">${s.name}</span>
                        <span class="supplement-card-dose">${s.standard_dose}${s.unit}</span>
                    </div>
                    <div class="supplement-card-desc">${s.description}</div>
                    <div class="supplement-card-benefits">
                        ${(s.benefits || []).slice(0, 3).map(b => `<span class="benefit-tag">${b}</span>`).join('')}
                    </div>
                    ${s.pubmed_studies && s.pubmed_studies.length > 0 ? `
                        <div class="supplement-card-links">
                            ${s.pubmed_studies.slice(0, 2).map(link => `
                                <a href="${link.url}" target="_blank" class="pubmed-link" onclick="event.stopPropagation()">
                                    ${link.title.substring(0, 50)}...
                                </a>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Toggle supplement selection
        function toggleSupplement(id) {
            const supp = allSupplements.find(s => s.id === id);
            if (!supp) return;

            if (selectedSupplements[id]) {
                delete selectedSupplements[id];
            } else {
                selectedSupplements[id] = {
                    supplement_id: id,
                    name: supp.name,
                    dose: supp.standard_dose,
                    unit: supp.unit,
                    min_dose: supp.standard_dose * 0.5,
                    max_dose: supp.max_daily_dose
                };
            }

            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
        }

        // Update selected supplements display
        function updateSelectedSupplements() {
            const container = document.getElementById('selected-supplements');
            const list = document.getElementById('selected-supplements-list');
            const selected = Object.values(selectedSupplements);

            if (selected.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            list.innerHTML = selected.map(s => `
                <div class="selected-supp-item">
                    <span class="selected-supp-name">${s.name}</span>
                    <div class="selected-supp-dose">
                        <div class="dose-controls">
                            <input type="number" class="dose-input" value="${s.dose}"
                                min="${s.min_dose}" max="${s.max_dose}"
                                onchange="updateDose('${s.supplement_id}', this.value)">
                            <span class="dose-unit">${s.unit}</span>
                        </div>
                        <span class="dose-range">(${s.min_dose}-${s.max_dose})</span>
                        <button class="btn-remove-supp" onclick="removeSupplement('${s.supplement_id}')">&#x2715;</button>
                    </div>
                </div>
            `).join('');
        }

        // Update dose
        function updateDose(id, value) {
            if (selectedSupplements[id]) {
                selectedSupplements[id].dose = parseFloat(value);
            }
        }

        // Remove supplement
        function removeSupplement(id) {
            delete selectedSupplements[id];
            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
        }

        // AI Blend suggestion
        async function getAIBlendSuggestion() {
            const input = document.getElementById('ai-blend-input').value.trim();
            if (!input) {
                showStatus('Please describe what you want', 'error');
                return;
            }

            const suggestionsDiv = document.getElementById('ai-suggestions');
            const listDiv = document.getElementById('ai-suggestions-list');

            suggestionsDiv.classList.add('visible');
            listDiv.innerHTML = '<div class="ai-loading">Thinking</div>';

            try {
                const res = await fetch('/mixes/suggest-blend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_request: input, user_id: currentUserId })
                });

                if (res.ok) {
                    const data = await res.json();
                    aiSuggestions = data.supplements || [];
                    aiBlendName = data.blend_name || 'Custom Blend';
                    aiBlendIcon = data.blend_icon || '';
                    renderAISuggestions(data.summary);
                } else {
                    listDiv.innerHTML = '<p style="color: #EF4444;">Error getting suggestions</p>';
                }
            } catch (e) {
                listDiv.innerHTML = '<p style="color: #EF4444;">Error: ' + e.message + '</p>';
            }
        }

        // Render AI suggestions
        function renderAISuggestions(summary) {
            const listDiv = document.getElementById('ai-suggestions-list');

            if (aiSuggestions.length === 0) {
                listDiv.innerHTML = '<p style="color: #888;">No suggestions found. Try a different description.</p>';
                return;
            }

            // Show summary and suggested blend name
            let html = '';
            if (summary) {
                html += `<div style="color: #A78BFA; margin-bottom: 12px; font-size: 0.9em;">${summary}</div>`;
            }

            html += aiSuggestions.map(s => {
                // Look up supplement details from catalog
                const supp = allSupplements.find(sup => sup.id === s.supplement_id);
                const name = supp ? supp.name : s.supplement_id;
                const unit = supp ? supp.unit : 'mg';

                return `
                    <div class="ai-suggestion-item" onclick="addSuggestion('${s.supplement_id}', ${s.dose})">
                        <div>
                            <div class="ai-suggestion-name">${name}</div>
                            <div class="ai-suggestion-reason">${s.reason}</div>
                        </div>
                        <span class="ai-suggestion-dose">${s.dose}${unit}</span>
                    </div>
                `;
            }).join('');

            // Add "Add All" button
            html += `<button class="btn-dispense" onclick="addAllSuggestions()" style="margin-top: 12px; width: 100%;">Add All to Blend</button>`;

            listDiv.innerHTML = html;

            // Auto-fill blend name if empty
            const blendNameInput = document.getElementById('blend-name');
            if (!blendNameInput.value) {
                blendNameInput.value = aiBlendName;
            }
            const blendIconInput = document.getElementById('blend-icon');
            if (blendIconInput.value === '&#x1F9EA;' || !blendIconInput.value) {
                blendIconInput.value = aiBlendIcon;
            }
        }

        // Add single suggestion
        function addSuggestion(id, dose) {
            const suggestion = aiSuggestions.find(s => s.supplement_id === id);
            if (!suggestion) return;

            const supp = allSupplements.find(s => s.id === id);
            if (!supp) return;

            selectedSupplements[id] = {
                supplement_id: id,
                name: supp.name,
                dose: dose || suggestion.dose,
                unit: supp.unit,
                min_dose: supp.standard_dose * 0.5,
                max_dose: supp.max_daily_dose
            };

            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
            showStatus(`Added ${supp.name}`, 'success');
        }

        // Add all suggestions
        function addAllSuggestions() {
            aiSuggestions.forEach(s => {
                const supp = allSupplements.find(sup => sup.id === s.supplement_id);
                if (supp) {
                    selectedSupplements[s.supplement_id] = {
                        supplement_id: s.supplement_id,
                        name: supp.name,
                        dose: s.dose,
                        unit: supp.unit,
                        min_dose: supp.standard_dose * 0.5,
                        max_dose: supp.max_daily_dose
                    };
                }
            });

            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
            showStatus(`Added ${aiSuggestions.length} supplements`, 'success');
        }

        // Save custom blend
        async function saveCustomBlend() {
            const name = document.getElementById('blend-name').value.trim();
            const icon = document.getElementById('blend-icon').value || '&#x1F9EA;';
            const supplements = Object.values(selectedSupplements);

            if (!name) {
                showStatus('Please enter a blend name', 'error');
                return;
            }

            if (supplements.length === 0) {
                showStatus('Please select at least one supplement', 'error');
                return;
            }

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        icon,
                        components: supplements.map(s => ({
                            supplement_id: s.supplement_id,
                            dose: s.dose
                        }))
                    })
                });

                if (res.ok) {
                    showStatus('Blend created!', 'success');
                    closeBlendBuilder();
                    loadCustomBlends();
                    loadMixes();
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error creating blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Delete custom blend
        async function deleteCustomBlend(blendId) {
            if (!confirm('Delete this blend?')) return;

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}/${blendId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    showStatus('Blend deleted', 'success');
                    loadCustomBlends();
                    loadMixes();
                } else {
                    showStatus('Error deleting blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // ========== ANALYTICS FUNCTIONS ==========

        // Switch between Dashboard and Analytics tabs
        function switchMainTab(tab) {
            document.getElementById('nav-dashboard').classList.toggle('active', tab === 'dashboard');
            document.getElementById('nav-analytics').classList.toggle('active', tab === 'analytics');

            const dashboardSection = document.getElementById('dashboard-section');
            const analyticsSection = document.getElementById('analytics-section');

            if (tab === 'dashboard') {
                dashboardSection.classList.remove('hidden-section');
                analyticsSection.classList.remove('active');
                // Load Today's Stack (needs analytics data)
                loadTodaysStackData();
            } else {
                dashboardSection.classList.add('hidden-section');
                analyticsSection.classList.add('active');
                loadAnalyticsData();
            }
        }

        // Load minimal data for Today's Stack on Dashboard
        async function loadTodaysStackData() {
            if (!currentUserId) return;

            // Load supplement library if not already loaded
            if (!supplementLibrary) {
                await loadSupplementLibrary();
            }

            try {
                // Always fetch fresh analytics data (includes health data for Oura display)
                const res = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                if (res.ok) {
                    analyticsData = await res.json();
                }
                loadTodaysStack();
                // Update Oura metrics for the selected date
                updateOuraMetricsForSelectedDate();
            } catch (e) {
                console.error('Error loading Your Stack:', e);
            }
        }

        // Load all analytics data
        async function loadAnalyticsData() {
            if (!currentUserId) return;

            // Load supplement library if not already loaded
            if (!supplementLibrary) {
                await loadSupplementLibrary();
            }

            try {
                const res = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                if (res.ok) {
                    analyticsData = await res.json();
                    renderSupplementsGrid();
                    renderHealthChart();
                    renderSupplementMarkers();
                    loadSupplementInsights(); // Load the new insights feature
                    renderLifeEvents();
                    // Also refresh Your Stack on Dashboard
                    loadTodaysStack();
                    // Update progressive disclosure elements
                    updateProgressiveDisclosure();
                }
            } catch (e) {
                console.error('Error loading analytics:', e);
            }
        }

        // Load and render supplement insights
        async function loadSupplementInsights() {
            if (!currentUserId) return;

            const container = document.getElementById('insights-content');
            if (!container) return;

            try {
                const res = await fetch(`/analytics/${currentUserId}/supplement-insights`);
                if (res.ok) {
                    const data = await res.json();
                    renderSupplementInsights(data);
                } else {
                    container.innerHTML = '<div class="insights-empty"><div class="insights-empty-icon"></div><div>Unable to load insights</div></div>';
                }
            } catch (e) {
                console.error('Error loading supplement insights:', e);
                container.innerHTML = '<div class="insights-empty"><div class="insights-empty-icon"></div><div>Unable to load insights</div></div>';
            }
        }

        // Render supplement insights
        function renderSupplementInsights(data) {
            const container = document.getElementById('insights-content');
            if (!container) return;

            const { impact_analysis, consistency_tracking, summary } = data;

            if (summary.total_supplements === 0) {
                container.innerHTML = `
                    <div class="insights-empty">
                        <div class="insights-empty-icon"></div>
                        <div>No supplements to analyze yet</div>
                        <div style="font-size: 0.85em; margin-top: 8px; color: #666;">Add supplements you're taking to see insights</div>
                    </div>
                `;
                return;
            }

            let html = '';

            // Impact Analysis Section
            if (impact_analysis.length > 0) {
                html += '<div class="insights-section-title"> Impact Analysis</div>';

                impact_analysis.forEach(insight => {
                    const hasData = insight.has_sufficient_data && insight.change !== null;
                    const isPositive = insight.is_positive;
                    const cardClass = !hasData ? 'pending' : (isPositive ? 'positive' : 'negative');
                    const badgeClass = !hasData ? 'pending' : (isPositive ? 'positive' : 'negative');

                    let badgeText = '';
                    if (!hasData) {
                        badgeText = insight.message || 'Collecting data...';
                    } else {
                        const sign = insight.change_pct > 0 ? '+' : '';
                        badgeText = `${sign}${insight.change_pct}%`;
                    }

                    html += `
                        <div class="insight-card ${cardClass}">
                            <div class="insight-header">
                                <div>
                                    <div class="insight-supp-name">${insight.supplement_name}</div>
                                    <div class="insight-start-date">Started ${formatDateShort(insight.start_date)}  ${insight.days_on} days</div>
                                </div>
                                <div class="insight-badge ${badgeClass}">${badgeText}</div>
                            </div>
                    `;

                    if (hasData) {
                        const changeClass = isPositive ? 'positive' : 'negative';
                        const arrow = isPositive ? '' : '';
                        html += `
                            <div class="insight-metric">
                                <div class="insight-metric-label">${insight.metric_display_name}</div>
                                <div class="insight-metric-values">
                                    <span class="insight-metric-before">${insight.before_avg}</span>
                                    <span class="insight-metric-arrow"></span>
                                    <span class="insight-metric-after">${insight.after_avg}</span>
                                    <span class="insight-metric-change ${changeClass}">${arrow} ${Math.abs(insight.change_pct)}%</span>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="color: #888; font-size: 0.85em; margin: 8px 0;">
                                Tracking ${insight.metric_display_name}  ${insight.expected_effect}
                            </div>
                        `;
                    }

                    // Footer with confidence and adherence
                    const confidenceClass = insight.confidence === 'high' || insight.confidence === 'very_high' ? 'high' :
                                           insight.confidence === 'medium' ? 'medium' : 'low';
                    const confidenceText = hasData ? (
                        insight.confidence === 'high' || insight.confidence === 'very_high' ? 'High confidence' :
                        insight.confidence === 'medium' ? 'Medium confidence' : 'Low confidence'
                    ) : 'Gathering data';

                    html += `
                            <div class="insight-footer">
                                <div class="insight-confidence">
                                    <span class="insight-confidence-dot ${confidenceClass}"></span>
                                    <span>${confidenceText}</span>
                                </div>
                                <div class="insight-adherence">
                                    ${insight.streak_days > 0 ? `<span class="insight-streak"> ${insight.streak_days} day streak</span>` : ''}
                                    <span>${insight.adherence_pct}% adherence</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // Consistency Tracking Section
            if (consistency_tracking.length > 0) {
                html += '<div class="insights-section-title"> Consistency Tracking</div>';
                html += '<div class="consistency-info">These supplements have long-term benefits that build over months. Keep taking them consistently!</div>';
                html += '<div class="consistency-grid">';

                consistency_tracking.forEach(supp => {
                    const barWidth = Math.min(100, supp.adherence_pct);
                    html += `
                        <div class="consistency-card">
                            <div class="consistency-header">
                                <div class="consistency-name">${supp.supplement_name}</div>
                                ${supp.streak_days > 0 ? `<div class="consistency-streak"> ${supp.streak_days}d</div>` : ''}
                            </div>
                            <div class="consistency-bar">
                                <div class="consistency-bar-fill" style="width: ${barWidth}%"></div>
                            </div>
                            <div class="consistency-stats">
                                <span>${supp.adherence_pct}% adherence</span>
                                <span>${supp.days_on} days</span>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            container.innerHTML = html;
        }

        // Format date as "Jan 5"
        function formatDateShort(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Render health metrics chart
        function renderHealthChart() {
            const ctx = document.getElementById('health-chart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (healthChart) {
                healthChart.destroy();
            }

            const healthData = analyticsData?.health_data || [];
            if (healthData.length === 0) {
                return;
            }

            // Sort by date
            healthData.sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = healthData.map(d => d.date);
            const sleepScores = healthData.map(d => d.sleep_score);
            const hrvScores = healthData.map(d => d.hrv_score);
            const recoveryScores = healthData.map(d => d.recovery_score);

            // Get supplement start dates for vertical lines
            const supplementStarts = analyticsData?.supplement_starts || [];
            const lifeEvents = analyticsData?.life_events || [];

            // Create annotations for supplement starts (different colors for manual vs recommended)
            const annotations = {};
            supplementStarts.forEach((start, i) => {
                const isManual = start.is_manual;
                const color = isManual ? '#22C55E' : '#8B5CF6';
                const bgColor = isManual ? 'rgba(34, 197, 94, 0.8)' : 'rgba(139, 92, 246, 0.8)';

                annotations[`supp-${i}`] = {
                    type: 'line',
                    xMin: start.start_date,
                    xMax: start.start_date,
                    borderColor: color,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: {
                        display: true,
                        content: (start.supplement_name || start.supplement_id.replace(/_/g, ' ')).substring(0, 15),
                        position: 'start',
                        backgroundColor: bgColor,
                        color: '#fff',
                        font: { size: 10 }
                    }
                };
            });

            // Add life event markers
            lifeEvents.forEach((event, i) => {
                const color = event.impact === 'positive' ? '#22C55E' :
                              event.impact === 'negative' ? '#EF4444' : '#666';
                annotations[`event-${i}`] = {
                    type: 'line',
                    xMin: event.date,
                    xMax: event.date,
                    borderColor: color,
                    borderWidth: 1,
                    borderDash: [3, 3]
                };
            });

            healthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sleep Score',
                            data: sleepScores,
                            borderColor: '#8B5CF6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'HRV',
                            data: hrvScores,
                            borderColor: '#22C55E',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Recovery',
                            data: recoveryScores,
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.95)',
                            titleColor: '#E8E8E8',
                            bodyColor: '#A0A0A0',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#666',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#666'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });
        }

        // Render supplement start markers
        function renderSupplementMarkers() {
            const container = document.getElementById('supplement-markers-list');
            if (!container) return;

            const starts = analyticsData?.supplement_starts || [];

            // Add legend for marker colors
            let html = `
                <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 0.8em;">
                    <div class="legend-marker">
                        <div class="legend-marker-dot recommended"></div>
                        <span>Tracked</span>
                    </div>
                    <div class="legend-marker">
                        <div class="legend-marker-dot manual"></div>
                        <span>Manual</span>
                    </div>
                </div>
            `;

            html += starts.map(start => {
                const isManual = start.is_manual;
                const dotColor = isManual ? 'background: #22C55E;' : 'background: #8B5CF6;';
                const nameColor = isManual ? 'color: #22C55E;' : 'color: #A78BFA;';

                return `
                    <div class="marker-item" style="${isManual ? 'border-color: rgba(34, 197, 94, 0.2); background: rgba(34, 197, 94, 0.08);' : ''}">
                        <div class="marker-dot" style="${dotColor}"></div>
                        <span class="marker-name" style="${nameColor}">${start.supplement_name || formatSupplementName(start.supplement_id)}</span>
                        <span class="marker-date">${formatDate(start.start_date)}</span>
                    </div>
                `;
            }).join('');

            html += `<button class="add-marker-btn" onclick="openAddSupplementStart()">+ Add Supplement Start</button>`;

            container.innerHTML = html;
        }

        // ========== YOUR STACK - QUICK LOG ==========

        // Load and render Your Stack on Dashboard (uses selected date from date nav)
        async function loadTodaysStack() {
            const container = document.getElementById('stack-pills');
            const dateEl = document.getElementById('todays-stack-date');
            if (!container) return;

            // Use selected date from date navigation (currentDate)
            const selectedDate = currentDate;
            const selectedDateStr = selectedDate.toISOString().split('T')[0];

            // Determine if today, past, or future
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selected = new Date(selectedDate);
            selected.setHours(0, 0, 0, 0);
            const isToday = today.getTime() === selected.getTime();
            const isFuture = selected.getTime() > today.getTime();

            // Format date label
            if (isToday) {
                dateEl.textContent = 'Today';
            } else if (isFuture) {
                dateEl.textContent = selectedDate.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                }) + ' (future)';
            } else {
                dateEl.textContent = selectedDate.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // Handle future dates - show message instead of logging pills
            if (isFuture) {
                container.innerHTML = `
                    <div class="stack-future">
                        <div class="stack-future-icon"></div>
                        <div class="stack-future-text">Future date</div>
                        <div class="stack-future-hint">Navigate to today or a past date to log supplements</div>
                    </div>
                `;
                return;
            }

            // Get active supplements from analytics data
            const activeSupplements = (analyticsData?.supplement_starts || [])
                .filter(s => !s.end_date);

            // Get logs for selected date (NOT auto-populated)
            const selectedDateLogs = (analyticsData?.supplement_logs || [])
                .filter(l => l.date === selectedDateStr);

            // Build lookup for what's already logged ON THIS DATE
            const loggedOnDate = {};
            selectedDateLogs.forEach(log => {
                if (log.taken) {
                    loggedOnDate[log.supplement_id] = log.time_taken || 'morning';
                }
            });

            // Render the pills
            renderTodaysStack(activeSupplements, loggedOnDate);
        }

        // Render Today's Stack pills
        function renderTodaysStack(supplements, loggedToday) {
            const container = document.getElementById('stack-pills');
            if (!container) return;

            if (supplements.length === 0) {
                container.innerHTML = `
                    <div class="stack-empty">
                        <div class="stack-empty-icon"></div>
                        <div class="stack-empty-text">Start Your Supplement Journey</div>
                        <div class="stack-empty-hint">Add the supplements you take daily and track their impact on your health</div>
                        <div class="quick-add-buttons">
                            <button class="quick-add-btn" onclick="quickAddSupplement('vitamin_d3', 'Vitamin D3', '2000 IU')">+ Vitamin D</button>
                            <button class="quick-add-btn" onclick="quickAddSupplement('fish_oil', 'Fish Oil', '1000mg')">+ Fish Oil</button>
                            <button class="quick-add-btn" onclick="quickAddSupplement('magnesium_glycinate', 'Magnesium', '400mg')">+ Magnesium</button>
                            <button class="quick-add-btn" onclick="quickAddSupplement('vitamin_b12', 'Vitamin B12', '1000mcg')">+ B12</button>
                        </div>
                        <button onclick="switchMainTab('analytics'); setTimeout(() => openAddManualSupplement(), 100);" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: #fff; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 12px;">
                            + Add Your First Supplement
                        </button>
                    </div>
                `;
                return;
            }

            let html = supplements.map(supp => {
                const suppId = supp.supplement_id;
                const suppName = supp.supplement_name || formatSupplementName(suppId);
                const dosage = supp.dosage || '';
                const isTaken = loggedToday[suppId] !== undefined;
                const timeTaken = loggedToday[suppId] || '';

                return `
                    <div class="stack-pill ${isTaken ? 'taken' : ''}"
                         id="stack-pill-${suppId}"
                         onclick="toggleStackLog('${suppId}', '${suppName.replace(/'/g, "\\'")}', '${dosage.replace(/'/g, "\\'")}')">
                        <div class="stack-pill-check"></div>
                        <div class="stack-pill-name">${suppName}</div>
                        <div class="stack-pill-dose">${dosage || 'Tap to log'}</div>
                        <div class="stack-pill-time">${isTaken ? (timeTaken === 'morning' ? 'AM' : 'PM') : ''}</div>
                    </div>
                `;
            }).join('');

            // Add the "Add supplement" pill
            html += `
                <div class="stack-add-pill" onclick="switchMainTab('analytics'); setTimeout(() => openAddManualSupplement(), 100);">
                    <div class="stack-add-icon">+</div>
                    <div class="stack-add-text">Add</div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Toggle a supplement log with one tap
        async function toggleStackLog(suppId, suppName, dosage) {
            if (!currentUserId) return;

            const pill = document.getElementById(`stack-pill-${suppId}`);
            if (!pill) return;

            const isCurrentlyTaken = pill.classList.contains('taken');

            // Use selected date from date navigation
            const selectedDateStr = currentDate.toISOString().split('T')[0];

            // Auto-detect AM/PM based on selected time (currentTime is the hour)
            const autoTime = currentTime < 12 ? 'morning' : 'evening';

            // Optimistic UI update
            pill.classList.toggle('taken', !isCurrentlyTaken);
            const timeEl = pill.querySelector('.stack-pill-time');
            if (!isCurrentlyTaken) {
                timeEl.textContent = autoTime === 'morning' ? 'AM' : 'PM';
            } else {
                timeEl.textContent = '';
            }

            try {
                // Call the API with single supplement for the selected date
                const res = await fetch(`/analytics/${currentUserId}/daily-checkin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: selectedDateStr,
                        supplements: [{
                            supplement_id: suppId,
                            taken: !isCurrentlyTaken,
                            time_taken: autoTime
                        }]
                    })
                });

                if (!res.ok) throw new Error('Failed to save');

                // Refresh analytics data in background to keep in sync
                const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                if (analyticsRes.ok) {
                    analyticsData = await analyticsRes.json();
                }

            } catch (e) {
                console.error('Error toggling supplement:', e);
                // Revert UI on error
                pill.classList.toggle('taken', isCurrentlyTaken);
                timeEl.textContent = isCurrentlyTaken ? (autoTime === 'morning' ? 'AM' : 'PM') : '';
                showStatus('Failed to save. Please try again.', 'error');
            }
        }

        // Quick add a common supplement (one-click from empty state)
        async function quickAddSupplement(suppId, suppName, dosage) {
            if (!currentUserId) return;

            const today = new Date().toISOString().split('T')[0];

            try {
                // Add the supplement to tracking
                const res = await fetch(`/analytics/${currentUserId}/supplement-starts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        supplement_id: suppId,
                        supplement_name: suppName,
                        start_date: today,
                        is_manual: true,
                        dosage: dosage,
                        frequency: 'daily'
                    })
                });

                if (res.ok) {
                    showStatus(`${suppName} added!`, 'success');
                    // Refresh analytics data and re-render
                    const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                    if (analyticsRes.ok) {
                        analyticsData = await analyticsRes.json();
                        loadTodaysStack();
                    }
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error adding supplement', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // ========== END YOUR STACK ==========

        // Render outcome analysis cards
        async function renderOutcomeCards() {
            const container = document.getElementById('outcome-cards');
            if (!container) return;

            const starts = analyticsData?.supplement_starts || [];
            if (starts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">&#x1F4CA;</div>
                        <div>Add supplement start dates to see analysis</div>
                    </div>
                `;
                return;
            }

            // Fetch outcome analysis for each supplement
            const cards = [];
            for (const start of starts) {
                try {
                    const res = await fetch(`/analytics/${currentUserId}/outcome-analysis/${start.supplement_id}`);
                    if (res.ok) {
                        const data = await res.json();
                        cards.push(renderOutcomeCard(data));
                    }
                } catch (e) {
                    console.error('Error fetching outcome:', e);
                }
            }

            container.innerHTML = cards.length > 0 ? cards.join('') : `
                <div class="empty-state">
                    <div class="emoji">&#x1F4CA;</div>
                    <div>Not enough data yet for analysis</div>
                </div>
            `;
        }

        // Render single outcome card with confidence and trends
        function renderOutcomeCard(data) {
            const changes = data.changes || {};
            const adherence = data.adherence?.rate_pct || 0;
            const trends = data.trends || {};
            const confoundingEvents = data.confounding_events || [];
            const overallConfidence = data.overall_confidence || 'low';
            const hasSufficientData = data.has_sufficient_data !== false;

            // Confidence badge
            const confidenceBadgeClass = {
                'high': 'confidence-high',
                'very_high': 'confidence-high',
                'medium': 'confidence-medium',
                'low': 'confidence-low',
                'needs_more_data': 'confidence-low',
                'confounded': 'confidence-warning'
            }[overallConfidence] || 'confidence-low';

            const confidenceLabel = {
                'high': 'High Confidence',
                'very_high': 'Very High Confidence',
                'medium': 'Medium Confidence',
                'low': 'Low Confidence',
                'needs_more_data': `Need ${data.min_data_days || 14}+ days`,
                'confounded': 'Check Life Events'
            }[overallConfidence] || 'Low Confidence';

            // Metrics with confidence indicators
            const metricsHtml = Object.entries(changes).map(([key, change]) => {
                const isPositive = key === 'resting_hr' ? change.change < 0 : change.change > 0;
                const diffClass = change.change === 0 ? 'neutral' : (isPositive ? 'positive' : 'negative');
                const arrow = change.change > 0 ? '' : (change.change < 0 ? '' : '');

                // Add confidence indicator
                const confidence = change.confidence || 'low';
                const confDot = confidence === 'high' || confidence === 'very_high' ? '' :
                               confidence === 'medium' ? '' : '';

                // Get trend if available
                const trend = trends[key];
                let trendHtml = '';
                if (trend && trend.direction !== 'insufficient_data') {
                    const trendIcon = trend.interpretation === 'improving' ? '' :
                                     trend.interpretation === 'declining' || trend.interpretation === 'worsening' ? '' : '';
                    trendHtml = `<span class="metric-trend" title="${trend.strength} trend">${trendIcon}</span>`;
                }

                return `
                    <div class="outcome-metric">
                        <span class="metric-name">${formatMetricName(key)} <span class="conf-dot" title="${confidence} confidence">${confDot}</span></span>
                        <div class="metric-change">
                            <span class="metric-values">${change.before}  ${change.after}</span>
                            <span class="metric-diff ${diffClass}">${arrow} ${Math.abs(change.change_pct).toFixed(0)}%</span>
                            ${trendHtml}
                        </div>
                    </div>
                `;
            }).join('');

            // Confounding events warning
            let confoundingHtml = '';
            if (confoundingEvents.length > 0) {
                const eventNames = confoundingEvents.map(e => formatEventType(e.event_type)).join(', ');
                confoundingHtml = `
                    <div class="confounding-warning">
                         Life event${confoundingEvents.length > 1 ? 's' : ''} near start: ${eventNames}
                    </div>
                `;
            }

            // Insufficient data message
            let insufficientHtml = '';
            if (!hasSufficientData) {
                const daysNeeded = Math.max(1, (data.min_data_days || 14) - data.days_on_supplement);
                insufficientHtml = `
                    <div class="insufficient-data-notice">
                         Need ${daysNeeded} more day${daysNeeded !== 1 ? 's' : ''} of data for reliable analysis
                    </div>
                `;
            }

            return `
                <div class="outcome-card ${!hasSufficientData ? 'insufficient-data' : ''}">
                    <div class="outcome-header">
                        <div>
                            <div class="outcome-supplement">${data.supplement_name || formatSupplementName(data.supplement_id)}</div>
                            <div class="outcome-duration">Started ${formatDate(data.start_date)} (${data.days_on_supplement} days)</div>
                        </div>
                        <div class="outcome-badges">
                            <div class="confidence-badge ${confidenceBadgeClass}">${confidenceLabel}</div>
                            <div class="outcome-adherence">
                                <div class="adherence-value">${adherence.toFixed(0)}%</div>
                                <div class="adherence-label">Adherence</div>
                            </div>
                        </div>
                    </div>
                    ${confoundingHtml}
                    ${insufficientHtml}
                    <div class="outcome-metrics">
                        ${metricsHtml || '<div style="color: #666; font-size: 0.9em;">Not enough data yet</div>'}
                    </div>
                </div>
            `;
        }

        // Render correlation insights
        async function renderCorrelationCards() {
            const container = document.getElementById('correlation-cards');
            if (!container) return;

            try {
                const res = await fetch(`/analytics/${currentUserId}/correlations?days=60`);
                if (!res.ok) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="emoji"></div>
                            <div>Log daily supplement intake to see correlations</div>
                        </div>
                    `;
                    return;
                }

                const data = await res.json();
                const correlations = data.correlations || [];

                if (correlations.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="emoji"></div>
                            <div>Log daily supplement intake to see correlations</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 6px;">Need at least 5 days of data per supplement</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = correlations.map(corr => renderCorrelationCard(corr)).join('');
            } catch (e) {
                console.error('Error fetching correlations:', e);
            }
        }

        // Render single correlation card
        function renderCorrelationCard(corr) {
            const metrics = corr.metrics || [];
            const best = corr.best_correlation;

            const metricsHtml = metrics.map(m => {
                const isPositive = m.is_positive;
                const diffClass = isPositive ? 'positive' : 'negative';
                const arrow = m.difference > 0 ? '+' : '';
                const strengthClass = m.strength === 'strong' ? 'strong' :
                                     m.strength === 'moderate' ? 'moderate' : '';

                return `
                    <div class="correlation-metric">
                        <span class="corr-metric-name">${formatMetricName(m.metric)}</span>
                        <div class="corr-metric-diff">
                            <span class="corr-diff-value ${diffClass}">${arrow}${m.difference.toFixed(1)}</span>
                            <span class="corr-strength ${strengthClass}">${m.strength}</span>
                        </div>
                    </div>
                `;
            }).join('');

            const bestMetricText = best ? `Best: ${formatMetricName(best.metric)}` : 'No clear correlation';
            const bestValueText = best ? `+${best.difference.toFixed(1)}` : '--';

            return `
                <div class="correlation-card">
                    <div class="correlation-header">
                        <div>
                            <div class="correlation-supplement">${corr.supplement_name}</div>
                            <div class="correlation-days">${corr.days_taken} days taken of ${corr.total_days_analyzed} analyzed</div>
                        </div>
                        <div class="correlation-best">
                            <div class="best-metric-label">${bestMetricText}</div>
                            <div class="best-metric-value">${bestValueText}</div>
                        </div>
                    </div>
                    <div class="correlation-metrics">
                        ${metricsHtml || '<div style="color: #666; font-size: 0.9em;">Not enough data</div>'}
                    </div>
                </div>
            `;
        }

        // Render life events
        function renderLifeEvents() {
            const container = document.getElementById('life-events-list');
            if (!container) return;

            const events = analyticsData?.life_events || [];

            if (events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 16px;">
                        <div style="color: #666;">No life events logged yet</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = events.map(event => {
                const icon = getEventIcon(event.event_type);
                return `
                    <div class="life-event-item">
                        <div class="life-event-icon ${event.impact || 'neutral'}">${icon}</div>
                        <div class="life-event-info">
                            <div class="life-event-type">${formatEventType(event.event_type)}</div>
                            <div class="life-event-date">${formatDate(event.date)}${event.description ? ' - ' + event.description : ''}</div>
                        </div>
                        <button class="life-event-delete" onclick="deleteLifeEvent('${event.id}')">Delete</button>
                    </div>
                `;
            }).join('');
        }

        // Toggle add event form
        function toggleAddEventForm() {
            const form = document.getElementById('add-event-form');
            form.classList.toggle('visible');
            if (form.classList.contains('visible')) {
                document.getElementById('event-date').value = new Date().toISOString().split('T')[0];
            }
        }

        // Save life event
        async function saveLifeEvent() {
            const eventDate = document.getElementById('event-date').value;
            const eventType = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value;
            const impact = document.getElementById('event-impact').value;

            if (!eventDate || !eventType) {
                showStatus('Please select date and event type', 'error');
                return;
            }

            try {
                const res = await fetch(`/analytics/${currentUserId}/life-events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_date: eventDate,
                        event_type: eventType,
                        description: description || null,
                        impact: impact
                    })
                });

                if (res.ok) {
                    showStatus('Life event saved!', 'success');
                    toggleAddEventForm();
                    loadAnalyticsData();
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error saving event', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Delete life event
        async function deleteLifeEvent(eventId) {
            if (!confirm('Delete this life event?')) return;

            try {
                const res = await fetch(`/analytics/${currentUserId}/life-events/${eventId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    showStatus('Event deleted', 'success');
                    loadAnalyticsData();
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Supplement library data
        let supplementLibrary = null;

        // Load supplement library
        async function loadSupplementLibrary() {
            try {
                const res = await fetch('/analytics/supplement-library');
                if (res.ok) {
                    supplementLibrary = await res.json();
                }
            } catch (e) {
                console.error('Error loading supplement library:', e);
            }
        }

        // Open add supplement modal (for manual supplements)
        function openAddManualSupplement() {
            document.getElementById('supplement-modal-title').textContent = 'Add Supplement';
            document.getElementById('supplement-modal-subtitle').textContent = 'Track a supplement you\'re taking';
            document.getElementById('start-is-manual').value = 'true';
            populateSupplementDropdown();
            resetSupplementForm();
            document.getElementById('supplement-start-modal').classList.remove('hidden');
        }

        // Open add supplement start modal (for chart markers)
        function openAddSupplementStart() {
            document.getElementById('supplement-modal-title').textContent = 'Add Supplement Start';
            document.getElementById('supplement-modal-subtitle').textContent = 'Track when you started a supplement';
            document.getElementById('start-is-manual').value = 'false';
            populateSupplementDropdown();
            resetSupplementForm();
            document.getElementById('supplement-start-modal').classList.remove('hidden');
        }

        // Open edit supplement modal
        function openEditSupplement(suppId) {
            // Find the supplement in analyticsData
            const supp = (analyticsData?.supplement_starts || []).find(s => s.id === suppId);
            if (!supp) {
                showStatus('Supplement not found', 'error');
                return;
            }

            document.getElementById('supplement-modal-title').textContent = 'Edit Supplement';
            document.getElementById('supplement-modal-subtitle').textContent = 'Update ' + (supp.supplement_name || formatSupplementName(supp.supplement_id));
            document.getElementById('start-is-manual').value = supp.is_manual ? 'true' : 'false';
            document.getElementById('edit-supplement-id').value = suppId;

            populateSupplementDropdown();

            // Set the supplement selection
            const select = document.getElementById('start-supplement-id');
            select.value = supp.supplement_id;
            if (!select.value) {
                // Custom supplement not in list
                select.value = 'custom';
                document.getElementById('custom-name-row').style.display = 'block';
                document.getElementById('start-supplement-name').value = supp.supplement_name || '';
            }
            select.disabled = true; // Can't change supplement type when editing

            // Pre-fill form values
            document.getElementById('start-date').value = supp.start_date;
            document.getElementById('start-date').disabled = true; // Can't change start date when editing
            document.getElementById('start-dosage').value = supp.dosage || '';
            document.getElementById('start-frequency').value = supp.frequency || 'daily';
            document.getElementById('start-reason').value = supp.reason || '';
            document.getElementById('start-notes').value = supp.notes || '';

            // Hide adherence row (not applicable for edits)
            document.getElementById('adherence-row').style.display = 'none';

            // Update save button text
            document.getElementById('supplement-save-btn').textContent = 'Save Changes';

            document.getElementById('supplement-start-modal').classList.remove('hidden');
        }

        // Populate supplement dropdown from library
        function populateSupplementDropdown() {
            const select = document.getElementById('start-supplement-id');

            if (supplementLibrary && supplementLibrary.supplements) {
                select.innerHTML = supplementLibrary.supplements.map(s =>
                    `<option value="${s.id}" data-dose="${s.typical_dose}">${s.name}</option>`
                ).join('');
                select.innerHTML += '<option value="custom">+ Add Custom Supplement</option>';
            } else {
                // Fallback if library not loaded
                const supplements = [
                    'vitamin_d3', 'fish_oil', 'magnesium', 'zinc', 'b_complex', 'creatine',
                    'protein_powder', 'melatonin', 'probiotics', 'iron', 'vitamin_c',
                    'multivitamin', 'caffeine', 'ashwagandha', 'l_theanine', 'collagen'
                ];
                select.innerHTML = supplements.map(s =>
                    `<option value="${s}">${formatSupplementName(s)}</option>`
                ).join('');
                select.innerHTML += '<option value="custom">+ Add Custom Supplement</option>';
            }
        }

        // Reset supplement form
        function resetSupplementForm() {
            document.getElementById('start-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('start-dosage').value = '';
            document.getElementById('start-frequency').value = 'daily';
            document.getElementById('start-reason').value = '';
            document.getElementById('start-notes').value = '';
            document.getElementById('custom-name-row').style.display = 'none';
            document.getElementById('start-supplement-name').value = '';
            document.getElementById('edit-supplement-id').value = '';
            document.getElementById('start-adherence').value = 80;
            document.getElementById('adherence-label').textContent = '80%';
            document.getElementById('adherence-row').style.display = 'none';
            document.getElementById('supplement-save-btn').textContent = 'Add Supplement';
            onSupplementSelect();
            checkBackdateAdherence();
        }

        // Update adherence label when slider changes
        function updateAdherenceLabel() {
            const value = document.getElementById('start-adherence').value;
            document.getElementById('adherence-label').textContent = value + '%';
        }

        // Check if start date is in the past and show adherence option
        function checkBackdateAdherence() {
            const startDate = document.getElementById('start-date').value;
            const adherenceRow = document.getElementById('adherence-row');

            if (!startDate) {
                adherenceRow.style.display = 'none';
                return;
            }

            const start = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            start.setHours(0, 0, 0, 0);

            // Show adherence option if start date is more than 1 day in the past
            const daysDiff = Math.floor((today - start) / (1000 * 60 * 60 * 24));
            if (daysDiff > 1) {
                adherenceRow.style.display = 'block';
            } else {
                adherenceRow.style.display = 'none';
            }
        }

        // Handle supplement selection change
        function onSupplementSelect() {
            const select = document.getElementById('start-supplement-id');
            const customRow = document.getElementById('custom-name-row');
            const dosageInput = document.getElementById('start-dosage');

            if (select.value === 'custom') {
                customRow.style.display = 'block';
            } else {
                customRow.style.display = 'none';
                // Auto-fill typical dose
                const option = select.options[select.selectedIndex];
                const typicalDose = option.dataset.dose;
                if (typicalDose && !dosageInput.value) {
                    dosageInput.placeholder = `Typical: ${typicalDose}`;
                }
            }
        }

        // Close supplement start modal
        function closeSupplementStartModal() {
            document.getElementById('supplement-start-modal').classList.add('hidden');
            // Re-enable fields that might have been disabled for edit mode
            document.getElementById('start-supplement-id').disabled = false;
            document.getElementById('start-date').disabled = false;
        }

        // Save supplement start (handles both add and edit)
        async function saveSupplementStart() {
            const select = document.getElementById('start-supplement-id');
            const editId = document.getElementById('edit-supplement-id').value;
            let supplementId = select.value;
            let supplementName = null;

            if (supplementId === 'custom') {
                supplementName = document.getElementById('start-supplement-name').value.trim();
                if (!supplementName) {
                    showStatus('Please enter a supplement name', 'error');
                    return;
                }
                supplementId = supplementName.toLowerCase().replace(/\s+/g, '_');
            } else {
                supplementName = select.options[select.selectedIndex].text;
            }

            const startDate = document.getElementById('start-date').value;
            const dosage = document.getElementById('start-dosage').value;
            const frequency = document.getElementById('start-frequency').value;
            const reason = document.getElementById('start-reason').value;
            const notes = document.getElementById('start-notes').value;
            const isManual = document.getElementById('start-is-manual').value === 'true';

            if (!supplementId || !startDate) {
                showStatus('Please select supplement and date', 'error');
                return;
            }

            try {
                let res;
                if (editId) {
                    // Update existing supplement
                    res = await fetch(`/analytics/${currentUserId}/supplement-starts/${editId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            dosage: dosage || null,
                            frequency: frequency || null,
                            reason: reason || null,
                            notes: notes || null
                        })
                    });
                } else {
                    // Create new supplement
                    res = await fetch(`/analytics/${currentUserId}/supplement-starts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            supplement_id: supplementId,
                            supplement_name: supplementName,
                            start_date: startDate,
                            notes: notes || null,
                            is_manual: isManual,
                            dosage: dosage || null,
                            frequency: frequency || null,
                            reason: reason || null
                        })
                    });
                }

                if (res.ok) {
                    // Check if we need to create backdate logs
                    const adherenceRow = document.getElementById('adherence-row');
                    if (!editId && adherenceRow.style.display !== 'none') {
                        const adherence = parseInt(document.getElementById('start-adherence').value) / 100;
                        await createBackdateLogs(supplementId, startDate, adherence);
                    }

                    showStatus(editId ? 'Supplement updated!' : 'Supplement added!', 'success');
                    closeSupplementStartModal();
                    loadAnalyticsData();
                    loadTodaysStackData();
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error saving', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Create backdate logs based on adherence percentage
        async function createBackdateLogs(supplementId, startDate, adherence) {
            const start = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            start.setHours(0, 0, 0, 0);

            const daysDiff = Math.floor((today - start) / (1000 * 60 * 60 * 24));
            if (daysDiff <= 1) return;

            // Generate logs for past days based on adherence
            const datesToLog = [];
            for (let i = 0; i < daysDiff; i++) {
                if (Math.random() < adherence) {
                    const logDate = new Date(start);
                    logDate.setDate(logDate.getDate() + i);
                    datesToLog.push(logDate.toISOString().split('T')[0]);
                }
            }

            // Create logs for each date (using correct API format)
            for (const dateStr of datesToLog) {
                try {
                    await fetch(`/analytics/${currentUserId}/daily-checkin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            date: dateStr,
                            supplements: [{
                                supplement_id: supplementId,
                                taken: true,
                                time_taken: 'morning'
                            }]
                        })
                    });
                } catch (e) {
                    console.error('Error creating backdate log:', e);
                }
            }
        }

        // Render supplements grid (My Supplements)
        function renderSupplementsGrid() {
            const container = document.getElementById('supplements-grid');
            if (!container) return;

            const supplements = analyticsData?.supplement_starts || [];

            if (supplements.length === 0) {
                container.innerHTML = `
                    <div class="supplements-empty">
                        <div class="supplements-empty-icon"></div>
                        <div>No supplements tracked yet</div>
                        <div style="font-size: 0.85em; margin-top: 6px;">Add the supplements you're currently taking</div>
                    </div>
                `;
                return;
            }

            // Separate active supplements (no end_date)
            const active = supplements.filter(s => !s.end_date);

            container.innerHTML = active.map(supp => {
                const isManual = supp.is_manual;
                const typeClass = isManual ? 'manual' : 'recommended';
                const icon = getSupplementIcon(supp.supplement_id);
                const reasonText = supp.reason ? formatReason(supp.reason) : '';
                const suppName = supp.supplement_name || formatSupplementName(supp.supplement_id);

                return `
                    <div class="supplement-card ${typeClass}">
                        <div class="supplement-icon ${typeClass}">${icon}</div>
                        <div class="supplement-details">
                            <div class="supplement-name">${suppName}</div>
                            <div class="supplement-meta">
                                ${supp.dosage ? `<span class="supplement-tag">${supp.dosage}</span>` : ''}
                                ${supp.frequency ? `<span class="supplement-tag">${formatFrequency(supp.frequency)}</span>` : ''}
                                ${reasonText ? `<span class="supplement-tag">${reasonText}</span>` : ''}
                            </div>
                            <div style="font-size: 0.75em; color: #555; margin-top: 4px;">
                                Since ${formatDate(supp.start_date)}
                                <span class="type-badge ${typeClass}">${isManual ? 'Manual' : 'Tracked'}</span>
                            </div>
                        </div>
                        <div class="supplement-actions">
                            <button class="supplement-action-btn edit" onclick="openEditSupplement('${supp.id}')" title="Edit"></button>
                            <button class="supplement-action-btn stop" onclick="stopSupplement('${supp.id}')" title="Stop taking"></button>
                            <button class="supplement-action-btn delete" onclick="deleteSupplement('${supp.id}', '${suppName.replace(/'/g, "\\'")}')" title="Delete permanently"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Stop taking a supplement (set end date)
        async function stopSupplement(startId) {
            if (!confirm('Mark this supplement as stopped? It will still appear in your history.')) return;

            try {
                const res = await fetch(`/analytics/${currentUserId}/supplement-starts/${startId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        end_date: new Date().toISOString().split('T')[0]
                    })
                });

                if (res.ok) {
                    showStatus('Supplement marked as stopped', 'success');
                    loadAnalyticsData();
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Permanently delete a supplement
        async function deleteSupplement(startId, name) {
            if (!confirm(`Permanently delete "${name}" from your stack?\n\nThis will remove all tracking data for this supplement and cannot be undone.`)) return;

            try {
                const res = await fetch(`/analytics/${currentUserId}/supplement-starts/${startId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    showStatus('Supplement deleted', 'success');
                    loadAnalyticsData();
                    loadTodaysStackData(); // Refresh Dashboard stack too
                } else {
                    const error = await res.json();
                    showStatus('Error: ' + (error.detail || 'Failed to delete'), 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Get supplement icon
        function getSupplementIcon(id) {
            const icons = {
                vitamin_d3: '',
                fish_oil: '',
                omega3: '',
                magnesium: '',
                magnesium_glycinate: '',
                zinc: '',
                b_complex: '',
                vitamin_b12: '',
                creatine: '',
                protein_powder: '',
                melatonin: '',
                probiotics: '',
                iron: '',
                vitamin_c: '',
                multivitamin: '',
                caffeine: '',
                ashwagandha: '',
                l_theanine: '',
                collagen: '',
                coq10: '',
                turmeric: '',
                elderberry: '',
                lions_mane: '',
                rhodiola: '',
                glycine: '',
                electrolytes: '',
                blackseed_oil: '',
            };
            return icons[id] || '';
        }

        // Format frequency
        function formatFrequency(freq) {
            const formats = {
                daily: 'Daily',
                twice_daily: '2x/day',
                three_times: '3x/day',
                as_needed: 'As needed',
                weekly: 'Weekly'
            };
            return formats[freq] || freq;
        }

        // Format reason
        function formatReason(reason) {
            const formats = {
                sleep: ' Sleep',
                energy: ' Energy',
                recovery: ' Recovery',
                focus: ' Focus',
                stress: ' Stress',
                immunity: ' Immunity',
                general_health: ' Health',
                deficiency: ' Deficiency'
            };
            return formats[reason] || reason;
        }

        // Helper: Format supplement name
        function formatSupplementName(id) {
            return id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        // Helper: Format metric name
        function formatMetricName(key) {
            const names = {
                sleep_score: 'Sleep Score',
                hrv_score: 'HRV',
                recovery_score: 'Recovery',
                resting_hr: 'Resting HR',
                sleep_duration_hrs: 'Sleep Duration'
            };
            return names[key] || key;
        }

        // Helper: Format date
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Helper: Format event type
        function formatEventType(type) {
            const types = {
                new_job: 'New Job/Work Stress',
                changed_mattress: 'Changed Mattress',
                moved: 'Moved Homes',
                started_exercise: 'Started Exercising',
                stopped_exercise: 'Stopped Exercising',
                sick: 'Got Sick',
                travel: 'Travel/Jet Lag',
                relationship: 'Relationship Change',
                diet_change: 'Major Diet Change',
                medication: 'Started/Stopped Medication',
                stress: 'Major Stress Event',
                other: 'Other'
            };
            return types[type] || type;
        }

        // Helper: Get event icon
        function getEventIcon(type) {
            const icons = {
                new_job: '',
                changed_mattress: '',
                moved: '',
                started_exercise: '',
                stopped_exercise: '',
                sick: '',
                travel: '',
                relationship: '',
                diet_change: '',
                medication: '',
                stress: '',
                other: ''
            };
            return icons[type] || '';
        }
    </script>
</body>
</html>
