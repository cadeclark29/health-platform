<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dose - Smart Supplement Dispensing</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0A0A0A;
            min-height: 100vh;
            color: #E8E8E8;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 24px;
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 50%, #C4B5FD 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow:
                0 4px 6px rgba(0, 0, 0, 0.1),
                0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow:
                0 8px 25px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(139, 92, 246, 0.05);
        }

        .card h2 {
            margin-bottom: 16px;
            font-size: 1.1em;
            font-weight: 600;
            color: #A0A0A0;
            letter-spacing: -0.01em;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        input, select, textarea {
            padding: 14px 18px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.04);
            color: #E8E8E8;
            font-size: 0.95em;
            font-family: inherit;
            flex: 1;
            min-width: 150px;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.08);
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.35);
        }

        select {
            cursor: pointer;
        }

        select option {
            background: #1a1a1a;
            color: #E8E8E8;
        }

        button {
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: #fff;
            font-size: 0.95em;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.35);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.06);
            color: #A0A0A0;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #E8E8E8;
            box-shadow: none;
        }

        .hidden {
            display: none !important;
        }

        #status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 1000;
            max-width: 350px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        #status.success {
            background: rgba(34, 197, 94, 0.9);
            color: #fff;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.3);
        }

        #status.error {
            background: rgba(239, 68, 68, 0.9);
            color: #fff;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }

        /* Signup Card */
        .signup-card {
            max-width: 400px;
            margin: 40px auto;
            padding: 32px;
            text-align: center;
        }

        .signup-header {
            margin-bottom: 28px;
        }

        .signup-logo {
            font-size: 3em;
            margin-bottom: 16px;
        }

        .signup-card h2 {
            font-size: 1.6em;
            margin-bottom: 8px;
            color: #E8E8E8;
        }

        .signup-subtitle {
            color: #888;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .signup-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .signup-input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #E8E8E8;
            font-size: 1em;
            box-sizing: border-box;
        }

        .signup-input:focus {
            outline: none;
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.08);
        }

        .signup-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .signup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.35);
        }

        .signup-btn.secondary {
            background: rgba(255, 255, 255, 0.06);
            color: #A0A0A0;
        }

        .signup-features {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .signup-feature {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #888;
            font-size: 0.85em;
        }

        .feature-icon {
            font-size: 1.1em;
        }

        .signin-section {
            color: #666;
            font-size: 0.9em;
        }

        .signin-link {
            color: #A78BFA;
            margin-left: 8px;
        }

        .signin-form-container {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Onboarding */
        .onboarding-step {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .onboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .onboard-grid input, .onboard-grid select {
            min-width: 0;
        }

        /* Date Navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .date-nav button {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.04);
            color: #A0A0A0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-nav button:hover {
            background: rgba(139, 92, 246, 0.15);
            color: #8B5CF6;
            box-shadow: none;
        }

        .date-display {
            text-align: center;
            min-width: 200px;
        }

        .date-display .day {
            font-size: 1.4em;
            font-weight: 700;
            color: #E8E8E8;
        }

        .date-display .full-date {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .date-display .today-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Time Selector */
        .time-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .time-btn {
            padding: 10px 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 24px;
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }

        .time-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .time-btn.active {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }

        /* Smart Recommendation Hero Card */
        .smart-rec-card {
            position: relative;
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.15) 0%,
                rgba(124, 58, 237, 0.1) 50%,
                rgba(99, 102, 241, 0.08) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .smart-rec-glow {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
            animation: rec-glow 6s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes rec-glow {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .smart-rec-content {
            position: relative;
            z-index: 1;
        }

        .smart-rec-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .smart-rec-icon {
            width: 36px;
            height: 36px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .smart-rec-label {
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #A78BFA;
        }

        .smart-rec-main {
            min-height: 80px;
        }

        .smart-rec-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            color: #888;
        }

        .smart-rec-loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8B5CF6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .smart-rec-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #E8E8E8;
            margin-bottom: 8px;
        }

        .smart-rec-reason {
            font-size: 0.95em;
            color: #A0A0A0;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .smart-rec-reason strong {
            color: #C4B5FD;
        }

        .smart-rec-metrics {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .smart-rec-metric {
            flex: 1;
            text-align: center;
        }

        .smart-rec-metric .metric-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #E8E8E8;
            display: block;
        }

        .smart-rec-metric .metric-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .smart-rec-metric .metric-trend {
            display: inline-flex;
            align-items: center;
            font-size: 0.75em;
            margin-left: 4px;
        }

        .smart-rec-metric .metric-trend.up { color: #22C55E; }
        .smart-rec-metric .metric-trend.down { color: #EF4444; }
        .smart-rec-metric .metric-trend.flat { color: #888; }

        .smart-rec-actions {
            display: flex;
            gap: 12px;
        }

        .smart-rec-take-btn {
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .smart-rec-take-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .smart-rec-take-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .smart-rec-details-btn {
            flex: 1;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #888;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .smart-rec-details-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #E8E8E8;
        }

        .smart-rec-empty {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .smart-rec-empty-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #888;
            margin-bottom: 8px;
        }

        .smart-rec-empty-text {
            font-size: 0.9em;
            margin-bottom: 16px;
        }

        .smart-rec-supplements {
            margin: 16px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
        }

        .smart-rec-supplements-label {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #666;
            margin-bottom: 10px;
        }

        .smart-rec-supp-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .smart-rec-supp-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
        }

        .smart-rec-supp-item.logged {
            background: rgba(34, 197, 94, 0.08);
            border-color: rgba(34, 197, 94, 0.25);
        }

        .smart-rec-supp-timing {
            font-size: 1.1em;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .smart-rec-supp-info {
            flex: 1;
            min-width: 0;
        }

        .supp-name {
            font-weight: 500;
            font-size: 0.95em;
            color: #E8E8E8;
            margin-bottom: 2px;
        }

        .smart-rec-supp-item.logged .supp-name {
            color: #86EFAC;
        }

        .supp-timing-note {
            font-size: 0.8em;
            color: #888;
        }

        .smart-rec-supp-dose {
            font-size: 0.85em;
            color: #A78BFA;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .smart-rec-supp-check {
            width: 18px;
            height: 18px;
            color: #22C55E;
            flex-shrink: 0;
        }

        .smart-rec-take-btn.logged {
            background: linear-gradient(135deg, #22C55E, #16A34A) !important;
            cursor: default;
        }

        /* Progress Card */
        .progress-card {
            margin-bottom: 20px;
        }

        .progress-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .progress-card-header h3 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
            color: #E8E8E8;
        }

        .progress-period {
            font-size: 0.8em;
            color: #666;
        }

        .progress-metrics {
            display: flex;
            gap: 12px;
        }

        .progress-metric {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .progress-metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-metric-icon.sleep {
            background: rgba(99, 102, 241, 0.2);
            color: #818CF8;
        }

        .progress-metric-icon.hrv {
            background: rgba(236, 72, 153, 0.2);
            color: #F472B6;
        }

        .progress-metric-icon.recovery {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .progress-metric-info {
            flex: 1;
        }

        .progress-metric-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .progress-metric-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #E8E8E8;
        }

        .progress-metric-trend {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8em;
            font-weight: 600;
        }

        .progress-metric-trend.up {
            color: #22C55E;
        }

        .progress-metric-trend.down {
            color: #EF4444;
        }

        .progress-metric-trend.flat {
            color: #888;
        }

        .progress-summary {
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 10px;
            font-size: 0.9em;
            color: #A0A0A0;
        }

        .progress-summary strong {
            color: #C4B5FD;
        }

        /* Main Dispenser Layout */
        .dispenser-layout {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        /* AI Recommendation - Center */
        .ai-recommendation {
            grid-column: 1 / -1;  /* Full width - hero card */
            grid-row: 1;
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.2) 0%,
                rgba(124, 58, 237, 0.15) 50%,
                rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 20px;
            padding: 28px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.15);
            position: relative;
            overflow: hidden;
        }

        .ai-recommendation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
            animation: pulse-glow 4s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .ai-recommendation:hover {
            transform: scale(1.02);
            border-color: #8B5CF6;
            box-shadow: 0 8px 50px rgba(139, 92, 246, 0.35);
        }

        .ai-recommendation .ai-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .ai-recommendation .ai-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #A78BFA, #C4B5FD);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-recommendation .ai-subtitle {
            font-size: 0.8em;
            color: #666;
            line-height: 1.4;
        }

        .ai-recommendation.loading .ai-icon {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Daily Foundation - Below AI */
        .daily-foundation {
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(196, 181, 253, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .daily-foundation:hover {
            transform: scale(1.02);
            border-color: #A78BFA;
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.2);
        }

        .daily-foundation.taken {
            opacity: 0.4;
            cursor: default;
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .daily-foundation.taken:hover {
            transform: none;
            box-shadow: none;
            border-color: rgba(255, 255, 255, 0.05);
        }

        .daily-foundation.taken .df-name {
            color: #555;
        }

        .daily-foundation .df-contents {
            font-size: 0.7em;
            color: #888;
            margin-top: 4px;
            letter-spacing: 0.02em;
        }

        .daily-foundation .df-status {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.7em;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .daily-foundation.taken .df-status {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .daily-foundation.partial .df-status {
            background: rgba(251, 191, 36, 0.2);
            color: #FBBF24;
        }

        .daily-foundation .df-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .daily-foundation .df-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #A78BFA;
        }


        /* Mix Cards */
        .mix-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mix-card:hover {
            transform: translateY(-4px);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
            background: rgba(139, 92, 246, 0.05);
        }

        .mix-card .mix-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .mix-card .mix-name {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 4px;
            color: #E8E8E8;
        }

        .mix-card .mix-desc {
            font-size: 0.7em;
            color: #555;
            line-height: 1.3;
        }

        .mix-card.custom-blend-mix {
            position: relative;
        }

        .mix-card .custom-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            font-size: 0.55em;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Dispense Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(20px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: #121212;
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.08);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-icon {
            font-size: 3em;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 6px;
            color: #E8E8E8;
        }

        .modal-subtitle {
            color: #666;
            font-size: 0.9em;
        }

        .supplement-list {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 18px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .supplement-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            gap: 12px;
        }

        .supplement-item:last-child {
            border-bottom: none;
        }

        .supplement-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .supplement-name {
            font-weight: 500;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .supplement-description {
            font-size: 0.75em;
            color: #888;
            margin-top: 4px;
            line-height: 1.4;
        }

        .supplement-dose {
            color: #A78BFA;
            font-weight: 600;
            white-space: nowrap;
            padding-top: 2px;
        }

        .modal-warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.25);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 18px;
            font-size: 0.85em;
            color: #FBBF24;
        }

        .modal-skipped {
            background: rgba(100, 100, 100, 0.1);
            border: 1px solid rgba(100, 100, 100, 0.25);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 18px;
            font-size: 0.8em;
        }

        .skipped-header {
            color: #888;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .skipped-item {
            display: inline-block;
            background: rgba(255, 255, 255, 0.05);
            color: #666;
            padding: 4px 10px;
            border-radius: 20px;
            margin: 2px 4px 2px 0;
            font-size: 0.9em;
            text-decoration: line-through;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-actions button {
            flex: 1;
            padding: 16px;
            font-size: 1em;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            color: #666;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #A0A0A0;
            box-shadow: none;
        }

        .btn-dispense {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .btn-dispense.dispensing {
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
        }

        /* Onboarding Modal */
        .onboarding-modal-content {
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
        }

        .onboarding-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .progress-step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
            color: #666;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
        }

        .progress-step.completed {
            background: #22C55E;
            color: #fff;
        }

        .progress-line {
            width: 40px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
        }

        .progress-line.completed {
            background: #22C55E;
        }

        .onboarding-illustration {
            font-size: 4em;
            margin-bottom: 16px;
        }

        .onboarding-step-content h2 {
            font-size: 1.6em;
            margin-bottom: 8px;
            color: #E8E8E8;
        }

        .onboarding-subtitle {
            color: #888;
            margin-bottom: 24px;
        }

        /* Onboarding Form Components */
        .onboarding-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
            text-align: left;
        }

        .onboarding-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .onboarding-field label {
            font-size: 0.8em;
            color: #888;
            font-weight: 500;
        }

        .onboarding-field input {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #E8E8E8;
            font-size: 1em;
        }

        .onboarding-field input:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        .onboarding-pill-group {
            display: flex;
            gap: 8px;
        }

        .ob-pill {
            flex: 1;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #888;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ob-pill:hover {
            border-color: rgba(139, 92, 246, 0.3);
            color: #E8E8E8;
        }

        .ob-pill.selected {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8B5CF6;
            color: #E8E8E8;
        }

        .height-inputs, .weight-input {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .height-inputs input, .weight-input input {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #E8E8E8;
            font-size: 1em;
            min-width: 0;
        }

        .height-unit, .weight-unit {
            color: #666;
            font-size: 0.85em;
        }

        /* Lifestyle Cards */
        .lifestyle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .lifestyle-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lifestyle-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
        }

        .lifestyle-card.selected {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.1);
        }

        .lifestyle-icon {
            font-size: 1.5em;
            margin-bottom: 6px;
        }

        .lifestyle-label {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 4px;
        }

        .lifestyle-value {
            font-size: 0.95em;
            color: #E8E8E8;
            font-weight: 500;
        }

        .lifestyle-options {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .lifestyle-option {
            display: flex;
            flex-direction: column;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .lifestyle-option:last-child {
            border-bottom: none;
        }

        .lifestyle-option:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .lifestyle-option.selected {
            background: rgba(139, 92, 246, 0.15);
        }

        .lifestyle-option .option-label {
            color: #E8E8E8;
            font-weight: 500;
        }

        .lifestyle-option .option-desc {
            color: #666;
            font-size: 0.85em;
            margin-top: 2px;
        }

        /* Chronotype Cards */
        .chronotype-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .chronotype-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .chronotype-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .chronotype-card.selected {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.15);
        }

        .chronotype-icon {
            font-size: 2em;
        }

        .chronotype-label {
            color: #E8E8E8;
            font-weight: 600;
            font-size: 1em;
        }

        .chronotype-desc {
            color: #888;
            font-size: 0.85em;
            margin-top: 2px;
        }

        /* Progress line completed state */
        .progress-line.completed {
            background: linear-gradient(90deg, #8B5CF6, #7C3AED);
        }

        /* Onboarding navigation buttons */
        .onboarding-nav {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .onboarding-nav .onboarding-btn {
            flex: 1;
        }

        .onboarding-btn.back {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .onboarding-btn.back:hover {
            border-color: rgba(255, 255, 255, 0.2);
            color: #E8E8E8;
        }

        .onboarding-feature-card {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: left;
            margin-bottom: 24px;
        }

        .onboarding-feature-card .feature-icon {
            font-size: 2em;
            flex-shrink: 0;
        }

        .onboarding-feature-card .feature-text strong {
            display: block;
            color: #E8E8E8;
            margin-bottom: 4px;
        }

        .onboarding-feature-card .feature-text p {
            color: #888;
            font-size: 0.9em;
            margin: 0;
        }

        .onboarding-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .onboarding-btn.primary {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            border: none;
        }

        .onboarding-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.35);
        }

        .onboarding-btn.primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        .onboarding-btn.secondary {
            background: transparent;
            color: #888;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .onboarding-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #E8E8E8;
            box-shadow: none;
        }

        /* Quick Add Grid for Onboarding */
        .onboarding-quick-add {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 400px) {
            .onboarding-quick-add {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .onboarding-quick-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .onboarding-quick-item:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .onboarding-quick-item.selected {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22C55E;
        }

        .onboarding-quick-item .quick-icon {
            font-size: 1.8em;
            margin-bottom: 6px;
        }

        .onboarding-quick-item .quick-name {
            font-size: 0.85em;
            color: #E8E8E8;
        }

        .onboarding-quick-item .quick-check {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #22C55E;
            font-weight: bold;
            display: none;
        }

        .onboarding-quick-item.selected .quick-check {
            display: block;
        }

        /* Searchable Supplement Picker */
        .supp-search-container {
            margin-bottom: 16px;
        }

        .supp-search-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #E8E8E8;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
        }

        .supp-search-input:focus {
            border-color: rgba(139, 92, 246, 0.5);
        }

        .supp-search-input::placeholder {
            color: #666;
        }

        .supp-list-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
        }

        .supp-list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .supp-list-item:last-child {
            border-bottom: none;
        }

        .supp-list-item:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .supp-list-item.selected {
            background: rgba(34, 197, 94, 0.1);
        }

        /* SVG Supplement Icons */
        .supp-icon {
            width: 20px;
            height: 20px;
            stroke: #8B5CF6;
            flex-shrink: 0;
        }

        /* SVG Life Event Icons */
        .event-icon {
            width: 18px;
            height: 18px;
            stroke: #8B5CF6;
            flex-shrink: 0;
            display: inline-block;
            vertical-align: middle;
            margin-right: 6px;
        }

        /* Inline SVG Icons */
        .inline-icon {
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }

        .lifestyle-svg, .chronotype-svg {
            stroke: #8B5CF6;
            flex-shrink: 0;
        }

        .streak-icon {
            vertical-align: baseline;
        }

        .warning-icon {
            vertical-align: text-bottom;
        }

        .supp-list-icon {
            font-size: 1.3em;
            margin-right: 12px;
            width: 28px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .supp-list-icon .supp-icon {
            width: 22px;
            height: 22px;
        }

        .supp-list-info {
            flex: 1;
        }

        .supp-list-name {
            color: #E8E8E8;
            font-weight: 500;
        }

        .supp-list-dose {
            color: #888;
            font-size: 0.8em;
        }

        .supp-list-check {
            color: #22C55E;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .supp-list-item.selected .supp-list-check {
            opacity: 1;
        }

        .supp-no-results {
            padding: 24px;
            text-align: center;
            color: #666;
        }

        /* Selected Supplements Section - Compact Pills */
        .selected-supps-section {
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .selected-supps-label {
            width: 100%;
            font-size: 0.85em;
            color: #888;
            margin-bottom: 4px;
        }

        .selected-supp-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 20px;
            padding: 6px 10px 6px 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .selected-supp-tag:hover {
            background: rgba(34, 197, 94, 0.25);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .selected-supp-icon {
            font-size: 1em;
        }

        .selected-supp-name {
            color: #E8E8E8;
            font-weight: 500;
        }

        .selected-supp-dose {
            color: #888;
            font-size: 0.9em;
        }

        .selected-supp-start {
            color: #A78BFA;
            font-size: 0.8em;
            background: rgba(139, 92, 246, 0.15);
            padding: 2px 6px;
            border-radius: 8px;
        }

        .selected-supp-edit {
            color: #666;
            font-size: 0.8em;
            margin-left: 2px;
        }

        .selected-supp-remove {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 2px;
            font-size: 0.8em;
            line-height: 1;
            margin-left: 2px;
        }

        .selected-supp-remove:hover {
            color: #EF4444;
            font-size: 0.9em;
        }

        /* Onboarding Edit Popup */
        .onboarding-edit-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .onboarding-edit-popup.hidden {
            display: none;
        }

        .edit-popup-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
        }

        .edit-popup-content {
            position: relative;
            background: #1A1A1A;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 90%;
            max-width: 360px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .edit-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .edit-popup-title {
            font-weight: 600;
            color: #E8E8E8;
        }

        .edit-popup-close {
            background: none;
            border: none;
            color: #666;
            font-size: 1.2em;
            cursor: pointer;
            padding: 4px;
        }

        .edit-popup-close:hover {
            color: #E8E8E8;
        }

        .edit-popup-body {
            padding: 20px;
        }

        .edit-popup-supp-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #E8E8E8;
            margin-bottom: 16px;
            text-align: center;
        }

        .edit-field {
            margin-bottom: 20px;
        }

        .edit-field label {
            display: block;
            font-size: 0.85em;
            color: #888;
            margin-bottom: 8px;
        }

        .dosage-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dosage-input-row input {
            flex: 1;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #E8E8E8;
            font-size: 1em;
        }

        .dosage-input-row input:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        .dosage-unit {
            color: #888;
            font-size: 0.9em;
            min-width: 30px;
        }

        .start-date-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .start-option {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #A0A0A0;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .start-option:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .start-option.selected {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8B5CF6;
            color: #E8E8E8;
        }

        .custom-date-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85em;
            color: #666;
        }

        .custom-date-row input[type="date"] {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #E8E8E8;
            font-size: 0.9em;
        }

        .custom-date-row input[type="date"]:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        .edit-popup-footer {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .edit-popup-footer button {
            flex: 1;
        }

        .selected-supp-field input:focus,
        .selected-supp-field select:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
        }

        .dosage-input-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dosage-input-wrapper input {
            flex: 1;
            min-width: 0;
            max-width: calc(100% - 50px);
        }

        .dosage-unit {
            font-size: 0.85em;
            color: #8B5CF6;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 30px;
        }

        /* Goal Options */
        .goal-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .goal-option {
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            position: relative;
        }

        .goal-option:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .goal-option.selected {
            background: rgba(139, 92, 246, 0.15);
            border-color: #8B5CF6;
        }

        .goal-option .goal-icon {
            font-size: 2em;
            display: block;
            margin-bottom: 8px;
        }

        .goal-option .goal-name {
            color: #E8E8E8;
            font-weight: 500;
        }

        .goal-option .goal-check {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #8B5CF6;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Completion */
        .completion-checkmark {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #22C55E, #16A34A);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            color: #fff;
            margin: 0 auto 24px;
            animation: scaleIn 0.5s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes checkmarkDraw {
            0% { stroke-dashoffset: 50; }
            100% { stroke-dashoffset: 0; }
        }

        @keyframes slideInRight {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-30px); opacity: 0; }
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(139, 92, 246, 0); }
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @keyframes fieldComplete {
            0% { border-color: rgba(255, 255, 255, 0.1); }
            50% { border-color: #22C55E; box-shadow: 0 0 12px rgba(34, 197, 94, 0.3); }
            100% { border-color: rgba(34, 197, 94, 0.5); }
        }

        /* Enhanced Progress Bar */
        .onboarding-progress {
            position: relative;
        }

        .progress-bar-bg {
            position: absolute;
            top: 50%;
            left: 32px;
            right: 32px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-50%);
            z-index: 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #22C55E);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2px;
        }

        .progress-step {
            position: relative;
            z-index: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Step Content Transitions - only animate on actual step changes */
        .onboarding-step-content {
            /* No animation by default - prevents re-animation on re-renders within same step */
        }

        .onboarding-step-content.entering {
            animation: slideInRight 0.3s ease-out;
        }

        .onboarding-step-content.exiting {
            animation: slideOutLeft 0.2s ease-in forwards;
        }

        /* Enhanced Micro-copy */
        .onboarding-microcopy {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 20px;
            font-size: 0.85em;
            color: #A78BFA;
            text-align: left;
        }

        .onboarding-microcopy svg {
            flex-shrink: 0;
        }

        /* Why We Ask Tooltip */
        .why-ask {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
            font-size: 0.7em;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }

        .why-ask:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #E8E8E8;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Pill Buttons */
        .ob-pill {
            position: relative;
            overflow: hidden;
        }

        .ob-pill::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(139, 92, 246, 0.1));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .ob-pill.selected::before {
            opacity: 1;
        }

        .ob-pill .pill-check {
            display: none;
            margin-left: 6px;
            color: #8B5CF6;
        }

        .ob-pill.selected .pill-check {
            display: inline;
        }

        /* Combined Height Input */
        .height-combined {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .height-combined input {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #E8E8E8;
            font-size: 1em;
            text-align: center;
        }

        .height-combined input:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        .unit-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 2px;
        }

        .unit-toggle button {
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .unit-toggle button.active {
            background: rgba(139, 92, 246, 0.3);
            color: #E8E8E8;
        }

        /* Field Complete Animation */
        .onboarding-field input.complete,
        .onboarding-field select.complete {
            animation: fieldComplete 0.5s ease-out forwards;
        }

        /* Enhanced Lifestyle Cards (Full Selection Mode) */
        .lifestyle-selection-panel {
            position: absolute;
            inset: 0;
            background: #121212;
            z-index: 10;
            animation: slideInRight 0.3s ease-out;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .lifestyle-selection-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .lifestyle-selection-header button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 8px;
            font-size: 1.2em;
        }

        .lifestyle-selection-header h3 {
            color: #E8E8E8;
            font-size: 1.1em;
            margin: 0;
        }

        .lifestyle-selection-options {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }

        .lifestyle-selection-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lifestyle-selection-option:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .lifestyle-selection-option.selected {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.15);
        }

        .lifestyle-selection-option .option-icon {
            font-size: 1.5em;
            width: 40px;
            text-align: center;
        }

        .lifestyle-selection-option .option-content {
            flex: 1;
        }

        .lifestyle-selection-option .option-label {
            color: #E8E8E8;
            font-weight: 500;
            display: block;
        }

        .lifestyle-selection-option .option-desc {
            color: #888;
            font-size: 0.85em;
        }

        .lifestyle-selection-option .option-check {
            color: #8B5CF6;
            font-size: 1.2em;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .lifestyle-selection-option.selected .option-check {
            opacity: 1;
        }

        /* Lifestyle Card Enhanced */
        .lifestyle-card.selected {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.15);
        }

        .lifestyle-card.selected::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            color: #8B5CF6;
            font-size: 0.9em;
            font-weight: bold;
        }

        .lifestyle-card {
            position: relative;
        }

        /* Benefits List */
        .benefits-list {
            text-align: left;
            margin-bottom: 24px;
        }

        .benefit-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 0;
            color: #888;
            font-size: 0.9em;
        }

        .benefit-item .benefit-check {
            color: #22C55E;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .benefit-item strong {
            color: #E8E8E8;
        }

        /* Skip Later Enhanced */
        .skip-later-btn {
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 12px;
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
            margin-bottom: 12px;
            transition: color 0.2s;
        }

        .skip-later-btn:hover {
            color: #E8E8E8;
        }

        .skip-later-btn .skip-subtext {
            font-size: 0.8em;
            color: #666;
        }

        /* Common Stacks Section */
        .stacks-section {
            margin-bottom: 20px;
        }

        .stacks-label {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stack-cards {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .stack-card {
            flex-shrink: 0;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            min-width: 140px;
        }

        .stack-card:hover {
            border-color: #8B5CF6;
            transform: translateY(-2px);
        }

        .stack-card.added {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .stack-name {
            color: #E8E8E8;
            font-weight: 500;
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        .stack-items {
            color: #888;
            font-size: 0.75em;
        }

        /* Goal Max Selection Warning */
        .goal-limit-hint {
            font-size: 0.85em;
            color: #888;
            margin-top: -16px;
            margin-bottom: 20px;
        }

        .goal-limit-hint.at-limit {
            color: #F59E0B;
        }

        /* Goal Selected - static highlight, no animation */
        .goal-option.selected {
            border-color: #8B5CF6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
        }

        /* Confetti Container */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }

        /* Enhanced Completion */
        .completion-checkmark {
            position: relative;
        }

        .completion-checkmark svg {
            width: 48px;
            height: 48px;
        }

        .completion-checkmark svg path {
            stroke-dasharray: 50;
            stroke-dashoffset: 50;
            animation: checkmarkDraw 0.8s ease-out 0.3s forwards;
        }

        .personalized-summary {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: left;
        }

        .personalized-summary p {
            color: #A78BFA;
            font-size: 0.9em;
            margin: 0;
            line-height: 1.5;
        }

        .cta-primary {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            font-size: 1.1em;
            padding: 18px;
        }

        .cta-primary::after {
            content: ' ';
        }

        .completion-summary {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: #888;
            font-size: 0.9em;
        }

        .summary-item:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .summary-item .summary-icon {
            font-size: 1.2em;
        }

        .summary-item.completed {
            color: #22C55E;
        }

        /* Onboarding Duration/Adherence */
        .onboarding-details {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }

        .onboarding-details label {
            display: block;
            color: #888;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .onboarding-details select {
            width: 100%;
            margin-bottom: 16px;
        }

        .adherence-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .adherence-row input[type="range"] {
            flex: 1;
        }

        .adherence-row .adherence-value {
            min-width: 45px;
            text-align: right;
            color: #E8E8E8;
        }

        /* Getting Started Card */
        .getting-started-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .getting-started-card h3 {
            font-size: 1.1em;
            color: #E8E8E8;
            margin-bottom: 4px;
        }

        .getting-started-card .gs-subtitle {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 16px;
        }

        .gs-checklist {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .gs-checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .gs-checklist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .gs-check-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .gs-checklist-item.completed .gs-check-circle {
            background: #22C55E;
            border-color: #22C55E;
            color: #fff;
        }

        .gs-item-content {
            flex: 1;
        }

        .gs-item-title {
            color: #E8E8E8;
            font-weight: 500;
            font-size: 0.95em;
        }

        .gs-checklist-item.completed .gs-item-title {
            color: #888;
            text-decoration: line-through;
        }

        .gs-item-desc {
            color: #666;
            font-size: 0.8em;
            margin-top: 2px;
        }

        .gs-item-action {
            padding: 6px 14px;
            border-radius: 8px;
            border: none;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            background: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            transition: all 0.2s;
        }

        .gs-item-action:hover {
            background: rgba(139, 92, 246, 0.3);
        }

        .gs-checklist-item.completed .gs-item-action {
            display: none;
        }

        .gs-dismiss {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 10px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 0.85em;
            cursor: pointer;
        }

        .gs-dismiss:hover {
            color: #888;
        }

        .gs-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .gs-progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .gs-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #22C55E);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .gs-progress-text {
            color: #888;
            font-size: 0.8em;
            white-space: nowrap;
        }

        /* Chart Overlay */
        .chart-container {
            position: relative;
        }

        .chart-overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 10, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            text-align: center;
            padding: 24px;
            z-index: 5;
        }

        .chart-overlay.hidden {
            display: none;
        }

        .chart-overlay-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .chart-overlay h3 {
            color: #E8E8E8;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .chart-overlay p {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 16px;
            max-width: 260px;
        }

        .chart-overlay-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chart-overlay-btn:hover {
            transform: scale(1.05);
        }

        /* Improved empty state */
        .empty-state-modern {
            text-align: center;
            padding: 32px 20px;
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.05) 0%, transparent 100%);
            border-radius: 16px;
            border: 1px dashed rgba(139, 92, 246, 0.2);
        }

        .empty-state-modern .empty-illustration {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .empty-state-modern h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: #E8E8E8;
            margin-bottom: 8px;
        }

        .empty-state-modern p {
            color: #888;
            margin-bottom: 16px;
            font-size: 0.9em;
            max-width: 260px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state-cta {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .empty-state-cta:hover {
            transform: scale(1.03);
        }

        /* Dispense Animation */
        .dispense-animation {
            text-align: center;
            padding: 20px 0;
        }

        .glass-container {
            position: relative;
            width: 120px;
            height: 160px;
            margin: 0 auto 24px;
        }

        .glass {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 140px;
            border: 4px solid rgba(139, 92, 246, 0.3);
            border-radius: 0 0 24px 24px;
            border-top: none;
            overflow: hidden;
        }

        .glass-water {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.5) 0%, rgba(167, 139, 250, 0.7) 100%);
            height: 0;
            transition: height 2s ease-out;
            border-radius: 0 0 20px 20px;
        }

        .glass-water.filling {
            height: 85%;
        }

        .dropping-supplements {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .dropping-pill {
            font-size: 1.2em;
            animation: dropPill 1s ease-in forwards;
            opacity: 0;
        }

        @keyframes dropPill {
            0% { transform: translateY(-20px); opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }

        .dispense-message {
            font-size: 1.3em;
            font-weight: 700;
            background: linear-gradient(135deg, #A78BFA, #C4B5FD);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .dispense-details {
            color: #666;
            font-size: 0.9em;
        }

        .dispensed-list {
            margin-top: 18px;
            padding: 14px;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 12px;
            text-align: left;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .dispensed-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.85em;
        }

        .dispensed-item span:first-child {
            color: #A0A0A0;
        }

        .dispensed-item span:last-child {
            color: #A78BFA;
            font-weight: 500;
        }

        /* Tracking Section */
        .tracking-section {
            margin-top: 20px;
        }

        .tracking-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }

        .tracking-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            color: #555;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
        }

        .tracking-tab:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .tracking-tab.active {
            background: rgba(139, 92, 246, 0.12);
            border-color: rgba(139, 92, 246, 0.3);
            color: #A78BFA;
        }

        .tracking-content {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .tracking-item {
            margin-bottom: 18px;
        }

        .tracking-item:last-child {
            margin-bottom: 0;
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .tracking-name {
            font-weight: 500;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .tracking-values {
            font-size: 0.85em;
            color: #666;
        }

        .tracking-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .tracking-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #A78BFA);
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        .tracking-fill.warning {
            background: linear-gradient(90deg, #F59E0B, #FBBF24);
        }

        .tracking-fill.danger {
            background: linear-gradient(90deg, #EF4444, #F87171);
        }

        /* Oura Connection Card */
        .oura-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(59, 130, 246, 0.08) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
        }

        .oura-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .oura-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .oura-logo {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #8B5CF6, #3B82F6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
        }

        .oura-title {
            font-weight: 600;
            color: #E8E8E8;
            font-size: 0.95em;
        }

        .oura-subtitle {
            font-size: 0.8em;
            color: #666;
        }

        .oura-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .oura-status.connected {
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
        }

        .oura-status.disconnected {
            background: rgba(255, 255, 255, 0.06);
            color: #666;
        }

        .oura-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .oura-connect-btn {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .oura-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
        }

        .oura-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .oura-metric {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .oura-metric-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #E8E8E8;
            margin-bottom: 4px;
        }

        .oura-metric-value.good {
            color: #22C55E;
        }

        .oura-metric-value.fair {
            color: #F59E0B;
        }

        .oura-metric-value.poor {
            color: #EF4444;
        }

        .oura-metric-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .oura-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }

        .oura-sync-btn {
            flex: 1;
            padding: 10px 16px;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            color: #A78BFA;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .oura-sync-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: none;
            box-shadow: none;
        }

        .oura-disconnect-btn {
            padding: 10px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .oura-disconnect-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #EF4444;
            transform: none;
            box-shadow: none;
        }

        .oura-loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 500px) {
            .oura-metrics {
                grid-template-columns: repeat(3, 1fr);
            }

            .oura-metric {
                padding: 10px;
            }

            .oura-metric-value {
                font-size: 1.2em;
            }
        }

        /* Expandable Oura Details */
        .oura-details-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
            padding: 8px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 0.8em;
            cursor: pointer;
            transition: color 0.2s ease;
            width: 100%;
        }

        .oura-details-toggle:hover {
            color: #A78BFA;
        }

        .oura-details-toggle svg {
            transition: transform 0.2s ease;
        }

        .oura-details-toggle.expanded svg {
            transform: rotate(180deg);
        }

        /* Intelligent Insights Section */
        .health-insights {
            margin-top: 12px;
            display: none;
        }

        .health-insights.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .health-insight {
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.1) 0%, rgba(99, 102, 241, 0.08) 100%);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 8px;
        }

        .health-insight.alert-immune {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.15) 0%, rgba(239, 68, 68, 0.1) 100%);
            border-color: rgba(251, 146, 60, 0.4);
        }

        .health-insight.alert-stress {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.12) 0%, rgba(251, 146, 60, 0.08) 100%);
            border-color: rgba(234, 179, 8, 0.3);
        }

        .health-insight.alert-sleep {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(167, 139, 250, 0.08) 100%);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .health-insight.alert-recovery {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.08) 100%);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .insight-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .insight-title {
            font-weight: 600;
            font-size: 0.9em;
            color: #E8E8E8;
        }

        .insight-description {
            font-size: 0.8em;
            color: #999;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .insight-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .insight-action {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.08);
            color: #CCC;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .insight-action.add {
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
        }

        .insight-action.hold {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        .insight-action.reduce {
            background: rgba(251, 146, 60, 0.15);
            color: #FB923C;
        }

        .insight-research {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .insight-research-link {
            font-size: 0.7em;
            color: #A78BFA;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .insight-research-link:hover {
            text-decoration: underline;
        }

        .oura-details-sections {
            margin-top: 12px;
            display: none;
        }

        .oura-details-sections.expanded {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .oura-detail-section {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .oura-detail-section:last-child {
            margin-bottom: 0;
        }

        .oura-detail-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: #A78BFA;
            font-size: 0.85em;
            font-weight: 600;
        }

        .oura-detail-header svg {
            width: 16px;
            height: 16px;
        }

        .oura-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .oura-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .oura-detail-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #E8E8E8;
        }

        .oura-detail-label {
            font-size: 0.7em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .oura-detail-wide {
            grid-column: span 2;
        }

        .sleep-bar-container {
            display: flex;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            margin-top: 4px;
        }

        .sleep-bar-segment {
            height: 100%;
        }

        .sleep-bar-deep {
            background: #6366F1;
        }

        .sleep-bar-rem {
            background: #8B5CF6;
        }

        .sleep-bar-light {
            background: #A78BFA;
        }

        .sleep-bar-awake {
            background: #F59E0B;
        }

        .sleep-bar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
            font-size: 0.7em;
        }

        .sleep-bar-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #888;
        }

        .sleep-bar-legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }

        @media (max-width: 500px) {
            .oura-detail-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* User header */
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #fff;
            font-size: 1.1em;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.05em;
            color: #E8E8E8;
        }

        .btn-logout {
            padding: 10px 18px;
            font-size: 0.85em;
            background: rgba(255, 255, 255, 0.04);
            color: #666;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #A0A0A0;
            box-shadow: none;
        }

        /* Responsive */
        @media (max-width: 700px) {
            .dispenser-layout {
                grid-template-columns: repeat(2, 1fr);
            }

            .ai-recommendation {
                grid-column: 1 / -1;
                grid-row: auto;
            }

            .daily-foundation {
                grid-column: 1 / -1;
                grid-row: auto;
            }
        }

        @media (max-width: 400px) {
            .dispenser-layout {
                grid-template-columns: 1fr;
            }

            .ai-recommendation, .daily-foundation {
                grid-column: 1;
            }
        }

        /* Settings panel */
        .settings-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #666;
            font-size: 1.4em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .settings-toggle:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .settings-panel {
            position: fixed;
            bottom: 88px;
            right: 24px;
            background: #121212;
            border-radius: 18px;
            padding: 22px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            min-width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
        }

        .settings-panel h3 {
            margin-bottom: 18px;
            font-size: 1em;
            color: #A78BFA;
            font-weight: 600;
        }

        .setting-row {
            margin-bottom: 14px;
        }

        .setting-row label {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 6px;
        }

        .setting-row select {
            width: 100%;
        }

        .setting-danger {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .setting-hint {
            font-size: 0.75em;
            color: #666;
            margin-top: 6px;
            margin-bottom: 0;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* Notification Settings Styles */
        .setting-section {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .setting-section h4 {
            font-size: 0.85em;
            color: #A78BFA;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .btn-text {
            background: none;
            border: none;
            color: #A78BFA;
            cursor: pointer;
            font-size: 0.8em;
            padding: 4px 0;
            display: block;
        }

        .btn-text:hover {
            text-decoration: underline;
        }

        .btn-danger-text {
            color: #EF4444;
        }

        .verified-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            color: #22C55E;
            font-size: 0.85em;
            margin-bottom: 12px;
        }

        .verified-badge .checkmark {
            font-weight: bold;
        }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .toggle-row label {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch.small {
            width: 36px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: #666;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch.small .toggle-slider:before {
            height: 14px;
            width: 14px;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: rgba(139, 92, 246, 0.4);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            background: #A78BFA;
            transform: translateX(20px);
        }

        .toggle-switch.small input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }

        .reminder-options {
            margin-top: 8px;
            padding: 8px 0;
        }

        .reminder-time-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-input {
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 0.85em;
            width: 90px;
        }

        .time-input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
        }

        .sms-verification-section {
            padding: 4px 0;
        }

        /* Reset Confirmation Modal */
        .reset-confirm-modal {
            max-width: 400px;
            text-align: center;
            padding: 32px;
        }

        .reset-warning-icon {
            margin-bottom: 16px;
        }

        .reset-confirm-modal h2 {
            color: #EF4444;
            margin-bottom: 12px;
        }

        .reset-warning-text {
            color: #888;
            margin-bottom: 16px;
        }

        .reset-list {
            text-align: left;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 12px;
            padding: 16px 16px 16px 32px;
            margin-bottom: 16px;
            color: #ccc;
        }

        .reset-list li {
            margin-bottom: 8px;
        }

        .reset-list li:last-child {
            margin-bottom: 0;
        }

        .reset-warning-subtext {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 24px;
        }

        .reset-confirm-actions {
            display: flex;
            gap: 12px;
        }

        .btn-cancel {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #888;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-confirm-reset {
            flex: 1;
            padding: 14px;
            background: #EF4444;
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-confirm-reset:hover {
            background: #DC2626;
        }

        /* User Actions */
        .user-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-settings {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            color: #888;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-settings:hover {
            border-color: rgba(139, 92, 246, 0.3);
            color: #A78BFA;
        }

        .empty-state {
            text-align: center;
            padding: 36px;
            color: #444;
        }

        .empty-state .emoji {
            font-size: 2.5em;
            margin-bottom: 14px;
            opacity: 0.5;
        }

        /* Custom Blends Section */
        .custom-blends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .custom-blends-header h2 {
            margin: 0;
        }

        .btn-create-blend {
            padding: 10px 18px;
            font-size: 0.85em;
            border-radius: 24px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .custom-blend-card {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-blend-card:hover {
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.12);
        }

        .custom-blend-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .custom-blend-icon {
            font-size: 1.5em;
        }

        .custom-blend-name {
            font-weight: 600;
            color: #E8E8E8;
        }

        .custom-blend-count {
            font-size: 0.8em;
            color: #555;
            margin-top: 2px;
        }

        .custom-blend-actions {
            display: flex;
            gap: 8px;
        }

        .btn-delete-blend {
            width: 34px;
            height: 34px;
            padding: 0;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-delete-blend:hover {
            background: rgba(239, 68, 68, 0.2);
            box-shadow: none;
        }

        /* Blend Builder Modal */
        .blend-builder {
            max-height: 80vh;
            overflow-y: auto;
        }

        .blend-builder-header {
            display: flex;
            gap: 12px;
            margin-bottom: 22px;
        }

        .blend-builder-header input {
            flex: 1;
        }

        .icon-picker {
            width: 54px;
            text-align: center;
            font-size: 1.5em;
            cursor: pointer;
        }

        .supplement-categories {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .category-btn {
            padding: 8px 14px;
            font-size: 0.8em;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .category-btn.active {
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.12);
            color: #A78BFA;
        }

        .supplement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
            margin-bottom: 18px;
        }

        .supplement-card {
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .supplement-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .supplement-card.selected {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.1);
        }

        .supplement-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .supplement-card-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .supplement-card-dose {
            font-size: 0.8em;
            color: #A78BFA;
        }

        .supplement-card-desc {
            font-size: 0.75em;
            color: #555;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .supplement-card-benefits {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .benefit-tag {
            padding: 3px 8px;
            font-size: 0.65em;
            background: rgba(139, 92, 246, 0.12);
            color: #A78BFA;
            border-radius: 6px;
        }

        .supplement-card-links {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .pubmed-link {
            display: block;
            font-size: 0.7em;
            color: #8B5CF6;
            text-decoration: none;
            padding: 3px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pubmed-link:hover {
            color: #A78BFA;
            text-decoration: underline;
        }

        .selected-supplements {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 18px;
        }

        .selected-supplements-title {
            font-size: 0.85em;
            color: #A78BFA;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .selected-supp-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .selected-supp-item:last-child {
            border-bottom: none;
        }

        .selected-supp-name {
            font-size: 0.9em;
            color: #E8E8E8;
        }

        .selected-supp-dose {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dose-input {
            width: 75px;
            padding: 6px 10px;
            font-size: 0.85em;
            text-align: center;
        }

        .dose-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dose-unit {
            font-size: 0.75em;
            color: #555;
            min-width: 30px;
        }

        .dose-range {
            font-size: 0.65em;
            color: #444;
        }

        /* AI Blend Assistant */
        .ai-blend-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(167, 139, 250, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 22px;
        }

        .ai-blend-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .ai-blend-header .ai-icon {
            font-size: 1.5em;
        }

        .ai-blend-header h3 {
            margin: 0;
            font-size: 1em;
            color: #E8E8E8;
            font-weight: 600;
        }

        .ai-blend-header span {
            font-size: 0.8em;
            color: #555;
        }

        .ai-input-row {
            display: flex;
            gap: 10px;
        }

        .ai-input-row textarea {
            flex: 1;
            min-height: 60px;
            resize: vertical;
        }

        .ai-input-row button {
            align-self: flex-end;
            white-space: nowrap;
        }

        .ai-suggestions {
            margin-top: 14px;
            padding: 14px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: none;
        }

        .ai-suggestions.visible {
            display: block;
        }

        .ai-suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ai-suggestions-title {
            font-size: 0.9em;
            color: #A78BFA;
            font-weight: 500;
        }

        .ai-suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .ai-suggestion-item:last-child {
            margin-bottom: 0;
        }

        .ai-suggestion-name {
            font-size: 0.9em;
            color: #E8E8E8;
        }

        .ai-suggestion-dose {
            font-size: 0.8em;
            color: #A78BFA;
            font-weight: 500;
        }

        .ai-suggestion-reason {
            font-size: 0.75em;
            color: #555;
            margin-top: 3px;
        }

        .ai-loading {
            text-align: center;
            padding: 24px;
            color: #555;
        }

        .ai-loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .btn-add-all {
            padding: 8px 14px;
            font-size: 0.8em;
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
            border: 1px solid rgba(34, 197, 94, 0.25);
        }

        .btn-add-all:hover {
            background: rgba(34, 197, 94, 0.25);
            box-shadow: none;
        }

        .btn-remove-supp {
            width: 26px;
            height: 26px;
            padding: 0;
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
            border-radius: 50%;
            font-size: 0.8em;
        }

        .btn-remove-supp:hover {
            background: rgba(239, 68, 68, 0.25);
            box-shadow: none;
        }

        /* Supplement Info Modal */
        .supp-info-modal {
            max-width: 450px;
        }

        .supp-info-header {
            text-align: center;
            margin-bottom: 22px;
        }

        .supp-info-name {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 6px;
            color: #E8E8E8;
        }

        .supp-info-dose {
            color: #A78BFA;
            font-size: 0.9em;
        }

        .supp-info-desc {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 18px;
            font-size: 0.9em;
            line-height: 1.6;
            color: #A0A0A0;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .supp-info-benefits {
            margin-bottom: 18px;
        }

        .supp-info-benefits-title {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .supp-info-benefits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .supp-info-benefit {
            padding: 5px 12px;
            background: rgba(139, 92, 246, 0.12);
            color: #A78BFA;
            border-radius: 14px;
            font-size: 0.8em;
        }

        .supp-info-studies {
            background: rgba(139, 92, 246, 0.06);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 14px;
            padding: 16px;
        }

        .supp-info-studies-title {
            font-size: 0.85em;
            color: #A78BFA;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .study-link {
            display: block;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .study-link:last-child {
            margin-bottom: 0;
        }

        .study-link:hover {
            background: rgba(139, 92, 246, 0.15);
        }

        .study-title {
            color: #E8E8E8;
            font-size: 0.85em;
            display: block;
            margin-bottom: 3px;
        }

        .study-pmid {
            color: #555;
            font-size: 0.75em;
        }

        /* Intelligence notes styling */
        .intelligence-note {
            background: rgba(139, 92, 246, 0.08);
            border-left: 3px solid #8B5CF6;
            padding: 10px 14px;
            margin-top: 10px;
            border-radius: 0 10px 10px 0;
            font-size: 0.8em;
            color: #A78BFA;
        }

        /* Sign in link */
        a {
            color: #8B5CF6;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        a:hover {
            color: #A78BFA;
        }

        /* Footer */
        .footer {
            margin-top: 60px;
            padding: 30px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 12px;
        }

        .footer-links a {
            color: #666;
            text-decoration: none;
            font-size: 0.85em;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #A78BFA;
        }

        .footer-copyright {
            color: #444;
            font-size: 0.75em;
        }

        /* Main Navigation Tabs */
        .main-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            padding: 4px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .main-nav-btn {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: #666;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .main-nav-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .main-nav-btn.active {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }

        .coming-soon-badge {
            display: inline-block;
            font-size: 0.65em;
            font-weight: 600;
            padding: 2px 6px;
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: #fff;
            border-radius: 4px;
            margin-left: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            vertical-align: middle;
        }

        /* Dispenser Section */
        .dispenser-section {
            display: none;
        }

        .dispenser-section.active {
            display: block;
        }

        .dispenser-coming-soon {
            text-align: center;
            padding: 60px 20px;
        }

        .dispenser-hero-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dispenser-hero-icon svg {
            width: 60px;
            height: 60px;
            stroke: #8B5CF6;
        }

        .dispenser-coming-soon h2 {
            font-size: 1.8em;
            font-weight: 700;
            color: #E8E8E8;
            margin-bottom: 12px;
        }

        .dispenser-coming-soon p {
            color: #888;
            font-size: 1.1em;
            max-width: 400px;
            margin: 0 auto 32px;
            line-height: 1.6;
        }

        .dispenser-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .dispenser-feature {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 20px;
            text-align: left;
        }

        .dispenser-feature-icon {
            width: 40px;
            height: 40px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .dispenser-feature-icon svg {
            width: 20px;
            height: 20px;
            stroke: #8B5CF6;
        }

        .dispenser-feature h3 {
            font-size: 1em;
            font-weight: 600;
            color: #E8E8E8;
            margin-bottom: 4px;
        }

        .dispenser-feature p {
            font-size: 0.85em;
            color: #888;
            margin: 0;
        }

        .dispenser-preview-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .dispenser-preview-label {
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #666;
            margin-bottom: 20px;
            text-align: center;
        }

        .dispenser-preview-card {
            opacity: 0.7;
            pointer-events: none;
        }

        .dispenser-preview-card h2 {
            color: #888;
        }

        /* Analytics Section */
        .analytics-section {
            display: none;
        }

        .analytics-section.active {
            display: block;
        }

        .dashboard-section {
            display: block;
        }

        .dashboard-section.hidden-section {
            display: none;
        }

        /* Supplement Insights */
        .insights-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .insights-loading .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8B5CF6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .insights-section-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #A78BFA;
            margin: 20px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insights-section-title:first-child {
            margin-top: 0;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .insight-card.positive {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .insight-card.negative {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.05);
        }

        .insight-card.pending {
            border-color: rgba(251, 191, 36, 0.3);
            background: rgba(251, 191, 36, 0.05);
        }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .insight-mechanism {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 0.8em;
            color: #A0A0A0;
            line-height: 1.45;
        }

        .insight-mechanism-icon {
            flex-shrink: 0;
            color: #A78BFA;
            margin-top: 1px;
        }

        .insight-supp-name {
            font-weight: 600;
            color: #E8E8E8;
            font-size: 1em;
        }

        .insight-start-date {
            font-size: 0.8em;
            color: #666;
        }

        .insight-badge {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .insight-badge.positive {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .insight-badge.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        .insight-badge.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #FBBF24;
        }

        .insight-badge.neutral {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .insight-metric {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .insight-metric-label {
            font-size: 0.85em;
            color: #888;
            min-width: 80px;
        }

        .insight-metric-values {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .insight-metric-before {
            color: #666;
        }

        .insight-metric-arrow {
            color: #666;
        }

        .insight-metric-after {
            font-weight: 600;
            color: #E8E8E8;
        }

        .insight-metric-change {
            font-size: 0.85em;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 8px;
        }

        .insight-metric-change.positive {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .insight-metric-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        /* Progress Bar Visualization */
        .insight-progress {
            margin: 12px 0;
        }

        .insight-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .insight-progress-label {
            font-size: 0.85em;
            color: #888;
        }

        .insight-progress-change {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .insight-progress-change.positive {
            color: #22C55E;
        }

        .insight-progress-change.negative {
            color: #EF4444;
        }

        .insight-progress-bar-container {
            position: relative;
            height: 32px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .insight-progress-before {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(136, 136, 136, 0.3);
            border-radius: 8px 0 0 8px;
            display: flex;
            align-items: center;
            padding-left: 12px;
            font-size: 0.85em;
            color: #888;
            z-index: 1;
        }

        .insight-progress-after {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            font-size: 0.9em;
            font-weight: 600;
            color: #fff;
            z-index: 2;
            transition: width 0.5s ease-out;
        }

        .insight-progress-after.positive {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.4), rgba(34, 197, 94, 0.7));
        }

        .insight-progress-after.negative {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.4), rgba(239, 68, 68, 0.7));
        }

        .insight-progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.75em;
            color: #666;
        }

        .insight-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            font-size: 0.8em;
            color: #666;
        }

        .insight-confidence {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .insight-confidence-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .insight-confidence-dot.high { background: #22C55E; }
        .insight-confidence-dot.medium { background: #F59E0B; }
        .insight-confidence-dot.low { background: #666; }

        .insight-adherence {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-streak {
            color: #F59E0B;
        }

        /* Consistency Cards */
        .consistency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .consistency-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 14px;
        }

        .consistency-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .consistency-name {
            font-weight: 600;
            color: #E8E8E8;
            font-size: 0.9em;
        }

        .consistency-streak {
            font-size: 0.8em;
            color: #F59E0B;
        }

        .consistency-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .consistency-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #A78BFA);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .consistency-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: #666;
        }

        .consistency-info {
            font-size: 0.75em;
            color: #888;
            font-style: italic;
            margin-top: 12px;
            padding: 10px;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 8px;
        }

        .insights-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .insights-empty-icon {
            font-size: 2em;
            margin-bottom: 12px;
        }

        /* Chart Header with Timeframe Selector */
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .chart-header h2 {
            margin: 0;
        }

        .chart-timeframe-selector {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
        }

        .timeframe-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #888;
            font-size: 0.8em;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .timeframe-btn:hover {
            color: #E8E8E8;
            background: rgba(139, 92, 246, 0.15);
        }

        .timeframe-btn.active {
            background: #8B5CF6;
            color: #fff;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: #A0A0A0;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Daily Check-in */
        .checkin-card {
            margin-top: 20px;
        }

        .checkin-date {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .checkin-date-text {
            font-weight: 600;
            color: #E8E8E8;
        }

        .checkin-supplements {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkin-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all 0.2s ease;
        }

        .checkin-item:hover {
            background: rgba(139, 92, 246, 0.05);
            border-color: rgba(139, 92, 246, 0.15);
        }

        .checkin-item.taken {
            background: rgba(34, 197, 94, 0.08);
            border-color: rgba(34, 197, 94, 0.2);
        }

        .checkin-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .checkin-checkbox.checked {
            background: #22C55E;
            border-color: #22C55E;
        }

        .checkin-checkbox.checked::after {
            content: '';
            color: #fff;
            font-size: 14px;
            font-weight: bold;
        }

        .checkin-info {
            flex: 1;
        }

        .checkin-name {
            font-weight: 500;
            color: #E8E8E8;
            margin-bottom: 2px;
        }

        .checkin-dose {
            font-size: 0.8em;
            color: #666;
        }

        .checkin-time-btns {
            display: flex;
            gap: 6px;
        }

        .checkin-time-btn {
            padding: 6px 12px;
            font-size: 0.75em;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 6px;
            color: #666;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .checkin-time-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.2);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .checkin-time-btn.active {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.3);
            color: #A78BFA;
        }

        /* Today's Stack - Quick Log */
        .todays-stack-card {
            margin-bottom: 20px;
        }

        .todays-stack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .todays-stack-title {
            font-weight: 600;
            color: #E8E8E8;
            font-size: 1.1em;
        }

        .todays-stack-date {
            font-size: 0.85em;
            color: #666;
        }

        .todays-stack-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stack-add-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .stack-add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }

        .stack-add-btn:active {
            transform: scale(0.95);
        }

        .stack-pills {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        /* When empty state is the only child, don't use grid */
        .stack-pills:has(.stack-empty:only-child) {
            display: block;
        }

        /* When stack sections are present, use flex column */
        .stack-pills:has(.stack-section) {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stack-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 16px;
        }

        .stack-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .stack-section-icon {
            color: #A78BFA;
            flex-shrink: 0;
        }

        .stack-section-title {
            font-weight: 600;
            color: #E8E8E8;
            font-size: 0.95em;
        }

        .stack-section-hint {
            font-size: 0.75em;
            color: #666;
            margin-left: auto;
        }

        .stack-section-pills {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
        }

        .stack-pill {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 90px;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .stack-pill:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.25);
            transform: translateY(-2px);
        }

        .stack-pill:active {
            transform: translateY(0);
        }

        .stack-pill.taken {
            background: rgba(34, 197, 94, 0.12);
            border-color: rgba(34, 197, 94, 0.4);
        }

        .stack-pill.taken:hover {
            background: rgba(34, 197, 94, 0.18);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .stack-pill-check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #22C55E;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #fff;
            font-weight: bold;
        }

        .stack-pill.taken .stack-pill-check {
            display: flex;
        }

        .stack-pill-name {
            font-weight: 600;
            color: #E8E8E8;
            text-align: center;
            font-size: 0.95em;
            margin-bottom: 4px;
        }

        .stack-pill-dose {
            font-size: 0.75em;
            color: #666;
            text-align: center;
        }

        .stack-pill-time {
            font-size: 0.7em;
            color: #22C55E;
            margin-top: 6px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .stack-pill.taken .stack-pill-time {
            opacity: 1;
        }

        .stack-add-pill {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 12px;
            background: transparent;
            border: 2px dashed rgba(139, 92, 246, 0.25);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 90px;
            color: #8B5CF6;
        }

        .stack-add-pill:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: none;
            transform: translateY(-2px);
        }

        .stack-add-pill:active {
            transform: translateY(0);
        }

        .stack-add-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        .stack-add-text {
            font-size: 0.85em;
            font-weight: 500;
        }

        .stack-empty {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.05) 0%, transparent 100%);
            border-radius: 16px;
            border: 1px dashed rgba(139, 92, 246, 0.2);
            grid-column: 1 / -1;
        }

        .stack-empty-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .stack-empty-text {
            font-size: 1.15em;
            font-weight: 600;
            color: #E8E8E8;
            margin-bottom: 8px;
        }

        .stack-empty-hint {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 20px;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }

        .quick-add-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 8px;
        }

        .quick-add-btn {
            padding: 8px 14px;
            font-size: 0.85em;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            color: #A78BFA;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-add-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-1px);
            box-shadow: none;
        }

        /* Future date state for Your Stack */
        .stack-future {
            text-align: center;
            padding: 30px 20px;
            color: #666;
        }

        .stack-future-icon {
            font-size: 2em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .stack-future-text {
            font-size: 1em;
            font-weight: 500;
            color: #888;
            margin-bottom: 6px;
        }

        .stack-future-hint {
            font-size: 0.85em;
            color: #555;
        }

        /* Drag and drop styles */
        .stack-section.drag-over {
            background: rgba(139, 92, 246, 0.15);
            border: 2px dashed rgba(139, 92, 246, 0.5);
        }

        .stack-pill.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .stack-pill {
            cursor: grab;
        }

        .stack-pill:active {
            cursor: grabbing;
        }

        /* Stack pill content wrapper */
        .stack-pill-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        /* Editable dose input */
        .stack-pill-dose {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.15s ease;
        }

        .stack-pill-dose:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        .stack-pill-dose.adjusted {
            color: #A78BFA;
            font-weight: 500;
        }

        .dose-input {
            width: 70px;
            padding: 4px 6px;
            border: 1px solid #8B5CF6;
            border-radius: 6px;
            font-size: 0.75em;
            text-align: center;
            outline: none;
            background: rgba(0, 0, 0, 0.3);
            color: #E8E8E8;
        }

        .dose-input:focus {
            border-color: #A78BFA;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        /* Empty hint in sections */
        .stack-empty-hint {
            font-size: 0.8em;
            color: #555;
            text-align: center;
            padding: 16px;
            font-style: italic;
        }

        .stack-empty-inline {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            color: #666;
        }

        .stack-empty-inline button {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85em;
        }

        .stack-empty-inline button:hover {
            transform: translateY(-1px);
        }

        /* Supplement Start Markers */
        .supplement-markers {
            margin-top: 20px;
        }

        .marker-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .marker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 20px;
            font-size: 0.85em;
        }

        .marker-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8B5CF6;
        }

        .marker-name {
            color: #A78BFA;
            font-weight: 500;
        }

        .marker-date {
            color: #666;
        }

        .add-marker-btn {
            padding: 8px 14px;
            font-size: 0.85em;
            background: transparent;
            border: 1px dashed rgba(139, 92, 246, 0.3);
            color: #8B5CF6;
            border-radius: 20px;
        }

        .add-marker-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-style: solid;
            box-shadow: none;
            transform: none;
        }

        /* Life Events */
        .life-events-section {
            margin-top: 20px;
        }

        .life-event-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }

        .life-event-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .life-event-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .life-event-icon.positive {
            background: rgba(34, 197, 94, 0.15);
        }

        .life-event-icon.negative {
            background: rgba(239, 68, 68, 0.15);
        }

        .life-event-icon.neutral {
            background: rgba(255, 255, 255, 0.05);
        }

        .life-event-info {
            flex: 1;
        }

        .life-event-type {
            font-weight: 500;
            color: #E8E8E8;
        }

        .life-event-date {
            font-size: 0.8em;
            color: #666;
        }

        .life-event-delete {
            padding: 6px 10px;
            font-size: 0.8em;
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #EF4444;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .life-event-item:hover .life-event-delete {
            opacity: 1;
        }

        .life-event-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            box-shadow: none;
            transform: none;
        }

        /* Show delete on mobile (no hover) */
        @media (hover: none) {
            .life-event-delete {
                opacity: 1;
            }
        }

        /* Add Life Event Form */
        .add-event-form {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .add-event-form.visible {
            display: block;
        }

        .add-event-form .form-row {
            margin-bottom: 12px;
        }

        .add-event-btn {
            margin-top: 16px;
            padding: 10px 18px;
            font-size: 0.9em;
            background: transparent;
            border: 1px dashed rgba(139, 92, 246, 0.3);
            color: #8B5CF6;
            width: 100%;
        }

        .add-event-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-style: solid;
            box-shadow: none;
            transform: none;
        }

        /* Add Supplement Start Modal */
        .modal-form-row {
            margin-bottom: 16px;
        }

        .modal-form-row label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: #A0A0A0;
        }

        /* Your Supplements Section */
        .supplements-section {
            margin-bottom: 20px;
        }

        .supplements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .supplements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        /* When empty state is the only child, don't use grid */
        .supplements-grid:has(.supplements-empty:only-child) {
            display: block;
        }

        .supplement-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all 0.2s ease;
        }

        .supplement-card:hover {
            background: rgba(139, 92, 246, 0.05);
            border-color: rgba(139, 92, 246, 0.15);
        }

        .supplement-card.manual {
            border-left: 3px solid #22C55E;
        }

        .supplement-card.recommended {
            border-left: 3px solid #8B5CF6;
        }

        .supplement-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .supplement-icon.manual {
            background: rgba(34, 197, 94, 0.15);
        }

        .supplement-icon.recommended {
            background: rgba(139, 92, 246, 0.15);
        }

        .supplement-details {
            flex: 1;
            min-width: 0;
        }

        .supplement-name {
            font-weight: 500;
            color: #E8E8E8;
            margin-bottom: 2px;
        }

        .supplement-meta {
            font-size: 0.8em;
            color: #666;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .supplement-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 0.85em;
        }

        .supplement-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .supplement-card:hover .supplement-actions {
            opacity: 1;
        }

        .supplement-action-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #666;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .supplement-action-btn:hover {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
            box-shadow: none;
            transform: none;
        }

        .supplement-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        .supplement-action-btn.edit:hover {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }

        .supplement-action-btn.stop:hover {
            background: rgba(251, 191, 36, 0.15);
            color: #FBBF24;
        }

        /* Show actions on mobile (no hover) */
        @media (hover: none) {
            .supplement-actions {
                opacity: 1;
            }
        }

        /* New supplement card v2 styles */
        .supplement-card-v2 {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-left: 3px solid #8B5CF6;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .supplement-card-v2:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.03);
        }

        .supplement-card-v2.measurable {
            border-left-color: #8B5CF6;
        }

        .supplement-card-v2.consistency {
            border-left-color: #22C55E;
        }

        .supp-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .supp-card-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #E8E8E8;
        }

        .supp-card-dose {
            font-size: 0.8em;
            color: #A78BFA;
            background: rgba(139, 92, 246, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .supp-card-metrics {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .metric-tag {
            font-size: 0.7em;
            padding: 2px 8px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 12px;
            color: #A78BFA;
        }

        .supp-mini-chart-container {
            height: 60px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 4px;
        }

        .supp-card-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .supp-change {
            font-weight: 500;
        }

        .supp-change.positive {
            color: #22C55E;
        }

        .supp-change.negative {
            color: #EF4444;
        }

        .supp-change.pending {
            color: #666;
            font-style: italic;
        }

        .supp-streak {
            color: #888;
            font-size: 0.9em;
        }

        .supp-card-info {
            margin-bottom: 12px;
        }

        .info-label {
            font-size: 0.75em;
            color: #666;
            font-style: italic;
        }

        .consistency-bar-container {
            position: relative;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 14px;
            overflow: hidden;
        }

        .consistency-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22C55E, #4ADE80);
            border-radius: 12px;
            transition: width 0.5s ease;
        }

        .consistency-bar-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75em;
            font-weight: 500;
            color: #E8E8E8;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .consistency-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            text-align: center;
            margin-bottom: 12px;
        }

        .consistency-stats .stat {
            background: rgba(255, 255, 255, 0.02);
            padding: 10px;
            border-radius: 8px;
        }

        .consistency-stats .stat-value {
            display: block;
            font-size: 1.3em;
            font-weight: 600;
            color: #E8E8E8;
        }

        .consistency-stats .stat-label {
            font-size: 0.7em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .supp-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .supp-start-date {
            font-size: 0.75em;
            color: #555;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .supp-start-date:hover {
            background: rgba(139, 92, 246, 0.15);
            color: #8B5CF6;
        }

        .supp-start-date-input {
            width: 110px;
            padding: 2px 4px;
            border: 1px solid #8B5CF6;
            border-radius: 4px;
            font-size: 0.75em;
            background: #1a1a1a;
            color: #fff;
            outline: none;
        }

        .supp-card-actions {
            display: flex;
            gap: 8px;
        }

        .supp-card-actions button {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.2s;
        }

        .supp-card-actions button:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            color: #E8E8E8;
        }

        .supplements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .add-supplement-btn {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            color: #8B5CF6;
            font-size: 0.95em;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-supplement-btn:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: none;
            transform: none;
        }

        .supplements-empty {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            grid-column: 1 / -1;
        }

        .supplements-empty-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Supplement type badges */
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .type-badge.manual {
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
        }

        .type-badge.recommended {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }

        /* Updated marker colors for chart legend */
        .legend-marker {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8em;
            color: #666;
        }

        .legend-marker-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-marker-dot.manual {
            background: #22C55E;
        }

        .legend-marker-dot.recommended {
            background: #8B5CF6;
        }
    </style>
</head>
<body>
    <div id="status" class="hidden"></div>

    <div class="container">
        <h1>Dose</h1>

        <!-- Not logged in -->
        <div id="no-user">
            <div class="card signup-card">
                <div class="signup-header">
                    <div class="signup-logo"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5"><rect x="6" y="4" width="12" height="16" rx="6"/><path d="M6 12h12"/></svg></div>
                    <h2>Welcome to Dose</h2>
                    <p class="signup-subtitle">Personalized supplement recommendations powered by your data</p>
                </div>

                <div class="signup-form">
                    <input type="text" id="user-name" placeholder="Your name" class="signup-input" required>
                    <input type="email" id="user-email" placeholder="Email address" class="signup-input" required>
                    <button onclick="createAccount()" class="signup-btn">
                        Get Started 
                    </button>
                </div>

                <div class="signup-features">
                    <div class="signup-feature">
                        <span class="feature-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></span>
                        <span>Track supplement effects</span>
                    </div>
                    <div class="signup-feature">
                        <span class="feature-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="5"/></svg></span>
                        <span>Sync with Oura Ring</span>
                    </div>
                    <div class="signup-feature">
                        <span class="feature-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></span>
                        <span>Personalized dosing</span>
                    </div>
                </div>

                <div class="signin-section">
                    <span style="color: #666;">Already have an account?</span>
                    <a href="#" onclick="toggleSignIn(event)" class="signin-link">Sign in</a>
                </div>

                <div id="signin-form" class="hidden signin-form-container">
                    <input type="email" id="signin-email" placeholder="Email address" class="signup-input">
                    <button onclick="signIn()" class="signup-btn secondary">Sign In</button>
                </div>
            </div>
        </div>

        <!-- Logged in -->
        <div id="has-user" class="hidden">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <span class="user-name" id="display-name">User</span>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>

            <!-- Main Navigation -->
            <div class="main-nav">
                <button class="main-nav-btn active" onclick="switchMainTab('dashboard')" id="nav-dashboard">Dashboard</button>
                <button class="main-nav-btn" onclick="switchMainTab('analytics')" id="nav-analytics">Analytics</button>
                <button class="main-nav-btn" onclick="switchMainTab('dispenser')" id="nav-dispenser">
                    Dispenser <span class="coming-soon-badge">Soon</span>
                </button>
            </div>

            <!-- Dashboard Section -->
            <div class="dashboard-section" id="dashboard-section">

            <!-- Date Navigation -->
            <div class="date-nav">
                <button onclick="changeDate(-1)" title="Previous day">&#8592;</button>
                <div class="date-display">
                    <div class="day" id="date-day">Today</div>
                    <div class="full-date" id="date-full">January 15, 2026</div>
                </div>
                <button onclick="changeDate(1)" title="Next day">&#8594;</button>
            </div>

            <!-- Getting Started Card (for new users) -->
            <div class="getting-started-card hidden" id="getting-started-card">
                <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>Getting Started</h3>
                <p class="gs-subtitle">Complete these steps to get personalized insights</p>

                <div class="gs-progress">
                    <div class="gs-progress-bar">
                        <div class="gs-progress-fill" id="gs-progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="gs-progress-text" id="gs-progress-text">0/3</span>
                </div>

                <div class="gs-checklist">
                    <div class="gs-checklist-item" id="gs-item-oura">
                        <div class="gs-check-circle" id="gs-check-oura"></div>
                        <div class="gs-item-content">
                            <div class="gs-item-title">Connect Oura Ring</div>
                            <div class="gs-item-desc">Sync your sleep and recovery data</div>
                        </div>
                        <button class="gs-item-action" onclick="connectOura()">Connect</button>
                    </div>

                    <div class="gs-checklist-item" id="gs-item-supplements">
                        <div class="gs-check-circle" id="gs-check-supplements"></div>
                        <div class="gs-item-content">
                            <div class="gs-item-title">Add your supplements</div>
                            <div class="gs-item-desc">Track what you take daily</div>
                        </div>
                        <button class="gs-item-action" onclick="openAddManualSupplement()">Add</button>
                    </div>

                    <div class="gs-checklist-item" id="gs-item-log">
                        <div class="gs-check-circle" id="gs-check-log"></div>
                        <div class="gs-item-content">
                            <div class="gs-item-title">Log your first check-in</div>
                            <div class="gs-item-desc">Start building your history</div>
                        </div>
                        <button class="gs-item-action" onclick="switchMainTab('dashboard')">Log</button>
                    </div>
                </div>

                <button class="gs-dismiss" onclick="dismissGettingStarted()">Dismiss for now</button>
            </div>

            <!-- Oura Connection Card -->
            <div class="oura-card" id="oura-card">
                <div class="oura-header">
                    <div class="oura-brand">
                        <div class="oura-logo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="5"/></svg></div>
                        <div>
                            <div class="oura-title">Oura Ring</div>
                            <div class="oura-subtitle">Health data sync</div>
                        </div>
                    </div>
                    <div class="oura-status disconnected" id="oura-status">
                        <span class="oura-status-dot"></span>
                        <span id="oura-status-text">Not connected</span>
                    </div>
                </div>

                <!-- Not connected state -->
                <div id="oura-not-connected">
                    <button class="oura-connect-btn" onclick="connectOura()">
                        Connect Oura Ring
                    </button>
                </div>

                <!-- Connected state with metrics -->
                <div id="oura-connected" class="hidden">
                    <div class="oura-date-label" id="oura-date-label" style="text-align: center; font-size: 0.75em; color: #666; margin-bottom: 8px;">Today's scores</div>
                    <div class="oura-metrics" id="oura-metrics">
                        <div class="oura-metric">
                            <div class="oura-metric-value" id="oura-sleep">--</div>
                            <div class="oura-metric-label">Sleep</div>
                        </div>
                        <div class="oura-metric">
                            <div class="oura-metric-value" id="oura-hrv">--</div>
                            <div class="oura-metric-label">HRV</div>
                        </div>
                        <div class="oura-metric">
                            <div class="oura-metric-value" id="oura-recovery">--</div>
                            <div class="oura-metric-label">Recovery</div>
                        </div>
                    </div>

                    <!-- Intelligent Health Insights -->
                    <div class="health-insights" id="health-insights">
                        <!-- Dynamically populated by JavaScript -->
                    </div>

                    <!-- Toggle for expanded details -->
                    <button class="oura-details-toggle" id="oura-details-toggle" onclick="toggleOuraDetails()">
                        <span>View Details</span>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>

                    <!-- Expanded Details Sections -->
                    <div class="oura-details-sections" id="oura-details-sections">
                        <!-- Sleep Details -->
                        <div class="oura-detail-section">
                            <div class="oura-detail-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                                </svg>
                                Sleep Details
                            </div>
                            <div class="oura-detail-grid">
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-sleep-duration">--</div>
                                    <div class="oura-detail-label">Total Sleep</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-sleep-efficiency">--</div>
                                    <div class="oura-detail-label">Efficiency</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-bedtime">--</div>
                                    <div class="oura-detail-label">Bedtime</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-waketime">--</div>
                                    <div class="oura-detail-label">Wake Time</div>
                                </div>
                            </div>
                            <!-- Sleep Stage Breakdown -->
                            <div class="oura-detail-item oura-detail-wide" style="margin-top: 12px;">
                                <div class="oura-detail-label" style="margin-bottom: 6px;">Sleep Stages</div>
                                <div class="sleep-bar-container" id="oura-sleep-bar"></div>
                                <div class="sleep-bar-legend">
                                    <div class="sleep-bar-legend-item">
                                        <div class="sleep-bar-legend-dot sleep-bar-deep"></div>
                                        <span id="oura-deep-pct">--</span> Deep
                                    </div>
                                    <div class="sleep-bar-legend-item">
                                        <div class="sleep-bar-legend-dot sleep-bar-rem"></div>
                                        <span id="oura-rem-pct">--</span> REM
                                    </div>
                                    <div class="sleep-bar-legend-item">
                                        <div class="sleep-bar-legend-dot sleep-bar-light"></div>
                                        <span id="oura-light-pct">--</span> Light
                                    </div>
                                    <div class="sleep-bar-legend-item">
                                        <div class="sleep-bar-legend-dot sleep-bar-awake"></div>
                                        <span id="oura-awake-pct">--</span> Awake
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Heart Rate -->
                        <div class="oura-detail-section">
                            <div class="oura-detail-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                </svg>
                                Heart Rate
                            </div>
                            <div class="oura-detail-grid">
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-resting-hr">--</div>
                                    <div class="oura-detail-label">Resting HR</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-lowest-hr">--</div>
                                    <div class="oura-detail-label">Lowest HR</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-avg-hr">--</div>
                                    <div class="oura-detail-label">Avg During Sleep</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-vo2max">--</div>
                                    <div class="oura-detail-label">VO2 Max</div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity -->
                        <div class="oura-detail-section">
                            <div class="oura-detail-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                                </svg>
                                Activity
                            </div>
                            <div class="oura-detail-grid">
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-steps">--</div>
                                    <div class="oura-detail-label">Steps</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-active-cal">--</div>
                                    <div class="oura-detail-label">Active Calories</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-activity-score">--</div>
                                    <div class="oura-detail-label">Activity Score</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-active-time">--</div>
                                    <div class="oura-detail-label">Active Time</div>
                                </div>
                            </div>
                        </div>

                        <!-- Body & Wellness -->
                        <div class="oura-detail-section" id="oura-wellness-section">
                            <div class="oura-detail-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                                </svg>
                                Body & Wellness
                            </div>
                            <div class="oura-detail-grid">
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-spo2">--</div>
                                    <div class="oura-detail-label">SpO2</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-breathing">--</div>
                                    <div class="oura-detail-label">Breathing Rate</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-temp">--</div>
                                    <div class="oura-detail-label">Temp Deviation</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-stress">--</div>
                                    <div class="oura-detail-label">Stress Level</div>
                                </div>
                            </div>
                        </div>

                        <!-- Workout (conditional) -->
                        <div class="oura-detail-section hidden" id="oura-workout-section">
                            <div class="oura-detail-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                                Workout
                            </div>
                            <div class="oura-detail-grid">
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-workout-type">--</div>
                                    <div class="oura-detail-label">Activity</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-workout-duration">--</div>
                                    <div class="oura-detail-label">Duration</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-workout-calories">--</div>
                                    <div class="oura-detail-label">Calories</div>
                                </div>
                                <div class="oura-detail-item">
                                    <div class="oura-detail-value" id="oura-workout-intensity">--</div>
                                    <div class="oura-detail-label">Intensity</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="oura-actions">
                        <button class="oura-sync-btn" onclick="syncOuraData()">
                            Sync Latest
                        </button>
                        <button class="oura-sync-btn" onclick="syncOuraFullHistory()" style="background: rgba(139, 92, 246, 0.3);">
                            Sync Full History
                        </button>
                        <button class="oura-disconnect-btn" onclick="disconnectOura()">
                            Disconnect
                        </button>
                    </div>
                </div>

                <!-- Loading state -->
                <div id="oura-loading" class="oura-loading hidden">
                    Checking connection...
                </div>
            </div>

            <!-- Your Stack - Quick Log with Time Sections -->
            <div class="card todays-stack-card" id="stack-card">
                <div class="todays-stack-header">
                    <span class="todays-stack-title">Your Stack</span>
                    <div class="todays-stack-actions">
                        <span class="todays-stack-date" id="todays-stack-date">Loading...</span>
                        <button class="stack-add-btn" onclick="switchMainTab('analytics'); setTimeout(() => openAddManualSupplement(), 100);">+</button>
                    </div>
                </div>
                <div id="stack-container">
                    <!-- Morning Section -->
                    <div class="stack-section" data-time="morning" ondrop="dropPill(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                        <div class="stack-section-header">
                            <span class="stack-section-icon">&#127749;</span>
                            <span class="stack-section-title">Morning</span>
                        </div>
                        <div class="stack-section-pills" id="morning-pills"></div>
                    </div>

                    <!-- Intra-Day Section -->
                    <div class="stack-section" data-time="intraday" ondrop="dropPill(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                        <div class="stack-section-header">
                            <span class="stack-section-icon">&#9728;&#65039;</span>
                            <span class="stack-section-title">Intra-Day</span>
                        </div>
                        <div class="stack-section-pills" id="intraday-pills"></div>
                    </div>

                    <!-- Evening Section -->
                    <div class="stack-section" data-time="evening" ondrop="dropPill(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                        <div class="stack-section-header">
                            <span class="stack-section-icon">&#127769;</span>
                            <span class="stack-section-title">Evening</span>
                        </div>
                        <div class="stack-section-pills" id="evening-pills"></div>
                    </div>
                </div>
            </div>

            </div><!-- End Dashboard Section -->

            <!-- Analytics Section -->
            <div class="analytics-section" id="analytics-section">
                <!-- My Supplements Section -->
                <div class="card supplements-section">
                    <div class="supplements-header">
                        <h2>My Supplements</h2>
                        <button class="btn-secondary" onclick="openAddManualSupplement()" style="padding: 8px 16px; font-size: 0.85em;">+ Add Supplement</button>
                    </div>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 16px;">Supplements you're currently taking. Add start dates to track their effects on your health.</p>
                    <div class="supplements-grid" id="supplements-grid">
                        <div class="supplements-empty">
                            <div class="supplements-empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5"><rect x="6" y="4" width="12" height="16" rx="6"/><path d="M6 12h12"/></svg></div>
                            <div>No supplements tracked yet</div>
                            <div style="font-size: 0.85em; margin-top: 6px;">Add the supplements you're currently taking</div>
                        </div>
                    </div>
                </div>

                <!-- Supplement Insights -->
                <div class="card" id="insights-card">
                    <h2>Supplement Insights</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 16px;">See how your supplements are affecting your health metrics.</p>

                    <div id="insights-content">
                        <div class="insights-loading">
                            <div class="spinner"></div>
                            <div>Analyzing your data...</div>
                        </div>
                    </div>
                </div>

                <!-- Health Metrics Chart -->
                <div class="card">
                    <div class="chart-header">
                        <h2>Health Metrics Over Time</h2>
                        <div class="chart-timeframe-selector">
                            <button class="timeframe-btn" onclick="setChartTimeframe(7)">7d</button>
                            <button class="timeframe-btn" onclick="setChartTimeframe(14)">14d</button>
                            <button class="timeframe-btn active" onclick="setChartTimeframe(30)">30d</button>
                            <button class="timeframe-btn" onclick="setChartTimeframe(90)">90d</button>
                            <button class="timeframe-btn" onclick="setChartTimeframe(0)">All</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="health-chart"></canvas>
                        <!-- Overlay for when Oura not connected -->
                        <div class="chart-overlay hidden" id="chart-overlay">
                            <div class="chart-overlay-icon"><svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></div>
                            <h3>See Your Health Trends</h3>
                            <p>Connect your Oura Ring to visualize sleep, HRV, and recovery data over time</p>
                            <button class="chart-overlay-btn" onclick="connectOura()">Connect Oura</button>
                        </div>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #8B5CF6;"></div>
                            <span>Sleep Score</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #22C55E;"></div>
                            <span>HRV</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #F59E0B;"></div>
                            <span>Recovery</span>
                        </div>
                    </div>

                    <!-- Supplement Start Markers -->
                    <div class="supplement-markers">
                        <h3 style="font-size: 0.95em; color: #A0A0A0; margin-bottom: 8px;">Supplement Markers on Chart</h3>
                        <div class="marker-list" id="supplement-markers-list">
                            <button class="add-marker-btn" onclick="openAddSupplementStart()">+ Add Supplement Start</button>
                        </div>
                    </div>
                </div>

                <!-- Life Events -->
                <div class="card life-events-section">
                    <h2>Life Events</h2>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 12px;">Track events that might affect your health metrics</p>
                    <div class="life-event-list" id="life-events-list">
                        <!-- Populated by JS -->
                    </div>
                    <button class="add-event-btn" onclick="toggleAddEventForm()">+ Log Life Event</button>
                    <div class="add-event-form" id="add-event-form">
                        <div class="form-row">
                            <input type="date" id="event-date" style="flex: 1;">
                            <select id="event-type" style="flex: 1;">
                                <option value="">Select event type...</option>
                                <option value="new_job">New job/work stress</option>
                                <option value="changed_mattress">Changed mattress</option>
                                <option value="moved">Moved homes</option>
                                <option value="started_exercise">Started exercising</option>
                                <option value="stopped_exercise">Stopped exercising</option>
                                <option value="sick">Got sick</option>
                                <option value="travel">Travel/jet lag</option>
                                <option value="relationship">Relationship change</option>
                                <option value="diet_change">Major diet change</option>
                                <option value="medication">Started/stopped medication</option>
                                <option value="stress">Major stress event</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <input type="text" id="event-description" placeholder="Optional description..." style="flex: 2;">
                            <select id="event-impact" style="flex: 1;">
                                <option value="neutral">Neutral</option>
                                <option value="positive">Positive</option>
                                <option value="negative">Negative</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button class="btn-secondary" onclick="toggleAddEventForm()" style="flex: 1;">Cancel</button>
                            <button onclick="saveLifeEvent()" style="flex: 1;">Save Event</button>
                        </div>
                    </div>
                </div>
            </div><!-- End Analytics Section -->

            <!-- Dispenser Section -->
            <div class="dispenser-section" id="dispenser-section">
                <!-- Coming Soon Hero -->
                <div class="dispenser-coming-soon">
                    <div class="dispenser-hero-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 3v2m8-2v2M3 10h18M5 5h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z"/>
                            <circle cx="12" cy="15" r="3"/>
                            <path d="M12 13v4m-2-2h4"/>
                        </svg>
                    </div>
                    <h2>Dose Dispenser</h2>
                    <p>Smart hardware that automatically dispenses your personalized supplement stack. Coming soon.</p>

                    <div class="dispenser-features">
                        <div class="dispenser-feature">
                            <div class="dispenser-feature-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
                                </svg>
                            </div>
                            <h3>Auto-Dispense</h3>
                            <p>Precise doses at the right time</p>
                        </div>
                        <div class="dispenser-feature">
                            <div class="dispenser-feature-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 12l2 2 4-4"/>
                                    <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h3>Smart Tracking</h3>
                            <p>Automatic logging when you dispense</p>
                        </div>
                        <div class="dispenser-feature">
                            <div class="dispenser-feature-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                            </div>
                            <h3>Refill Alerts</h3>
                            <p>Never run out of supplements</p>
                        </div>
                    </div>
                </div>

                <!-- Preview: What the dispenser will offer -->
                <div class="dispenser-preview-section">
                    <div class="dispenser-preview-label">Preview: What you'll be able to dispense</div>

                    <!-- Dispenser Card -->
                    <div class="card dispenser-preview-card">
                        <h2>What do you need today?</h2>

                        <div class="dispenser-layout" id="dispenser-layout">
                            <!-- AI Recommendation -->
                            <div class="ai-recommendation" id="ai-recommendation">
                                <div class="ai-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                    </svg>
                                </div>
                                <div class="ai-title">Smart Recommendation</div>
                                <div class="ai-subtitle" id="ai-subtitle">Connect Oura for personalized insights</div>
                            </div>

                            <!-- Daily Foundation -->
                            <div class="daily-foundation" id="daily-foundation">
                                <div class="df-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                    </svg>
                                </div>
                                <div class="df-name">Daily Foundation</div>
                                <div class="df-contents">D3 + K2 + Omega-3</div>
                                <div class="df-status" id="df-status">Coming with dispenser</div>
                            </div>

                            <!-- Mix cards populated by JS -->
                        </div>
                    </div>

                    <!-- Custom Blends Card -->
                    <div class="card dispenser-preview-card" id="custom-blends-card">
                        <div class="custom-blends-header">
                            <h2>Your Custom Blends</h2>
                            <button class="btn-create-blend" onclick="openBlendBuilder()">+ Create Blend</button>
                        </div>
                        <div id="custom-blends-list">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2v-4M9 21H5a2 2 0 01-2-2v-4m0-6v6"/>
                                    </svg>
                                </div>
                                <div>No custom blends yet</div>
                                <div style="font-size: 0.8em; color: #666; margin-top: 6px;">
                                    Create your own supplement combinations
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Dispenser Section -->

        </div>
    </div>

    <!-- Add Supplement Modal (supports both manual and recommended) -->
    <div class="modal-overlay hidden" id="supplement-start-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="text-align: left; margin-bottom: 18px;">
                <div class="modal-title" id="supplement-modal-title">Add Supplement</div>
                <div class="modal-subtitle" id="supplement-modal-subtitle">Track a supplement you're taking</div>
            </div>
            <div class="modal-form-row">
                <label>Supplement</label>
                <select id="start-supplement-id" style="width: 100%;" onchange="onSupplementSelect()">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div class="modal-form-row" id="custom-name-row" style="display: none;">
                <label>Custom Name</label>
                <input type="text" id="start-supplement-name" placeholder="Enter supplement name" style="width: 100%;">
            </div>
            <div class="modal-form-row">
                <label>Dosage</label>
                <input type="text" id="start-dosage" placeholder="e.g., 500mg, 2000 IU" style="width: 100%;">
            </div>
            <div class="form-row">
                <div class="modal-form-row" style="flex: 1;">
                    <label>Frequency</label>
                    <select id="start-frequency" style="width: 100%;">
                        <option value="daily">Once daily</option>
                        <option value="twice_daily">Twice daily</option>
                        <option value="three_times">Three times daily</option>
                        <option value="as_needed">As needed</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>
                <div class="modal-form-row" style="flex: 1;">
                    <label>Start Date</label>
                    <input type="date" id="start-date" style="width: 100%;" onchange="checkBackdateAdherence()">
                </div>
            </div>
            <div class="modal-form-row">
                <label>Goal / Reason</label>
                <select id="start-reason" style="width: 100%;">
                    <option value="">Select reason (optional)</option>
                    <option value="sleep">Better Sleep</option>
                    <option value="energy">More Energy</option>
                    <option value="recovery">Exercise Recovery</option>
                    <option value="focus">Focus & Cognition</option>
                    <option value="stress">Stress & Mood</option>
                    <option value="immunity">Immune Support</option>
                    <option value="general_health">General Health</option>
                    <option value="deficiency">Address Deficiency</option>
                </select>
            </div>
            <div class="modal-form-row">
                <label>Notes (optional)</label>
                <input type="text" id="start-notes" placeholder="Any additional notes..." style="width: 100%;">
            </div>
            <div class="modal-form-row" id="adherence-row" style="display: none;">
                <label>Estimated Adherence</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="range" id="start-adherence" min="0" max="100" value="80" style="flex: 1;" oninput="updateAdherenceLabel()">
                    <span id="adherence-label" style="min-width: 45px; text-align: right;">80%</span>
                </div>
                <div style="font-size: 0.75em; color: #666; margin-top: 4px;">
                    We'll auto-fill past logs based on this percentage
                </div>
            </div>
            <input type="hidden" id="start-is-manual" value="true">
            <input type="hidden" id="edit-supplement-id" value="">
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn-cancel" onclick="closeSupplementStartModal()">Cancel</button>
                <button id="supplement-save-btn" onclick="saveSupplementStart()">Add Supplement</button>
            </div>
        </div>
    </div>

    <!-- Blend Builder Modal -->
    <div class="modal-overlay hidden" id="blend-builder-modal">
        <div class="modal-content blend-builder" id="blend-builder-content">
            <div class="modal-header" style="text-align: left; margin-bottom: 18px;">
                <div class="modal-title">Create Custom Blend</div>
                <div class="modal-subtitle">Select supplements and customize doses</div>
            </div>

            <div class="blend-builder-header">
                <input type="text" id="blend-name" placeholder="Blend name (e.g. My Morning Stack)">
                <input type="text" id="blend-icon" class="icon-picker" value="&#x1F9EA;" maxlength="2" onclick="this.select()">
            </div>

            <!-- AI Assistant Section -->
            <div class="ai-blend-section">
                <div class="ai-blend-header">
                    <span class="ai-icon">&#x2728;</span>
                    <div>
                        <h3>AI Blend Assistant</h3>
                        <span>Describe what you want and I'll suggest supplements</span>
                    </div>
                </div>
                <div class="ai-input-row">
                    <textarea id="ai-blend-input" placeholder="Example: I want better sleep and less stress, but I also need energy in the morning without feeling jittery..."></textarea>
                    <button onclick="getAIBlendSuggestion()">Suggest</button>
                </div>
                <div class="ai-suggestions" id="ai-suggestions">
                    <div class="ai-suggestions-header">
                        <span class="ai-suggestions-title">Suggested Supplements</span>
                        <button class="btn-add-all" onclick="addAllSuggestions()">+ Add All</button>
                    </div>
                    <div id="ai-suggestions-list"></div>
                </div>
            </div>

            <div class="supplement-categories" id="supplement-categories">
                <!-- Populated by JS -->
            </div>

            <div class="supplement-grid" id="supplement-grid">
                <!-- Populated by JS -->
            </div>

            <div class="selected-supplements" id="selected-supplements" style="display: none;">
                <div class="selected-supplements-title">Selected Supplements</div>
                <div id="selected-supplements-list"></div>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeBlendBuilder()">Cancel</button>
                <button class="btn-dispense" onclick="saveCustomBlend()" id="save-blend-btn">
                    Save Blend
                </button>
            </div>
        </div>
    </div>

    <!-- Supplement Info Modal -->
    <div class="modal-overlay hidden" id="supp-info-modal">
        <div class="modal-content supp-info-modal" id="supp-info-content">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Dispense Modal -->
    <div class="modal-overlay hidden" id="dispense-modal">
        <div class="modal-content" id="modal-content">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Settings Toggle -->
    <button class="settings-toggle" onclick="toggleSettings()" title="Settings">
        <span>&#x2699;</span>
    </button>

    <!-- Settings Panel -->
    <div class="settings-panel hidden" id="settings-panel">
        <h3>Settings</h3>
        <div class="setting-row">
            <label>Simulate Health Data</label>
            <select id="scenario" onchange="loadScenario()">
                <option value="none">-- Select scenario --</option>
                <option value="average">Average Day</option>
                <option value="poor_sleep">Poor Sleep</option>
                <option value="high_strain">High Strain</option>
                <option value="stressed">Stressed</option>
                <option value="recovering">Recovering Well</option>
            </select>
        </div>
        <div class="setting-row">
            <label>Connect Wearable</label>
            <button onclick="connectOura()" class="btn-secondary" style="width: 100%; margin-top: 6px;">
                Connect Oura Ring
            </button>
        </div>

        <!-- Push Notifications Section -->
        <div class="setting-section">
            <h4>Reminders</h4>
            <div id="notification-section">
                <!-- Permission not granted -->
                <div id="notification-disabled">
                    <p class="setting-hint">Get reminders to take your supplements at the right time.</p>
                    <button onclick="enableNotifications()" class="btn-primary" style="width: 100%; margin-top: 8px;" id="enable-notifications-btn">
                        Enable Notifications
                    </button>
                    <p class="setting-hint" id="notification-blocked-hint" style="display: none; color: #EF4444;">
                        Notifications are blocked. Please enable them in your browser settings.
                    </p>
                </div>

                <!-- Notifications enabled -->
                <div id="notification-enabled" class="hidden">
                    <div class="verified-badge">
                        <span class="checkmark">&#x2713;</span>
                        Notifications enabled
                    </div>

                    <div class="reminder-options">
                        <div class="toggle-row">
                            <label>Morning reminder</label>
                            <div class="reminder-time-row">
                                <input type="time" id="morning-time" class="time-input" value="07:00" onchange="updateNotificationPrefs()">
                                <label class="toggle-switch small">
                                    <input type="checkbox" id="morning-enabled" onchange="updateNotificationPrefs()" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="toggle-row">
                            <label>Evening reminder</label>
                            <div class="reminder-time-row">
                                <input type="time" id="evening-time" class="time-input" value="21:00" onchange="updateNotificationPrefs()">
                                <label class="toggle-switch small">
                                    <input type="checkbox" id="evening-enabled" onchange="updateNotificationPrefs()" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button onclick="testNotification()" class="btn-text" style="margin-top: 8px;">Send test notification</button>
                    <button onclick="disableNotifications()" class="btn-text btn-danger-text">Disable notifications</button>
                </div>
            </div>
        </div>

        <!-- Stack Preferences -->
        <div class="setting-section">
            <h4>Stack Preferences</h4>
            <div class="toggle-row">
                <label>Enable Afternoon Stack</label>
                <label class="toggle-switch small">
                    <input type="checkbox" id="afternoon-stack-toggle" onchange="toggleAfternoonStack()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <p class="setting-hint">Add a midday stack for pre-workout or afternoon energy supplements.</p>
        </div>

        <div class="setting-row setting-danger">
            <label>Account</label>
            <button onclick="confirmResetAccount()" class="btn-danger" style="width: 100%; margin-top: 6px;">
                Reset Account
            </button>
            <p class="setting-hint">Clear all data and start fresh</p>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal-overlay hidden" id="reset-confirm-modal">
        <div class="modal-content reset-confirm-modal">
            <div class="reset-warning-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <h2>Reset Account?</h2>
            <p class="reset-warning-text">This will permanently delete:</p>
            <ul class="reset-list">
                <li>All supplement tracking data</li>
                <li>Health metrics and check-ins</li>
                <li>Life events and correlations</li>
                <li>Oura Ring connection</li>
                <li>Profile information</li>
            </ul>
            <p class="reset-warning-subtext">Your account (email) will be preserved. You'll go through onboarding again.</p>
            <div class="reset-confirm-actions">
                <button class="btn-cancel" onclick="closeResetModal()">Cancel</button>
                <button class="btn-confirm-reset" onclick="executeResetAccount()">Yes, Reset Everything</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal-overlay hidden" id="onboarding-modal">
        <div class="modal-content onboarding-modal-content">
            <!-- Progress indicator (built dynamically by JS) -->
            <div class="onboarding-progress"></div>

            <!-- Step content container -->
            <div id="onboarding-content"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-links">
            <a href="/privacy">Privacy Policy</a>
            <a href="/terms">Terms of Service</a>
        </div>
        <div class="footer-copyright">
            &copy; 2026 Dose. All rights reserved.
        </div>
    </footer>

    <script>
        // State
        let currentUserId = localStorage.getItem('userId');
        let currentDate = new Date();
        let currentTime = 14;
        let availableMixes = [];
        let customBlends = [];
        let currentMixData = null;
        let isDispensing = false;
        let ouraConnected = false;
        let ouraData = null;

        // Analytics State
        let healthChart = null;
        let analyticsData = null;
        let supplementInsightsData = null; // Cached insights for supplement cards
        let miniCharts = {}; // Store mini chart instances
        let supplementList = []; // List of all supplements for dropdown

        // Supplement timing - determines Morning, Intra-Day, or Evening stack
        const SUPPLEMENT_TIMING = {
            // Morning supplements (take with breakfast or AM)
            'vitamin_d3': 'morning',
            'vitamin_d': 'morning',
            'fish_oil': 'morning',
            'omega_3': 'morning',
            'vitamin_b12': 'morning',
            'vitamin_b_complex': 'morning',
            'iron': 'morning',
            'coq10': 'morning',
            'rhodiola': 'morning',
            'cordyceps': 'morning',
            'lions_mane': 'morning',
            'caffeine': 'morning',

            // Intra-day supplements (take during the day, timing flexible)
            'creatine': 'intraday',
            'alpha_lipoic_acid': 'intraday',
            'electrolytes': 'intraday',

            // Evening supplements (take 60 mins before bed)
            'magnesium_glycinate': 'evening',
            'magnesium': 'evening',
            'glycine': 'evening',
            'melatonin': 'evening',
            'l_theanine': 'evening',
            'ashwagandha': 'evening',
            'valerian': 'evening',
            'gaba': 'evening',
            'zinc': 'evening',
            'apigenin': 'evening',
            'magnesium_l_threonate': 'evening',

            // Default: morning for unspecified supplements
            '_default': 'morning'
        };

        // Default units for supplements (used when dose is just a number)
        const SUPPLEMENT_UNITS = {
            'vitamin_d3': 'IU',
            'vitamin_d': 'IU',
            'fish_oil': 'mg',
            'omega_3': 'mg',
            'magnesium_glycinate': 'mg',
            'magnesium': 'mg',
            'magnesium_l_threonate': 'mg',
            'glycine': 'g',
            'creatine': 'g',
            'l_theanine': 'mg',
            'ashwagandha': 'mg',
            'melatonin': 'mg',
            'zinc': 'mg',
            'rhodiola': 'mg',
            'lions_mane': 'mg',
            'cordyceps': 'mg',
            'coq10': 'mg',
            'alpha_lipoic_acid': 'mg',
            'gaba': 'mg',
            'valerian': 'mg',
            'apigenin': 'mg',
            'vitamin_b12': 'mcg',
            'vitamin_b_complex': '',
            'iron': 'mg',
            'caffeine': 'mg'
        };

        // Format dose with proper units
        function formatDoseWithUnit(dose, suppId) {
            if (!dose) return null;
            const doseStr = String(dose).trim();

            // If already has a unit (letters at end), return as-is
            if (/[a-zA-Z]/.test(doseStr)) {
                return doseStr;
            }

            // Add the appropriate unit
            const unit = SUPPLEMENT_UNITS[suppId] || 'mg';
            return unit ? `${doseStr}${unit}` : doseStr;
        }

        // Dynamic dose adjustments based on health metrics
        const DOSE_ADJUSTMENTS = {
            'magnesium_glycinate': {
                default: '400mg',
                poor_sleep: '500mg',
                good_sleep: '300mg'
            },
            'glycine': {
                default: '3g',
                poor_sleep: '4g',
                good_sleep: '2g'
            },
            'l_theanine': {
                default: '200mg',
                high_stress: '300mg',
                low_stress: '100mg'
            },
            'ashwagandha': {
                default: '300mg',
                high_stress: '600mg',
                low_stress: '300mg'
            },
            'melatonin': {
                default: '0.5mg',
                poor_sleep: '1mg',
                good_sleep: '0.3mg'
            },
            'vitamin_d3': { default: '2000 IU' },
            'vitamin_d': { default: '2000 IU' },
            'fish_oil': { default: '2g' },
            'omega_3': { default: '2g' },
            'creatine': { default: '5g' },
            'zinc': { default: '15mg' },
            'magnesium': { default: '400mg' },
            'magnesium_l_threonate': { default: '2g' },
            'rhodiola': { default: '400mg' },
            'lions_mane': { default: '1g' },
            'cordyceps': { default: '1g' },
            'coq10': { default: '100mg' },
            'alpha_lipoic_acid': { default: '600mg' },
            'gaba': { default: '500mg' },
            'valerian': { default: '500mg' },
            'apigenin': { default: '50mg' },
            'vitamin_b12': { default: '1000mcg' },
            'vitamin_b_complex': { default: '1 capsule' },
            'iron': { default: '18mg' },
            'caffeine': { default: '100mg' }
        };

        // Supplement mechanisms - explains WHY each supplement works
        const SUPPLEMENT_MECHANISMS = {
            'magnesium_glycinate': 'Glycine crosses the blood-brain barrier, promoting GABA activity for deeper sleep. Magnesium relaxes muscles and calms the nervous system.',
            'magnesium': 'Regulates neurotransmitters and melatonin production. Deficiency is linked to poor sleep quality.',
            'glycine': 'Acts on NMDA receptors to lower core body temperature, a key trigger for sleep onset.',
            'vitamin_d3': 'Regulates circadian rhythm genes and supports immune function. Most people are deficient, especially in winter.',
            'vitamin_d': 'Supports calcium absorption and immune function. Low levels correlate with poor sleep and mood.',
            'fish_oil': 'EPA/DHA reduce inflammation markers and support brain cell membrane fluidity, improving neural signaling.',
            'omega_3': 'Essential fatty acids that reduce systemic inflammation and support cardiovascular and cognitive function.',
            'vitamin_b12': 'Critical for red blood cell formation and neurological function. Deficiency causes fatigue and brain fog.',
            'l_theanine': 'Promotes alpha brain waves associated with calm alertness. Increases GABA, serotonin, and dopamine.',
            'ashwagandha': 'Adaptogen that reduces cortisol levels by up to 30%. Supports HPA axis recovery from chronic stress.',
            'creatine': 'Increases phosphocreatine stores in muscles and brain. Supports ATP regeneration for power output and cognitive function.',
            'coq10': 'Essential for mitochondrial energy production. Levels decline with age and statin use.',
            'zinc': 'Cofactor for 300+ enzymes. Supports immune function and testosterone production. Best absorbed at night.',
            'iron': 'Carries oxygen in hemoglobin. Deficiency causes fatigue. Take with vitamin C for better absorption.',
            'melatonin': 'Directly signals sleep onset to the brain. Best for jet lag and shift work, not long-term use.',
            'rhodiola': 'Adaptogen that increases stress resistance and reduces mental fatigue by modulating cortisol.',
            'caffeine': 'Blocks adenosine receptors, reducing perceived fatigue. Half-life of 5-6 hours.',
            'lions_mane': 'Stimulates nerve growth factor (NGF) production, supporting neuroplasticity and cognitive function.',
            'cordyceps': 'Increases ATP production and oxygen utilization. Traditionally used for endurance and vitality.',
        };

        // Supplements with measurable health metrics - show charts for these
        const MEASURABLE_SUPPLEMENTS = {
            'magnesium_glycinate': {
                metrics: ['sleep_score', 'deep_sleep_pct'],
                primary: 'sleep_score',
                label: 'Sleep & relaxation',
                color: '#8B5CF6'
            },
            'magnesium': {
                metrics: ['sleep_score', 'hrv_score'],
                primary: 'sleep_score',
                label: 'Sleep & relaxation',
                color: '#8B5CF6'
            },
            'glycine': {
                metrics: ['sleep_score', 'deep_sleep_pct'],
                primary: 'sleep_score',
                label: 'Sleep quality',
                color: '#8B5CF6'
            },
            'ashwagandha': {
                metrics: ['hrv_score', 'recovery_score'],
                primary: 'hrv_score',
                label: 'Stress & HRV',
                color: '#22C55E'
            },
            'l_theanine': {
                metrics: ['hrv_score', 'sleep_score'],
                primary: 'hrv_score',
                label: 'Calm & focus',
                color: '#22C55E'
            },
            'melatonin': {
                metrics: ['sleep_score'],
                primary: 'sleep_score',
                label: 'Sleep onset',
                color: '#8B5CF6'
            },
            'apigenin': {
                metrics: ['sleep_score'],
                primary: 'sleep_score',
                label: 'Sleep quality',
                color: '#8B5CF6'
            },
            'rhodiola': {
                metrics: ['recovery_score', 'hrv_score'],
                primary: 'recovery_score',
                label: 'Energy & recovery',
                color: '#F59E0B'
            },
            'gaba': {
                metrics: ['sleep_score', 'hrv_score'],
                primary: 'sleep_score',
                label: 'Relaxation',
                color: '#8B5CF6'
            }
        };

        // Helper to check if supplement has measurable metrics
        function isMeasurableSupplement(supplementId) {
            const id = (supplementId || '').toLowerCase().replace(/-/g, '_');
            return MEASURABLE_SUPPLEMENTS.hasOwnProperty(id);
        }

        // Format metric name for display
        function formatMetricName(metric) {
            const names = {
                'sleep_score': 'Sleep',
                'hrv_score': 'HRV',
                'recovery_score': 'Recovery',
                'deep_sleep_pct': 'Deep Sleep',
                'resting_hr': 'Resting HR'
            };
            return names[metric] || metric.replace(/_/g, ' ');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check for Oura OAuth callback
            checkOuraCallback();

            if (currentUserId) {
                loadUserAndShow();
            }
            updateDateDisplay();
            updateTimeButtons();
        });

        // Check Oura OAuth callback from URL params
        function checkOuraCallback() {
            const params = new URLSearchParams(window.location.search);
            const wasOnboarding = localStorage.getItem('onboardingInProgress') === 'true';

            console.log('checkOuraCallback - URL params:', window.location.search);
            console.log('checkOuraCallback - wasOnboarding:', wasOnboarding);

            if (params.get('oura_connected') === 'true') {
                showStatus('Oura Ring connected successfully!', 'success');
                // Clean URL
                window.history.replaceState({}, document.title, '/');

                // Resume onboarding if it was in progress
                if (wasOnboarding) {
                    console.log('Resuming onboarding after successful Oura connect');
                    resumeOnboardingAfterOAuth(true);
                } else {
                    console.log('Not in onboarding, showing dashboard');
                }
            } else if (params.get('oura_error')) {
                showStatus('Failed to connect Oura: ' + params.get('oura_error'), 'error');
                window.history.replaceState({}, document.title, '/');

                // Resume onboarding even on error (let user skip Oura)
                if (wasOnboarding) {
                    console.log('Resuming onboarding after Oura error');
                    resumeOnboardingAfterOAuth(false);
                }
            }
        }

        // Resume onboarding after Oura OAuth redirect
        function resumeOnboardingAfterOAuth(ouraConnectedStatus) {
            console.log('Resuming onboarding after OAuth, connected:', ouraConnectedStatus);

            // Restore saved onboarding data
            const savedData = localStorage.getItem('onboardingData');
            const savedStep = localStorage.getItem('onboardingStep');

            if (savedData) {
                try {
                    onboardingData = JSON.parse(savedData);
                } catch (e) {
                    console.error('Failed to parse saved onboarding data');
                    // Reset to defaults if parse fails
                    onboardingData = {
                        age: null, sex: null, height_feet: null, height_inches: null, weight_lbs: null,
                        region: null, activity_level: null, work_environment: null, diet_type: null,
                        chronotype: null, ouraConnected: false, selectedSupplements: [], goals: []
                    };
                }
            }

            // Mark Oura as connected in onboarding data
            onboardingData.ouraConnected = ouraConnectedStatus;

            // Clean up localStorage
            localStorage.removeItem('onboardingData');
            localStorage.removeItem('onboardingStep');
            // Keep onboardingInProgress until completion

            // Show onboarding modal and go to the right step
            const modal = document.getElementById('onboarding-modal');
            if (modal) {
                modal.classList.remove('hidden');
                lastRenderedStep = 0; // Reset to ensure animation plays
                const resumeStep = parseInt(savedStep) || 5;
                console.log('Rendering onboarding step:', resumeStep);
                renderOnboardingStep(resumeStep);
            } else {
                console.error('Onboarding modal not found');
            }
        }

        // Status messages
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 4000);
        }

        // ========== OURA INTEGRATION ==========

        // Connect Oura - redirect to OAuth
        function connectOura() {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }
            // Redirect to Oura OAuth
            window.location.href = `/api/oura/auth?user_id=${currentUserId}`;
        }

        // Check Oura connection status
        async function checkOuraStatus() {
            console.log('[Oura] checkOuraStatus called');
            console.log('[Oura] currentUserId:', currentUserId);
            console.log('[Oura] analyticsData:', analyticsData);
            console.log('[Oura] analyticsData?.health_data:', analyticsData?.health_data);

            if (!currentUserId) {
                console.log('[Oura] No currentUserId, returning');
                return;
            }

            const card = document.getElementById('oura-card');
            const loading = document.getElementById('oura-loading');
            const notConnected = document.getElementById('oura-not-connected');
            const connected = document.getElementById('oura-connected');
            const status = document.getElementById('oura-status');
            const statusText = document.getElementById('oura-status-text');

            // Helper to show connected state
            const showConnected = (syncing = false) => {
                console.log('[Oura] showConnected called, syncing:', syncing);
                ouraConnected = true;
                loading.classList.add('hidden');
                status.className = 'oura-status connected';
                statusText.textContent = syncing ? 'Connected' : 'Connected';
                notConnected.classList.add('hidden');
                connected.classList.remove('hidden');
                updateAISubtitle();
                updateProgressiveDisclosure();
            };

            // Helper to show not connected state
            const showNotConnected = () => {
                console.log('[Oura] showNotConnected called');
                ouraConnected = false;
                loading.classList.add('hidden');
                status.className = 'oura-status disconnected';
                statusText.textContent = 'Not connected';
                notConnected.classList.remove('hidden');
                connected.classList.add('hidden');
                updateAISubtitle();
                updateProgressiveDisclosure();
            };

            // Check for cached Oura data FIRST (instant UI response)
            const healthData = analyticsData?.health_data || [];
            console.log('[Oura] healthData length:', healthData.length);
            console.log('[Oura] healthData sources:', healthData.map(h => h.source));
            const hasOuraData = healthData.some(h => h.source === 'oura');
            console.log('[Oura] hasOuraData:', hasOuraData);

            if (hasOuraData) {
                // We have cached data - show connected immediately
                console.log('[Oura] Found cached Oura data, showing connected');
                showConnected(false);
                // Update metrics display
                updateOuraMetricsForSelectedDate();
                // Then try to sync fresh data in the background
                fetchOuraHistory().catch(e => console.log('Background sync failed:', e));
                return;
            }

            // No cached data - show loading and check API
            console.log('[Oura] No cached data, checking API');
            loading.classList.remove('hidden');
            notConnected.classList.add('hidden');
            connected.classList.add('hidden');

            try {
                const res = await fetch(`/integrations/${currentUserId}/oura/status`);

                if (!res.ok) {
                    showNotConnected();
                    return;
                }

                const data = await res.json();

                if (data.connected) {
                    showConnected(true);
                    // Fetch latest data
                    await fetchOuraHistory();
                } else {
                    showNotConnected();
                }
            } catch (e) {
                console.error('Error checking Oura status:', e);
                showNotConnected();
            }
        }

        // Fetch Oura history data and refresh display
        async function fetchOuraHistory() {
            if (!currentUserId) return;

            try {
                // Sync latest 7 days of data to the database
                const res = await fetch(`/integrations/${currentUserId}/oura/history?days=7`);
                if (res.ok) {
                    console.log('Oura history synced');
                    // Reload analytics data to get fresh Oura metrics
                    const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                    if (analyticsRes.ok) {
                        analyticsData = await analyticsRes.json();
                        // Update display with fresh data
                        updateOuraMetricsForSelectedDate();
                        loadTodaysStack();
                    }
                }
            } catch (e) {
                console.error('Error fetching Oura data:', e);
            }
        }

        // Update AI subtitle based on Oura status
        function updateAISubtitle() {
            const subtitle = document.getElementById('ai-subtitle');
            if (subtitle) {
                subtitle.textContent = ouraConnected ? 'Powered by your Oura Ring data' : 'Connect Oura for personalized insights';
            }
        }

        // Update Oura metrics display
        function updateOuraMetrics(data) {
            const sleepEl = document.getElementById('oura-sleep');
            const hrvEl = document.getElementById('oura-hrv');
            const recoveryEl = document.getElementById('oura-recovery');

            // Sleep score
            if (data.sleep_score != null) {
                sleepEl.textContent = Math.round(data.sleep_score);
                sleepEl.className = 'oura-metric-value ' + getScoreClass(data.sleep_score);
            } else {
                sleepEl.textContent = '--';
                sleepEl.className = 'oura-metric-value';
            }

            // HRV score
            if (data.hrv_score != null) {
                hrvEl.textContent = Math.round(data.hrv_score);
                hrvEl.className = 'oura-metric-value ' + getScoreClass(data.hrv_score);
            } else {
                hrvEl.textContent = '--';
                hrvEl.className = 'oura-metric-value';
            }

            // Recovery score
            if (data.recovery_score != null) {
                recoveryEl.textContent = Math.round(data.recovery_score);
                recoveryEl.className = 'oura-metric-value ' + getScoreClass(data.recovery_score);
            } else {
                recoveryEl.textContent = '--';
                recoveryEl.className = 'oura-metric-value';
            }

            // Update expanded details
            updateOuraDetails(data);
        }

        // Update Oura metrics for the currently selected date
        // Note: Oura records sleep data under the date you WAKE UP,
        // so today's data = last night's sleep
        function updateOuraMetricsForSelectedDate() {
            const dateLabel = document.getElementById('oura-date-label');
            if (!dateLabel) return;
            const selectedDateStr = getLocalDateString(currentDate);

            // Check if today or future
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selected = new Date(currentDate);
            selected.setHours(0, 0, 0, 0);
            const isToday = today.getTime() === selected.getTime();
            const isFuture = selected.getTime() > today.getTime();

            // Handle future dates
            if (isFuture) {
                updateOuraMetrics({ sleep_score: null, hrv_score: null, recovery_score: null });
                const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
                dateLabel.textContent = currentDate.toLocaleDateString('en-US', dateOptions) + ' (future)';
                return;
            }

            // Find health data for this date from analyticsData
            const healthData = analyticsData?.health_data || [];
            let dayData = healthData.find(h => h.date === selectedDateStr);

            // If viewing today and no data for today, show most recent data (last night's sleep)
            if (isToday && !dayData && healthData.length > 0) {
                // Sort by date descending and get most recent
                const sorted = [...healthData].sort((a, b) => b.date.localeCompare(a.date));
                dayData = sorted[0];
            }

            if (dayData) {
                updateOuraMetrics(dayData);
                generateHealthInsights(dayData);  // Generate intelligent insights
                if (isToday) {
                    dateLabel.textContent = "Last night's sleep";
                } else {
                    const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
                    dateLabel.textContent = currentDate.toLocaleDateString('en-US', dateOptions);
                }
            } else {
                // No data for this date
                updateOuraMetrics({ sleep_score: null, hrv_score: null, recovery_score: null });
                generateHealthInsights(null);  // Clear insights
                if (isToday) {
                    dateLabel.textContent = "No sleep data yet";
                } else {
                    const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
                    dateLabel.textContent = currentDate.toLocaleDateString('en-US', dateOptions) + ' (no data)';
                }
            }
        }

        // Get local date string in YYYY-MM-DD format (avoids timezone issues with toISOString)
        function getLocalDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Get CSS class based on score
        function getScoreClass(score) {
            if (score >= 70) return 'good';
            if (score >= 50) return 'fair';
            return 'poor';
        }

        // Generate health insights based on current health data
        function generateHealthInsights(data) {
            const container = document.getElementById('health-insights');
            if (!container) return;

            // Clear previous insights
            container.innerHTML = '';
            container.classList.remove('visible');

            if (!data) return;

            const insights = [];

            // Temperature-based immune alerts (HIGHEST PRIORITY)
            if (data.temperature_deviation != null && data.temperature_deviation > 0.5) {
                const severity = data.temperature_deviation > 1.0 ? 'crisis' : 'alert';
                insights.push({
                    type: 'immune',
                    priority: severity === 'crisis' ? 100 : 90,
                    title: severity === 'crisis' ? 'Immune System Alert' : 'Immune Support Activated',
                    description: `Your body temperature is ${data.temperature_deviation.toFixed(1)}C above baseline. ${severity === 'crisis' ? 'This indicates a strong immune response.' : 'Your immune system may be responding to something.'}`,
                    actions: [
                        { type: 'add', text: '+ Elderberry' },
                        { type: 'add', text: '+ Vitamin C' },
                        { type: 'add', text: '+ Zinc' },
                        { type: 'hold', text: 'Hold Caffeine' }
                    ],
                    research: {
                        text: 'Meta-analysis: Elderberry reduces respiratory symptoms',
                        url: 'https://pubmed.ncbi.nlm.nih.gov/30670267'
                    },
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#FB923C" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>'
                });
            }

            // HRV-based stress alerts
            const hrvBaseline = analyticsData?.user_baseline?.hrv?.mean;
            if (data.hrv_score != null) {
                const threshold = hrvBaseline ? hrvBaseline * 0.75 : 40;
                const isStressed = hrvBaseline
                    ? data.hrv_score < hrvBaseline * 0.75
                    : data.hrv_score < 40;

                if (isStressed) {
                    const percentBelow = hrvBaseline
                        ? Math.round((1 - data.hrv_score / hrvBaseline) * 100)
                        : null;
                    insights.push({
                        type: 'stress',
                        priority: 80,
                        title: 'Stress Recovery Mode',
                        description: percentBelow
                            ? `Your HRV is ${percentBelow}% below your baseline. This indicates elevated stress.`
                            : `Your HRV of ${data.hrv_score}ms suggests elevated stress levels.`,
                        actions: [
                            { type: 'add', text: '+ Ashwagandha' },
                            { type: 'add', text: '+ L-Theanine' },
                            { type: 'reduce', text: 'Reduce Caffeine' }
                        ],
                        research: {
                            text: 'Ashwagandha significantly reduces cortisol',
                            url: 'https://pubmed.ncbi.nlm.nih.gov/28471731'
                        },
                        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#EAB308" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>'
                    });
                }
            }

            // Sleep-based alerts
            if (data.sleep_score != null && data.sleep_score < 60) {
                insights.push({
                    type: 'sleep',
                    priority: 70,
                    title: 'Sleep Recovery Support',
                    description: `Sleep score of ${data.sleep_score} is below optimal. Prioritizing sleep support today.`,
                    actions: [
                        { type: 'add', text: '+ Magnesium' },
                        { type: 'add', text: '+ Apigenin (PM)' },
                        { type: 'reduce', text: 'Limit Caffeine' }
                    ],
                    research: {
                        text: 'Magnesium improves sleep quality',
                        url: 'https://pubmed.ncbi.nlm.nih.gov/34883514'
                    },
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#6366F1" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>'
                });
            }

            // Recovery-based alerts
            if (data.recovery_score != null && data.recovery_score < 50) {
                insights.push({
                    type: 'recovery',
                    priority: 60,
                    title: 'Recovery Focus',
                    description: `Recovery score of ${data.recovery_score} suggests your body needs extra support today.`,
                    actions: [
                        { type: 'add', text: '+ Omega-3' },
                        { type: 'add', text: '+ Magnesium' }
                    ],
                    research: {
                        text: 'Omega-3 reduces inflammation and supports recovery',
                        url: 'https://pubmed.ncbi.nlm.nih.gov/17277604'
                    },
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>'
                });
            }

            // Compound condition: Overtraining syndrome
            const hasLowHRV = data.hrv_score != null && (hrvBaseline ? data.hrv_score < hrvBaseline * 0.8 : data.hrv_score < 45);
            const hasPoorSleep = data.sleep_score != null && data.sleep_score < 60;
            const hasPoorRecovery = data.recovery_score != null && data.recovery_score < 50;
            const overtrained = [hasLowHRV, hasPoorSleep, hasPoorRecovery].filter(Boolean).length >= 2;

            if (overtrained) {
                // Replace individual alerts with compound alert
                insights.length = 0; // Clear other insights
                insights.push({
                    type: 'stress',
                    priority: 95,
                    title: 'Accumulated Fatigue Detected',
                    description: 'Multiple metrics indicate your body needs rest. Consider a recovery day.',
                    actions: [
                        { type: 'hold', text: 'Hold Caffeine' },
                        { type: 'hold', text: 'Hold Creatine' },
                        { type: 'add', text: '+ Ashwagandha' },
                        { type: 'add', text: '+ Omega-3' }
                    ],
                    research: {
                        text: 'Recovery protocols for accumulated fatigue',
                        url: 'https://pubmed.ncbi.nlm.nih.gov/28471731'
                    },
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                });
            }

            // Sort by priority and limit to top 2 insights
            insights.sort((a, b) => b.priority - a.priority);
            const topInsights = insights.slice(0, 2);

            // Render insights
            if (topInsights.length > 0) {
                container.classList.add('visible');
                container.innerHTML = topInsights.map(insight => `
                    <div class="health-insight alert-${insight.type}">
                        <div class="insight-header">
                            <div class="insight-icon">${insight.icon}</div>
                            <div class="insight-title">${insight.title}</div>
                        </div>
                        <div class="insight-description">${insight.description}</div>
                        <div class="insight-actions">
                            ${insight.actions.map(a => `
                                <span class="insight-action ${a.type}">${a.text}</span>
                            `).join('')}
                        </div>
                        ${insight.research ? `
                            <div class="insight-research">
                                <a href="${insight.research.url}" target="_blank" class="insight-research-link">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                    ${insight.research.text}
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }
        }

        // Toggle Oura details visibility
        function toggleOuraDetails() {
            const toggle = document.getElementById('oura-details-toggle');
            const sections = document.getElementById('oura-details-sections');
            const isExpanded = sections.classList.contains('expanded');

            if (isExpanded) {
                sections.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.querySelector('span').textContent = 'View Details';
            } else {
                sections.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.querySelector('span').textContent = 'Hide Details';
            }
        }

        // Update expanded Oura details
        function updateOuraDetails(data) {
            // Helper to set element text or '--'
            const setText = (id, value, suffix = '') => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = value != null ? value + suffix : '--';
                }
            };

            // Helper to format duration in minutes to "Xh Ym"
            const formatDuration = (seconds) => {
                if (seconds == null) return '--';
                const hours = Math.floor(seconds / 3600);
                const mins = Math.round((seconds % 3600) / 60);
                if (hours > 0) {
                    return `${hours}h ${mins}m`;
                }
                return `${mins}m`;
            };

            // Helper to format time from ISO string
            const formatTime = (isoString) => {
                if (!isoString) return '--';
                try {
                    const date = new Date(isoString);
                    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                } catch (e) {
                    return '--';
                }
            };

            // Sleep Details
            setText('oura-sleep-duration', data.sleep_duration_hrs ? data.sleep_duration_hrs.toFixed(1) + 'h' : null);
            setText('oura-sleep-efficiency', data.sleep_efficiency, '%');
            setText('oura-bedtime', formatTime(data.bedtime));
            setText('oura-waketime', formatTime(data.wake_time));

            // Calculate sleep stage percentages from durations
            const totalSleep = (data.deep_sleep_duration || 0) + (data.rem_sleep_duration || 0) +
                              (data.light_sleep_duration || 0) + (data.awake_duration || 0);

            if (totalSleep > 0) {
                const deepPct = Math.round((data.deep_sleep_duration || 0) / totalSleep * 100);
                const remPct = Math.round((data.rem_sleep_duration || 0) / totalSleep * 100);
                const lightPct = Math.round((data.light_sleep_duration || 0) / totalSleep * 100);
                const awakePct = Math.round((data.awake_duration || 0) / totalSleep * 100);

                setText('oura-deep-pct', deepPct + '%');
                setText('oura-rem-pct', remPct + '%');
                setText('oura-light-pct', lightPct + '%');
                setText('oura-awake-pct', awakePct + '%');

                // Update sleep bar
                const sleepBar = document.getElementById('oura-sleep-bar');
                if (sleepBar) {
                    sleepBar.innerHTML = `
                        <div class="sleep-bar-segment sleep-bar-deep" style="width: ${deepPct}%"></div>
                        <div class="sleep-bar-segment sleep-bar-rem" style="width: ${remPct}%"></div>
                        <div class="sleep-bar-segment sleep-bar-light" style="width: ${lightPct}%"></div>
                        <div class="sleep-bar-segment sleep-bar-awake" style="width: ${awakePct}%"></div>
                    `;
                }
            } else {
                setText('oura-deep-pct', '--');
                setText('oura-rem-pct', '--');
                setText('oura-light-pct', '--');
                setText('oura-awake-pct', '--');
                const sleepBar = document.getElementById('oura-sleep-bar');
                if (sleepBar) sleepBar.innerHTML = '';
            }

            // Heart Rate
            setText('oura-resting-hr', data.resting_hr, ' bpm');
            setText('oura-lowest-hr', data.lowest_hr, ' bpm');
            setText('oura-avg-hr', data.average_hr_sleep ? Math.round(data.average_hr_sleep) + ' bpm' : null);
            setText('oura-vo2max', data.vo2_max ? data.vo2_max.toFixed(1) : null);

            // Activity
            setText('oura-steps', data.steps ? data.steps.toLocaleString() : null);
            setText('oura-active-cal', data.active_calories ? data.active_calories.toLocaleString() : null);
            setText('oura-activity-score', data.activity_score);
            setText('oura-active-time', data.active_time ? Math.round(data.active_time / 60) + 'm' : null);

            // Body & Wellness
            setText('oura-spo2', data.spo2_average ? data.spo2_average.toFixed(1) + '%' : null);
            setText('oura-breathing', data.breathing_average ? data.breathing_average.toFixed(1) + '/min' : null);

            if (data.temperature_deviation != null) {
                const sign = data.temperature_deviation >= 0 ? '+' : '';
                setText('oura-temp', sign + data.temperature_deviation.toFixed(2) + '');
            } else {
                setText('oura-temp', null);
            }

            // Stress level formatting
            if (data.stress_level) {
                const stressColors = { low: '#22C55E', medium: '#F59E0B', high: '#EF4444' };
                const stressEl = document.getElementById('oura-stress');
                if (stressEl) {
                    stressEl.textContent = data.stress_level.charAt(0).toUpperCase() + data.stress_level.slice(1);
                    stressEl.style.color = stressColors[data.stress_level] || '#E8E8E8';
                }
            } else {
                setText('oura-stress', null);
                const stressEl = document.getElementById('oura-stress');
                if (stressEl) stressEl.style.color = '';
            }

            // Workout section (show only if there's workout data)
            const workoutSection = document.getElementById('oura-workout-section');
            if (data.workout_type) {
                workoutSection.classList.remove('hidden');
                setText('oura-workout-type', data.workout_type);
                setText('oura-workout-duration', data.workout_duration ? data.workout_duration + 'm' : null);
                setText('oura-workout-calories', data.workout_calories);
                setText('oura-workout-intensity', data.workout_intensity ?
                    data.workout_intensity.charAt(0).toUpperCase() + data.workout_intensity.slice(1) : null);
            } else {
                workoutSection.classList.add('hidden');
            }
        }

        // Sync Oura data (fetch last 7 days to ensure we get today's data)
        async function syncOuraData() {
            if (!currentUserId) return;

            const btn = document.querySelector('.oura-sync-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Syncing...';
            btn.disabled = true;

            try {
                // Use history endpoint with 7 days to properly store date-specific data
                const res = await fetch(`/integrations/${currentUserId}/oura/history?days=7`);

                if (res.ok) {
                    const result = await res.json();
                    // Refresh analytics data to get new health scores
                    const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                    if (analyticsRes.ok) {
                        analyticsData = await analyticsRes.json();
                        updateOuraMetricsForSelectedDate();
                    }
                    const added = result.records_added || 0;
                    showStatus(added > 0 ? `Synced ${added} day(s) of data!` : 'Data is up to date!', 'success');
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Sync failed', 'error');
                }
            } catch (e) {
                showStatus('Error syncing: ' + e.message, 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Sync full Oura history (up to 365 days)
        async function syncOuraFullHistory() {
            if (!currentUserId) return;

            if (!confirm('Sync your full Oura history? This may take a moment and will fetch up to 12 months of data.')) {
                return;
            }

            const btns = document.querySelectorAll('.oura-sync-btn');
            btns.forEach(btn => {
                btn.disabled = true;
            });
            showStatus('Syncing full history... This may take a moment.', 'success');

            try {
                // Fetch 365 days of history
                const res = await fetch(`/integrations/${currentUserId}/oura/history?days=365`);

                if (res.ok) {
                    const data = await res.json();
                    showStatus(`Full history synced! Added ${data.records_added || 0} days of data.`, 'success');

                    // Refresh analytics data and update Oura display
                    const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                    if (analyticsRes.ok) {
                        analyticsData = await analyticsRes.json();
                        updateOuraMetricsForSelectedDate();
                        // Also refresh chart if on analytics tab
                        if (document.getElementById('analytics-section').classList.contains('active')) {
                            renderHealthChart();
                        }
                    }
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Failed to sync full history', 'error');
                }
            } catch (e) {
                showStatus('Error syncing history: ' + e.message, 'error');
            } finally {
                btns.forEach(btn => {
                    btn.disabled = false;
                });
            }
        }

        // Disconnect Oura
        async function disconnectOura() {
            if (!currentUserId) return;

            if (!confirm('Disconnect your Oura Ring?')) return;

            try {
                const res = await fetch(`/integrations/${currentUserId}/oura`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    ouraConnected = false;
                    ouraData = null;

                    const status = document.getElementById('oura-status');
                    const statusText = document.getElementById('oura-status-text');
                    const notConnected = document.getElementById('oura-not-connected');
                    const connected = document.getElementById('oura-connected');

                    status.className = 'oura-status disconnected';
                    statusText.textContent = 'Not connected';
                    notConnected.classList.remove('hidden');
                    connected.classList.add('hidden');
                    updateAISubtitle();

                    showStatus('Oura Ring disconnected', 'success');
                }
            } catch (e) {
                showStatus('Error disconnecting: ' + e.message, 'error');
            }
        }

        // ========== END OURA INTEGRATION ==========

        // Toggle sign in form
        function toggleSignIn(e) {
            e.preventDefault();
            document.getElementById('signin-form').classList.toggle('hidden');
        }

        // Create account
        async function createAccount() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();

            if (!name || !email) {
                showStatus('Please enter your name and email', 'error');
                return;
            }

            try {
                const res = await fetch('/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });

                if (res.ok) {
                    const user = await res.json();
                    currentUserId = user.id;
                    localStorage.setItem('userId', user.id);
                    showLoggedIn(user);
                    // Show onboarding to collect profile data
                    showOnboarding();
                } else {
                    // Handle both JSON and plain text error responses
                    const contentType = res.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const err = await res.json();
                        showStatus(err.detail || 'Error creating account', 'error');
                    } else {
                        const text = await res.text();
                        showStatus(text || 'Error creating account. Please try again.', 'error');
                    }
                }
            } catch (e) {
                showStatus('Unable to connect. Please check your internet and try again.', 'error');
            }
        }

        // ==================== ONBOARDING ====================

        let onboardingStep = 1;
        const ONBOARDING_TOTAL_STEPS = 6; // About You, Lifestyle, Sleep, Oura, Supplements, Goal
        let onboardingData = {
            // Profile - Step 1: About You
            age: null,
            sex: null,
            height_feet: null,
            height_inches: null,
            weight_lbs: null,
            // Profile - Step 2: Lifestyle
            region: null,
            activity_level: null,
            work_environment: null,
            diet_type: null,
            // Profile - Step 3: Sleep
            chronotype: null,
            // Step 4: Oura
            ouraConnected: false,
            // Step 5: Supplements
            selectedSupplements: [], // { id, name, dosage, duration }
            // Step 6: Goals (multi-select)
            goals: []
        };

        // SVG icons for supplements (clean, professional look)
        const SUPPLEMENT_ICONS = {
            'vitamin_d3': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>',
            'fish_oil': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="12" rx="8" ry="5"/><path d="M20 12c2 0 3-1 3-2s-1-2-3-2m0 8c2 0 3 1 3 2s-1 2-3 2"/></svg>',
            'omega3': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="12" rx="8" ry="5"/><path d="M20 12c2 0 3-1 3-2s-1-2-3-2"/></svg>',
            'magnesium': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 8h10M7 12h10M7 16h6"/></svg>',
            'magnesium_glycinate': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 8h10M7 12h10M7 16h6"/></svg>',
            'vitamin_b12': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>',
            'b_complex': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M9 8h4a2 2 0 010 4H9m0-4v8m0-4h4a2 2 0 010 4H9"/></svg>',
            'ashwagandha': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22V8M7 12c-2-2-2-5 0-7 2-2 5-2 7 0m-7 7c-2 2-2 5 0 7m7-7c2-2 2-5 0-7m0 7c2 2 2 5 0 7"/></svg>',
            'zinc': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
            'creatine': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5L17.5 17.5M6.5 17.5L17.5 6.5"/><circle cx="12" cy="12" r="9"/></svg>',
            'protein_powder': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2h8l2 4v14a2 2 0 01-2 2H8a2 2 0 01-2-2V6l2-4z"/><path d="M6 6h12"/></svg>',
            'melatonin': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>',
            'vitamin_c': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M15 9a3 3 0 00-6 0v6a3 3 0 006 0"/></svg>',
            'iron': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="3"/></svg>',
            'calcium': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 002 2h8a2 2 0 002-2V4z"/><path d="M10 8h4M10 12h4M10 16h2"/></svg>',
            'probiotics': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="4"/><circle cx="12" cy="12" r="1"/></svg>',
            'collagen': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15 8l6 1-4.5 4 1.5 6-6-3-6 3 1.5-6L3 9l6-1 3-6z"/></svg>',
            'turmeric': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M8 12h8M12 8v8"/></svg>',
            'l_theanine': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg>',
            'caffeine': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/></svg>',
            'multivitamin': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="12" height="16" rx="6"/><path d="M6 12h12"/></svg>',
            'electrolytes': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
            'lions_mane': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="6"/><path d="M12 16v6M8 18l4-2 4 2"/></svg>',
            'rhodiola': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22V8M7 12c-2-2-2-5 0-7 2-2 5-2 7 0m0 0c2 2 2 5 0 7"/></svg>',
            'gaba': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01"/></svg>',
            'glycine': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>',
            'coq10': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
            'elderberry': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M12 12v10M8 16l4-4 4 4"/></svg>',
            'default': '<svg class="supp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2.4 7.4H22l-6 4.6 2.3 7L12 17l-6.3 4 2.3-7-6-4.6h7.6L12 2z"/></svg>'
        };

        function getSupplementIcon(id) {
            return SUPPLEMENT_ICONS[id] || SUPPLEMENT_ICONS['default'];
        }

        // Helper to escape HTML attributes
        function escapeAttr(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        let lastRenderedStep = 0; // Track to only animate on actual step changes

        function showOnboarding() {
            document.getElementById('onboarding-modal').classList.remove('hidden');
            onboardingStep = 1;
            lastRenderedStep = 0; // Reset so first step animates
            onboardingData = {
                age: null,
                sex: null,
                height_feet: null,
                height_inches: null,
                weight_lbs: null,
                region: null,
                activity_level: null,
                work_environment: null,
                diet_type: null,
                chronotype: null,
                ouraConnected: false,
                selectedSupplements: [],
                goals: []
            };
            renderOnboardingStep(1);
        }

        function renderOnboardingStep(step, forceNoAnimation = false) {
            const isStepChange = step !== lastRenderedStep;
            lastRenderedStep = step;
            onboardingStep = step;
            updateProgressIndicator(step);
            const content = document.getElementById('onboarding-content');

            switch(step) {
                case 1:
                    content.innerHTML = getStepAboutYouHTML();
                    break;
                case 2:
                    content.innerHTML = getStepLifestyleHTML();
                    break;
                case 3:
                    content.innerHTML = getStepSleepHTML();
                    break;
                case 4:
                    content.innerHTML = getStepOuraHTML();
                    break;
                case 5:
                    content.innerHTML = getStepSupplementsHTML();
                    setTimeout(() => filterOnboardingSupplements(''), 10);
                    break;
                case 6:
                    content.innerHTML = getStepGoalHTML();
                    break;
                case 7:
                    content.innerHTML = getCompletionHTML();
                    break;
            }

            // Only add entering animation when step actually changes
            if (isStepChange && !forceNoAnimation) {
                const stepContent = content.querySelector('.onboarding-step-content');
                if (stepContent) {
                    stepContent.classList.add('entering');
                    // Remove class after animation completes
                    setTimeout(() => stepContent.classList.remove('entering'), 300);
                }
            }
        }

        function updateProgressIndicator(currentStep) {
            const progressContainer = document.querySelector('.onboarding-progress');
            if (!progressContainer) return;

            // Calculate progress percentage
            const progressPercent = ((currentStep - 1) / (ONBOARDING_TOTAL_STEPS - 1)) * 100;

            // Build progress indicator HTML with animated bar
            let progressHTML = `
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
                </div>
            `;

            for (let i = 1; i <= ONBOARDING_TOTAL_STEPS; i++) {
                const isActive = i === currentStep;
                const isCompleted = i < currentStep;
                const icon = isCompleted ? '' : i;
                progressHTML += `<div class="progress-step ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">${icon}</div>`;
            }
            progressContainer.innerHTML = progressHTML;
        }

        function nextOnboardingStep() {
            renderOnboardingStep(onboardingStep + 1);
        }

        function prevOnboardingStep() {
            if (onboardingStep > 1) {
                renderOnboardingStep(onboardingStep - 1);
            }
        }

        // Step 1: About You (age, sex, height, weight)
        let heightUnit = 'imperial'; // 'imperial' or 'metric'

        function getStepAboutYouHTML() {
            const heightDisplay = heightUnit === 'imperial'
                ? `${onboardingData.height_feet || ''}'${onboardingData.height_inches || ''}"`.replace("'\"", '')
                : onboardingData.height_cm || '';

            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <h2>About You</h2>
                    <p class="onboarding-subtitle">Help us personalize your supplement doses</p>

                    <div class="onboarding-microcopy">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                        <span>We use this to calculate safe, effective doses for your body</span>
                    </div>

                    <div class="onboarding-field" style="margin-bottom: 16px;">
                        <label>Biological sex <span class="why-ask" data-tip="Used for accurate supplement dosing">?</span></label>
                        <div class="onboarding-pill-group">
                            <button class="ob-pill ${onboardingData.sex === 'male' ? 'selected' : ''}" onclick="selectSex('male')">
                                Male ${onboardingData.sex === 'male' ? '<span class="pill-check"></span>' : ''}
                            </button>
                            <button class="ob-pill ${onboardingData.sex === 'female' ? 'selected' : ''}" onclick="selectSex('female')">
                                Female ${onboardingData.sex === 'female' ? '<span class="pill-check"></span>' : ''}
                            </button>
                            <button class="ob-pill ${onboardingData.sex === 'other' ? 'selected' : ''}" onclick="selectSex('other')">
                                Other ${onboardingData.sex === 'other' ? '<span class="pill-check"></span>' : ''}
                            </button>
                        </div>
                    </div>

                    <div class="onboarding-form-grid">
                        <div class="onboarding-field">
                            <label>Age <span class="why-ask" data-tip="Vitamin needs change with age">?</span></label>
                            <input type="number" id="ob-age" placeholder="30" min="18" max="100"
                                   value="${onboardingData.age || ''}"
                                   onchange="onboardingData.age = parseInt(this.value); markFieldComplete(this)">
                        </div>
                        <div class="onboarding-field">
                            <label>Weight <span class="why-ask" data-tip="Many doses scale with body weight">?</span></label>
                            <div class="weight-input">
                                <input type="number" id="ob-weight" placeholder="170" step="1"
                                       value="${onboardingData.weight_lbs || ''}"
                                       onchange="onboardingData.weight_lbs = parseFloat(this.value); markFieldComplete(this)">
                                <span class="weight-unit">lbs</span>
                            </div>
                        </div>
                    </div>

                    <div class="onboarding-field" style="margin-bottom: 24px;">
                        <label style="display: flex; align-items: center; justify-content: space-between;">
                            Height
                            <div class="unit-toggle">
                                <button class="${heightUnit === 'imperial' ? 'active' : ''}" onclick="toggleHeightUnit('imperial')">ft/in</button>
                                <button class="${heightUnit === 'metric' ? 'active' : ''}" onclick="toggleHeightUnit('metric')">cm</button>
                            </div>
                        </label>
                        ${heightUnit === 'imperial' ? `
                            <div class="height-inputs">
                                <input type="number" id="ob-height-ft" placeholder="5" min="3" max="8"
                                       value="${onboardingData.height_feet || ''}"
                                       onchange="onboardingData.height_feet = parseInt(this.value); markFieldComplete(this)">
                                <span class="height-unit">ft</span>
                                <input type="number" id="ob-height-in" placeholder="10" min="0" max="11"
                                       value="${onboardingData.height_inches || ''}"
                                       onchange="onboardingData.height_inches = parseInt(this.value); markFieldComplete(this)">
                                <span class="height-unit">in</span>
                            </div>
                        ` : `
                            <div class="height-combined">
                                <input type="number" id="ob-height-cm" placeholder="178" min="100" max="250"
                                       value="${onboardingData.height_cm || ''}"
                                       onchange="updateHeightFromCm(this.value); markFieldComplete(this)">
                                <span class="height-unit">cm</span>
                            </div>
                        `}
                    </div>

                    <button class="onboarding-btn primary" onclick="animateToNextStep()">
                        Continue
                    </button>
                    <button class="skip-later-btn" onclick="animateToNextStep()">
                        <span>Skip for now</span>
                        <span class="skip-subtext">You can add this later in settings</span>
                    </button>
                </div>
            `;
        }

        function selectSex(value) {
            onboardingData.sex = value;
            renderOnboardingStep(1);
        }

        function toggleHeightUnit(unit) {
            heightUnit = unit;
            renderOnboardingStep(1);
        }

        function updateHeightFromCm(cm) {
            const totalInches = Math.round(parseFloat(cm) / 2.54);
            onboardingData.height_feet = Math.floor(totalInches / 12);
            onboardingData.height_inches = totalInches % 12;
            onboardingData.height_cm = parseFloat(cm);
        }

        function markFieldComplete(input) {
            if (input.value) {
                input.classList.add('complete');
            }
        }

        function animateToNextStep() {
            // Reset lifestyle selection mode when leaving step 2
            if (onboardingStep === 2) {
                lifestyleSelectionMode = null;
            }
            const content = document.querySelector('.onboarding-step-content');
            if (content) {
                content.classList.add('exiting');
                setTimeout(() => {
                    nextOnboardingStep();
                }, 250);
            } else {
                nextOnboardingStep();
            }
        }

        function animateToPrevStep() {
            // Reset lifestyle selection mode when leaving step 2
            if (onboardingStep === 2) {
                lifestyleSelectionMode = null;
            }
            const content = document.querySelector('.onboarding-step-content');
            if (content) {
                content.style.animation = 'slideOutLeft 0.25s ease-in reverse';
                setTimeout(() => {
                    prevOnboardingStep();
                }, 200);
            } else {
                prevOnboardingStep();
            }
        }

        // Step 2: Lifestyle (region, activity, work, diet)
        let lifestyleSelectionMode = null; // null = grid view, 'region'/'activity'/'work'/'diet' = selection mode

        function getStepLifestyleHTML() {
            // If we're in selection mode, show the selection panel
            if (lifestyleSelectionMode) {
                return getLifestyleSelectionHTML(lifestyleSelectionMode);
            }

            const completedCount = [
                onboardingData.region,
                onboardingData.activity_level,
                onboardingData.work_environment,
                onboardingData.diet_type
            ].filter(Boolean).length;

            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>
                        </svg>
                    </div>
                    <h2>Your Lifestyle</h2>
                    <p class="onboarding-subtitle">Tap each card to customize your profile</p>

                    <div class="lifestyle-grid">
                        <div class="lifestyle-card ${onboardingData.region ? 'selected' : ''}" onclick="openLifestyleSelection('region')">
                            <span class="lifestyle-icon"></span>
                            <span class="lifestyle-label">Location</span>
                            <span class="lifestyle-value">${getRegionLabel(onboardingData.region) || 'Tap to select'}</span>
                        </div>
                        <div class="lifestyle-card ${onboardingData.activity_level ? 'selected' : ''}" onclick="openLifestyleSelection('activity')">
                            <span class="lifestyle-icon"></span>
                            <span class="lifestyle-label">Activity</span>
                            <span class="lifestyle-value">${getActivityLabel(onboardingData.activity_level) || 'Tap to select'}</span>
                        </div>
                        <div class="lifestyle-card ${onboardingData.work_environment ? 'selected' : ''}" onclick="openLifestyleSelection('work')">
                            <span class="lifestyle-icon"></span>
                            <span class="lifestyle-label">Work</span>
                            <span class="lifestyle-value">${getWorkLabel(onboardingData.work_environment) || 'Tap to select'}</span>
                        </div>
                        <div class="lifestyle-card ${onboardingData.diet_type ? 'selected' : ''}" onclick="openLifestyleSelection('diet')">
                            <span class="lifestyle-icon"></span>
                            <span class="lifestyle-label">Diet</span>
                            <span class="lifestyle-value">${getDietLabel(onboardingData.diet_type) || 'Tap to select'}</span>
                        </div>
                    </div>

                    <div class="onboarding-nav">
                        <button class="onboarding-btn back" onclick="animateToPrevStep()"> Back</button>
                        <button class="onboarding-btn primary" onclick="animateToNextStep()">
                            ${completedCount > 0 ? 'Continue' : 'Skip for now'}
                        </button>
                    </div>
                </div>
            `;
        }

        function getLifestyleSelectionHTML(field) {
            const options = LIFESTYLE_OPTIONS[field];
            const dataKey = field === 'activity' ? 'activity_level' : field === 'work' ? 'work_environment' : field === 'diet' ? 'diet_type' : field;
            const currentValue = onboardingData[dataKey];
            const titles = { region: 'Where do you live?', activity: 'How active are you?', work: 'What\'s your work like?', diet: 'What\'s your diet?' };
            const icons = {
                region: { northern: '', central: '', southern: '', gulf: '' },
                activity: { sedentary: '', light: '', moderate: '', active: '', athlete: '' },
                work: { office: '', remote: '', outdoor: '', shift: '' },
                diet: { omnivore: '', vegetarian: '', vegan: '' }
            };

            return `
                <div class="onboarding-step-content" style="text-align: left;">
                    <div class="lifestyle-selection-header">
                        <button onclick="closeLifestyleSelection()"></button>
                        <h3>${titles[field]}</h3>
                    </div>

                    <div class="lifestyle-selection-options">
                        ${options.map(opt => `
                            <div class="lifestyle-selection-option ${opt.value === currentValue ? 'selected' : ''}"
                                 onclick="selectLifestyleAndClose('${field}', '${opt.value}')">
                                <span class="option-icon">${icons[field][opt.value] || ''}</span>
                                <div class="option-content">
                                    <span class="option-label">${opt.label}</span>
                                    <span class="option-desc">${opt.desc}</span>
                                </div>
                                <span class="option-check"></span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        const LIFESTYLE_OPTIONS = {
            region: [
                { value: 'northern', label: 'Northern US', desc: 'Seattle, Boston, Minneapolis, Chicago' },
                { value: 'central', label: 'Central US', desc: 'NYC, Denver, SF, Philadelphia' },
                { value: 'southern', label: 'Southern US', desc: 'LA, Phoenix, Atlanta, Dallas' },
                { value: 'gulf', label: 'Gulf / Florida', desc: 'Miami, Houston, New Orleans' }
            ],
            activity: [
                { value: 'sedentary', label: 'Sedentary', desc: 'Desk job, minimal exercise' },
                { value: 'light', label: 'Lightly Active', desc: 'Exercise 1-2x per week' },
                { value: 'moderate', label: 'Moderately Active', desc: 'Exercise 3-4x per week' },
                { value: 'active', label: 'Very Active', desc: 'Exercise 5-6x per week' },
                { value: 'athlete', label: 'Athlete', desc: 'Intense training daily' }
            ],
            work: [
                { value: 'office', label: 'Office', desc: 'Indoor workplace, limited sunlight' },
                { value: 'remote', label: 'Remote / Hybrid', desc: 'Work from home' },
                { value: 'outdoor', label: 'Outdoor', desc: 'Outside most of the day' },
                { value: 'shift', label: 'Shift Work', desc: 'Irregular or night hours' }
            ],
            diet: [
                { value: 'omnivore', label: 'Omnivore', desc: 'Eat everything including meat' },
                { value: 'vegetarian', label: 'Vegetarian', desc: 'No meat, but eggs & dairy OK' },
                { value: 'vegan', label: 'Vegan', desc: 'No animal products' }
            ]
        };

        function getRegionLabel(v) { return LIFESTYLE_OPTIONS.region.find(o => o.value === v)?.label; }
        function getActivityLabel(v) { return LIFESTYLE_OPTIONS.activity.find(o => o.value === v)?.label; }
        function getWorkLabel(v) { return LIFESTYLE_OPTIONS.work.find(o => o.value === v)?.label; }
        function getDietLabel(v) { return LIFESTYLE_OPTIONS.diet.find(o => o.value === v)?.label; }

        function openLifestyleSelection(field) {
            lifestyleSelectionMode = field;
            renderOnboardingStep(2);
        }

        function closeLifestyleSelection() {
            lifestyleSelectionMode = null;
            renderOnboardingStep(2);
        }

        function selectLifestyleAndClose(field, value) {
            const dataKey = field === 'activity' ? 'activity_level' : field === 'work' ? 'work_environment' : field === 'diet' ? 'diet_type' : field;
            onboardingData[dataKey] = value;
            lifestyleSelectionMode = null;
            renderOnboardingStep(2);
        }

        // Step 3: Sleep (chronotype)
        function getStepSleepHTML() {
            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5">
                            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                        </svg>
                    </div>
                    <h2>Your Sleep Style</h2>
                    <p class="onboarding-subtitle">When do you feel most energized?</p>

                    <div class="chronotype-options">
                        <div class="chronotype-card ${onboardingData.chronotype === 'early_bird' ? 'selected' : ''}"
                             onclick="selectChronotype('early_bird')">
                            <span class="chronotype-icon"></span>
                            <div>
                                <span class="chronotype-label">Early Bird</span>
                                <span class="chronotype-desc">I'm most productive in the morning</span>
                            </div>
                        </div>
                        <div class="chronotype-card ${onboardingData.chronotype === 'night_owl' ? 'selected' : ''}"
                             onclick="selectChronotype('night_owl')">
                            <span class="chronotype-icon"></span>
                            <div>
                                <span class="chronotype-label">Night Owl</span>
                                <span class="chronotype-desc">I come alive in the evening</span>
                            </div>
                        </div>
                        <div class="chronotype-card ${onboardingData.chronotype === 'neutral' ? 'selected' : ''}"
                             onclick="selectChronotype('neutral')">
                            <span class="chronotype-icon"></span>
                            <div>
                                <span class="chronotype-label">Flexible</span>
                                <span class="chronotype-desc">I adapt to any schedule</span>
                            </div>
                        </div>
                    </div>

                    <div class="onboarding-nav">
                        <button class="onboarding-btn back" onclick="animateToPrevStep()"> Back</button>
                        <button class="onboarding-btn primary" onclick="animateToNextStep()">
                            ${onboardingData.chronotype ? 'Continue' : 'Skip for now'}
                        </button>
                    </div>
                </div>
            `;
        }

        function selectChronotype(value) {
            onboardingData.chronotype = value;
            renderOnboardingStep(3);
        }

        // Step 4: Connect Oura
        function getStepOuraHTML() {
            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5">
                            <circle cx="12" cy="12" r="9"/>
                            <circle cx="12" cy="12" r="5"/>
                            <circle cx="12" cy="12" r="1"/>
                        </svg>
                    </div>
                    <h2>Connect Oura Ring</h2>
                    <p class="onboarding-subtitle">Unlock personalized insights with your health data</p>

                    <div class="benefits-list">
                        <div class="benefit-item">
                            <span class="benefit-check"></span>
                            <span><strong>Personalized sleep recommendations</strong> based on your actual sleep scores</span>
                        </div>
                        <div class="benefit-item">
                            <span class="benefit-check"></span>
                            <span><strong>Recovery-based dosing</strong>  adjust supplements based on how rested you are</span>
                        </div>
                        <div class="benefit-item">
                            <span class="benefit-check"></span>
                            <span><strong>Track supplement impact</strong> on your HRV, sleep quality & readiness</span>
                        </div>
                    </div>

                    <button class="onboarding-btn primary" onclick="startOuraConnectionOnboarding()">
                        Connect Oura Ring
                    </button>

                    <button class="skip-later-btn" onclick="animateToNextStep()">
                        <span>I'll connect later</span>
                        <span class="skip-subtext">You can always connect from your dashboard</span>
                    </button>

                    <button class="onboarding-btn back" style="margin-top: 8px;" onclick="animateToPrevStep()">
                         Back
                    </button>
                </div>
            `;
        }

        function startOuraConnectionOnboarding() {
            // Start OAuth flow - this will redirect, so save onboarding state
            localStorage.setItem('onboardingInProgress', 'true');
            localStorage.setItem('onboardingData', JSON.stringify(onboardingData));
            localStorage.setItem('onboardingStep', '5'); // Resume at supplements step after OAuth
            connectOura();
        }

        // Common supplement stacks for quick-add
        const COMMON_STACKS = [
            {
                name: 'Sleep Stack',
                icon: '',
                supplements: [
                    { id: 'magnesium_glycinate', name: 'Magnesium Glycinate', dosage: '400', unit: 'mg' },
                    { id: 'glycine', name: 'Glycine', dosage: '3', unit: 'g' },
                    { id: 'l_theanine', name: 'L-Theanine', dosage: '200', unit: 'mg' }
                ]
            },
            {
                name: 'Daily Essentials',
                icon: '',
                supplements: [
                    { id: 'vitamin_d3', name: 'Vitamin D3', dosage: '5000', unit: 'IU' },
                    { id: 'fish_oil', name: 'Omega-3 Fish Oil', dosage: '2000', unit: 'mg' },
                    { id: 'magnesium_glycinate', name: 'Magnesium', dosage: '400', unit: 'mg' }
                ]
            },
            {
                name: 'Focus Stack',
                icon: '',
                supplements: [
                    { id: 'lions_mane', name: "Lion's Mane", dosage: '500', unit: 'mg' },
                    { id: 'l_theanine', name: 'L-Theanine', dosage: '200', unit: 'mg' },
                    { id: 'caffeine', name: 'Caffeine', dosage: '100', unit: 'mg' }
                ]
            }
        ];

        // Step 5: Add Supplements
        function getStepSupplementsHTML() {
            const hasSelected = onboardingData.selectedSupplements.length > 0;
            const selectedIds = onboardingData.selectedSupplements.map(s => s.id);

            // Check which stacks have all supplements added
            const addedStacks = COMMON_STACKS.filter(stack =>
                stack.supplements.every(s => selectedIds.includes(s.id))
            ).map(s => s.name);

            // Build selected supplements - compact pills (clickable to edit)
            const selectedCardsHTML = onboardingData.selectedSupplements.map((supp, idx) => {
                const startLabel = getStartDateLabel(supp.startDate);
                return `
                <div class="selected-supp-tag" onclick="openOnboardingSupplementEdit(${idx})" title="Click to edit">
                    <span class="selected-supp-icon">${getSupplementIcon(supp.id)}</span>
                    <span class="selected-supp-name">${escapeAttr(supp.name)}</span>
                    <span class="selected-supp-dose">${escapeAttr(supp.dosage || '')} ${escapeAttr(supp.unit || '')}</span>
                    ${startLabel ? `<span class="selected-supp-start">${startLabel}</span>` : ''}
                    <span class="selected-supp-edit"></span>
                    <button class="selected-supp-remove" onclick="event.stopPropagation(); removeOnboardingSupplement(${idx})"></button>
                </div>
            `}).join('');

            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5">
                            <rect x="6" y="4" width="12" height="16" rx="6"/>
                            <path d="M6 12h12"/>
                        </svg>
                    </div>
                    <h2>What do you take?</h2>
                    <p class="onboarding-subtitle">Add your current supplements to track</p>

                    <div class="stacks-section">
                        <div class="stacks-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                            Quick add a stack
                        </div>
                        <div class="stack-cards">
                            ${COMMON_STACKS.map(stack => `
                                <div class="stack-card ${addedStacks.includes(stack.name) ? 'added' : ''}"
                                     onclick="addStack('${stack.name}')">
                                    <div class="stack-name">${stack.icon} ${stack.name}</div>
                                    <div class="stack-items">${stack.supplements.map(s => s.name.split(' ')[0]).join(' + ')}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="supp-search-container">
                        <input type="text" class="supp-search-input" id="onboarding-supp-search"
                               placeholder=" Search supplements..."
                               oninput="filterOnboardingSupplements(this.value)">
                    </div>

                    <div class="supp-list-container" id="onboarding-supp-list" style="max-height: 180px;">
                        <!-- Populated by JS -->
                    </div>

                    ${hasSelected ? `
                        <div class="selected-supps-section" style="margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div class="selected-supps-label">Added (${onboardingData.selectedSupplements.length})</div>
                            ${selectedCardsHTML}
                        </div>
                    ` : ''}

                    <div class="onboarding-nav" style="margin-top: 16px;">
                        <button class="onboarding-btn back" onclick="animateToPrevStep()"> Back</button>
                        <button class="onboarding-btn ${hasSelected ? 'primary' : 'secondary'}" onclick="animateToNextStep()">
                            ${hasSelected ? 'Continue' : 'Skip for now'}
                        </button>
                    </div>
                </div>
            `;
        }

        function addStack(stackName) {
            const stack = COMMON_STACKS.find(s => s.name === stackName);
            if (!stack) return;

            const selectedIds = onboardingData.selectedSupplements.map(s => s.id);

            stack.supplements.forEach(supp => {
                if (!selectedIds.includes(supp.id)) {
                    onboardingData.selectedSupplements.push({
                        id: supp.id,
                        name: supp.name,
                        dosage: supp.dosage,
                        typical_dose: supp.dosage,
                        unit: supp.unit,
                        duration: 0
                    });
                }
            });

            renderOnboardingStep(5);
            setTimeout(() => filterOnboardingSupplements(''), 10);
        }

        // Filter supplements in onboarding search
        function filterOnboardingSupplements(query) {
            const container = document.getElementById('onboarding-supp-list');
            if (!container) return;

            // Use supplement library if loaded, otherwise use a basic list
            let supplements = [];
            if (supplementLibrary && supplementLibrary.supplements) {
                supplements = supplementLibrary.supplements;
            } else {
                // Fallback list
                supplements = [
                    { id: 'vitamin_d3', name: 'Vitamin D3', typical_dose: '2000-5000', unit: 'IU' },
                    { id: 'fish_oil', name: 'Fish Oil / Omega-3', typical_dose: '1000-2000', unit: 'mg' },
                    { id: 'magnesium_glycinate', name: 'Magnesium Glycinate', typical_dose: '200-400', unit: 'mg' },
                    { id: 'vitamin_b12', name: 'Vitamin B12', typical_dose: '500-1000', unit: 'mcg' },
                    { id: 'ashwagandha', name: 'Ashwagandha', typical_dose: '300-600', unit: 'mg' },
                    { id: 'zinc', name: 'Zinc', typical_dose: '15-30', unit: 'mg' },
                    { id: 'melatonin', name: 'Melatonin', typical_dose: '0.5-5', unit: 'mg' },
                    { id: 'creatine', name: 'Creatine', typical_dose: '3-5', unit: 'g' },
                    { id: 'vitamin_c', name: 'Vitamin C', typical_dose: '500-1000', unit: 'mg' },
                    { id: 'b_complex', name: 'B-Complex', typical_dose: '1', unit: 'capsule' }
                ];
            }

            // Filter by query
            const lowerQuery = query.toLowerCase().trim();
            const filtered = lowerQuery
                ? supplements.filter(s => s.name.toLowerCase().includes(lowerQuery))
                : supplements.slice(0, 8); // Show first 8 by default

            // Check which are already selected
            const selectedIds = onboardingData.selectedSupplements.map(s => s.id);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="supp-no-results">No supplements found for "${query}"</div>`;
                return;
            }

            container.innerHTML = filtered.map(supp => {
                const isSelected = selectedIds.includes(supp.id);
                const doseDisplay = supp.unit ? `${supp.typical_dose} ${supp.unit}` : supp.typical_dose;
                return `
                    <div class="supp-list-item ${isSelected ? 'selected' : ''}"
                         onclick="toggleOnboardingSupplementFromSearch('${supp.id}', '${supp.name.replace(/'/g, "\\'")}', '${(supp.typical_dose || '').replace(/'/g, "\\'")}', '${(supp.unit || '').replace(/'/g, "\\'")}')">
                        <span class="supp-list-icon">${getSupplementIcon(supp.id)}</span>
                        <div class="supp-list-info">
                            <div class="supp-list-name">${supp.name}</div>
                            <div class="supp-list-dose">${doseDisplay || ''}</div>
                        </div>
                        <span class="supp-list-check"></span>
                    </div>
                `;
            }).join('');
        }

        // Toggle supplement from search list
        function toggleOnboardingSupplementFromSearch(id, name, typicalDose, unit) {
            const idx = onboardingData.selectedSupplements.findIndex(s => s.id === id);
            if (idx > -1) {
                // Remove it
                onboardingData.selectedSupplements.splice(idx, 1);
            } else {
                // Add it with default values
                const defaultDose = typicalDose ? typicalDose.split('-')[0] || typicalDose : '';
                onboardingData.selectedSupplements.push({
                    id: id,
                    name: name,
                    dosage: defaultDose,
                    typical_dose: typicalDose,
                    unit: unit || '',
                    duration: 0 // Just starting
                });
            }
            // Re-render current step (supplements is step 5)
            renderOnboardingStep(5);
            // Restore search and re-filter
            setTimeout(() => {
                const searchInput = document.getElementById('onboarding-supp-search');
                if (searchInput) {
                    filterOnboardingSupplements(searchInput.value || '');
                }
            }, 10);
        }

        // Remove a selected supplement
        function removeOnboardingSupplement(idx) {
            onboardingData.selectedSupplements.splice(idx, 1);
            renderOnboardingStep(5);
            setTimeout(() => {
                const searchInput = document.getElementById('onboarding-supp-search');
                if (searchInput) {
                    filterOnboardingSupplements(searchInput.value || '');
                }
            }, 10);
        }

        // Update a field on a selected supplement
        function updateOnboardingSupplementField(idx, field, value) {
            if (onboardingData.selectedSupplements[idx]) {
                onboardingData.selectedSupplements[idx][field] = value;
            }
        }

        // Get human-readable label for start date
        function getStartDateLabel(startDate) {
            if (!startDate) return '';
            const today = new Date();
            const start = new Date(startDate);
            const diffDays = Math.floor((today - start) / (1000 * 60 * 60 * 24));

            if (diffDays <= 0) return 'Just started';
            if (diffDays <= 7) return `${diffDays}d ago`;
            if (diffDays <= 30) return `${Math.round(diffDays / 7)}w ago`;
            if (diffDays <= 365) return `${Math.round(diffDays / 30)}mo ago`;
            return `${Math.round(diffDays / 365)}y ago`;
        }

        // Open edit popup for onboarding supplement
        function openOnboardingSupplementEdit(idx) {
            const supp = onboardingData.selectedSupplements[idx];
            if (!supp) return;

            // Create popup if it doesn't exist
            let popup = document.getElementById('onboarding-supp-edit-popup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'onboarding-supp-edit-popup';
                popup.className = 'onboarding-edit-popup hidden';
                popup.innerHTML = `
                    <div class="edit-popup-backdrop" onclick="closeOnboardingSupplementEdit()"></div>
                    <div class="edit-popup-content">
                        <div class="edit-popup-header">
                            <span class="edit-popup-title">Edit Supplement</span>
                            <button class="edit-popup-close" onclick="closeOnboardingSupplementEdit()"></button>
                        </div>
                        <div class="edit-popup-body">
                            <div class="edit-popup-supp-name" id="edit-supp-name"></div>

                            <div class="edit-field">
                                <label>Dosage</label>
                                <div class="dosage-input-row">
                                    <input type="text" id="edit-supp-dosage" placeholder="e.g. 400">
                                    <span class="dosage-unit" id="edit-supp-unit">mg</span>
                                </div>
                            </div>

                            <div class="edit-field">
                                <label>When did you start taking this?</label>
                                <div class="start-date-options">
                                    <button class="start-option" data-days="0">Just started</button>
                                    <button class="start-option" data-days="7">~1 week ago</button>
                                    <button class="start-option" data-days="30">~1 month ago</button>
                                    <button class="start-option" data-days="90">~3 months ago</button>
                                    <button class="start-option" data-days="180">~6 months ago</button>
                                    <button class="start-option" data-days="365">~1 year+</button>
                                </div>
                                <div class="custom-date-row">
                                    <span>Or pick a date:</span>
                                    <input type="date" id="edit-supp-date">
                                </div>
                            </div>
                        </div>
                        <div class="edit-popup-footer">
                            <button class="onboarding-btn secondary" onclick="closeOnboardingSupplementEdit()">Cancel</button>
                            <button class="onboarding-btn primary" onclick="saveOnboardingSupplementEdit()">Save</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(popup);

                // Add click handlers for start date options
                popup.querySelectorAll('.start-option').forEach(btn => {
                    btn.addEventListener('click', function() {
                        popup.querySelectorAll('.start-option').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        // Clear custom date
                        document.getElementById('edit-supp-date').value = '';
                    });
                });

                // When custom date is selected, clear the option buttons
                document.getElementById('edit-supp-date').addEventListener('change', function() {
                    popup.querySelectorAll('.start-option').forEach(b => b.classList.remove('selected'));
                });
            }

            // Store current index
            popup.dataset.editIdx = idx;

            // Populate fields
            document.getElementById('edit-supp-name').textContent = supp.name;
            document.getElementById('edit-supp-dosage').value = supp.dosage || '';
            document.getElementById('edit-supp-unit').textContent = supp.unit || 'mg';
            document.getElementById('edit-supp-date').value = supp.startDate || '';

            // Select the appropriate start option or custom date
            popup.querySelectorAll('.start-option').forEach(btn => btn.classList.remove('selected'));
            if (supp.startDate) {
                const diffDays = Math.floor((new Date() - new Date(supp.startDate)) / (1000 * 60 * 60 * 24));
                // Try to match to closest option
                const options = [0, 7, 30, 90, 180, 365];
                const closest = options.reduce((prev, curr) =>
                    Math.abs(curr - diffDays) < Math.abs(prev - diffDays) ? curr : prev
                );
                if (Math.abs(closest - diffDays) <= 3) {
                    popup.querySelector(`.start-option[data-days="${closest}"]`)?.classList.add('selected');
                } else {
                    document.getElementById('edit-supp-date').value = supp.startDate;
                }
            } else {
                // Default to "Just started"
                popup.querySelector('.start-option[data-days="0"]')?.classList.add('selected');
            }

            popup.classList.remove('hidden');
        }

        function closeOnboardingSupplementEdit() {
            const popup = document.getElementById('onboarding-supp-edit-popup');
            if (popup) popup.classList.add('hidden');
        }

        function saveOnboardingSupplementEdit() {
            const popup = document.getElementById('onboarding-supp-edit-popup');
            const idx = parseInt(popup.dataset.editIdx);
            const supp = onboardingData.selectedSupplements[idx];
            if (!supp) return;

            // Save dosage
            const dosage = document.getElementById('edit-supp-dosage').value.trim();
            supp.dosage = dosage;

            // Determine start date
            const customDate = document.getElementById('edit-supp-date').value;
            const selectedOption = popup.querySelector('.start-option.selected');

            if (customDate) {
                supp.startDate = customDate;
            } else if (selectedOption) {
                const daysAgo = parseInt(selectedOption.dataset.days);
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - daysAgo);
                supp.startDate = startDate.toISOString().split('T')[0];
            }

            closeOnboardingSupplementEdit();
            renderOnboardingStep(5);
            setTimeout(() => {
                const searchInput = document.getElementById('onboarding-supp-search');
                if (searchInput) filterOnboardingSupplements(searchInput.value || '');
            }, 10);
        }

        // Step 6: Set Goal (multi-select, max 3)
        const MAX_GOALS = 3;

        function getStepGoalHTML() {
            const goals = [
                { id: 'sleep', icon: '', name: 'Better Sleep', desc: 'Fall asleep faster, wake up refreshed' },
                { id: 'recovery', icon: '', name: 'Recovery & Performance', desc: 'Bounce back faster from workouts' },
                { id: 'energy', icon: '', name: 'Energy & Focus', desc: 'Stay sharp and energized all day' },
                { id: 'wellness', icon: '', name: 'General Wellness', desc: 'Support overall health & longevity' }
            ];

            // Ensure goals is an array
            if (!Array.isArray(onboardingData.goals)) {
                onboardingData.goals = [];
            }

            const selectedCount = onboardingData.goals.length;
            const atLimit = selectedCount >= MAX_GOALS;

            const goalsHTML = goals.map(goal => {
                const isSelected = onboardingData.goals.includes(goal.id);
                const isDisabled = atLimit && !isSelected;
                return `
                    <div class="goal-option ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
                         onclick="${isDisabled ? '' : `toggleOnboardingGoal('${goal.id}')`}"
                         style="${isDisabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        <span class="goal-icon">${goal.icon}</span>
                        <span class="goal-name">${goal.name}</span>
                        <span class="goal-check">${isSelected ? '' : ''}</span>
                    </div>
                `;
            }).join('');

            const hasGoals = selectedCount > 0;

            return `
                <div class="onboarding-step-content">
                    <div class="onboarding-illustration">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="6"/>
                            <circle cx="12" cy="12" r="2"/>
                        </svg>
                    </div>
                    <h2>What's your focus?</h2>
                    <p class="onboarding-subtitle">Select up to ${MAX_GOALS} priorities</p>

                    ${selectedCount > 0 ? `
                        <p class="goal-limit-hint ${atLimit ? 'at-limit' : ''}" style="text-align: center; margin-bottom: 16px;">
                            ${selectedCount} of ${MAX_GOALS} selected ${atLimit ? '(max reached)' : ''}
                        </p>
                    ` : ''}

                    <div class="goal-options">
                        ${goalsHTML}
                    </div>

                    <div class="onboarding-nav">
                        <button class="onboarding-btn back" onclick="animateToPrevStep()"> Back</button>
                        <button class="onboarding-btn ${hasGoals ? 'primary' : 'secondary'}" onclick="animateToNextStep()">
                            ${hasGoals ? 'Continue' : 'Skip for now'}
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleOnboardingGoal(goal) {
            // Ensure goals is an array
            if (!Array.isArray(onboardingData.goals)) {
                onboardingData.goals = [];
            }

            const idx = onboardingData.goals.indexOf(goal);
            if (idx > -1) {
                // Remove it
                onboardingData.goals.splice(idx, 1);
            } else if (onboardingData.goals.length < MAX_GOALS) {
                // Add it only if under limit
                onboardingData.goals.push(goal);
            }

            // Re-render the step to update UI
            renderOnboardingStep(6);
        }

        // Completion Screen
        function getCompletionHTML() {
            const profileComplete = onboardingData.age && onboardingData.sex && onboardingData.height_feet && onboardingData.weight_lbs;
            const lifestyleComplete = onboardingData.region || onboardingData.activity_level || onboardingData.work_environment || onboardingData.diet_type;
            const suppCount = onboardingData.selectedSupplements.length;
            const goalsArray = onboardingData.goals || [];
            const hasGoals = goalsArray.length > 0;

            // Build personalized summary
            const goalNames = {
                sleep: 'Better Sleep',
                recovery: 'Recovery & Performance',
                energy: 'Energy & Focus',
                wellness: 'General Wellness'
            };
            const primaryGoal = hasGoals ? goalNames[goalsArray[0]] : 'your health goals';
            const regionText = onboardingData.region ? {
                northern: 'Northern US sunlight levels',
                central: 'Central US conditions',
                southern: 'Southern US sun exposure',
                gulf: 'Gulf region climate'
            }[onboardingData.region] : 'your location';

            // Trigger confetti on mount
            setTimeout(() => triggerConfetti(), 300);

            return `
                <div class="onboarding-step-content">
                    <div class="completion-checkmark">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12l5 5L20 7"/>
                        </svg>
                    </div>
                    <h2>You're all set!</h2>
                    <p class="onboarding-subtitle">Your personalized dashboard is ready</p>

                    <div class="personalized-summary">
                        <p>
                            Based on your profile, we'll focus on <strong>${primaryGoal}</strong>
                            ${onboardingData.region ? ` with recommendations optimized for ${regionText}` : ''}.
                            ${suppCount > 0 ? ` We're tracking ${suppCount} supplement${suppCount > 1 ? 's' : ''} for you.` : ''}
                        </p>
                    </div>

                    <div class="completion-summary">
                        <div class="summary-item ${profileComplete ? 'completed' : ''}">
                            <span class="summary-icon">${profileComplete ? '' : ''}</span>
                            ${profileComplete ? 'Profile complete' : 'Profile (complete later in settings)'}
                        </div>
                        <div class="summary-item ${lifestyleComplete ? 'completed' : ''}">
                            <span class="summary-icon">${lifestyleComplete ? '' : ''}</span>
                            ${lifestyleComplete ? 'Lifestyle preferences set' : 'Lifestyle (set later)'}
                        </div>
                        <div class="summary-item ${(onboardingData.ouraConnected || ouraConnected) ? 'completed' : ''}">
                            <span class="summary-icon">${(onboardingData.ouraConnected || ouraConnected) ? '' : ''}</span>
                            ${(onboardingData.ouraConnected || ouraConnected) ? 'Oura Ring connected' : 'Oura Ring (connect later)'}
                        </div>
                        <div class="summary-item ${suppCount > 0 ? 'completed' : ''}">
                            <span class="summary-icon">${suppCount > 0 ? '' : ''}</span>
                            ${suppCount > 0 ? `${suppCount} supplement${suppCount > 1 ? 's' : ''} tracked` : 'No supplements added'}
                        </div>
                        <div class="summary-item ${hasGoals ? 'completed' : ''}">
                            <span class="summary-icon">${hasGoals ? '' : ''}</span>
                            ${hasGoals ? `Focus: ${goalsArray.map(g => goalNames[g]).join(', ')}` : 'No focus areas set'}
                        </div>
                    </div>

                    <button class="onboarding-btn primary cta-primary" id="complete-onboarding-btn" onclick="completeOnboarding()">
                        Start Your Journey
                    </button>
                    <button class="onboarding-btn back" onclick="animateToPrevStep()">
                         Back
                    </button>
                </div>
            `;
        }

        // Confetti celebration
        function triggerConfetti() {
            const colors = ['#8B5CF6', '#22C55E', '#F59E0B', '#EC4899', '#3B82F6'];
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                container.appendChild(confetti);
            }

            // Clean up after animation
            setTimeout(() => container.remove(), 4000);
        }

        async function completeOnboarding() {
            // Show loading state
            const btn = document.getElementById('complete-onboarding-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> Setting up...';
            }

            // Save supplements if any were selected
            if (onboardingData.selectedSupplements.length > 0) {
                for (const supp of onboardingData.selectedSupplements) {
                    // Use explicit startDate if set, otherwise calculate from duration
                    let startDateStr;
                    if (supp.startDate) {
                        startDateStr = supp.startDate;
                    } else {
                        const startDate = new Date();
                        startDate.setDate(startDate.getDate() - (supp.duration || 0));
                        startDateStr = getLocalDateString(startDate);
                    }

                    try {
                        // Combine dosage with unit for storage (e.g., "2000 IU", "400 mg")
                        const fullDosage = supp.dosage && supp.unit
                            ? `${supp.dosage} ${supp.unit}`
                            : (supp.dosage || '');

                        await fetch(`/analytics/${currentUserId}/supplement-starts`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                supplement_id: supp.id,
                                supplement_name: supp.name,
                                start_date: startDateStr,
                                is_manual: true,
                                dosage: fullDosage
                            })
                        });

                        // Create backdate logs if start date is in the past (assume 80% adherence)
                        const daysAgo = Math.floor((new Date() - new Date(startDateStr)) / (1000 * 60 * 60 * 24));
                        if (daysAgo > 0) {
                            await createBackdateLogs(supp.id, startDateStr, 0.8);
                        }
                    } catch (e) {
                        console.error('Error adding supplement:', e);
                    }
                }
            }

            // Save all profile data to user
            try {
                const profileData = {
                    onboarding_complete: 'true'
                };

                // Add profile fields if provided
                if (onboardingData.age) profileData.age = onboardingData.age;
                if (onboardingData.sex) profileData.sex = onboardingData.sex;
                if (onboardingData.height_feet) profileData.height_feet = onboardingData.height_feet;
                if (onboardingData.height_inches !== null) profileData.height_inches = onboardingData.height_inches;
                if (onboardingData.weight_lbs) profileData.weight_lbs = onboardingData.weight_lbs;

                // Add lifestyle fields if provided
                if (onboardingData.region) profileData.region = onboardingData.region;
                if (onboardingData.activity_level) profileData.activity_level = onboardingData.activity_level;
                if (onboardingData.work_environment) profileData.work_environment = onboardingData.work_environment;
                if (onboardingData.diet_type) profileData.diet_type = onboardingData.diet_type;

                // Add sleep/chronotype if provided
                if (onboardingData.chronotype) profileData.chronotype = onboardingData.chronotype;

                // Add goals if provided (save first as primary health_goal, all in goals array)
                if (onboardingData.goals && onboardingData.goals.length > 0) {
                    profileData.health_goal = onboardingData.goals[0]; // Primary goal
                    profileData.goals = onboardingData.goals; // All goals
                }

                await fetch(`/users/${currentUserId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
            } catch (e) {
                console.error('Error saving profile:', e);
            }

            // Close modal and refresh data
            closeOnboarding();
            await loadAnalyticsData(); // Reload analytics to get new supplements
            loadAllData();
            showStatus('Welcome to Dose! Your dashboard is ready.', 'success');
        }

        function closeOnboarding() {
            document.getElementById('onboarding-modal').classList.add('hidden');
            localStorage.removeItem('onboardingInProgress');
        }

        // ==================== END ONBOARDING ====================


        // ==================== PROGRESSIVE DISCLOSURE ====================

        // Check user setup status
        function getUserSetupStatus() {
            return {
                hasOura: ouraConnected,
                hasSupplements: (analyticsData?.supplement_starts || []).filter(s => !s.end_date).length > 0,
                hasLogs: (analyticsData?.supplement_logs || []).length > 0
            };
        }

        // Check if user is new (needs getting started guidance)
        function isNewUser() {
            const status = getUserSetupStatus();
            // User is "new" if they haven't completed 2 of the 3 setup steps
            const completedSteps = (status.hasOura ? 1 : 0) + (status.hasSupplements ? 1 : 0) + (status.hasLogs ? 1 : 0);
            return completedSteps < 2;
        }

        // Update the Getting Started card
        function updateGettingStartedCard() {
            const card = document.getElementById('getting-started-card');
            if (!card) return;

            // Don't show if user dismissed it
            if (localStorage.getItem('gettingStartedDismissed') === 'true') {
                card.classList.add('hidden');
                return;
            }

            const status = getUserSetupStatus();

            // Update checklist items
            const ouraItem = document.getElementById('gs-item-oura');
            const supplementsItem = document.getElementById('gs-item-supplements');
            const logItem = document.getElementById('gs-item-log');

            if (status.hasOura) {
                ouraItem.classList.add('completed');
            } else {
                ouraItem.classList.remove('completed');
            }

            if (status.hasSupplements) {
                supplementsItem.classList.add('completed');
            } else {
                supplementsItem.classList.remove('completed');
            }

            if (status.hasLogs) {
                logItem.classList.add('completed');
            } else {
                logItem.classList.remove('completed');
            }

            // Update progress
            const completedCount = (status.hasOura ? 1 : 0) + (status.hasSupplements ? 1 : 0) + (status.hasLogs ? 1 : 0);
            const progressFill = document.getElementById('gs-progress-fill');
            const progressText = document.getElementById('gs-progress-text');

            if (progressFill) progressFill.style.width = `${(completedCount / 3) * 100}%`;
            if (progressText) progressText.textContent = `${completedCount}/3`;

            // Hide if all completed
            if (completedCount >= 3) {
                card.classList.add('hidden');
            } else if (isNewUser()) {
                card.classList.remove('hidden');
            } else {
                // User has some progress, show card to encourage completion
                card.classList.remove('hidden');
            }
        }

        // Dismiss Getting Started card
        function dismissGettingStarted() {
            localStorage.setItem('gettingStartedDismissed', 'true');
            const card = document.getElementById('getting-started-card');
            if (card) card.classList.add('hidden');
        }
        // Update chart overlay visibility
        function updateChartOverlay() {
            const overlay = document.getElementById('chart-overlay');
            if (!overlay) return;

            // Show overlay if no Oura connected
            if (!ouraConnected) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        // Master function to update all progressive disclosure elements
        function updateProgressiveDisclosure() {
            updateGettingStartedCard();
            updateChartOverlay();
        }

        // ==================== END PROGRESSIVE DISCLOSURE ====================


        // Sign in
        async function signIn() {
            const email = document.getElementById('signin-email').value.trim();
            if (!email) {
                showStatus('Please enter your email', 'error');
                return;
            }

            try {
                const res = await fetch('/users/signin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (res.ok) {
                    const user = await res.json();
                    currentUserId = user.id;
                    localStorage.setItem('userId', user.id);
                    showLoggedIn(user);
                    loadAllData();
                    showStatus('Welcome back!', 'success');
                } else {
                    // Handle both JSON and plain text error responses
                    const contentType = res.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const err = await res.json();
                        showStatus(err.detail || 'Error signing in', 'error');
                    } else {
                        const text = await res.text();
                        showStatus(text || 'Error signing in. Please try again.', 'error');
                    }
                }
            } catch (e) {
                showStatus('Unable to connect. Please check your internet and try again.', 'error');
            }
        }

        // Load user and show UI
        async function loadUserAndShow() {
            try {
                const res = await fetch(`/users/${currentUserId}`);
                if (res.ok) {
                    const user = await res.json();
                    showLoggedIn(user);
                    loadAllData();
                } else {
                    localStorage.removeItem('userId');
                    currentUserId = null;
                }
            } catch (e) {
                console.error('Error loading user:', e);
            }
        }

        // Load all data
        async function loadAllData() {
            console.log('[Init] loadAllData called');
            loadMixes();
            checkDailyFoundationTaken();
            // Load analytics data first so checkOuraStatus can use cached data if API fails
            console.log('[Init] Calling loadTodaysStackData...');
            await loadTodaysStackData();
            console.log('[Init] loadTodaysStackData complete, analyticsData:', analyticsData ? 'set' : 'null');
            console.log('[Init] Calling checkOuraStatus...');
            checkOuraStatus();
        }

        // Check Daily Foundation status and update display
        async function checkDailyFoundationTaken() {
            if (!currentUserId) return;

            const dfElement = document.getElementById('daily-foundation');
            const dfStatus = document.getElementById('df-status');

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/tracking/daily?date_override=${dateStr}`);

                if (res.ok) {
                    const data = await res.json();
                    // Daily Foundation contains: vitamin_d3, vitamin_k2, omega_3
                    const dfSupplements = ['vitamin_d3', 'vitamin_k2', 'omega_3'];
                    const takenSupps = data.supplements.map(s => s.supplement_id);
                    const takenCount = dfSupplements.filter(s => takenSupps.includes(s)).length;

                    // Update status based on how many were taken
                    dfElement.classList.remove('taken', 'partial');

                    if (takenCount === 3) {
                        dfElement.classList.add('taken');
                        dfStatus.textContent = ' All 3 taken';
                    } else if (takenCount > 0) {
                        dfElement.classList.add('partial');
                        dfStatus.textContent = `${takenCount}/3 taken`;
                    } else {
                        dfStatus.textContent = 'Tap to dispense';
                    }
                }
            } catch (e) {
                console.error('Error checking daily foundation:', e);
            }
        }

        // Select Daily Foundation (with taken check)
        function selectDailyFoundation() {
            const dfElement = document.getElementById('daily-foundation');
            if (dfElement.classList.contains('taken')) {
                showStatus('All 3 foundation supplements taken!', 'success');
                return;
            }
            selectMix('daily_foundation');
        }

        // Show logged in state
        function showLoggedIn(user) {
            document.getElementById('no-user').classList.add('hidden');
            document.getElementById('has-user').classList.remove('hidden');
            document.getElementById('display-name').textContent = user.name;
            document.getElementById('user-avatar').textContent = user.name.charAt(0).toUpperCase();

            // Show/hide afternoon stack based on user preference
            const afternoonBtn = document.getElementById('time-btn-afternoon');
            if (afternoonBtn) {
                afternoonBtn.style.display = user.afternoon_stack_enabled ? 'inline-flex' : 'none';
            }

            // Initialize afternoon stack toggle in settings
            initAfternoonStackToggle(user.afternoon_stack_enabled);

            // Update time buttons based on current time
            updateTimeButtons();
        }

        // Logout
        function logout() {
            localStorage.removeItem('userId');
            currentUserId = null;
            ouraConnected = false;
            ouraData = null;
            analyticsData = null;
            checkinState = {};
            document.getElementById('has-user').classList.add('hidden');
            document.getElementById('no-user').classList.remove('hidden');
            // Switch back to dashboard tab
            switchMainTab('dashboard');
        }

        // Date functions
        function getDateString() {
            return getLocalDateString(currentDate);
        }

        function updateDateDisplay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const current = new Date(currentDate);
            current.setHours(0, 0, 0, 0);

            const isToday = today.getTime() === current.getTime();
            const dayEl = document.getElementById('date-day');
            const fullEl = document.getElementById('date-full');

            const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
            fullEl.textContent = currentDate.toLocaleDateString('en-US', options);

            if (isToday) {
                dayEl.innerHTML = 'Today<span class="today-badge">Now</span>';
            } else {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                dayEl.textContent = days[currentDate.getDay()];
            }
        }

        function changeDate(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            updateDateDisplay();
            loadAllData();
        }

        // Time functions
        function setTime(hour) {
            currentTime = hour;
            updateTimeButtons();
            loadMixes();
        }

        function updateTimeButtons() {
            // Time buttons may not exist after UI redesign - safely handle missing elements
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));

            // Check if afternoon stack is visible
            const afternoonBtn = document.getElementById('time-btn-afternoon');
            const afternoonVisible = afternoonBtn && afternoonBtn.style.display !== 'none';

            const morningBtn = document.getElementById('time-btn-morning');
            const bedtimeBtn = document.getElementById('time-btn-bedtime');

            if (currentTime < 12) {
                morningBtn?.classList.add('active');
            } else if (afternoonVisible && currentTime < 21) {
                // If afternoon is enabled and before bedtime
                afternoonBtn?.classList.add('active');
            } else {
                bedtimeBtn?.classList.add('active');
            }
        }

        // Load mixes
        async function loadMixes() {
            try {
                const res = await fetch('/mixes/all');
                if (res.ok) {
                    availableMixes = await res.json();
                    renderMixCards();
                }
            } catch (e) {
                console.error('Error loading mixes:', e);
            }
        }

        // Render mix cards
        function renderMixCards() {
            const layout = document.getElementById('dispenser-layout');
            // Keep AI recommendation and Daily Foundation
            const aiRec = document.getElementById('ai-recommendation');
            const dailyFoundation = document.getElementById('daily-foundation');

            // Remove existing mix cards
            layout.querySelectorAll('.mix-card').forEach(card => card.remove());

            // Filter mixes by time of day and exclude daily_foundation
            // Bedtime starts around 9pm (21:00) by default - 1hr before typical 10pm bedtime
            const currentPeriod = currentTime < 12 ? 'morning' : currentTime < 21 ? 'afternoon' : 'bedtime';
            const filteredMixes = availableMixes.filter(mix => {
                if (mix.id === 'daily_foundation') return false;
                if (!mix.time_windows || mix.time_windows.length === 0) return true;
                return mix.time_windows.includes(currentPeriod);
            });

            // Add mix cards
            filteredMixes.forEach(mix => {
                const card = document.createElement('div');
                card.className = 'mix-card';
                card.onclick = () => selectMix(mix.id);
                card.innerHTML = `
                    <div class="mix-icon">${mix.icon || ''}</div>
                    <div class="mix-name">${mix.name}</div>
                    <div class="mix-desc">${mix.description}</div>
                `;
                layout.appendChild(card);
            });

            // Load custom blends
            loadCustomBlends();
        }

        // Load custom blends
        async function loadCustomBlends() {
            if (!currentUserId) return;

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}`);
                if (res.ok) {
                    customBlends = await res.json();
                    renderCustomBlends();
                    renderCustomBlendCards();
                }
            } catch (e) {
                console.error('Error loading custom blends:', e);
            }
        }

        // Render custom blend cards in dispenser grid
        function renderCustomBlendCards() {
            const layout = document.getElementById('dispenser-layout');

            // Remove existing custom blend cards first to prevent duplicates
            layout.querySelectorAll('.custom-blend-mix').forEach(card => card.remove());

            customBlends.forEach(blend => {
                const card = document.createElement('div');
                card.className = 'mix-card custom-blend-mix';
                card.onclick = () => selectCustomBlend(blend.id);
                card.innerHTML = `
                    <div class="custom-badge">Custom</div>
                    <div class="mix-icon">${blend.icon || '&#x1F9EA;'}</div>
                    <div class="mix-name">${blend.name}</div>
                    <div class="mix-desc">${(blend.components || []).length} supplements</div>
                `;
                layout.appendChild(card);
            });
        }

        // Render custom blends list
        function renderCustomBlends() {
            const list = document.getElementById('custom-blends-list');

            if (customBlends.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5"><path d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2v-4M9 21H5a2 2 0 01-2-2v-4m0-6v6"/></svg></div>
                        <div>No custom blends yet</div>
                        <div style="font-size: 0.8em; color: #333; margin-top: 6px;">
                            Create your own supplement combinations
                        </div>
                    </div>
                `;
                return;
            }

            list.innerHTML = customBlends.map(blend => `
                <div class="custom-blend-card" onclick="selectCustomBlend('${blend.id}')">
                    <div class="custom-blend-info">
                        <span class="custom-blend-icon">${blend.icon || '&#x1F9EA;'}</span>
                        <div>
                            <div class="custom-blend-name">${blend.name}</div>
                            <div class="custom-blend-count">${(blend.components || []).length} supplements</div>
                        </div>
                    </div>
                    <div class="custom-blend-actions">
                        <button class="btn-delete-blend" onclick="event.stopPropagation(); deleteCustomBlend('${blend.id}')" title="Delete">&#x2715;</button>
                    </div>
                </div>
            `).join('');
        }

        // Select a mix
        async function selectMix(mixId) {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/${currentUserId}/${mixId}?hour=${currentTime}&date_override=${dateStr}`);

                if (res.ok) {
                    currentMixData = await res.json();
                    showDispenseModal(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error calculating mix', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Select custom blend
        async function selectCustomBlend(blendId) {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            try {
                const dateStr = getDateString();
                const res = await fetch(`/mixes/blends/${currentUserId}/${blendId}/preview?hour=${currentTime}&date_override=${dateStr}`);

                if (res.ok) {
                    currentMixData = await res.json();
                    showDispenseModal(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error calculating blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // AI Recommendation
        async function getAIRecommendation() {
            if (!currentUserId) {
                showStatus('Please sign in first', 'error');
                return;
            }

            const aiRec = document.getElementById('ai-recommendation');
            aiRec.classList.add('loading');
            const loadingText = ouraConnected ? 'Analyzing your Oura data...' : 'Analyzing your health data...';
            aiRec.querySelector('.ai-subtitle').textContent = loadingText;

            try {
                const dateStr = getDateString();

                // Step 1: Get smart recommendation (which mix to use)
                const smartRes = await fetch(`/mixes/${currentUserId}/smart?time_override=${currentTime}`);
                if (!smartRes.ok) {
                    const err = await smartRes.json();
                    showStatus(err.detail || 'Error getting recommendation', 'error');
                    return;
                }

                const smartData = await smartRes.json();
                const recommendedMixId = smartData.recommended_mix_id;

                // Step 2: Get the full mix details
                const mixRes = await fetch(`/mixes/${currentUserId}/${recommendedMixId}?time_override=${currentTime}&date_override=${dateStr}`);
                if (!mixRes.ok) {
                    const err = await mixRes.json();
                    showStatus(err.detail || 'Error loading mix', 'error');
                    return;
                }

                currentMixData = await mixRes.json();

                // Add the AI reason to the mix data
                currentMixData.ai_reason = smartData.reason;
                currentMixData.health_summary = smartData.health_summary;

                showDispenseModal(currentMixData);
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            } finally {
                aiRec.classList.remove('loading');
                const subtitle = ouraConnected ? 'Powered by your Oura Ring data' : 'Connect Oura for personalized insights';
                aiRec.querySelector('.ai-subtitle').textContent = subtitle;
            }
        }

        // Show dispense modal
        function showDispenseModal(data) {
            const modal = document.getElementById('dispense-modal');
            const content = document.getElementById('modal-content');

            const supplements = data.supplements || [];
            const warnings = data.warnings || [];
            const skipped = data.skipped || [];

            content.innerHTML = `
                <div class="modal-header">
                    <div class="modal-icon">${data.mix_icon || ''}</div>
                    <div class="modal-title">${data.mix_name}</div>
                    <div class="modal-subtitle">${data.mix_description || 'Your personalized supplement mix'}</div>
                </div>

                ${data.ai_reason ? `
                    <div class="ai-reason" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <span style="font-size: 1.1em;">&#x2728;</span>
                            <span style="color: #A78BFA; font-weight: 600; font-size: 0.85em;">AI Recommendation</span>
                        </div>
                        <div style="color: #B0B0B0; font-size: 0.9em;">${data.ai_reason}</div>
                    </div>
                ` : ''}

                ${supplements.length > 0 ? `
                    <div class="supplement-list">
                        ${supplements.map(s => `
                            <div class="supplement-item">
                                <div class="supplement-info">
                                    <span class="supplement-name">${s.name}</span>
                                    <span class="supplement-description">${s.description || ''}</span>
                                </div>
                                <span class="supplement-dose">${s.dose}${s.unit}</span>
                            </div>
                            ${s.intelligence_notes && s.intelligence_notes.length > 0 ? `
                                <div class="intelligence-note">
                                    ${s.intelligence_notes.join('; ')}
                                </div>
                            ` : ''}
                        `).join('')}
                    </div>
                ` : `
                    <div class="empty-state" style="padding: 20px 0;">
                        <div style="color: #666;">All supplements in this mix have reached their daily limits</div>
                    </div>
                `}

                ${skipped.length > 0 ? `
                    <div class="modal-skipped">
                        <div class="skipped-header">Skipped (daily limit reached):</div>
                        ${skipped.map(s => `<span class="skipped-item">${s.name || s.supplement_id}</span>`).join('')}
                    </div>
                ` : ''}

                ${warnings.length > 0 ? `
                    <div class="modal-warning">
                        ${warnings.map(w => w.message || w).join('<br>')}
                    </div>
                ` : ''}

                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeDispenseModal()">Cancel</button>
                    <button class="btn-dispense" onclick="confirmDispense()" id="dispense-btn" ${supplements.length === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        ${supplements.length === 0 ? 'Nothing to Dispense' : 'Get Dose'}
                    </button>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close dispense modal
        function closeDispenseModal() {
            document.getElementById('dispense-modal').classList.add('hidden');
            currentMixData = null;
            isDispensing = false;
        }

        // Confirm dispense
        async function confirmDispense() {
            if (!currentMixData || isDispensing) return;
            isDispensing = true;

            const btn = document.getElementById('dispense-btn');
            btn.classList.add('dispensing');
            btn.textContent = 'Dispensing...';

            try {
                const dateStr = getDateString();

                // Determine if this is a custom blend or regular mix
                let url;
                if (currentMixData.blend_id) {
                    // Custom blend
                    url = `/mixes/blends/${currentUserId}/${currentMixData.blend_id}/dispense?time_override=${currentTime}&date_override=${dateStr}`;
                } else {
                    // Regular mix
                    url = `/mixes/${currentUserId}/${currentMixData.mix_id}/dispense?time_override=${currentTime}&date_override=${dateStr}`;
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (res.ok) {
                    // Also add dispensed supplements to daily stack
                    const supplements = currentMixData.supplements || [];
                    if (supplements.length > 0) {
                        const autoTime = currentTime < 12 ? 'morning' : 'bedtime';
                        try {
                            await fetch(`/analytics/${currentUserId}/daily-checkin`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    date: dateStr,
                                    supplements: supplements.map(s => ({
                                        supplement_id: s.supplement_id,
                                        taken: true,
                                        time_taken: autoTime
                                    }))
                                })
                            });
                            // Refresh analytics data in background
                            const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                            if (analyticsRes.ok) {
                                analyticsData = await analyticsRes.json();
                                loadTodaysStack();
                            }
                        } catch (e) {
                            console.error('Error logging dispensed supplements:', e);
                        }
                    }
                    showDispenseAnimation(currentMixData);
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error dispensing', 'error');
                    closeDispenseModal();
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
                closeDispenseModal();
            }
        }

        // Show dispense animation
        function showDispenseAnimation(data) {
            const content = document.getElementById('modal-content');
            const supplements = data.supplements || [];

            content.innerHTML = `
                <div class="dispense-animation">
                    <div class="glass-container">
                        <div class="glass">
                            <div class="glass-water" id="water"></div>
                        </div>
                        <div class="dropping-supplements" id="dropping">
                            ${supplements.map((s, i) => `
                                <span class="dropping-pill" style="animation-delay: ${0.2 * i}s"></span>
                            `).join('')}
                        </div>
                    </div>
                    <div class="dispense-message">Dispensing your dose...</div>
                    <div class="dispense-details">${supplements.length} supplements</div>
                </div>
            `;

            // Start animation
            setTimeout(() => {
                document.getElementById('water').classList.add('filling');
            }, 100);

            // Show success after animation
            setTimeout(() => {
                showDispenseSuccess(data);
            }, 2500);
        }

        // Show dispense success
        function showDispenseSuccess(data) {
            const content = document.getElementById('modal-content');
            const supplements = data.supplements || [];

            content.innerHTML = `
                <div class="dispense-animation">
                    <div style="font-size: 4em; margin-bottom: 16px;">&#x2705;</div>
                    <div class="dispense-message">Dose Ready!</div>
                    <div class="dispense-details">Your supplements have been dispensed</div>

                    <div class="dispensed-list">
                        ${supplements.map(s => `
                            <div class="dispensed-item">
                                <span>${s.name}</span>
                                <span>${s.dose}${s.unit}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 20px;">
                    <button class="btn-dispense" onclick="closeDispenseModal(); loadAllData();" style="width: 100%;">
                        Done
                    </button>
                </div>
            `;
        }

        // Toggle settings
        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('hidden');
        }

        function openSettings() {
            document.getElementById('settings-panel').classList.remove('hidden');
            loadNotificationPreferences();
        }

        // ========== PUSH NOTIFICATIONS ==========

        // Notification state
        let notificationTimers = [];

        // Check if notifications are supported and load preferences
        async function loadNotificationPreferences() {
            if (!('Notification' in window)) {
                document.getElementById('enable-notifications-btn').textContent = 'Not supported in this browser';
                document.getElementById('enable-notifications-btn').disabled = true;
                return;
            }

            const permission = Notification.permission;

            if (permission === 'granted') {
                // Show enabled state
                document.getElementById('notification-disabled').classList.add('hidden');
                document.getElementById('notification-enabled').classList.remove('hidden');

                // Load saved preferences from localStorage
                const prefs = JSON.parse(localStorage.getItem('notificationPrefs') || '{}');
                document.getElementById('morning-enabled').checked = prefs.morning_reminder !== false;
                document.getElementById('evening-enabled').checked = prefs.evening_reminder !== false;
                document.getElementById('morning-time').value = prefs.morning_time || '07:00';
                document.getElementById('evening-time').value = prefs.evening_time || '21:00';

                // Schedule notifications
                scheduleNotifications();
            } else if (permission === 'denied') {
                document.getElementById('notification-blocked-hint').style.display = 'block';
                document.getElementById('enable-notifications-btn').disabled = true;
            } else {
                // Default state - show enable button
                document.getElementById('notification-disabled').classList.remove('hidden');
                document.getElementById('notification-enabled').classList.add('hidden');
            }
        }

        // Request notification permission
        async function enableNotifications() {
            try {
                const permission = await Notification.requestPermission();

                if (permission === 'granted') {
                    showStatus('Notifications enabled!', 'success');

                    // Save default preferences
                    const defaultPrefs = {
                        enabled: true,
                        morning_reminder: true,
                        evening_reminder: true,
                        morning_time: '07:00',
                        evening_time: '21:00'
                    };
                    localStorage.setItem('notificationPrefs', JSON.stringify(defaultPrefs));

                    // Update UI
                    loadNotificationPreferences();

                    // Show a test notification
                    new Notification('Dose Reminders Enabled', {
                        body: 'You\'ll get reminders to take your supplements.',
                        icon: '/static/icon-192.png'
                    });
                } else if (permission === 'denied') {
                    showStatus('Notifications blocked. Enable in browser settings.', 'error');
                    document.getElementById('notification-blocked-hint').style.display = 'block';
                }
            } catch (e) {
                showStatus('Error enabling notifications', 'error');
                console.error('Notification error:', e);
            }
        }

        // Disable notifications
        function disableNotifications() {
            // Clear scheduled notifications
            notificationTimers.forEach(timer => clearTimeout(timer));
            notificationTimers = [];

            // Clear preferences
            localStorage.removeItem('notificationPrefs');

            // Update UI
            document.getElementById('notification-enabled').classList.add('hidden');
            document.getElementById('notification-disabled').classList.remove('hidden');

            showStatus('Notifications disabled', 'success');
        }

        // Update notification preferences
        function updateNotificationPrefs() {
            const prefs = {
                enabled: true,
                morning_reminder: document.getElementById('morning-enabled').checked,
                evening_reminder: document.getElementById('evening-enabled').checked,
                morning_time: document.getElementById('morning-time').value || '07:00',
                evening_time: document.getElementById('evening-time').value || '21:00'
            };
            localStorage.setItem('notificationPrefs', JSON.stringify(prefs));

            // Reschedule notifications
            scheduleNotifications();
        }

        // Toggle afternoon stack preference
        async function toggleAfternoonStack() {
            if (!currentUserId) return;

            const enabled = document.getElementById('afternoon-stack-toggle').checked;
            const afternoonBtn = document.getElementById('time-btn-afternoon');

            // Update UI immediately
            if (afternoonBtn) {
                afternoonBtn.style.display = enabled ? 'inline-flex' : 'none';
            }

            // Save to backend
            try {
                await fetch(`/users/${currentUserId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ afternoon_stack_enabled: enabled })
                });
                showStatus(enabled ? 'Afternoon stack enabled' : 'Afternoon stack disabled', 'success');
                updateTimeButtons();
            } catch (e) {
                console.error('Error updating afternoon stack preference:', e);
                showStatus('Failed to save preference', 'error');
            }
        }

        // Initialize afternoon stack toggle from user data
        function initAfternoonStackToggle(enabled) {
            const toggle = document.getElementById('afternoon-stack-toggle');
            if (toggle) {
                toggle.checked = enabled || false;
            }
        }

        // Schedule notifications for today
        function scheduleNotifications() {
            // Clear existing timers
            notificationTimers.forEach(timer => clearTimeout(timer));
            notificationTimers = [];

            if (Notification.permission !== 'granted') return;

            const prefs = JSON.parse(localStorage.getItem('notificationPrefs') || '{}');
            const now = new Date();

            // Schedule morning notification
            if (prefs.morning_reminder !== false) {
                const morningTime = prefs.morning_time || '07:00';
                const [mHours, mMinutes] = morningTime.split(':').map(Number);
                const morningDate = new Date();
                morningDate.setHours(mHours, mMinutes, 0, 0);

                if (morningDate > now) {
                    const delay = morningDate - now;
                    const timer = setTimeout(() => showSupplementReminder('morning'), delay);
                    notificationTimers.push(timer);
                }
            }

            // Schedule evening notification
            if (prefs.evening_reminder !== false) {
                const eveningTime = prefs.evening_time || '21:00';
                const [eHours, eMinutes] = eveningTime.split(':').map(Number);
                const eveningDate = new Date();
                eveningDate.setHours(eHours, eMinutes, 0, 0);

                if (eveningDate > now) {
                    const delay = eveningDate - now;
                    const timer = setTimeout(() => showSupplementReminder('bedtime'), delay);
                    notificationTimers.push(timer);
                }
            }
        }

        // Show supplement reminder notification
        function showSupplementReminder(timeOfDay) {
            if (Notification.permission !== 'granted') return;

            const greeting = timeOfDay === 'morning' ? 'Good morning!' : 'Evening reminder!';

            new Notification(greeting, {
                body: 'Time to take your supplements.',
                icon: '/static/icon-192.png',
                tag: `supplement-${timeOfDay}`,
                requireInteraction: true
            });
        }

        // Test notification
        function testNotification() {
            if (Notification.permission !== 'granted') {
                showStatus('Please enable notifications first', 'error');
                return;
            }

            new Notification('Test Notification', {
                body: 'Your supplement reminders are working!',
                icon: '/static/icon-192.png'
            });
        }

        // Initialize notifications on page load
        document.addEventListener('DOMContentLoaded', () => {
            if ('Notification' in window && Notification.permission === 'granted') {
                scheduleNotifications();
            }
        });

        // Account Reset Functions
        function confirmResetAccount() {
            document.getElementById('settings-panel').classList.add('hidden');
            document.getElementById('reset-confirm-modal').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('reset-confirm-modal').classList.add('hidden');
        }

        async function executeResetAccount() {
            if (!currentUserId) {
                showStatus('No user logged in', 'error');
                return;
            }

            try {
                const btn = document.querySelector('.btn-confirm-reset');
                btn.textContent = 'Resetting...';
                btn.disabled = true;

                const res = await fetch(`/users/${currentUserId}/reset`, {
                    method: 'POST'
                });

                if (!res.ok) {
                    throw new Error('Failed to reset account');
                }

                const data = await res.json();
                console.log('Account reset:', data);

                // Close modal
                closeResetModal();

                // Show success message
                showStatus('Account reset successfully! Starting fresh...', 'success');

                // Clear local storage
                localStorage.removeItem('userId');
                localStorage.removeItem('onboardingComplete');

                // Reload the page to start fresh
                setTimeout(() => {
                    window.location.reload();
                }, 1500);

            } catch (err) {
                console.error('Reset error:', err);
                showStatus('Failed to reset account: ' + err.message, 'error');
                const btn = document.querySelector('.btn-confirm-reset');
                btn.textContent = 'Yes, Reset Everything';
                btn.disabled = false;
            }
        }

        // Close reset modal when clicking outside
        document.getElementById('reset-confirm-modal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeResetModal();
            }
        });

        // Load scenario
        async function loadScenario() {
            const scenario = document.getElementById('scenario').value;
            if (!currentUserId || scenario === 'none') return;

            try {
                const res = await fetch(`/integrations/${currentUserId}/mock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scenario: scenario })
                });

                if (res.ok) {
                    showStatus(`Loaded ${scenario} scenario`, 'success');
                    loadAllData();
                } else {
                    showStatus('Error loading scenario', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // ========== Custom Blend Builder ==========

        let selectedSupplements = {};
        let allSupplements = [];
        let aiSuggestions = [];
        let aiBlendName = 'Custom Blend';
        let aiBlendIcon = '<svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M9 3h6v5l4 9a2 2 0 01-2 3H7a2 2 0 01-2-3l4-9V3z"/><line x1="9" y1="3" x2="15" y2="3"/></svg>';

        // Open blend builder
        async function openBlendBuilder() {
            document.getElementById('blend-builder-modal').classList.remove('hidden');
            document.getElementById('blend-name').value = '';
            document.getElementById('blend-icon').value = '&#x1F9EA;';
            selectedSupplements = {};
            aiSuggestions = [];

            await loadSupplements();
            renderSupplementGrid();
            updateSelectedSupplements();
        }

        // Close blend builder
        function closeBlendBuilder() {
            document.getElementById('blend-builder-modal').classList.add('hidden');
        }

        // Load all supplements
        async function loadSupplements() {
            try {
                const res = await fetch('/mixes/catalog');
                if (res.ok) {
                    const data = await res.json();
                    allSupplements = data.supplements || [];
                    renderCategories();
                }
            } catch (e) {
                console.error('Error loading supplements:', e);
            }
        }

        // Render categories
        function renderCategories() {
            const categories = [...new Set(allSupplements.map(s => s.category).filter(Boolean))];
            const container = document.getElementById('supplement-categories');

            container.innerHTML = `
                <button class="category-btn active" onclick="filterCategory('all')">All</button>
                ${categories.map(cat => `
                    <button class="category-btn" onclick="filterCategory('${cat}')">${cat.replace('_', ' ')}</button>
                `).join('')}
            `;
        }

        // Filter by category
        function filterCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            renderSupplementGrid(category);
        }

        // Render supplement grid
        function renderSupplementGrid(category = 'all') {
            const grid = document.getElementById('supplement-grid');
            let supplements = allSupplements;

            if (category !== 'all') {
                supplements = allSupplements.filter(s => s.category === category);
            }

            grid.innerHTML = supplements.map(s => `
                <div class="supplement-card ${selectedSupplements[s.id] ? 'selected' : ''}"
                     onclick="toggleSupplement('${s.id}')">
                    <div class="supplement-card-header">
                        <span class="supplement-card-name">${s.name}</span>
                        <span class="supplement-card-dose">${s.standard_dose}${s.unit}</span>
                    </div>
                    <div class="supplement-card-desc">${s.description}</div>
                    <div class="supplement-card-benefits">
                        ${(s.benefits || []).slice(0, 3).map(b => `<span class="benefit-tag">${b}</span>`).join('')}
                    </div>
                    ${s.pubmed_studies && s.pubmed_studies.length > 0 ? `
                        <div class="supplement-card-links">
                            ${s.pubmed_studies.slice(0, 2).map(link => `
                                <a href="${link.url}" target="_blank" class="pubmed-link" onclick="event.stopPropagation()">
                                    ${link.title.substring(0, 50)}...
                                </a>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Toggle supplement selection
        function toggleSupplement(id) {
            const supp = allSupplements.find(s => s.id === id);
            if (!supp) return;

            if (selectedSupplements[id]) {
                delete selectedSupplements[id];
            } else {
                selectedSupplements[id] = {
                    supplement_id: id,
                    name: supp.name,
                    dose: supp.standard_dose,
                    unit: supp.unit,
                    min_dose: supp.standard_dose * 0.5,
                    max_dose: supp.max_daily_dose
                };
            }

            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
        }

        // Update selected supplements display
        function updateSelectedSupplements() {
            const container = document.getElementById('selected-supplements');
            const list = document.getElementById('selected-supplements-list');
            const selected = Object.values(selectedSupplements);

            if (selected.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            list.innerHTML = selected.map(s => `
                <div class="selected-supp-item">
                    <span class="selected-supp-name">${s.name}</span>
                    <div class="selected-supp-dose">
                        <div class="dose-controls">
                            <input type="number" class="dose-input" value="${s.dose}"
                                min="${s.min_dose}" max="${s.max_dose}"
                                onchange="updateDose('${s.supplement_id}', this.value)">
                            <span class="dose-unit">${s.unit}</span>
                        </div>
                        <span class="dose-range">(${s.min_dose}-${s.max_dose})</span>
                        <button class="btn-remove-supp" onclick="removeSupplement('${s.supplement_id}')">&#x2715;</button>
                    </div>
                </div>
            `).join('');
        }

        // Update dose
        function updateDose(id, value) {
            if (selectedSupplements[id]) {
                selectedSupplements[id].dose = parseFloat(value);
            }
        }

        // Remove supplement
        function removeSupplement(id) {
            delete selectedSupplements[id];
            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
        }

        // AI Blend suggestion
        async function getAIBlendSuggestion() {
            const input = document.getElementById('ai-blend-input').value.trim();
            if (!input) {
                showStatus('Please describe what you want', 'error');
                return;
            }

            const suggestionsDiv = document.getElementById('ai-suggestions');
            const listDiv = document.getElementById('ai-suggestions-list');

            suggestionsDiv.classList.add('visible');
            listDiv.innerHTML = '<div class="ai-loading">Thinking</div>';

            try {
                const res = await fetch('/mixes/suggest-blend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_request: input, user_id: currentUserId })
                });

                if (res.ok) {
                    const data = await res.json();
                    aiSuggestions = data.supplements || [];
                    aiBlendName = data.blend_name || 'Custom Blend';
                    aiBlendIcon = data.blend_icon || '<svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M9 3h6v5l4 9a2 2 0 01-2 3H7a2 2 0 01-2-3l4-9V3z"/><line x1="9" y1="3" x2="15" y2="3"/></svg>';
                    renderAISuggestions(data.summary);
                } else {
                    listDiv.innerHTML = '<p style="color: #EF4444;">Error getting suggestions</p>';
                }
            } catch (e) {
                listDiv.innerHTML = '<p style="color: #EF4444;">Error: ' + e.message + '</p>';
            }
        }

        // Render AI suggestions
        function renderAISuggestions(summary) {
            const listDiv = document.getElementById('ai-suggestions-list');

            if (aiSuggestions.length === 0) {
                listDiv.innerHTML = '<p style="color: #888;">No suggestions found. Try a different description.</p>';
                return;
            }

            // Show summary and suggested blend name
            let html = '';
            if (summary) {
                html += `<div style="color: #A78BFA; margin-bottom: 12px; font-size: 0.9em;">${summary}</div>`;
            }

            html += aiSuggestions.map(s => {
                // Look up supplement details from catalog
                const supp = allSupplements.find(sup => sup.id === s.supplement_id);
                const name = supp ? supp.name : s.supplement_id;
                const unit = supp ? supp.unit : 'mg';

                return `
                    <div class="ai-suggestion-item" onclick="addSuggestion('${s.supplement_id}', ${s.dose})">
                        <div>
                            <div class="ai-suggestion-name">${name}</div>
                            <div class="ai-suggestion-reason">${s.reason}</div>
                        </div>
                        <span class="ai-suggestion-dose">${s.dose}${unit}</span>
                    </div>
                `;
            }).join('');

            // Add "Add All" button
            html += `<button class="btn-dispense" onclick="addAllSuggestions()" style="margin-top: 12px; width: 100%;">Add All to Blend</button>`;

            listDiv.innerHTML = html;

            // Auto-fill blend name if empty
            const blendNameInput = document.getElementById('blend-name');
            if (!blendNameInput.value) {
                blendNameInput.value = aiBlendName;
            }
            const blendIconInput = document.getElementById('blend-icon');
            if (blendIconInput.value === '&#x1F9EA;' || !blendIconInput.value) {
                blendIconInput.value = aiBlendIcon;
            }
        }

        // Add single suggestion
        function addSuggestion(id, dose) {
            const suggestion = aiSuggestions.find(s => s.supplement_id === id);
            if (!suggestion) return;

            const supp = allSupplements.find(s => s.id === id);
            if (!supp) return;

            selectedSupplements[id] = {
                supplement_id: id,
                name: supp.name,
                dose: dose || suggestion.dose,
                unit: supp.unit,
                min_dose: supp.standard_dose * 0.5,
                max_dose: supp.max_daily_dose
            };

            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
            showStatus(`Added ${supp.name}`, 'success');
        }

        // Add all suggestions
        function addAllSuggestions() {
            aiSuggestions.forEach(s => {
                const supp = allSupplements.find(sup => sup.id === s.supplement_id);
                if (supp) {
                    selectedSupplements[s.supplement_id] = {
                        supplement_id: s.supplement_id,
                        name: supp.name,
                        dose: s.dose,
                        unit: supp.unit,
                        min_dose: supp.standard_dose * 0.5,
                        max_dose: supp.max_daily_dose
                    };
                }
            });

            renderSupplementGrid(document.querySelector('.category-btn.active')?.textContent || 'all');
            updateSelectedSupplements();
            showStatus(`Added ${aiSuggestions.length} supplements`, 'success');
        }

        // Save custom blend
        async function saveCustomBlend() {
            const name = document.getElementById('blend-name').value.trim();
            const icon = document.getElementById('blend-icon').value || '&#x1F9EA;';
            const supplements = Object.values(selectedSupplements);

            if (!name) {
                showStatus('Please enter a blend name', 'error');
                return;
            }

            if (supplements.length === 0) {
                showStatus('Please select at least one supplement', 'error');
                return;
            }

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        icon,
                        components: supplements.map(s => ({
                            supplement_id: s.supplement_id,
                            dose: s.dose
                        }))
                    })
                });

                if (res.ok) {
                    showStatus('Blend created!', 'success');
                    closeBlendBuilder();
                    loadCustomBlends();
                    loadMixes();
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error creating blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Delete custom blend
        async function deleteCustomBlend(blendId) {
            if (!confirm('Delete this blend?')) return;

            try {
                const res = await fetch(`/mixes/blends/${currentUserId}/${blendId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    showStatus('Blend deleted', 'success');
                    loadCustomBlends();
                    loadMixes();
                } else {
                    showStatus('Error deleting blend', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // ========== ANALYTICS FUNCTIONS ==========

        // Switch between Dashboard and Analytics tabs
        function switchMainTab(tab) {
            document.getElementById('nav-dashboard').classList.toggle('active', tab === 'dashboard');
            document.getElementById('nav-analytics').classList.toggle('active', tab === 'analytics');
            document.getElementById('nav-dispenser').classList.toggle('active', tab === 'dispenser');

            const dashboardSection = document.getElementById('dashboard-section');
            const analyticsSection = document.getElementById('analytics-section');
            const dispenserSection = document.getElementById('dispenser-section');

            // Hide all sections first
            dashboardSection.classList.add('hidden-section');
            analyticsSection.classList.remove('active');
            dispenserSection.classList.remove('active');

            if (tab === 'dashboard') {
                dashboardSection.classList.remove('hidden-section');
                loadTodaysStackData();
            } else if (tab === 'analytics') {
                analyticsSection.classList.add('active');
                loadAnalyticsData();
            } else if (tab === 'dispenser') {
                dispenserSection.classList.add('active');
            }
        }

        // Load minimal data for Today's Stack on Dashboard
        async function loadTodaysStackData() {
            console.log('[Stack] loadTodaysStackData called');
            if (!currentUserId) {
                console.log('[Stack] No currentUserId, returning');
                return;
            }

            // Load supplement library if not already loaded
            if (!supplementLibrary) {
                await loadSupplementLibrary();
            }

            try {
                // Always fetch fresh analytics data (includes health data for Oura display)
                console.log('[Stack] Fetching analytics data...');
                const res = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                console.log('[Stack] Analytics response status:', res.status);
                if (res.ok) {
                    analyticsData = await res.json();
                    console.log('[Stack] analyticsData set, health_data length:', analyticsData?.health_data?.length);
                    console.log('[Stack] health_data sources:', analyticsData?.health_data?.map(h => h.source));
                } else {
                    console.log('[Stack] Analytics response not ok');
                }
                loadTodaysStack();
                // Update Oura metrics for the selected date
                updateOuraMetricsForSelectedDate();
            } catch (e) {
                console.error('Error loading Your Stack:', e);
            }
        }

        // Get time-based greeting
        function getTimeGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Morning';
            if (hour < 18) return 'Afternoon';
            return 'Evening';
        }


        // Load all analytics data
        async function loadAnalyticsData() {
            if (!currentUserId) return;

            // Load supplement library if not already loaded
            if (!supplementLibrary) {
                await loadSupplementLibrary();
            }

            try {
                const res = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                if (res.ok) {
                    analyticsData = await res.json();
                    renderSupplementsGrid();
                    renderHealthChart();
                    renderSupplementMarkers();
                    loadSupplementInsights(); // Load the new insights feature
                    renderLifeEvents();
                    // Also refresh Your Stack on Dashboard
                    loadTodaysStack();
                    // Update progressive disclosure elements
                    updateProgressiveDisclosure();
                }
            } catch (e) {
                console.error('Error loading analytics:', e);
            }
        }

        // Load and render supplement insights
        async function loadSupplementInsights() {
            if (!currentUserId) return;

            const container = document.getElementById('insights-content');

            try {
                const res = await fetch(`/analytics/${currentUserId}/supplement-insights`);
                if (res.ok) {
                    const data = await res.json();
                    supplementInsightsData = data; // Store globally for supplement cards
                    if (container) {
                        renderSupplementInsights(data);
                    }
                    // Re-render supplements grid with insights data
                    renderSupplementsGrid();
                } else if (container) {
                    container.innerHTML = '<div class="insights-empty"><div class="insights-empty-icon"><svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></div><div>Unable to load insights</div></div>';
                }
            } catch (e) {
                console.error('Error loading supplement insights:', e);
                if (container) {
                    container.innerHTML = '<div class="insights-empty"><div class="insights-empty-icon"><svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></div><div>Unable to load insights</div></div>';
                }
            }
        }

        // Render supplement insights
        function renderSupplementInsights(data) {
            const container = document.getElementById('insights-content');
            if (!container) return;

            const { impact_analysis, consistency_tracking, summary } = data;

            if (summary.total_supplements === 0) {
                container.innerHTML = `
                    <div class="insights-empty">
                        <div class="insights-empty-icon"><svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></div>
                        <div>No supplements to analyze yet</div>
                        <div style="font-size: 0.85em; margin-top: 8px; color: #666;">Add supplements you're taking to see insights</div>
                    </div>
                `;
                return;
            }

            let html = '';

            // Impact Analysis Section
            if (impact_analysis.length > 0) {
                html += '<div class="insights-section-title"><svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M18 20V10M12 20V4M6 20v-6"/></svg> Impact Analysis</div>';

                impact_analysis.forEach(insight => {
                    const hasData = insight.has_sufficient_data && insight.change !== null;
                    const isPositive = insight.is_positive;
                    const cardClass = !hasData ? 'pending' : (isPositive ? 'positive' : 'negative');
                    const badgeClass = !hasData ? 'pending' : (isPositive ? 'positive' : 'negative');

                    let badgeText = '';
                    if (!hasData) {
                        badgeText = insight.message || 'Collecting data...';
                    } else {
                        const sign = insight.change_pct > 0 ? '+' : '';
                        badgeText = `${sign}${insight.change_pct}%`;
                    }

                    // Get mechanism explanation for this supplement
                    const suppIdLower = (insight.supplement_id || insight.supplement_name.toLowerCase().replace(/\s+/g, '_')).toLowerCase();
                    const mechanism = SUPPLEMENT_MECHANISMS[suppIdLower] || SUPPLEMENT_MECHANISMS[suppIdLower.replace('-', '_')];

                    html += `
                        <div class="insight-card ${cardClass}">
                            <div class="insight-header">
                                <div>
                                    <div class="insight-supp-name">${insight.supplement_name}</div>
                                    <div class="insight-start-date">Started ${formatDateShort(insight.start_date)}  ${insight.days_on} days</div>
                                </div>
                                <div class="insight-badge ${badgeClass}">${badgeText}</div>
                            </div>
                            ${mechanism ? `
                            <div class="insight-mechanism">
                                <svg class="insight-mechanism-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                                <span>${mechanism}</span>
                            </div>
                            ` : ''}
                    `;

                    if (hasData) {
                        const changeClass = isPositive ? 'positive' : 'negative';
                        const arrow = isPositive ? '' : '';
                        const trendIcon = isPositive
                            ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>'
                            : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>';

                        // Calculate progress bar widths (normalize to percentage of max)
                        const maxScore = 100; // Assume scores are out of 100
                        const beforePct = Math.min((insight.before_avg / maxScore) * 100, 100);
                        const afterPct = Math.min((insight.after_avg / maxScore) * 100, 100);

                        html += `
                            <div class="insight-progress">
                                <div class="insight-progress-header">
                                    <span class="insight-progress-label">${insight.metric_display_name}</span>
                                    <span class="insight-progress-change ${changeClass}">
                                        ${trendIcon}
                                        ${arrow} ${Math.abs(insight.change_pct)}%
                                    </span>
                                </div>
                                <div class="insight-progress-bar-container">
                                    <div class="insight-progress-before" style="width: ${beforePct}%">
                                        ${insight.before_avg}
                                    </div>
                                    <div class="insight-progress-after ${changeClass}" style="width: ${afterPct}%">
                                        ${insight.after_avg}
                                    </div>
                                </div>
                                <div class="insight-progress-labels">
                                    <span>Before</span>
                                    <span>After ${insight.days_on} days</span>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="color: #888; font-size: 0.85em; margin: 8px 0;">
                                Tracking ${insight.metric_display_name}  ${insight.expected_effect}
                            </div>
                        `;
                    }

                    // Footer with confidence and adherence
                    const confidenceClass = insight.confidence === 'high' || insight.confidence === 'very_high' ? 'high' :
                                           insight.confidence === 'medium' ? 'medium' : 'low';
                    const confidenceText = hasData ? (
                        insight.confidence === 'high' || insight.confidence === 'very_high' ? 'High confidence' :
                        insight.confidence === 'medium' ? 'Medium confidence' : 'Low confidence'
                    ) : 'Gathering data';

                    html += `
                            <div class="insight-footer">
                                <div class="insight-confidence">
                                    <span class="insight-confidence-dot ${confidenceClass}"></span>
                                    <span>${confidenceText}</span>
                                </div>
                                <div class="insight-adherence">
                                    ${insight.streak_days > 0 ? `<span class="insight-streak"><svg class="inline-icon streak-icon" viewBox="0 0 24 24" fill="none" stroke="#F97316" stroke-width="2" width="14" height="14"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/></svg> ${insight.streak_days} day streak</span>` : ''}
                                    <span>${insight.adherence_pct}% adherence</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // Consistency Tracking Section
            if (consistency_tracking.length > 0) {
                html += '<div class="insights-section-title"><svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Consistency Tracking</div>';
                html += '<div class="consistency-info">These supplements have long-term benefits that build over months. Keep taking them consistently!</div>';
                html += '<div class="consistency-grid">';

                consistency_tracking.forEach(supp => {
                    const barWidth = Math.min(100, supp.adherence_pct);
                    html += `
                        <div class="consistency-card">
                            <div class="consistency-header">
                                <div class="consistency-name">${supp.supplement_name}</div>
                                ${supp.streak_days > 0 ? `<div class="consistency-streak"><svg class="inline-icon streak-icon" viewBox="0 0 24 24" fill="none" stroke="#F97316" stroke-width="2" width="14" height="14"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/></svg> ${supp.streak_days}d</div>` : ''}
                            </div>
                            <div class="consistency-bar">
                                <div class="consistency-bar-fill" style="width: ${barWidth}%"></div>
                            </div>
                            <div class="consistency-stats">
                                <span>${supp.adherence_pct}% adherence</span>
                                <span>${supp.days_on} days</span>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            container.innerHTML = html;
        }

        // Format date as "Jan 5"
        function formatDateShort(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Current chart timeframe in days (0 = all)
        let chartTimeframeDays = 30;

        // Set chart timeframe and re-render
        function setChartTimeframe(days) {
            chartTimeframeDays = days;

            // Update button states
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Re-render chart with new timeframe
            renderHealthChart();
        }

        // Render health metrics chart
        function renderHealthChart() {
            const ctx = document.getElementById('health-chart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (healthChart) {
                healthChart.destroy();
            }

            let healthData = [...(analyticsData?.health_data || [])];
            if (healthData.length === 0) {
                return;
            }

            // Sort by date
            healthData.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Filter by timeframe
            if (chartTimeframeDays > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - chartTimeframeDays);
                healthData = healthData.filter(d => new Date(d.date) >= cutoffDate);
            }

            const labels = healthData.map(d => d.date);
            const sleepScores = healthData.map(d => d.sleep_score);
            const hrvScores = healthData.map(d => d.hrv_score);
            const recoveryScores = healthData.map(d => d.recovery_score);

            // Get supplement start dates for vertical lines
            const supplementStarts = analyticsData?.supplement_starts || [];
            const lifeEvents = analyticsData?.life_events || [];

            // Create annotations for supplement starts (different colors for manual vs recommended)
            const annotations = {};
            supplementStarts.forEach((start, i) => {
                const isManual = start.is_manual;
                const color = isManual ? '#22C55E' : '#8B5CF6';
                const bgColor = isManual ? 'rgba(34, 197, 94, 0.8)' : 'rgba(139, 92, 246, 0.8)';

                annotations[`supp-${i}`] = {
                    type: 'line',
                    xMin: start.start_date,
                    xMax: start.start_date,
                    borderColor: color,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: {
                        display: true,
                        content: (start.supplement_name || start.supplement_id.replace(/_/g, ' ')).substring(0, 15),
                        position: 'start',
                        backgroundColor: bgColor,
                        color: '#fff',
                        font: { size: 10 }
                    }
                };
            });

            // Add life event markers
            lifeEvents.forEach((event, i) => {
                const color = event.impact === 'positive' ? '#22C55E' :
                              event.impact === 'negative' ? '#EF4444' : '#666';
                annotations[`event-${i}`] = {
                    type: 'line',
                    xMin: event.date,
                    xMax: event.date,
                    borderColor: color,
                    borderWidth: 1,
                    borderDash: [3, 3]
                };
            });

            healthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sleep Score',
                            data: sleepScores,
                            borderColor: '#8B5CF6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'HRV',
                            data: hrvScores,
                            borderColor: '#22C55E',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Recovery',
                            data: recoveryScores,
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.95)',
                            titleColor: '#E8E8E8',
                            bodyColor: '#A0A0A0',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#666',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#666'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });
        }

        // Render supplement start markers
        function renderSupplementMarkers() {
            const container = document.getElementById('supplement-markers-list');
            if (!container) return;

            const starts = analyticsData?.supplement_starts || [];

            // Add legend for marker colors
            let html = `
                <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 0.8em;">
                    <div class="legend-marker">
                        <div class="legend-marker-dot recommended"></div>
                        <span>Tracked</span>
                    </div>
                    <div class="legend-marker">
                        <div class="legend-marker-dot manual"></div>
                        <span>Manual</span>
                    </div>
                </div>
            `;

            html += starts.map(start => {
                const isManual = start.is_manual;
                const dotColor = isManual ? 'background: #22C55E;' : 'background: #8B5CF6;';
                const nameColor = isManual ? 'color: #22C55E;' : 'color: #A78BFA;';

                return `
                    <div class="marker-item" style="${isManual ? 'border-color: rgba(34, 197, 94, 0.2); background: rgba(34, 197, 94, 0.08);' : ''}">
                        <div class="marker-dot" style="${dotColor}"></div>
                        <span class="marker-name" style="${nameColor}">${start.supplement_name || formatSupplementName(start.supplement_id)}</span>
                        <span class="marker-date">${formatDate(start.start_date)}</span>
                    </div>
                `;
            }).join('');

            html += `<button class="add-marker-btn" onclick="openAddSupplementStart()">+ Add Supplement Start</button>`;

            container.innerHTML = html;
        }

        // ========== YOUR STACK - QUICK LOG ==========

        // Load and render Your Stack on Dashboard (uses selected date from date nav)
        async function loadTodaysStack() {
            const stackContainer = document.getElementById('stack-container');
            const dateEl = document.getElementById('todays-stack-date');
            if (!stackContainer) return;

            // Use selected date from date navigation (currentDate)
            const selectedDate = currentDate;
            const selectedDateStr = getLocalDateString(selectedDate);

            // Determine if today, past, or future
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selected = new Date(selectedDate);
            selected.setHours(0, 0, 0, 0);
            const isToday = today.getTime() === selected.getTime();
            const isFuture = selected.getTime() > today.getTime();

            // Format date label
            if (isToday) {
                dateEl.textContent = 'Today';
            } else if (isFuture) {
                dateEl.textContent = selectedDate.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                }) + ' (future)';
            } else {
                dateEl.textContent = selectedDate.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // Handle future dates - show message instead of logging pills
            if (isFuture) {
                const morningPills = document.getElementById('morning-pills');
                const intradayPills = document.getElementById('intraday-pills');
                const eveningPills = document.getElementById('evening-pills');
                if (morningPills) morningPills.innerHTML = '<div class="stack-empty-hint">Future date - navigate to today to log</div>';
                if (intradayPills) intradayPills.innerHTML = '';
                if (eveningPills) eveningPills.innerHTML = '';
                return;
            }

            // Get active supplements from analytics data
            const activeSupplements = (analyticsData?.supplement_starts || [])
                .filter(s => !s.end_date);

            // Get logs for selected date (NOT auto-populated)
            const selectedDateLogs = (analyticsData?.supplement_logs || [])
                .filter(l => l.date === selectedDateStr);

            // Build lookup for what's already logged ON THIS DATE
            const loggedOnDate = {};
            selectedDateLogs.forEach(log => {
                if (log.taken) {
                    loggedOnDate[log.supplement_id] = log.time_taken || 'morning';
                }
            });

            // Render the pills
            renderTodaysStack(activeSupplements, loggedOnDate);
        }

        // Get recommended dose based on health metrics
        function getRecommendedDose(suppId) {
            const config = DOSE_ADJUSTMENTS[suppId];
            if (!config) return null;

            // Get today's health data
            const healthData = analyticsData?.health_data || [];
            const today = getLocalDateString(new Date());
            const todayData = healthData.find(h => h.date === today) || healthData[healthData.length - 1];

            if (!todayData) return { dose: config.default, adjusted: false };

            const sleepScore = todayData.sleep_score;
            const hrvScore = todayData.hrv_score;

            // Sleep-based supplements
            if (config.poor_sleep && sleepScore && sleepScore < 60) {
                return { dose: config.poor_sleep, adjusted: true, reason: 'poor sleep' };
            }
            if (config.good_sleep && sleepScore && sleepScore > 80) {
                return { dose: config.good_sleep, adjusted: true, reason: 'good sleep' };
            }

            // Stress-based supplements
            if (config.high_stress && hrvScore && hrvScore < 40) {
                return { dose: config.high_stress, adjusted: true, reason: 'high stress' };
            }
            if (config.low_stress && hrvScore && hrvScore > 70) {
                return { dose: config.low_stress, adjusted: true, reason: 'low stress' };
            }

            return { dose: config.default, adjusted: false };
        }

        // Drag and drop functions
        function dragPill(event) {
            const pill = event.target.closest('.stack-pill');
            if (!pill) return;
            event.dataTransfer.setData('suppId', pill.dataset.suppId);
            event.dataTransfer.effectAllowed = 'move';
            pill.classList.add('dragging');
        }

        function allowDrop(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function dragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function dropPill(event) {
            event.preventDefault();
            const section = event.currentTarget;
            section.classList.remove('drag-over');

            const suppId = event.dataTransfer.getData('suppId');
            if (!suppId) return;

            const newTime = section.dataset.time; // 'morning', 'intraday', 'evening'

            // Move the pill element
            const pill = document.getElementById(`stack-pill-${suppId}`);
            if (pill) {
                pill.classList.remove('dragging');
                section.querySelector('.stack-section-pills').appendChild(pill);
            }

            // Save new timing preference to localStorage
            saveSupplementTiming(suppId, newTime);
        }

        function saveSupplementTiming(suppId, timeSlot) {
            const userTimings = JSON.parse(localStorage.getItem('userSupplementTimings') || '{}');
            userTimings[suppId] = timeSlot;
            localStorage.setItem('userSupplementTimings', JSON.stringify(userTimings));
        }

        // Inline dose editing
        function editDose(suppId, event) {
            if (event) event.stopPropagation();

            const doseEl = document.getElementById(`dose-${suppId}`);
            if (!doseEl || doseEl.querySelector('input')) return; // Already editing

            const currentDose = doseEl.textContent.replace(/^[]\s*/, '').trim();

            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentDose === 'Set dose' ? '' : currentDose;
            input.className = 'dose-input';
            input.placeholder = 'e.g., 400mg';

            doseEl.innerHTML = '';
            doseEl.appendChild(input);
            input.focus();
            input.select();

            const saveDose = () => {
                const newDose = input.value.trim() || 'Set dose';
                doseEl.textContent = newDose;

                // Save to localStorage
                const userDoses = JSON.parse(localStorage.getItem('userSupplementDoses') || '{}');
                userDoses[suppId] = newDose;
                localStorage.setItem('userSupplementDoses', JSON.stringify(userDoses));
            };

            input.addEventListener('blur', saveDose);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    doseEl.textContent = currentDose;
                }
            });
        }

        // Render Today's Stack pills - split into Morning, Intra-Day, and Evening sections
        function renderTodaysStack(supplements, loggedToday) {
            const morningPills = document.getElementById('morning-pills');
            const intradayPills = document.getElementById('intraday-pills');
            const eveningPills = document.getElementById('evening-pills');

            if (!morningPills) return;

            // Get user's custom timings and doses from localStorage
            const userTimings = JSON.parse(localStorage.getItem('userSupplementTimings') || '{}');
            const userDoses = JSON.parse(localStorage.getItem('userSupplementDoses') || '{}');

            if (supplements.length === 0) {
                const emptyHtml = `
                    <div class="stack-empty-inline">
                        <span>No supplements yet</span>
                        <button onclick="switchMainTab('analytics'); setTimeout(() => openAddManualSupplement(), 100);">+ Add</button>
                    </div>
                `;
                morningPills.innerHTML = emptyHtml;
                intradayPills.innerHTML = '<div class="stack-empty-hint">Add intra-day supplements</div>';
                eveningPills.innerHTML = '<div class="stack-empty-hint">Add evening supplements</div>';
                return;
            }

            // Group supplements by time
            const groups = { morning: [], intraday: [], evening: [] };

            supplements.forEach(supp => {
                const suppId = supp.supplement_id;
                // Check user's custom timing first, then default
                let timing = userTimings[suppId] || SUPPLEMENT_TIMING[suppId] || SUPPLEMENT_TIMING._default || 'morning';
                // Map 'bedtime' to 'evening' for backwards compatibility
                if (timing === 'bedtime') timing = 'evening';
                if (!groups[timing]) timing = 'morning';
                groups[timing].push(supp);
            });

            // Helper to render a single pill
            const renderPill = (supp) => {
                const suppId = supp.supplement_id;
                const suppName = supp.supplement_name || formatSupplementName(suppId);
                const isTaken = loggedToday[suppId] !== undefined;
                const timeTaken = loggedToday[suppId] || '';

                // Get dose: user override > supplement record > recommended > default
                let dose = userDoses[suppId];
                let isAdjusted = false;

                if (!dose && supp.dosage) {
                    // Format the stored dose with proper units
                    dose = formatDoseWithUnit(supp.dosage, suppId);
                }

                if (!dose) {
                    const recommended = getRecommendedDose(suppId);
                    if (recommended) {
                        dose = recommended.dose;
                        isAdjusted = recommended.adjusted;
                    } else {
                        dose = 'Set dose';
                    }
                }

                const dosePrefix = isAdjusted ? ' ' : '';

                return `
                    <div class="stack-pill ${isTaken ? 'taken' : ''}"
                         id="stack-pill-${suppId}"
                         draggable="true"
                         ondragstart="dragPill(event)"
                         data-supp-id="${suppId}"
                         data-supp-name="${suppName.replace(/"/g, '&quot;')}">
                        <div class="stack-pill-check"></div>
                        <div class="stack-pill-content" onclick="toggleStackLog('${suppId}', '${suppName.replace(/'/g, "\\'")}', '${(dose || '').replace(/'/g, "\\'")}')">
                            <div class="stack-pill-name">${suppName}</div>
                            <div class="stack-pill-dose ${isAdjusted ? 'adjusted' : ''}"
                                 onclick="editDose('${suppId}', event)"
                                 id="dose-${suppId}">${dosePrefix}${dose}</div>
                        </div>
                    </div>
                `;
            };

            // Render each group
            morningPills.innerHTML = groups.morning.length > 0
                ? groups.morning.map(renderPill).join('')
                : '<div class="stack-empty-hint">Drag supplements here</div>';

            intradayPills.innerHTML = groups.intraday.length > 0
                ? groups.intraday.map(renderPill).join('')
                : '<div class="stack-empty-hint">Drag supplements here</div>';

            eveningPills.innerHTML = groups.evening.length > 0
                ? groups.evening.map(renderPill).join('')
                : '<div class="stack-empty-hint">Drag supplements here</div>';
        }

        // Toggle a supplement log with one tap
        async function toggleStackLog(suppId, suppName, dosage) {
            if (!currentUserId) return;

            const pill = document.getElementById(`stack-pill-${suppId}`);
            if (!pill) return;

            const isCurrentlyTaken = pill.classList.contains('taken');

            // Use selected date from date navigation
            const selectedDateStr = getLocalDateString(currentDate);

            // Detect which section the pill is in to determine time
            const section = pill.closest('.stack-section');
            const sectionTime = section ? section.dataset.time : 'morning';

            // Map section time to API time format
            let apiTime = 'morning';
            if (sectionTime === 'evening') apiTime = 'bedtime';
            else if (sectionTime === 'intraday') apiTime = 'afternoon';
            else apiTime = 'morning';

            // Optimistic UI update
            pill.classList.toggle('taken', !isCurrentlyTaken);

            try {
                // Call the API with single supplement for the selected date
                const res = await fetch(`/analytics/${currentUserId}/daily-checkin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: selectedDateStr,
                        supplements: [{
                            supplement_id: suppId,
                            taken: !isCurrentlyTaken,
                            time_taken: apiTime
                        }]
                    })
                });

                if (!res.ok) throw new Error('Failed to save');

                // Refresh analytics data in background to keep in sync
                const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                if (analyticsRes.ok) {
                    analyticsData = await analyticsRes.json();
                }

            } catch (e) {
                console.error('Error toggling supplement:', e);
                // Revert UI on error
                pill.classList.toggle('taken', isCurrentlyTaken);
                showStatus('Failed to save. Please try again.', 'error');
            }
        }

        // Quick add a common supplement (one-click from empty state)
        async function quickAddSupplement(suppId, suppName, dosage) {
            if (!currentUserId) return;

            const today = getLocalDateString(new Date());

            try {
                // Add the supplement to tracking
                const res = await fetch(`/analytics/${currentUserId}/supplement-starts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        supplement_id: suppId,
                        supplement_name: suppName,
                        start_date: today,
                        is_manual: true,
                        dosage: dosage,
                        frequency: 'daily'
                    })
                });

                if (res.ok) {
                    showStatus(`${suppName} added!`, 'success');
                    // Refresh analytics data and re-render
                    const analyticsRes = await fetch(`/analytics/${currentUserId}/analytics?days=60`);
                    if (analyticsRes.ok) {
                        analyticsData = await analyticsRes.json();
                        loadTodaysStack();
                    }
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error adding supplement', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // ========== END YOUR STACK ==========

        // Render life events
        function renderLifeEvents() {
            const container = document.getElementById('life-events-list');
            if (!container) return;

            const events = analyticsData?.life_events || [];

            if (events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 16px;">
                        <div style="color: #666;">No life events logged yet</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = events.map(event => {
                const icon = getEventIcon(event.event_type);
                return `
                    <div class="life-event-item">
                        <div class="life-event-icon ${event.impact || 'neutral'}">${icon}</div>
                        <div class="life-event-info">
                            <div class="life-event-type">${formatEventType(event.event_type)}</div>
                            <div class="life-event-date">${formatDate(event.date)}${event.description ? ' - ' + event.description : ''}</div>
                        </div>
                        <button class="life-event-delete" onclick="deleteLifeEvent('${event.id}')">Delete</button>
                    </div>
                `;
            }).join('');
        }

        // Toggle add event form
        function toggleAddEventForm() {
            const form = document.getElementById('add-event-form');
            form.classList.toggle('visible');
            if (form.classList.contains('visible')) {
                document.getElementById('event-date').value = new Date().toISOString().split('T')[0];
            }
        }

        // Save life event
        async function saveLifeEvent() {
            const eventDate = document.getElementById('event-date').value;
            const eventType = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value;
            const impact = document.getElementById('event-impact').value;

            if (!eventDate || !eventType) {
                showStatus('Please select date and event type', 'error');
                return;
            }

            try {
                const res = await fetch(`/analytics/${currentUserId}/life-events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_date: eventDate,
                        event_type: eventType,
                        description: description || null,
                        impact: impact
                    })
                });

                if (res.ok) {
                    showStatus('Life event saved!', 'success');
                    toggleAddEventForm();
                    loadAnalyticsData();
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error saving event', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Delete life event
        async function deleteLifeEvent(eventId) {
            if (!confirm('Delete this life event?')) return;

            try {
                const res = await fetch(`/analytics/${currentUserId}/life-events/${eventId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    showStatus('Event deleted', 'success');
                    loadAnalyticsData();
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Supplement library data
        let supplementLibrary = null;

        // Supplement guidance: timing, dosage notes, and affected metrics
        const SUPPLEMENT_GUIDANCE = {
            vitamin_d3: {
                timing: "morning",
                timingNote: "Take with breakfast (fat helps absorption)",
                affectedMetrics: ["recovery_score"],
                loadingDays: 60,
                dosePerKg: null, // flat dose
                notes: "Fat-soluble, takes 2-3 months to change blood levels"
            },
            fish_oil: {
                timing: "meal",
                timingNote: "Take with any meal",
                affectedMetrics: ["hrv_score", "recovery_score"],
                loadingDays: 28,
                dosePerKg: null,
                notes: "Reduces inflammation, supports heart health"
            },
            magnesium: {
                timing: "bedtime",
                timingNote: "Take 1-2hr before bed",
                affectedMetrics: ["sleep_score", "hrv_score"],
                loadingDays: 14,
                dosePerKg: 4, // ~4mg per kg body weight
                notes: "Promotes relaxation and sleep quality"
            },
            magnesium_glycinate: {
                timing: "bedtime",
                timingNote: "Take 1-2hr before bed",
                affectedMetrics: ["sleep_score", "hrv_score"],
                loadingDays: 14,
                dosePerKg: 4,
                notes: "Best form for sleep, highly absorbable"
            },
            zinc: {
                timing: "bedtime",
                timingNote: "Take with dinner (not with magnesium)",
                affectedMetrics: ["recovery_score"],
                loadingDays: 21,
                dosePerKg: null,
                notes: "Don't take at same time as magnesium"
            },
            ashwagandha: {
                timing: "bedtime",
                timingNote: "Take in evening for stress/sleep",
                affectedMetrics: ["hrv_score", "recovery_score", "sleep_score"],
                loadingDays: 28,
                dosePerKg: null,
                notes: "Adaptogen, reduces cortisol over time"
            },
            l_theanine: {
                timing: "flexible",
                timingNote: "Morning for focus, evening for calm",
                affectedMetrics: ["hrv_score", "sleep_score"],
                loadingDays: 1, // works quickly
                dosePerKg: null,
                notes: "Works within 30-60 minutes"
            },
            melatonin: {
                timing: "bedtime",
                timingNote: "Take 30-60min before bed",
                affectedMetrics: ["sleep_score"],
                loadingDays: 1,
                dosePerKg: null,
                notes: "Start with lowest effective dose (0.5-1mg)"
            },
            creatine: {
                timing: "anytime",
                timingNote: "Take anytime, consistency matters",
                affectedMetrics: ["recovery_score"],
                loadingDays: 28,
                dosePerKg: 0.03, // ~3g for 100kg person
                notes: "Takes 2-4 weeks to saturate muscles"
            },
            glycine: {
                timing: "bedtime",
                timingNote: "Take before bed",
                affectedMetrics: ["sleep_score"],
                loadingDays: 1,
                dosePerKg: null,
                notes: "Improves sleep quality, works quickly"
            },
            rhodiola: {
                timing: "morning",
                timingNote: "Take in morning on empty stomach",
                affectedMetrics: ["recovery_score", "hrv_score"],
                loadingDays: 14,
                dosePerKg: null,
                notes: "Adaptogen for energy and stress"
            },
            gaba: {
                timing: "bedtime",
                timingNote: "Take 30-60min before bed",
                affectedMetrics: ["sleep_score", "hrv_score"],
                loadingDays: 1,
                dosePerKg: null,
                notes: "Promotes relaxation"
            },
            vitamin_b12: {
                timing: "morning",
                timingNote: "Take in morning (can be energizing)",
                affectedMetrics: ["recovery_score"],
                loadingDays: 30,
                dosePerKg: null,
                notes: "Essential for vegans/vegetarians"
            },
            b_complex: {
                timing: "morning",
                timingNote: "Take with breakfast",
                affectedMetrics: ["recovery_score"],
                loadingDays: 14,
                dosePerKg: null,
                notes: "Can be energizing, avoid late in day"
            },
            coq10: {
                timing: "morning",
                timingNote: "Take with breakfast (fat helps)",
                affectedMetrics: ["recovery_score", "hrv_score"],
                loadingDays: 28,
                dosePerKg: null,
                notes: "Supports cellular energy production"
            },
            lions_mane: {
                timing: "morning",
                timingNote: "Take in morning for cognitive benefits",
                affectedMetrics: ["recovery_score"],
                loadingDays: 28,
                dosePerKg: null,
                notes: "Supports brain health and focus"
            },
            turmeric: {
                timing: "meal",
                timingNote: "Take with meals (fat + black pepper help)",
                affectedMetrics: ["recovery_score"],
                loadingDays: 28,
                dosePerKg: null,
                notes: "Anti-inflammatory, pair with black pepper"
            },
            collagen: {
                timing: "anytime",
                timingNote: "Take anytime, consistency matters",
                affectedMetrics: ["recovery_score"],
                loadingDays: 60,
                dosePerKg: null,
                notes: "Takes 2-3 months to see skin/joint benefits"
            },
            iron: {
                timing: "morning",
                timingNote: "Take on empty stomach (not with calcium)",
                affectedMetrics: ["recovery_score"],
                loadingDays: 60,
                dosePerKg: null,
                notes: "Vitamin C improves absorption"
            },
            probiotics: {
                timing: "morning",
                timingNote: "Take on empty stomach in morning",
                affectedMetrics: ["recovery_score"],
                loadingDays: 14,
                dosePerKg: null,
                notes: "Best on empty stomach"
            },
            electrolytes: {
                timing: "flexible",
                timingNote: "During/after exercise or in morning",
                affectedMetrics: ["recovery_score"],
                loadingDays: 1,
                dosePerKg: null,
                notes: "Hydration support"
            },
            caffeine: {
                timing: "morning",
                timingNote: "Take before noon (avoid late day)",
                affectedMetrics: ["recovery_score"],
                loadingDays: 1,
                dosePerKg: null,
                notes: "Avoid within 8-10hr of bedtime"
            },
            vitamin_c: {
                timing: "anytime",
                timingNote: "Take anytime with food",
                affectedMetrics: ["recovery_score"],
                loadingDays: 7,
                dosePerKg: null,
                notes: "Water-soluble, excess is excreted"
            },
            multivitamin: {
                timing: "morning",
                timingNote: "Take with breakfast",
                affectedMetrics: ["recovery_score"],
                loadingDays: 30,
                dosePerKg: null,
                notes: "General nutritional insurance"
            },
            protein_powder: {
                timing: "flexible",
                timingNote: "Post-workout or anytime for protein needs",
                affectedMetrics: ["recovery_score"],
                loadingDays: 1,
                dosePerKg: null,
                notes: "Aim for ~1.6g protein/kg body weight daily"
            },
            elderberry: {
                timing: "anytime",
                timingNote: "Take daily for immune support",
                affectedMetrics: ["recovery_score"],
                loadingDays: 7,
                dosePerKg: null,
                notes: "Immune support"
            }
        };

        // Get timing icon based on timing type
        function getTimingIcon(timing) {
            switch(timing) {
                case 'morning': return '';
                case 'bedtime': return '';
                case 'evening': return ''; // Legacy support
                case 'meal': return '';
                case 'flexible': return '';
                case 'anytime': return '';
                default: return '';
            }
        }

        // Load supplement library
        async function loadSupplementLibrary() {
            try {
                const res = await fetch('/analytics/supplement-library');
                if (res.ok) {
                    supplementLibrary = await res.json();
                }
            } catch (e) {
                console.error('Error loading supplement library:', e);
            }
        }

        // Open add supplement modal (for manual supplements)
        function openAddManualSupplement() {
            document.getElementById('supplement-modal-title').textContent = 'Add Supplement';
            document.getElementById('supplement-modal-subtitle').textContent = 'Track a supplement you\'re taking';
            document.getElementById('start-is-manual').value = 'true';
            populateSupplementDropdown();
            resetSupplementForm();
            document.getElementById('supplement-start-modal').classList.remove('hidden');
        }

        // Open add supplement start modal (for chart markers)
        function openAddSupplementStart() {
            document.getElementById('supplement-modal-title').textContent = 'Add Supplement Start';
            document.getElementById('supplement-modal-subtitle').textContent = 'Track when you started a supplement';
            document.getElementById('start-is-manual').value = 'false';
            populateSupplementDropdown();
            resetSupplementForm();
            document.getElementById('supplement-start-modal').classList.remove('hidden');
        }

        // Open edit supplement modal
        function openEditSupplement(suppId) {
            // Find the supplement in analyticsData
            const supp = (analyticsData?.supplement_starts || []).find(s => s.id === suppId);
            if (!supp) {
                showStatus('Supplement not found', 'error');
                return;
            }

            document.getElementById('supplement-modal-title').textContent = 'Edit Supplement';
            document.getElementById('supplement-modal-subtitle').textContent = 'Update ' + (supp.supplement_name || formatSupplementName(supp.supplement_id));
            document.getElementById('start-is-manual').value = supp.is_manual ? 'true' : 'false';
            document.getElementById('edit-supplement-id').value = suppId;

            populateSupplementDropdown();

            // Set the supplement selection
            const select = document.getElementById('start-supplement-id');
            select.value = supp.supplement_id;
            if (!select.value) {
                // Custom supplement not in list
                select.value = 'custom';
                document.getElementById('custom-name-row').style.display = 'block';
                document.getElementById('start-supplement-name').value = supp.supplement_name || '';
            }
            select.disabled = true; // Can't change supplement type when editing

            // Pre-fill form values
            document.getElementById('start-date').value = supp.start_date;
            document.getElementById('start-date').disabled = false; // Allow editing start date
            document.getElementById('start-dosage').value = supp.dosage || '';
            document.getElementById('start-frequency').value = supp.frequency || 'daily';
            document.getElementById('start-reason').value = supp.reason || '';
            document.getElementById('start-notes').value = supp.notes || '';

            // Hide adherence row (not applicable for edits)
            document.getElementById('adherence-row').style.display = 'none';

            // Update save button text
            document.getElementById('supplement-save-btn').textContent = 'Save Changes';

            document.getElementById('supplement-start-modal').classList.remove('hidden');
        }

        // Inline edit start date (click on "Since [date]" to edit)
        function editStartDate(suppId, currentDate) {
            const dateEl = document.getElementById(`start-date-${suppId}`);
            if (!dateEl || dateEl.querySelector('input')) return; // Already editing

            // Create inline date input
            const input = document.createElement('input');
            input.type = 'date';
            input.value = currentDate;
            input.className = 'supp-start-date-input';

            // Replace text with input
            dateEl.innerHTML = '';
            dateEl.appendChild(input);
            input.focus();

            // Save on blur or Enter
            const saveDate = async () => {
                const newDate = input.value;
                if (!newDate) {
                    // Cancelled - restore original
                    dateEl.textContent = `Since ${formatDateShort(currentDate)}`;
                    return;
                }

                if (newDate === currentDate) {
                    // No change
                    dateEl.textContent = `Since ${formatDateShort(currentDate)}`;
                    return;
                }

                try {
                    const res = await fetch(`/analytics/${currentUserId}/supplement-starts/${suppId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ start_date: newDate })
                    });

                    if (res.ok) {
                        dateEl.textContent = `Since ${formatDateShort(newDate)}`;
                        // Update onclick with new date
                        dateEl.onclick = () => editStartDate(suppId, newDate);
                        showStatus('Start date updated!', 'success');
                        // Reload analytics data to refresh charts
                        loadAnalyticsData();
                    } else {
                        const err = await res.json();
                        showStatus(err.detail || 'Error updating date', 'error');
                        dateEl.textContent = `Since ${formatDateShort(currentDate)}`;
                    }
                } catch (e) {
                    showStatus('Error updating date', 'error');
                    dateEl.textContent = `Since ${formatDateShort(currentDate)}`;
                }
            };

            input.addEventListener('blur', saveDate);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    dateEl.textContent = `Since ${formatDateShort(currentDate)}`;
                }
            });
        }

        // Populate supplement dropdown from library
        function populateSupplementDropdown() {
            const select = document.getElementById('start-supplement-id');

            if (supplementLibrary && supplementLibrary.supplements) {
                select.innerHTML = supplementLibrary.supplements.map(s =>
                    `<option value="${s.id}" data-dose="${s.typical_dose}">${s.name}</option>`
                ).join('');
                select.innerHTML += '<option value="custom">+ Add Custom Supplement</option>';
            } else {
                // Fallback if library not loaded
                const supplements = [
                    'vitamin_d3', 'fish_oil', 'magnesium', 'zinc', 'b_complex', 'creatine',
                    'protein_powder', 'melatonin', 'probiotics', 'iron', 'vitamin_c',
                    'multivitamin', 'caffeine', 'ashwagandha', 'l_theanine', 'collagen'
                ];
                select.innerHTML = supplements.map(s =>
                    `<option value="${s}">${formatSupplementName(s)}</option>`
                ).join('');
                select.innerHTML += '<option value="custom">+ Add Custom Supplement</option>';
            }
        }

        // Reset supplement form
        function resetSupplementForm() {
            document.getElementById('start-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('start-dosage').value = '';
            document.getElementById('start-frequency').value = 'daily';
            document.getElementById('start-reason').value = '';
            document.getElementById('start-notes').value = '';
            document.getElementById('custom-name-row').style.display = 'none';
            document.getElementById('start-supplement-name').value = '';
            document.getElementById('edit-supplement-id').value = '';
            document.getElementById('start-adherence').value = 80;
            document.getElementById('adherence-label').textContent = '80%';
            document.getElementById('adherence-row').style.display = 'none';
            document.getElementById('supplement-save-btn').textContent = 'Add Supplement';
            onSupplementSelect();
            checkBackdateAdherence();
        }

        // Update adherence label when slider changes
        function updateAdherenceLabel() {
            const value = document.getElementById('start-adherence').value;
            document.getElementById('adherence-label').textContent = value + '%';
        }

        // Check if start date is in the past and show adherence option
        function checkBackdateAdherence() {
            const startDate = document.getElementById('start-date').value;
            const adherenceRow = document.getElementById('adherence-row');

            if (!startDate) {
                adherenceRow.style.display = 'none';
                return;
            }

            const start = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            start.setHours(0, 0, 0, 0);

            // Show adherence option if start date is more than 1 day in the past
            const daysDiff = Math.floor((today - start) / (1000 * 60 * 60 * 24));
            if (daysDiff > 1) {
                adherenceRow.style.display = 'block';
            } else {
                adherenceRow.style.display = 'none';
            }
        }

        // Handle supplement selection change
        function onSupplementSelect() {
            const select = document.getElementById('start-supplement-id');
            const customRow = document.getElementById('custom-name-row');
            const dosageInput = document.getElementById('start-dosage');

            if (select.value === 'custom') {
                customRow.style.display = 'block';
            } else {
                customRow.style.display = 'none';
                // Auto-fill typical dose
                const option = select.options[select.selectedIndex];
                const typicalDose = option.dataset.dose;
                if (typicalDose && !dosageInput.value) {
                    dosageInput.placeholder = `Typical: ${typicalDose}`;
                }
            }
        }

        // Close supplement start modal
        function closeSupplementStartModal() {
            document.getElementById('supplement-start-modal').classList.add('hidden');
            // Re-enable fields that might have been disabled for edit mode
            document.getElementById('start-supplement-id').disabled = false;
            document.getElementById('start-date').disabled = false;
        }

        // Save supplement start (handles both add and edit)
        async function saveSupplementStart() {
            const select = document.getElementById('start-supplement-id');
            const editId = document.getElementById('edit-supplement-id').value;
            let supplementId = select.value;
            let supplementName = null;

            if (supplementId === 'custom') {
                supplementName = document.getElementById('start-supplement-name').value.trim();
                if (!supplementName) {
                    showStatus('Please enter a supplement name', 'error');
                    return;
                }
                supplementId = supplementName.toLowerCase().replace(/\s+/g, '_');
            } else {
                supplementName = select.options[select.selectedIndex].text;
            }

            const startDate = document.getElementById('start-date').value;
            const dosage = document.getElementById('start-dosage').value;
            const frequency = document.getElementById('start-frequency').value;
            const reason = document.getElementById('start-reason').value;
            const notes = document.getElementById('start-notes').value;
            const isManual = document.getElementById('start-is-manual').value === 'true';

            if (!supplementId || !startDate) {
                showStatus('Please select supplement and date', 'error');
                return;
            }

            try {
                let res;
                if (editId) {
                    // Update existing supplement
                    res = await fetch(`/analytics/${currentUserId}/supplement-starts/${editId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            dosage: dosage || null,
                            frequency: frequency || null,
                            reason: reason || null,
                            notes: notes || null
                        })
                    });
                } else {
                    // Create new supplement
                    res = await fetch(`/analytics/${currentUserId}/supplement-starts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            supplement_id: supplementId,
                            supplement_name: supplementName,
                            start_date: startDate,
                            notes: notes || null,
                            is_manual: isManual,
                            dosage: dosage || null,
                            frequency: frequency || null,
                            reason: reason || null
                        })
                    });
                }

                if (res.ok) {
                    // Check if we need to create backdate logs
                    const adherenceRow = document.getElementById('adherence-row');
                    if (!editId && adherenceRow.style.display !== 'none') {
                        const adherence = parseInt(document.getElementById('start-adherence').value) / 100;
                        await createBackdateLogs(supplementId, startDate, adherence);
                    }

                    showStatus(editId ? 'Supplement updated!' : 'Supplement added!', 'success');
                    closeSupplementStartModal();
                    loadAnalyticsData();
                    loadTodaysStackData();
                } else {
                    const err = await res.json();
                    showStatus(err.detail || 'Error saving', 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Create backdate logs based on adherence percentage
        async function createBackdateLogs(supplementId, startDate, adherence) {
            const start = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            start.setHours(0, 0, 0, 0);

            const daysDiff = Math.floor((today - start) / (1000 * 60 * 60 * 24));
            if (daysDiff <= 1) return;

            // Generate logs for past days based on adherence
            const datesToLog = [];
            for (let i = 0; i < daysDiff; i++) {
                if (Math.random() < adherence) {
                    const logDate = new Date(start);
                    logDate.setDate(logDate.getDate() + i);
                    datesToLog.push(getLocalDateString(logDate));
                }
            }

            // Create logs for each date (using correct API format)
            for (const dateStr of datesToLog) {
                try {
                    await fetch(`/analytics/${currentUserId}/daily-checkin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            date: dateStr,
                            supplements: [{
                                supplement_id: supplementId,
                                taken: true,
                                time_taken: 'morning'
                            }]
                        })
                    });
                } catch (e) {
                    console.error('Error creating backdate log:', e);
                }
            }
        }

        // Render supplements grid (My Supplements)
        function renderSupplementsGrid() {
            const container = document.getElementById('supplements-grid');
            if (!container) return;

            const supplements = analyticsData?.supplement_starts || [];

            if (supplements.length === 0) {
                container.innerHTML = `
                    <div class="supplements-empty">
                        <div class="supplements-empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5"><rect x="6" y="4" width="12" height="16" rx="6"/><path d="M6 12h12"/></svg></div>
                        <div>No supplements tracked yet</div>
                        <div style="font-size: 0.85em; margin-top: 6px;">Add the supplements you're currently taking</div>
                    </div>
                `;
                return;
            }

            // Separate active supplements (no end_date)
            const active = supplements.filter(s => !s.end_date);

            // Destroy existing mini charts before re-rendering
            Object.values(miniCharts).forEach(chart => chart?.destroy?.());
            miniCharts = {};

            container.innerHTML = active.map(supp => {
                const suppId = (supp.supplement_id || '').toLowerCase().replace(/-/g, '_');
                const suppName = supp.supplement_name || formatSupplementName(supp.supplement_id);

                if (isMeasurableSupplement(suppId)) {
                    return renderMeasurableCard(supp, suppId, suppName);
                } else {
                    return renderConsistencyCard(supp, suppId, suppName);
                }
            }).join('');

            // Initialize mini charts after DOM is updated
            setTimeout(() => initMiniCharts(), 50);
        }

        // Render card for supplements with measurable health metrics
        function renderMeasurableCard(supp, suppId, suppName) {
            const config = MEASURABLE_SUPPLEMENTS[suppId] || {};
            const metrics = config.metrics || [];
            const color = config.color || '#8B5CF6';

            // Get impact data from insights
            const impact = supplementInsightsData?.impact_analysis?.find(
                i => (i.supplement_id || '').toLowerCase().replace(/-/g, '_') === suppId
            );

            const hasData = impact?.has_sufficient_data && impact?.change !== null;
            const changeText = hasData
                ? `${impact.change_pct > 0 ? '+' : ''}${impact.change_pct}% ${formatMetricName(impact.primary_metric)}`
                : 'Collecting data...';
            const changeClass = hasData ? (impact.is_positive ? 'positive' : 'negative') : 'pending';
            const streakDays = impact?.days_on || Math.floor((new Date() - new Date(supp.start_date)) / (1000 * 60 * 60 * 24));

            return `
                <div class="supplement-card-v2 measurable" style="border-left-color: ${color}">
                    <div class="supp-card-header">
                        <span class="supp-card-name">${suppName}</span>
                        ${supp.dosage ? `<span class="supp-card-dose">${supp.dosage}</span>` : ''}
                    </div>
                    <div class="supp-card-metrics">
                        ${metrics.map(m => `<span class="metric-tag">${formatMetricName(m)}</span>`).join('')}
                    </div>
                    <div class="supp-mini-chart-container">
                        <canvas id="mini-chart-${supp.id}" width="200" height="60"></canvas>
                    </div>
                    <div class="supp-card-stats">
                        <span class="supp-change ${changeClass}">${changeText}</span>
                        <span class="supp-streak">${streakDays}d</span>
                    </div>
                    <div class="supp-card-footer">
                        <span class="supp-start-date" id="start-date-${supp.id}" onclick="editStartDate('${supp.id}', '${supp.start_date}')" title="Click to edit start date">Since ${formatDateShort(supp.start_date)}</span>
                        <div class="supp-card-actions">
                            <button onclick="openEditSupplement('${supp.id}')" title="Edit">Edit</button>
                            <button onclick="deleteSupplement('${supp.id}', '${suppName.replace(/'/g, "\\'")}')" title="Remove">Remove</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render card for supplements without measurable metrics (consistency tracking only)
        function renderConsistencyCard(supp, suppId, suppName) {
            // Get consistency data from insights
            const tracking = supplementInsightsData?.consistency_tracking?.find(
                t => (t.supplement_id || '').toLowerCase().replace(/-/g, '_') === suppId
            );

            const adherencePct = tracking?.adherence_pct || 0;
            const streak = tracking?.streak_days || 0;
            const daysTaken = tracking?.days_taken || Math.floor((new Date() - new Date(supp.start_date)) / (1000 * 60 * 60 * 24));

            return `
                <div class="supplement-card-v2 consistency">
                    <div class="supp-card-header">
                        <span class="supp-card-name">${suppName}</span>
                        ${supp.dosage ? `<span class="supp-card-dose">${supp.dosage}</span>` : ''}
                    </div>
                    <div class="supp-card-info">
                        <span class="info-label">Long-term supplement - tracking consistency</span>
                    </div>
                    <div class="consistency-bar-container">
                        <div class="consistency-bar-fill" style="width: ${adherencePct}%"></div>
                        <span class="consistency-bar-label">${adherencePct}% adherence</span>
                    </div>
                    <div class="consistency-stats">
                        <div class="stat">
                            <span class="stat-value">${streak}</span>
                            <span class="stat-label">Day Streak</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${daysTaken}</span>
                            <span class="stat-label">Days Taken</span>
                        </div>
                    </div>
                    <div class="supp-card-footer">
                        <span class="supp-start-date" id="start-date-${supp.id}" onclick="editStartDate('${supp.id}', '${supp.start_date}')" title="Click to edit start date">Since ${formatDateShort(supp.start_date)}</span>
                        <div class="supp-card-actions">
                            <button onclick="openEditSupplement('${supp.id}')" title="Edit">Edit</button>
                            <button onclick="deleteSupplement('${supp.id}', '${suppName.replace(/'/g, "\\'")}')" title="Remove">Remove</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize mini sparkline charts for measurable supplements
        function initMiniCharts() {
            const supplements = analyticsData?.supplement_starts?.filter(s => !s.end_date) || [];
            const healthData = analyticsData?.health_data || [];

            if (healthData.length === 0) return;

            supplements.forEach(supp => {
                const suppId = (supp.supplement_id || '').toLowerCase().replace(/-/g, '_');
                if (!isMeasurableSupplement(suppId)) return;

                const canvas = document.getElementById(`mini-chart-${supp.id}`);
                if (!canvas) return;

                const config = MEASURABLE_SUPPLEMENTS[suppId];
                const primaryMetric = config?.primary || 'sleep_score';
                const color = config?.color || '#8B5CF6';

                // Filter health data from supplement start date
                const startDate = new Date(supp.start_date);
                const relevantData = healthData
                    .filter(d => new Date(d.date) >= startDate && d[primaryMetric] !== null)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                if (relevantData.length < 2) return;

                const chartData = relevantData.map(d => d[primaryMetric]);
                const labels = relevantData.map(d => d.date);

                miniCharts[supp.id] = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: chartData,
                            borderColor: color,
                            backgroundColor: color + '20',
                            borderWidth: 1.5,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(26, 26, 26, 0.9)',
                                titleColor: '#E8E8E8',
                                bodyColor: '#A0A0A0',
                                padding: 8,
                                displayColors: false,
                                callbacks: {
                                    title: (items) => items[0]?.label || '',
                                    label: (item) => `${formatMetricName(primaryMetric)}: ${item.raw}`
                                }
                            }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            });
        }

        // Stop taking a supplement (set end date)
        async function stopSupplement(startId) {
            if (!confirm('Mark this supplement as stopped? It will still appear in your history.')) return;

            try {
                const res = await fetch(`/analytics/${currentUserId}/supplement-starts/${startId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        end_date: getLocalDateString(new Date())
                    })
                });

                if (res.ok) {
                    showStatus('Supplement marked as stopped', 'success');
                    loadAnalyticsData();
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Permanently delete a supplement
        async function deleteSupplement(startId, name) {
            if (!confirm(`Permanently delete "${name}" from your stack?\n\nThis will remove all tracking data for this supplement and cannot be undone.`)) return;

            try {
                const res = await fetch(`/analytics/${currentUserId}/supplement-starts/${startId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    showStatus('Supplement deleted', 'success');
                    loadAnalyticsData();
                    loadTodaysStackData(); // Refresh Dashboard stack too
                } else {
                    const error = await res.json();
                    showStatus('Error: ' + (error.detail || 'Failed to delete'), 'error');
                }
            } catch (e) {
                showStatus('Error: ' + e.message, 'error');
            }
        }

        // Format frequency
        function formatFrequency(freq) {
            const formats = {
                daily: 'Daily',
                twice_daily: '2x/day',
                three_times: '3x/day',
                as_needed: 'As needed',
                weekly: 'Weekly'
            };
            return formats[freq] || freq;
        }

        // Format reason
        function formatReason(reason) {
            const formats = {
                sleep: 'Sleep',
                energy: 'Energy',
                recovery: 'Recovery',
                focus: 'Focus',
                stress: 'Stress',
                immunity: 'Immunity',
                general_health: 'Health',
                deficiency: 'Deficiency'
            };
            return formats[reason] || reason;
        }

        // Helper: Format supplement name
        function formatSupplementName(id) {
            return id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        // Helper: Format metric name
        function formatMetricName(key) {
            const names = {
                sleep_score: 'Sleep Score',
                hrv_score: 'HRV',
                recovery_score: 'Recovery',
                resting_hr: 'Resting HR',
                sleep_duration_hrs: 'Sleep Duration'
            };
            return names[key] || key;
        }

        // Helper: Format date
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Helper: Format event type
        function formatEventType(type) {
            const types = {
                new_job: 'New Job/Work Stress',
                changed_mattress: 'Changed Mattress',
                moved: 'Moved Homes',
                started_exercise: 'Started Exercising',
                stopped_exercise: 'Stopped Exercising',
                sick: 'Got Sick',
                travel: 'Travel/Jet Lag',
                relationship: 'Relationship Change',
                diet_change: 'Major Diet Change',
                medication: 'Started/Stopped Medication',
                stress: 'Major Stress Event',
                other: 'Other'
            };
            return types[type] || type;
        }

        // Helper: Get event icon (SVG icons)
        function getEventIcon(type) {
            const icons = {
                new_job: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>',
                changed_mattress: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="10" width="20" height="8" rx="2"/><path d="M2 14h20"/><path d="M4 10V6a2 2 0 012-2h12a2 2 0 012 2v4"/></svg>',
                moved: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
                started_exercise: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><path d="M12 8v4m-4 4l4-4 4 4m-8 4h8"/></svg>',
                stopped_exercise: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M8 8V6a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="12" x2="14" y2="16"/><line x1="14" y1="12" x2="10" y2="16"/></svg>',
                sick: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/></svg>',
                travel: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.8 19.2L16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>',
                relationship: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>',
                diet_change: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
                medication: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="12" height="16" rx="6"/><path d="M6 12h12"/></svg>',
                stress: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 15s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>',
                other: '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>'
            };
            return icons[type] || '<svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
        }
    </script>
</body>
</html>
